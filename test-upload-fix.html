<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>上传API修复验证</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            color: #2196F3;
            margin-top: 0;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        input[type="file"] {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🔧 上传API修复验证</h1>
        
        <div class="test-section">
            <h3>📡 API路径测试</h3>
            <p>测试修复后的API路径: <code>/api/v1/upload/product/cover</code></p>
            <button onclick="testApiEndpoint()">测试API端点</button>
            <div id="endpointResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>🖼️ 文件上传测试</h3>
            <p>选择一个图片文件进行上传测试：</p>
            <input type="file" id="testFile" accept="image/*">
            <button onclick="testFileUpload()">测试文件上传</button>
            <div id="uploadResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>📋 API状态检查</h3>
            <button onclick="checkApiStatus()">检查所有API状态</button>
            <div id="statusResult" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8081';

        // 测试API端点是否可访问
        async function testApiEndpoint() {
            const resultDiv = document.getElementById('endpointResult');
            resultDiv.innerHTML = '<div class="info">正在测试API端点...</div>';
            
            try {
                // 尝试访问API端点（会返回400因为没有文件，但至少证明端点存在）
                const response = await fetch(`${API_BASE}/api/v1/upload/product/cover`, {
                    method: 'POST',
                    body: new FormData() // 空的FormData
                });
                
                const data = await response.json();
                
                if (response.status === 200 || response.status === 400) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            ✅ API端点可访问！
                            状态码: ${response.status}
                            响应: ${JSON.stringify(data, null, 2)}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            ❌ API端点状态异常
                            状态码: ${response.status}
                            响应: ${JSON.stringify(data, null, 2)}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        ❌ API端点不可访问
                        错误: ${error.message}
                        
                        可能原因:
                        1. 应用未启动
                        2. 端口8081未开放
                        3. 路径配置错误
                    </div>
                `;
            }
        }

        // 测试文件上传
        async function testFileUpload() {
            const fileInput = document.getElementById('testFile');
            const resultDiv = document.getElementById('uploadResult');
            
            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<div class="error">请先选择一个图片文件</div>';
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            resultDiv.innerHTML = '<div class="info">正在上传文件...</div>';

            try {
                const startTime = Date.now();
                const response = await fetch(`${API_BASE}/api/v1/upload/product/cover`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                const uploadTime = Date.now() - startTime;

                if (data.code === 200) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            ✅ 文件上传成功！
                            
                            上传时间: ${uploadTime}ms
                            文件名: ${data.data.fileName}
                            原始名: ${data.data.originalName}
                            文件大小: ${data.data.size} bytes
                            文件类型: ${data.data.contentType}
                            访问URL: ${data.data.url}
                            完整URL: ${data.data.fullUrl}
                            
                            完整响应:
                            ${JSON.stringify(data, null, 2)}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            ❌ 上传失败
                            错误代码: ${data.code}
                            错误信息: ${data.message}
                            
                            完整响应:
                            ${JSON.stringify(data, null, 2)}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        ❌ 上传请求失败
                        错误: ${error.message}
                    </div>
                `;
            }
        }

        // 检查所有API状态
        async function checkApiStatus() {
            const resultDiv = document.getElementById('statusResult');
            resultDiv.innerHTML = '<div class="info">正在检查API状态...</div>';
            
            const apis = [
                { name: '产品列表API', url: '/api/admin/products?page=1&size=1' },
                { name: '产品上传API', url: '/api/v1/upload/product/cover', method: 'POST' },
                { name: '应用首页', url: '/' }
            ];
            
            let results = [];
            
            for (const api of apis) {
                try {
                    const options = { 
                        method: api.method || 'GET',
                        ...(api.method === 'POST' ? { body: new FormData() } : {})
                    };
                    
                    const response = await fetch(`${API_BASE}${api.url}`, options);
                    results.push(`✅ ${api.name}: ${response.status} ${response.statusText}`);
                } catch (error) {
                    results.push(`❌ ${api.name}: ${error.message}`);
                }
            }
            
            resultDiv.innerHTML = `
                <div class="info">
                    📊 API状态检查结果:
                    
                    ${results.join('\n')}
                    
                    ${results.filter(r => r.startsWith('✅')).length === apis.length ? 
                        '\n🎉 所有API都正常工作！' : 
                        '\n⚠️ 部分API可能有问题，请检查应用状态'}
                </div>
            `;
        }

        // 页面加载时自动检查API状态
        window.onload = function() {
            setTimeout(checkApiStatus, 1000);
        };
    </script>
</body>
</html>