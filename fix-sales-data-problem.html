<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é”€å”®æ•°æ®é—®é¢˜è§£å†³æ–¹æ¡ˆ</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .step-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        .step-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
        }
        .action-button {
            background-color: #409EFF;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 10px 10px 0;
        }
        .action-button:hover {
            background-color: #337ecc;
        }
        .success-button {
            background-color: #67c23a;
        }
        .danger-button {
            background-color: #f56c6c;
        }
        .warning-button {
            background-color: #e6a23c;
        }
        .result-area {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #409EFF;
            display: none;
        }
        .result-area.success {
            border-left-color: #67c23a;
            background-color: #f0f9ff;
        }
        .result-area.error {
            border-left-color: #f56c6c;
            background-color: #fef0f0;
        }
        .result-area.warning {
            border-left-color: #e6a23c;
            background-color: #fdf6ec;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-pending { background-color: #e6a23c; }
        .status-success { background-color: #67c23a; }
        .status-error { background-color: #f56c6c; }
        .progress {
            margin-top: 20px;
        }
        .progress-item {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
            background: #f8f9fa;
            border-left: 4px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ é”€å”®æ•°æ®æ˜¾ç¤ºé—®é¢˜è§£å†³æ–¹æ¡ˆ</h1>
        
        <div class="progress">
            <h3>è§£å†³è¿›åº¦ï¼š</h3>
            <div id="progress-1" class="progress-item">
                <span class="status-indicator status-pending"></span>
                <strong>æ­¥éª¤1:</strong> æ£€æŸ¥æ•°æ®åº“è¡¨ç»“æ„
            </div>
            <div id="progress-2" class="progress-item">
                <span class="status-indicator status-pending"></span>
                <strong>æ­¥éª¤2:</strong> åˆ›å»ºé”€å”®æ•°æ®è¡¨
            </div>
            <div id="progress-3" class="progress-item">
                <span class="status-indicator status-pending"></span>
                <strong>æ­¥éª¤3:</strong> æ’å…¥æµ‹è¯•æ•°æ®
            </div>
            <div id="progress-4" class="progress-item">
                <span class="status-indicator status-pending"></span>
                <strong>æ­¥éª¤4:</strong> æµ‹è¯•APIç«¯ç‚¹
            </div>
            <div id="progress-5" class="progress-item">
                <span class="status-indicator status-pending"></span>
                <strong>æ­¥éª¤5:</strong> éªŒè¯å‰ç«¯æ•°æ®æ˜¾ç¤º
            </div>
        </div>

        <!-- æ­¥éª¤1: æ£€æŸ¥æ•°æ®åº“è¡¨ -->
        <div class="step-section">
            <div class="step-title">ğŸ“Š æ­¥éª¤1: æ£€æŸ¥æ•°æ®åº“è¡¨ç»“æ„</div>
            <p>é¦–å…ˆæ£€æŸ¥é”€å”®ç›¸å…³çš„æ•°æ®åº“è¡¨æ˜¯å¦å­˜åœ¨</p>
            <button class="action-button" onclick="checkDatabaseTables()">æ£€æŸ¥æ•°æ®åº“è¡¨</button>
            <div id="check-tables-result" class="result-area"></div>
        </div>

        <!-- æ­¥éª¤2: åˆ›å»ºæ•°æ®åº“è¡¨ -->
        <div class="step-section">
            <div class="step-title">ğŸ—ƒï¸ æ­¥éª¤2: åˆ›å»ºé”€å”®æ•°æ®è¡¨</div>
            <p>å¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ‰€éœ€çš„é”€å”®æ•°æ®ç®¡ç†è¡¨ç»“æ„</p>
            <button class="action-button warning-button" onclick="createSalesTables()">åˆ›å»ºé”€å”®æ•°æ®è¡¨</button>
            <div id="create-tables-result" class="result-area"></div>
        </div>

        <!-- æ­¥éª¤3: æ’å…¥æµ‹è¯•æ•°æ® -->
        <div class="step-section">
            <div class="step-title">ğŸ’¾ æ­¥éª¤3: æ’å…¥æµ‹è¯•æ•°æ®</div>
            <p>å‘æ•°æ®åº“ä¸­æ’å…¥çœŸå®çš„é”€å”®æµ‹è¯•æ•°æ®ä¾›å‰ç«¯æ˜¾ç¤º</p>
            <button class="action-button success-button" onclick="insertTestData()">æ’å…¥æµ‹è¯•æ•°æ®</button>
            <div id="insert-data-result" class="result-area"></div>
        </div>

        <!-- æ­¥éª¤4: æµ‹è¯•API -->
        <div class="step-section">
            <div class="step-title">ğŸ”— æ­¥éª¤4: æµ‹è¯•APIç«¯ç‚¹</div>
            <p>éªŒè¯æ‰€æœ‰é”€å”®ç›¸å…³çš„APIç«¯ç‚¹æ˜¯å¦æ­£å¸¸å·¥ä½œ</p>
            <button class="action-button" onclick="testSalesStatsAPI()">æµ‹è¯•é”€å”®ç»Ÿè®¡API</button>
            <button class="action-button" onclick="testSalesRecordsAPI()">æµ‹è¯•é”€å”®è®°å½•API</button>
            <button class="action-button" onclick="testSalesChartsAPI()">æµ‹è¯•å›¾è¡¨API</button>
            <div id="test-api-result" class="result-area"></div>
        </div>

        <!-- æ­¥éª¤5: éªŒè¯å‰ç«¯ -->
        <div class="step-section">
            <div class="step-title">ğŸ¨ æ­¥éª¤5: éªŒè¯å‰ç«¯æ•°æ®æ˜¾ç¤º</div>
            <p>æ£€æŸ¥å‰ç«¯é¡µé¢æ˜¯å¦èƒ½æ­£ç¡®æ˜¾ç¤ºé”€å”®æ•°æ®</p>
            <button class="action-button success-button" onclick="openSalesPage()">æ‰“å¼€é”€å”®é¡µé¢</button>
            <button class="action-button" onclick="validateFrontendData()">éªŒè¯å‰ç«¯æ•°æ®</button>
            <div id="frontend-result" class="result-area"></div>
        </div>

        <!-- ä¸€é”®è§£å†³æ–¹æ¡ˆ -->
        <div class="step-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <div class="step-title" style="color: white;">ğŸš€ ä¸€é”®è§£å†³æ–¹æ¡ˆ</div>
            <p style="color: #f0f0f0;">è‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰æ­¥éª¤æ¥è§£å†³é”€å”®æ•°æ®æ˜¾ç¤ºé—®é¢˜</p>
            <button class="action-button" style="background: rgba(255,255,255,0.2); border: 1px solid white;" onclick="runCompleteFixProcedure()">
                ä¸€é”®ä¿®å¤æ‰€æœ‰é—®é¢˜
            </button>
            <div id="complete-fix-result" class="result-area"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8081';
        
        // å·¥å…·å‡½æ•°
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `result-area ${type}`;
            element.innerHTML = `<pre>${message}</pre>`;
        }
        
        function updateProgress(stepNumber, status) {
            const element = document.getElementById(`progress-${stepNumber}`);
            const indicator = element.querySelector('.status-indicator');
            indicator.className = `status-indicator status-${status}`;
        }
        
        async function makeAPICall(url, method = 'GET', body = null) {
            try {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json' }
                };
                if (body) options.body = JSON.stringify(body);
                
                const response = await fetch(url, options);
                const data = await response.json();
                
                return {
                    success: response.ok,
                    status: response.status,
                    data: data
                };
            } catch (error) {
                return {
                    success: false,
                    status: 0,
                    error: error.message
                };
            }
        }
        
        // æ­¥éª¤1: æ£€æŸ¥æ•°æ®åº“è¡¨
        async function checkDatabaseTables() {
            showResult('check-tables-result', 'æ­£åœ¨æ£€æŸ¥æ•°æ®åº“è¡¨ç»“æ„...', 'info');
            
            const result = await makeAPICall(`${API_BASE}/api/admin/sales/sql/check-sales-tables`);
            
            if (result.success) {
                const tables = result.data.tables;
                let message = 'âœ… æ•°æ®åº“è¡¨æ£€æŸ¥ç»“æœ:\n\n';
                
                Object.entries(tables).forEach(([table, exists]) => {
                    message += `${exists ? 'âœ…' : 'âŒ'} ${table}: ${exists ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}\n`;
                });
                
                message += `\næ‰€æœ‰è¡¨éƒ½å­˜åœ¨: ${result.data.allTablesExist ? 'æ˜¯' : 'å¦'}`;
                
                showResult('check-tables-result', message, result.data.allTablesExist ? 'success' : 'warning');
                updateProgress(1, result.data.allTablesExist ? 'success' : 'error');
                
                return result.data.allTablesExist;
            } else {
                showResult('check-tables-result', `âŒ æ£€æŸ¥å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                updateProgress(1, 'error');
                return false;
            }
        }
        
        // æ­¥éª¤2: åˆ›å»ºæ•°æ®åº“è¡¨
        async function createSalesTables() {
            showResult('create-tables-result', 'æ­£åœ¨åˆ›å»ºé”€å”®æ•°æ®è¡¨...', 'info');
            
            const result = await makeAPICall(`${API_BASE}/api/admin/sales/sql/create-sales-tables`, 'POST');
            
            if (result.success && result.data.success) {
                showResult('create-tables-result', `âœ… ${result.data.message}`, 'success');
                updateProgress(2, 'success');
                return true;
            } else {
                showResult('create-tables-result', `âŒ åˆ›å»ºå¤±è´¥: ${result.data?.message || result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                updateProgress(2, 'error');
                return false;
            }
        }
        
        // æ­¥éª¤3: æ’å…¥æµ‹è¯•æ•°æ®
        async function insertTestData() {
            showResult('insert-data-result', 'æ­£åœ¨æ’å…¥æµ‹è¯•æ•°æ®...', 'info');
            
            const result = await makeAPICall(`${API_BASE}/api/admin/sales/sql/init-sales-data`, 'POST');
            
            if (result.success && result.data.success) {
                showResult('insert-data-result', `âœ… ${result.data.message}\n\nğŸ’¡ ${result.data.note}`, 'success');
                updateProgress(3, 'success');
                return true;
            } else {
                showResult('insert-data-result', `âŒ æ’å…¥å¤±è´¥: ${result.data?.message || result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                updateProgress(3, 'error');
                return false;
            }
        }
        
        // æ­¥éª¤4a: æµ‹è¯•é”€å”®ç»Ÿè®¡API
        async function testSalesStatsAPI() {
            const startDate = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            const endDate = new Date().toISOString().split('T')[0];
            
            showResult('test-api-result', 'æ­£åœ¨æµ‹è¯•é”€å”®ç»Ÿè®¡API...', 'info');
            
            const result = await makeAPICall(`${API_BASE}/api/sales/stats?startDate=${startDate}&endDate=${endDate}`);
            
            if (result.success) {
                const stats = result.data.data;
                let message = 'âœ… é”€å”®ç»Ÿè®¡APIæµ‹è¯•æˆåŠŸ!\n\n';
                message += `æ€»é”€å”®é¢: Â¥${stats.totalSalesAmount}\n`;
                message += `è®¢å•æ€»æ•°: ${stats.totalOrders}\n`;
                message += `å¹³å‡è®¢å•ä»·å€¼: Â¥${stats.avgOrderAmount}\n`;
                message += `æ–°å¢å®¢æˆ·: ${stats.newCustomers}\n`;
                message += `æ´»è·ƒå®¢æˆ·: ${stats.activeCustomers}\n`;
                message += `å¢é•¿ç‡: ${stats.growthRate}%\n`;
                
                showResult('test-api-result', message, 'success');
                updateProgress(4, 'success');
                return true;
            } else {
                showResult('test-api-result', `âŒ APIæµ‹è¯•å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                updateProgress(4, 'error');
                return false;
            }
        }
        
        // æ­¥éª¤4b: æµ‹è¯•é”€å”®è®°å½•API
        async function testSalesRecordsAPI() {
            showResult('test-api-result', 'æ­£åœ¨æµ‹è¯•é”€å”®è®°å½•API...', 'info');
            
            const result = await makeAPICall(`${API_BASE}/api/sales/records?page=1&pageSize=5`);
            
            if (result.success) {
                const data = result.data.data;
                let message = 'âœ… é”€å”®è®°å½•APIæµ‹è¯•æˆåŠŸ!\n\n';
                message += `è®°å½•æ€»æ•°: ${data.total}\n`;
                message += `å½“å‰é¡µ: ${data.page}\n`;
                message += `æ¯é¡µå¤§å°: ${data.pageSize}\n`;
                message += `è¿”å›è®°å½•æ•°: ${data.list.length}\n`;
                
                if (data.list.length > 0) {
                    message += '\nğŸ“‹ ç¤ºä¾‹è®°å½•:\n';
                    const record = data.list[0];
                    message += `è®¢å•å·: ${record.order_number}\n`;
                    message += `é”€å”®é‡‘é¢: Â¥${record.sales_amount}\n`;
                    message += `è®¢å•æ—¥æœŸ: ${record.order_date}\n`;
                    message += `çŠ¶æ€: ${record.status}\n`;
                }
                
                showResult('test-api-result', message, 'success');
                return true;
            } else {
                showResult('test-api-result', `âŒ APIæµ‹è¯•å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                return false;
            }
        }
        
        // æ­¥éª¤4c: æµ‹è¯•å›¾è¡¨API
        async function testSalesChartsAPI() {
            showResult('test-api-result', 'æ­£åœ¨æµ‹è¯•å›¾è¡¨æ•°æ®API...', 'info');
            
            const trendsResult = await makeAPICall(`${API_BASE}/api/sales/charts/trends?groupBy=day`);
            const distributionResult = await makeAPICall(`${API_BASE}/api/sales/charts/distribution?type=product`);
            
            let message = '';
            
            if (trendsResult.success) {
                message += 'âœ… è¶‹åŠ¿å›¾è¡¨APIæµ‹è¯•æˆåŠŸ!\n';
                const data = trendsResult.data.data;
                message += `è¶‹åŠ¿æ•°æ®ç±»åˆ«æ•°: ${data.categories?.length || 0}\n`;
                message += `æ•°æ®ç³»åˆ—æ•°: ${data.series?.length || 0}\n\n`;
            } else {
                message += 'âŒ è¶‹åŠ¿å›¾è¡¨APIæµ‹è¯•å¤±è´¥\n\n';
            }
            
            if (distributionResult.success) {
                message += 'âœ… åˆ†å¸ƒå›¾è¡¨APIæµ‹è¯•æˆåŠŸ!\n';
                const data = distributionResult.data.data;
                message += `åˆ†å¸ƒæ•°æ®ç±»åˆ«æ•°: ${data.categories?.length || 0}\n`;
                message += `æ•°æ®ç³»åˆ—æ•°: ${data.series?.length || 0}\n`;
            } else {
                message += 'âŒ åˆ†å¸ƒå›¾è¡¨APIæµ‹è¯•å¤±è´¥\n';
            }
            
            const success = trendsResult.success && distributionResult.success;
            showResult('test-api-result', message, success ? 'success' : 'warning');
            
            return success;
        }
        
        // æ­¥éª¤5a: æ‰“å¼€é”€å”®é¡µé¢
        function openSalesPage() {
            window.open('http://localhost:8081/admin/business/sales', '_blank');
            showResult('frontend-result', 'âœ… å·²åœ¨æ–°çª—å£æ‰“å¼€é”€å”®é¡µé¢\n\nè¯·æ£€æŸ¥é¡µé¢ä¸Šçš„é”€å”®æ•°æ®æ˜¯å¦æ­£å¸¸æ˜¾ç¤º', 'info');
        }
        
        // æ­¥éª¤5b: éªŒè¯å‰ç«¯æ•°æ®
        async function validateFrontendData() {
            showResult('frontend-result', 'æ­£åœ¨éªŒè¯å‰ç«¯æ•°æ®æ˜¾ç¤º...', 'info');
            
            // æ£€æŸ¥æ‰€æœ‰ç›¸å…³API
            const statsResult = await testSalesStatsAPI();
            await new Promise(resolve => setTimeout(resolve, 1000));
            const recordsResult = await testSalesRecordsAPI();
            await new Promise(resolve => setTimeout(resolve, 1000));
            const chartsResult = await testSalesChartsAPI();
            
            let message = 'ğŸ” å‰ç«¯æ•°æ®éªŒè¯ç»“æœ:\n\n';
            message += `${statsResult ? 'âœ…' : 'âŒ'} é”€å”®ç»Ÿè®¡æ•°æ® API\n`;
            message += `${recordsResult ? 'âœ…' : 'âŒ'} é”€å”®è®°å½•åˆ—è¡¨ API\n`;
            message += `${chartsResult ? 'âœ…' : 'âŒ'} å›¾è¡¨æ•°æ® API\n\n`;
            
            if (statsResult && recordsResult && chartsResult) {
                message += 'ğŸ‰ æ‰€æœ‰APIæ­£å¸¸å·¥ä½œï¼\n';
                message += 'ğŸ’¡ ç°åœ¨å‰ç«¯é¡µé¢åº”è¯¥èƒ½æ­£å¸¸æ˜¾ç¤ºé”€å”®æ•°æ®äº†\n';
                message += 'ğŸ“± è¯·åˆ·æ–°é”€å”®é¡µé¢æŸ¥çœ‹æœ€æ–°æ•°æ®';
                updateProgress(5, 'success');
                showResult('frontend-result', message, 'success');
            } else {
                message += 'âš ï¸ éƒ¨åˆ†APIå­˜åœ¨é—®é¢˜ï¼Œè¯·æ£€æŸ¥Spring Bootåº”ç”¨æ˜¯å¦æ­£å¸¸è¿è¡Œ';
                updateProgress(5, 'error');
                showResult('frontend-result', message, 'warning');
            }
        }
        
        // ä¸€é”®è§£å†³æ–¹æ¡ˆ
        async function runCompleteFixProcedure() {
            showResult('complete-fix-result', 'ğŸš€ å¼€å§‹æ‰§è¡Œå®Œæ•´ä¿®å¤æµç¨‹...', 'info');
            
            let message = 'ğŸ“‹ æ‰§è¡Œæ­¥éª¤:\n\n';
            
            // æ­¥éª¤1: æ£€æŸ¥è¡¨
            message += '1. æ£€æŸ¥æ•°æ®åº“è¡¨...\n';
            showResult('complete-fix-result', message, 'info');
            const tablesExist = await checkDatabaseTables();
            
            if (!tablesExist) {
                // æ­¥éª¤2: åˆ›å»ºè¡¨
                message += '2. åˆ›å»ºé”€å”®æ•°æ®è¡¨...\n';
                showResult('complete-fix-result', message, 'info');
                const tablesCreated = await createSalesTables();
                
                if (!tablesCreated) {
                    showResult('complete-fix-result', message + 'âŒ åˆ›å»ºè¡¨å¤±è´¥ï¼Œæµç¨‹ä¸­æ­¢', 'error');
                    return;
                }
            } else {
                message += '2. è¡¨å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»ºæ­¥éª¤\n';
            }
            
            // æ­¥éª¤3: æ’å…¥æ•°æ®
            message += '3. æ’å…¥æµ‹è¯•æ•°æ®...\n';
            showResult('complete-fix-result', message, 'info');
            const dataInserted = await insertTestData();
            
            if (!dataInserted) {
                message += 'âš ï¸ æ•°æ®æ’å…¥å¤±è´¥ï¼Œå¯èƒ½å·²å­˜åœ¨æ•°æ®ï¼Œç»§ç»­ä¸‹ä¸€æ­¥\n';
            }
            
            // æ­¥éª¤4: æµ‹è¯•API
            message += '4. æµ‹è¯•APIç«¯ç‚¹...\n';
            showResult('complete-fix-result', message, 'info');
            const apiWorking = await testSalesStatsAPI();
            
            // æ­¥éª¤5: å®Œæˆ
            message += '5. ä¿®å¤å®Œæˆ!\n\n';
            
            if (apiWorking) {
                message += 'ğŸ‰ é”€å”®æ•°æ®æ˜¾ç¤ºé—®é¢˜å·²è§£å†³!\n';
                message += 'âœ… æ‰€æœ‰APIæ­£å¸¸å·¥ä½œ\n';
                message += 'âœ… æ•°æ®åº“åŒ…å«æµ‹è¯•æ•°æ®\n';
                message += 'âœ… å‰ç«¯é¡µé¢åº”è¯¥èƒ½æ­£å¸¸æ˜¾ç¤ºæ•°æ®\n\n';
                message += 'ğŸ“± è¯·åˆ·æ–°æµè§ˆå™¨ä¸­çš„é”€å”®é¡µé¢æŸ¥çœ‹æœ€æ–°æ•°æ®';
                showResult('complete-fix-result', message, 'success');
                
                // æ›´æ–°æ‰€æœ‰è¿›åº¦
                for (let i = 1; i <= 5; i++) {
                    updateProgress(i, 'success');
                }
            } else {
                message += 'âš ï¸ ä¿®å¤è¿‡ç¨‹å®Œæˆï¼Œä½†APIæµ‹è¯•å¤±è´¥\n';
                message += 'ğŸ”§ è¯·æ£€æŸ¥Spring Bootåº”ç”¨æ˜¯å¦æ­£å¸¸è¿è¡Œ\n';
                message += 'ğŸ”— ç¡®è®¤åº”ç”¨è¿è¡Œåœ¨ http://localhost:8081';
                showResult('complete-fix-result', message, 'warning');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = function() {
            setTimeout(() => {
                checkDatabaseTables();
            }, 1000);
        };
    </script>
</body>
</html>