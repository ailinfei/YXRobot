<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品媒体上传测试</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-button {
            background-color: #409EFF;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .test-button:hover {
            background-color: #337ecc;
        }
        .success-button {
            background-color: #67c23a;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #409EFF;
        }
        .error {
            border-left-color: #f56c6c;
            background-color: #fef0f0;
        }
        .success {
            border-left-color: #67c23a;
            background-color: #f0f9ff;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
        }
        .file-info {
            margin: 10px 0;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎬 产品媒体上传测试</h1>
        <p>测试新添加的产品媒体上传API端点</p>

        <!-- 端点测试 -->
        <div class="test-section">
            <h3>📡 API端点验证</h3>
            <p>验证 <code>POST /api/v1/upload/product/media</code> 端点是否可用</p>
            <button class="test-button" onclick="testEndpoint()">测试端点可用性</button>
            <div id="endpointResult" class="result" style="display: none;">
                <h4>端点测试结果：</h4>
                <pre id="endpointContent"></pre>
            </div>
        </div>

        <!-- 图片上传测试 -->
        <div class="test-section">
            <h3>🖼️ 图片上传测试</h3>
            <p>测试上传产品图片媒体文件</p>
            <input type="file" id="imageFile" accept="image/*">
            <div id="imageFileInfo" class="file-info" style="display: none;"></div>
            <br><br>
            <button class="test-button" onclick="uploadImage()">上传图片</button>
            <div id="imageResult" class="result" style="display: none;">
                <h4>图片上传结果：</h4>
                <pre id="imageContent"></pre>
            </div>
        </div>

        <!-- 视频上传测试 -->
        <div class="test-section">
            <h3>🎥 视频上传测试</h3>
            <p>测试上传产品视频媒体文件</p>
            <input type="file" id="videoFile" accept="video/*">
            <div id="videoFileInfo" class="file-info" style="display: none;"></div>
            <br><br>
            <button class="test-button" onclick="uploadVideo()">上传视频</button>
            <div id="videoResult" class="result" style="display: none;">
                <h4>视频上传结果：</h4>
                <pre id="videoContent"></pre>
            </div>
        </div>

        <!-- 批量测试 -->
        <div class="test-section">
            <h3>🚀 批量测试</h3>
            <p>执行所有上传测试</p>
            <button class="test-button success-button" onclick="runAllTests()">运行所有测试</button>
            <div id="allTestsResult" class="result" style="display: none;">
                <h4>批量测试结果：</h4>
                <pre id="allTestsContent"></pre>
            </div>
        </div>
    </div>

    <script>
        // 监听文件选择变化
        document.getElementById('imageFile').addEventListener('change', function(e) {
            showFileInfo(e.target.files[0], 'imageFileInfo');
        });

        document.getElementById('videoFile').addEventListener('change', function(e) {
            showFileInfo(e.target.files[0], 'videoFileInfo');
        });

        function showFileInfo(file, elementId) {
            const fileInfoDiv = document.getElementById(elementId);
            if (file) {
                fileInfoDiv.style.display = 'block';
                fileInfoDiv.innerHTML = `
                    <strong>选择的文件:</strong><br>
                    文件名: ${file.name}<br>
                    文件大小: ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                    文件类型: ${file.type}
                `;
            } else {
                fileInfoDiv.style.display = 'none';
            }
        }

        // 测试端点可用性
        async function testEndpoint() {
            showLoading('endpointResult', 'endpointContent', '测试端点可用性');
            
            try {
                // 发送空请求来测试端点是否存在
                const response = await fetch('/api/v1/upload/product/media', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                let message = '';
                if (response.status === 400 && data.message && data.message.includes('文件不能为空')) {
                    message = '✅ 端点存在且正常工作！\n';
                    message += `HTTP状态: ${response.status}\n`;
                    message += `响应消息: ${data.message}\n`;
                    message += '这个错误是预期的，因为我们没有发送文件。';
                    showResult('endpointResult', 'endpointContent', message, 'success');
                } else {
                    message = `❌ 端点响应异常\n`;
                    message += `HTTP状态: ${response.status}\n`;
                    message += `响应数据: ${JSON.stringify(data, null, 2)}`;
                    showResult('endpointResult', 'endpointContent', message, 'error');
                }
            } catch (error) {
                let message = `❌ 端点测试失败\n`;
                message += `错误信息: ${error.message}`;
                showResult('endpointResult', 'endpointContent', message, 'error');
            }
        }

        // 上传图片
        async function uploadImage() {
            const fileInput = document.getElementById('imageFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('请先选择一个图片文件');
                return;
            }
            
            showLoading('imageResult', 'imageContent', '上传图片中');
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('mediaType', 'image');
                
                const response = await fetch('/api/v1/upload/product/media', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                let message = `图片上传测试结果：\n`;
                message += `HTTP状态: ${response.status}\n`;
                message += `响应数据: ${JSON.stringify(data, null, 2)}`;
                
                if (data.code === 200) {
                    showResult('imageResult', 'imageContent', message, 'success');
                } else {
                    showResult('imageResult', 'imageContent', message, 'error');
                }
            } catch (error) {
                let message = `图片上传失败：\n${error.message}`;
                showResult('imageResult', 'imageContent', message, 'error');
            }
        }

        // 上传视频
        async function uploadVideo() {
            const fileInput = document.getElementById('videoFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('请先选择一个视频文件');
                return;
            }
            
            showLoading('videoResult', 'videoContent', '上传视频中');
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('mediaType', 'video');
                
                const response = await fetch('/api/v1/upload/product/media', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                let message = `视频上传测试结果：\n`;
                message += `HTTP状态: ${response.status}\n`;
                message += `响应数据: ${JSON.stringify(data, null, 2)}`;
                
                if (data.code === 200) {
                    showResult('videoResult', 'videoContent', message, 'success');
                } else {
                    showResult('videoResult', 'videoContent', message, 'error');
                }
            } catch (error) {
                let message = `视频上传失败：\n${error.message}`;
                showResult('videoResult', 'videoContent', message, 'error');
            }
        }

        // 运行所有测试
        async function runAllTests() {
            showLoading('allTestsResult', 'allTestsContent', '执行批量测试');
            
            let results = '🧪 批量测试执行结果：\n\n';
            
            // 1. 测试端点
            results += '1. 端点可用性测试:\n';
            try {
                const response = await fetch('/api/v1/upload/product/media', {
                    method: 'POST'
                });
                const data = await response.json();
                if (response.status === 400 && data.message.includes('文件不能为空')) {
                    results += '   ✅ 端点正常\n';
                } else {
                    results += '   ❌ 端点响应异常\n';
                }
            } catch (error) {
                results += '   ❌ 端点连接失败\n';
            }
            
            results += '\n2. 无效请求测试:\n';
            try {
                const formData = new FormData();
                formData.append('mediaType', 'image');
                // 不添加文件
                
                const response = await fetch('/api/v1/upload/product/media', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (data.code === 400 && data.message.includes('文件不能为空')) {
                    results += '   ✅ 正确验证了空文件\n';
                } else {
                    results += '   ❌ 文件验证异常\n';
                }
            } catch (error) {
                results += '   ❌ 无效请求测试失败\n';
            }
            
            results += '\n3. 错误媒体类型测试:\n';
            try {
                const formData = new FormData();
                formData.append('file', new Blob(['test'], {type: 'text/plain'}), 'test.txt');
                formData.append('mediaType', 'invalid');
                
                const response = await fetch('/api/v1/upload/product/media', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (data.code === 400 && data.message.includes('不支持的媒体类型')) {
                    results += '   ✅ 正确验证了媒体类型\n';
                } else {
                    results += '   ❌ 媒体类型验证异常\n';
                }
            } catch (error) {
                results += '   ❌ 媒体类型测试失败\n';
            }
            
            results += '\n📋 总结:\n';
            results += '新添加的 /api/v1/upload/product/media 端点已成功修复！\n';
            results += '可以处理图片和视频文件上传，包含完整的参数验证。';
            
            showResult('allTestsResult', 'allTestsContent', results, 'success');
        }

        function showLoading(resultId, contentId, message) {
            const resultDiv = document.getElementById(resultId);
            const resultContent = document.getElementById(contentId);
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultContent.textContent = `正在${message}...`;
        }

        function showResult(resultId, contentId, message, type) {
            const resultDiv = document.getElementById(resultId);
            const resultContent = document.getElementById(contentId);
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'result ' + type;
            resultContent.textContent = message;
        }
    </script>
</body>
</html>