<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.CharityInstitutionMapper">

    <!-- 结果映射 -->
    <resultMap id="CharityInstitutionResultMap" type="com.yxrobot.entity.CharityInstitution">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="type" property="type"/>
        <result column="location" property="location"/>
        <result column="address" property="address"/>
        <result column="contact_person" property="contactPerson"/>
        <result column="contact_phone" property="contactPhone"/>
        <result column="email" property="email"/>
        <result column="student_count" property="studentCount"/>
        <result column="cooperation_date" property="cooperationDate"/>
        <result column="status" property="status"/>
        <result column="device_count" property="deviceCount"/>
        <result column="last_visit_date" property="lastVisitDate"/>
        <result column="notes" property="notes"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="create_by" property="createBy"/>
        <result column="update_by" property="updateBy"/>
        <result column="deleted" property="deleted"/>
    </resultMap>

    <!-- 基础查询字段 -->
    <sql id="Base_Column_List">
        id, name, type, location, address, contact_person, contact_phone, email,
        student_count, cooperation_date, status, device_count, last_visit_date, notes,
        created_at as create_time, updated_at as update_time, created_by as create_by, updated_by as update_by, is_deleted as deleted
    </sql>

    <!-- 查询条件 -->
    <sql id="Query_Where_Clause">
        <where>
            is_deleted = 0
            <if test="keyword != null and keyword != ''">
                AND (name LIKE CONCAT('%', #{keyword}, '%') 
                     OR contact_person LIKE CONCAT('%', #{keyword}, '%')
                     OR location LIKE CONCAT('%', #{keyword}, '%')
                     OR address LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="type != null and type != ''">
                AND type = #{type}
            </if>
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
        </where>
    </sql>

    <!-- 根据查询条件获取合作机构列表 -->
    <select id="selectByQuery" resultMap="CharityInstitutionResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_institutions
        <include refid="Query_Where_Clause"/>
        ORDER BY created_at DESC
        <if test="offset != null and limit != null">
            LIMIT #{limit} OFFSET #{offset}
        </if>
    </select>

    <!-- 根据查询条件统计机构总数 -->
    <select id="countByQuery" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM charity_institutions
        <include refid="Query_Where_Clause"/>
    </select>

    <!-- 根据ID查询机构详情 -->
    <select id="selectById" resultMap="CharityInstitutionResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_institutions
        WHERE id = #{id} AND is_deleted = 0
    </select>

    <!-- 插入新机构 -->
    <insert id="insert" parameterType="com.yxrobot.entity.CharityInstitution" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO charity_institutions (
            name, type, location, address, contact_person, contact_phone, email,
            student_count, cooperation_date, status, device_count, last_visit_date, notes,
            created_at, updated_at, created_by, updated_by, is_deleted
        ) VALUES (
            #{name}, #{type}, #{location}, #{address}, #{contactPerson}, #{contactPhone}, #{email},
            #{studentCount}, #{cooperationDate}, #{status}, #{deviceCount}, #{lastVisitDate}, #{notes},
            #{createTime}, #{updateTime}, #{createBy}, #{updateBy}, #{deleted}
        )
    </insert>

    <!-- 根据ID更新机构信息 -->
    <update id="updateById" parameterType="com.yxrobot.entity.CharityInstitution">
        UPDATE charity_institutions
        SET name = #{name},
            type = #{type},
            location = #{location},
            address = #{address},
            contact_person = #{contactPerson},
            contact_phone = #{contactPhone},
            email = #{email},
            student_count = #{studentCount},
            cooperation_date = #{cooperationDate},
            status = #{status},
            device_count = #{deviceCount},
            last_visit_date = #{lastVisitDate},
            notes = #{notes},
            updated_at = #{updateTime},
            updated_by = #{updateBy}
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- 根据ID软删除机射-->
    <update id="deleteById">
        UPDATE charity_institutions
        SET is_deleted = 1, updated_at = NOW()
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- 批量软删除机射-->
    <update id="batchDeleteByIds">
        UPDATE charity_institutions
        SET is_deleted = 1, updated_at = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND is_deleted = 0
    </update>

    <!-- 检查机构名称是否存射-->
    <select id="existsByName" resultType="java.lang.Boolean">
        SELECT COUNT(*) &gt; 0
        FROM charity_institutions
        WHERE name = #{name} AND is_deleted = 0
    </select>

    <!-- 检查机构名称是否存在（排除指定ID射-->
    <select id="existsByNameExcludeId" resultType="java.lang.Boolean">
        SELECT COUNT(*) &gt; 0
        FROM charity_institutions
        WHERE name = #{name} AND id != #{excludeId} AND is_deleted = 0
    </select>

    <!-- 根据状态统计机构数射-->
    <select id="countByStatus" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM charity_institutions
        WHERE status = #{status} AND is_deleted = 0
    </select>

    <!-- 根据类型统计机构数量 -->
    <select id="countByType" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM charity_institutions
        WHERE type = #{type} AND is_deleted = 0
    </select>

    <!-- 获取所有机构状态统射-->
    <select id="getStatusStatistics" resultType="java.util.Map">
        SELECT 
            status,
            COUNT(*) as count,
            CASE status
                WHEN 'active' THEN '活跃'
                WHEN 'inactive' THEN '非活射
                WHEN 'suspended' THEN '暂停合作'
                ELSE status
            END as statusName
        FROM charity_institutions
        WHERE is_deleted = 0
        GROUP BY status
        ORDER BY 
            CASE status
                WHEN 'active' THEN 1
                WHEN 'inactive' THEN 2
                WHEN 'suspended' THEN 3
                ELSE 4
            END
    </select>

    <!-- 获取所有机构类型统射-->
    <select id="getTypeStatistics" resultType="java.util.Map">
        SELECT 
            type,
            COUNT(*) as count,
            CASE type
                WHEN 'school' THEN '学校'
                WHEN 'hospital' THEN '医院'
                WHEN 'community' THEN '社区'
                WHEN 'ngo' THEN '非政府组射
                WHEN 'other' THEN '其他'
                ELSE type
            END as typeName
        FROM charity_institutions
        WHERE is_deleted = 0
        GROUP BY type
        ORDER BY count DESC
    </select>

    <!-- 获取地区分布统计 -->
    <select id="getLocationStatistics" resultType="java.util.Map">
        SELECT 
            location,
            COUNT(*) as count
        FROM charity_institutions
        WHERE is_deleted = 0
        GROUP BY location
        ORDER BY count DESC
        LIMIT 10
    </select>

    <!-- 获取活跃机构列表 -->
    <select id="selectActiveInstitutions" resultMap="CharityInstitutionResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_institutions
        WHERE is_deleted = 0 AND status = 'active'
        ORDER BY cooperation_date DESC
    </select>

    <!-- 获取最近合作的机构 -->
    <select id="selectRecentCooperations" resultMap="CharityInstitutionResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_institutions
        WHERE is_deleted = 0
        ORDER BY cooperation_date DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 更新机构最后访问日射-->
    <update id="updateLastVisitDate">
        UPDATE charity_institutions
        SET last_visit_date = #{lastVisitDate},
            updated_at = NOW()
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- 批量更新机构状射-->
    <update id="batchUpdateStatus">
        UPDATE charity_institutions
        SET status = #{status},
            updated_at = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND is_deleted = 0
    </update>

    <!-- 获取机构合作时长统计 -->
    <select id="getCooperationDurationStats" resultType="java.util.Map">
        SELECT 
            id,
            name,
            cooperation_date,
            DATEDIFF(COALESCE(last_visit_date, NOW()), cooperation_date) as cooperation_days,
            CASE 
                WHEN DATEDIFF(COALESCE(last_visit_date, NOW()), cooperation_date) &gt;= 365 THEN '长期合作'
                WHEN DATEDIFF(COALESCE(last_visit_date, NOW()), cooperation_date) &gt;= 90 THEN '中期合作'
                ELSE '短期合作'
            END as cooperation_type
        FROM charity_institutions
        WHERE is_deleted = 0
        ORDER BY cooperation_days DESC
    </select>

</mapper>
