<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.CustomerDeviceMapper">

    <!-- 客户设备关联实体结果映射 -->
    <resultMap id="CustomerDeviceResultMap" type="com.yxrobot.entity.CustomerDevice">
        <id column="id" property="id"/>
        <result column="customer_id" property="customerId"/>
        <result column="device_id" property="deviceId"/>
        <result column="relation_type" property="relationType"/>
        <result column="start_date" property="startDate"/>
        <result column="end_date" property="endDate"/>
        <result column="warranty_end_date" property="warrantyEndDate"/>
        <result column="daily_rental_fee" property="dailyRentalFee"/>
        <result column="purchase_price" property="purchasePrice"/>
        <result column="relation_notes" property="relationNotes"/>
        <result column="created_time" property="createdTime"/>
        <result column="updated_time" property="updatedTime"/>
        <result column="status" property="status"/>
        <!-- 关联的设备信息 -->
        <association property="device" javaType="com.yxrobot.entity.Device">
            <id column="device_id" property="id"/>
            <result column="device_device_id" property="deviceId"/>
            <result column="device_serial_number" property="serialNumber"/>
            <result column="device_model" property="deviceModel"/>
            <result column="device_name" property="deviceName"/>
            <result column="device_status" property="deviceStatus"/>
            <result column="device_firmware_version" property="firmwareVersion"/>
            <result column="device_health_score" property="healthScore"/>
        </association>
    </resultMap>

    <!-- 客户设备关联DTO结果映射 -->
    <resultMap id="CustomerDeviceDTOResultMap" type="com.yxrobot.dto.CustomerDeviceDTO">
        <id column="id" property="id"/>
        <result column="device_serial_number" property="serialNumber"/>
        <result column="device_model" property="deviceModel"/>
        <result column="device_name" property="deviceName"/>
        <result column="relation_type" property="relationType"/>
        <result column="device_status" property="deviceStatus"/>
        <result column="device_activated_at" property="activatedAt"/>
        <result column="device_last_online_at" property="lastOnlineAt"/>
        <result column="device_firmware_version" property="firmwareVersion"/>
        <result column="device_health_score" property="healthScore"/>
        <result column="relation_notes" property="notes"/>
        <result column="start_date" property="startDate"/>
        <result column="end_date" property="endDate"/>
        <result column="warranty_end_date" property="warrantyEndDate"/>
        <result column="daily_rental_fee" property="dailyRentalFee"/>
        <result column="purchase_price" property="purchasePrice"/>
        <!-- 使用统计信息（可以通过额外查询填充） -->
        <association property="usageStats" javaType="com.yxrobot.dto.CustomerDeviceDTO$DeviceUsageStatsDTO">
            <result column="total_usage_hours" property="totalUsageHours"/>
            <result column="daily_average_usage" property="dailyAverageUsage"/>
            <result column="last_used_at" property="lastUsedAt"/>
            <result column="courses_completed" property="coursesCompleted"/>
            <result column="characters_written" property="charactersWritten"/>
        </association>
    </resultMap>

    <!-- 设备实体结果映射 -->
    <resultMap id="DeviceResultMap" type="com.yxrobot.entity.Device">
        <id column="id" property="id"/>
        <result column="device_id" property="deviceId"/>
        <result column="serial_number" property="serialNumber"/>
        <result column="device_model" property="deviceModel"/>
        <result column="device_name" property="deviceName"/>
        <result column="device_category" property="deviceCategory"/>
        <result column="device_status" property="deviceStatus"/>
        <result column="firmware_version" property="firmwareVersion"/>
        <result column="health_score" property="healthScore"/>
        <result column="region" property="region"/>
        <result column="is_active" property="isActive"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="is_deleted" property="isDeleted"/>
    </resultMap>

    <!-- 基础SQL片段 -->
    <sql id="customerDeviceColumns">
        cdr.id, cdr.customer_id, cdr.device_id, cdr.relation_type, cdr.start_date, cdr.end_date,
        cdr.warranty_end_date, cdr.daily_rental_fee, cdr.purchase_price, cdr.relation_notes,
        cdr.created_time, cdr.updated_time, cdr.status
    </sql>

    <!-- 客户设备关联DTO查询SQL片段（包含设备信息） -->
    <sql id="customerDeviceDTOColumns">
        cdr.id, cdr.relation_type, cdr.start_date, cdr.end_date, cdr.warranty_end_date,
        cdr.daily_rental_fee, cdr.purchase_price, cdr.relation_notes,
        d.device_id as device_device_id, d.serial_number as device_serial_number,
        d.device_model, d.device_name, d.device_status,
        d.activated_at as device_activated_at, d.last_online_at as device_last_online_at,
        d.firmware_version as device_firmware_version, d.health_score as device_health_score
    </sql>

    <!-- 设备信息SQL片段 -->
    <sql id="deviceColumns">
        d.id, d.device_id, d.serial_number, d.device_model, d.device_name, d.device_category,
        d.device_status, d.firmware_version, d.health_score, d.region, d.is_active,
        d.created_at, d.updated_at, d.is_deleted
    </sql>

    <!-- ==================== 基础CRUD操作 ==================== -->

    <!-- 根据ID查询客户设备关联 -->
    <select id="selectById" resultMap="CustomerDeviceResultMap">
        SELECT <include refid="customerDeviceColumns"/>,
               <include refid="deviceColumns"/>
        FROM customer_device_relation cdr
        LEFT JOIN devices d ON cdr.device_id = d.id AND d.is_deleted = 0
        WHERE cdr.id = #{id} AND cdr.status = 1
    </select>

    <!-- 根据ID查询客户设备关联DTO -->
    <select id="selectDTOById" resultMap="CustomerDeviceDTOResultMap">
        SELECT <include refid="customerDeviceDTOColumns"/>
        FROM customer_device_relation cdr
        INNER JOIN devices d ON cdr.device_id = d.id AND d.is_deleted = 0
        WHERE cdr.id = #{id} AND cdr.status = 1
    </select>

    <!-- 根据客户ID查询设备关联列表 -->
    <select id="selectByCustomerId" resultMap="CustomerDeviceResultMap">
        SELECT <include refid="customerDeviceColumns"/>,
               <include refid="deviceColumns"/>
        FROM customer_device_relation cdr
        LEFT JOIN devices d ON cdr.device_id = d.id AND d.is_deleted = 0
        WHERE cdr.customer_id = #{customerId} AND cdr.status = 1
        ORDER BY cdr.created_time DESC
    </select>

    <!-- 根据客户ID查询设备关联DTO列表 -->
    <select id="selectDTOByCustomerId" resultMap="CustomerDeviceDTOResultMap">
        SELECT <include refid="customerDeviceDTOColumns"/>
        FROM customer_device_relation cdr
        INNER JOIN devices d ON cdr.device_id = d.id AND d.is_deleted = 0
        WHERE cdr.customer_id = #{customerId} AND cdr.status = 1
        ORDER BY cdr.created_time DESC
    </select>

    <!-- 根据设备ID查询客户关联列表 -->
    <select id="selectByDeviceId" resultMap="CustomerDeviceResultMap">
        SELECT <include refid="customerDeviceColumns"/>
        FROM customer_device_relation cdr
        WHERE cdr.device_id = #{deviceId} AND cdr.status = 1
        ORDER BY cdr.created_time DESC
    </select>

    <!-- 插入客户设备关联 -->
    <insert id="insert" parameterType="com.yxrobot.entity.CustomerDevice" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO customer_device_relation (
            customer_id, device_id, relation_type, start_date, end_date, warranty_end_date,
            daily_rental_fee, purchase_price, relation_notes, created_time, updated_time, status
        ) VALUES (
            #{customerId}, #{deviceId}, #{relationType}, #{startDate}, #{endDate}, #{warrantyEndDate},
            #{dailyRentalFee}, #{purchasePrice}, #{relationNotes}, NOW(), NOW(), 1
        )
    </insert>

    <!-- 更新客户设备关联 -->
    <update id="updateById" parameterType="com.yxrobot.entity.CustomerDevice">
        UPDATE customer_device_relation SET
            relation_type = #{relationType},
            start_date = #{startDate},
            end_date = #{endDate},
            warranty_end_date = #{warrantyEndDate},
            daily_rental_fee = #{dailyRentalFee},
            purchase_price = #{purchasePrice},
            relation_notes = #{relationNotes},
            updated_time = NOW()
        WHERE id = #{id} AND status = 1
    </update>

    <!-- 根据ID删除客户设备关联 -->
    <update id="deleteById">
        UPDATE customer_device_relation SET status = 0, updated_time = NOW()
        WHERE id = #{id} AND status = 1
    </update>

    <!-- 根据客户ID和设备ID删除关联 -->
    <update id="deleteByCustomerAndDevice">
        UPDATE customer_device_relation SET status = 0, updated_time = NOW()
        WHERE customer_id = #{customerId} AND device_id = #{deviceId} AND status = 1
    </update>

    <!-- ==================== 关联查询功能 ==================== -->

    <!-- 查询客户的所有设备 -->
    <select id="selectDevicesByCustomerId" resultMap="DeviceResultMap">
        SELECT <include refid="deviceColumns"/>
        FROM devices d
        INNER JOIN customer_device_relation cdr ON d.id = cdr.device_id
        WHERE cdr.customer_id = #{customerId} AND cdr.status = 1 AND d.is_deleted = 0
        ORDER BY cdr.created_time DESC
    </select>

    <!-- 查询客户的购买设备列表 -->
    <select id="selectPurchasedDevicesByCustomerId" resultMap="CustomerDeviceDTOResultMap">
        SELECT <include refid="customerDeviceDTOColumns"/>
        FROM customer_device_relation cdr
        INNER JOIN devices d ON cdr.device_id = d.id AND d.is_deleted = 0
        WHERE cdr.customer_id = #{customerId} AND cdr.relation_type = 'purchased' AND cdr.status = 1
        ORDER BY cdr.created_time DESC
    </select>

    <!-- 查询客户的租赁设备列表 -->
    <select id="selectRentalDevicesByCustomerId" resultMap="CustomerDeviceDTOResultMap">
        SELECT <include refid="customerDeviceDTOColumns"/>
        FROM customer_device_relation cdr
        INNER JOIN devices d ON cdr.device_id = d.id AND d.is_deleted = 0
        WHERE cdr.customer_id = #{customerId} AND cdr.relation_type = 'rental' AND cdr.status = 1
        ORDER BY cdr.created_time DESC
    </select>

    <!-- 查询客户的活跃设备列表 -->
    <select id="selectActiveDevicesByCustomerId" resultMap="CustomerDeviceDTOResultMap">
        SELECT <include refid="customerDeviceDTOColumns"/>
        FROM customer_device_relation cdr
        INNER JOIN devices d ON cdr.device_id = d.id AND d.is_deleted = 0
        WHERE cdr.customer_id = #{customerId} AND cdr.status = 1 
        AND d.device_status = 'active'
        ORDER BY d.last_online_at DESC
    </select>

    <!-- ==================== 统计查询功能 ==================== -->

    <!-- 查询客户设备统计信息 -->
    <select id="selectCustomerDeviceStats" resultType="java.util.Map">
        SELECT 
            COUNT(*) as total_devices,
            COUNT(CASE WHEN cdr.relation_type = 'purchased' THEN 1 END) as purchased_devices,
            COUNT(CASE WHEN cdr.relation_type = 'rental' THEN 1 END) as rental_devices,
            COUNT(CASE WHEN d.device_status = 'active' THEN 1 END) as active_devices,
            COUNT(CASE WHEN d.device_status = 'offline' THEN 1 END) as offline_devices,
            COUNT(CASE WHEN d.device_status = 'maintenance' THEN 1 END) as maintenance_devices,
            COALESCE(SUM(cdr.purchase_price), 0) as total_purchase_value,
            COALESCE(SUM(cdr.daily_rental_fee), 0) as total_daily_rental_fee,
            COALESCE(AVG(d.health_score), 0) as avg_health_score
        FROM customer_device_relation cdr
        INNER JOIN devices d ON cdr.device_id = d.id AND d.is_deleted = 0
        WHERE cdr.customer_id = #{customerId} AND cdr.status = 1
    </select>

    <!-- 查询客户设备数量统计 -->
    <select id="selectCustomerDeviceCount" resultType="java.util.Map">
        SELECT 
            COUNT(*) as total,
            COUNT(CASE WHEN cdr.relation_type = 'purchased' THEN 1 END) as purchased,
            COUNT(CASE WHEN cdr.relation_type = 'rental' THEN 1 END) as rental
        FROM customer_device_relation cdr
        INNER JOIN devices d ON cdr.device_id = d.id AND d.is_deleted = 0
        WHERE cdr.customer_id = #{customerId} AND cdr.status = 1
    </select>

    <!-- 查询设备类型分布统计 -->
    <select id="selectDeviceTypeDistribution" resultType="java.util.Map">
        SELECT 
            d.device_category as device_type,
            COUNT(*) as count,
            ROUND(COUNT(*) * 100.0 / (
                SELECT COUNT(*) 
                FROM customer_device_relation cdr2 
                INNER JOIN devices d2 ON cdr2.device_id = d2.id AND d2.is_deleted = 0
                WHERE cdr2.customer_id = #{customerId} AND cdr2.status = 1
            ), 2) as percentage
        FROM customer_device_relation cdr
        INNER JOIN devices d ON cdr.device_id = d.id AND d.is_deleted = 0
        WHERE cdr.customer_id = #{customerId} AND cdr.status = 1
        GROUP BY d.device_category
        ORDER BY count DESC
    </select>

    <!-- ==================== 数据验证功能 ==================== -->

    <!-- 检查客户设备关联是否存在 -->
    <select id="existsByCustomerAndDevice" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM customer_device_relation
        WHERE customer_id = #{customerId} AND device_id = #{deviceId} 
        AND relation_type = #{relationType} AND status = 1
    </select>

    <!-- 检查设备是否已被其他客户关联 -->
    <select id="isDeviceOccupied" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM customer_device_relation
        WHERE device_id = #{deviceId} AND relation_type = #{relationType} AND status = 1
    </select>

    <!-- 查询客户设备关联数量 -->
    <select id="countByCustomerId" resultType="int">
        SELECT COUNT(*)
        FROM customer_device_relation
        WHERE customer_id = #{customerId} AND status = 1
    </select>

    <!-- 查询设备关联数量 -->
    <select id="countByDeviceId" resultType="int">
        SELECT COUNT(*)
        FROM customer_device_relation
        WHERE device_id = #{deviceId} AND status = 1
    </select>

    <!-- ==================== 设备管理功能 ==================== -->

    <!-- 查询即将到期的租赁设备 -->
    <select id="selectExpiringRentalDevices" resultMap="CustomerDeviceDTOResultMap">
        SELECT <include refid="customerDeviceDTOColumns"/>
        FROM customer_device_relation cdr
        INNER JOIN devices d ON cdr.device_id = d.id AND d.is_deleted = 0
        WHERE cdr.relation_type = 'rental' AND cdr.status = 1
        AND cdr.end_date IS NOT NULL 
        AND cdr.end_date BETWEEN CURDATE() AND DATE_ADD(CURDATE(), INTERVAL #{days} DAY)
        ORDER BY cdr.end_date ASC
    </select>

    <!-- 查询保修即将到期的购买设备 -->
    <select id="selectExpiringWarrantyDevices" resultMap="CustomerDeviceDTOResultMap">
        SELECT <include refid="customerDeviceDTOColumns"/>
        FROM customer_device_relation cdr
        INNER JOIN devices d ON cdr.device_id = d.id AND d.is_deleted = 0
        WHERE cdr.relation_type = 'purchased' AND cdr.status = 1
        AND cdr.warranty_end_date IS NOT NULL 
        AND cdr.warranty_end_date BETWEEN CURDATE() AND DATE_ADD(CURDATE(), INTERVAL #{days} DAY)
        ORDER BY cdr.warranty_end_date ASC
    </select>

    <!-- 更新设备关联状态 -->
    <update id="updateRelationStatus">
        UPDATE customer_device_relation SET status = #{status}, updated_time = NOW()
        WHERE id = #{id}
    </update>

    <!-- 批量更新设备关联状态 -->
    <update id="batchUpdateRelationStatus">
        UPDATE customer_device_relation SET status = #{status}, updated_time = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

</mapper>
