<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.CharityActivityMapper">

    <!-- ÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="CharityActivityResultMap" type="com.yxrobot.entity.CharityActivity">
        <id column="id" property="id"/>
        <result column="project_id" property="projectId"/>
        <result column="title" property="title"/>
        <result column="description" property="description"/>
        <result column="type" property="type"/>
        <result column="date" property="date"/>
        <result column="start_time" property="startTime"/>
        <result column="end_time" property="endTime"/>
        <result column="location" property="location"/>
        <result column="participants" property="participants"/>
        <result column="target_participants" property="targetParticipants"/>
        <result column="organizer" property="organizer"/>
        <result column="status" property="status"/>
        <result column="budget" property="budget"/>
        <result column="actual_cost" property="actualCost"/>
        <result column="manager" property="manager"/>
        <result column="manager_contact" property="managerContact"/>
        <result column="volunteer_needed" property="volunteerNeeded"/>
        <result column="actual_volunteers" property="actualVolunteers"/>
        <result column="achievements" property="achievements"/>
        <result column="photos" property="photos" />
        <result column="notes" property="notes"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="create_by" property="createBy"/>
        <result column="update_by" property="updateBy"/>
        <result column="deleted" property="deleted"/>
    </resultMap>

    <!-- Âü∫Á°ÄÊü•ËØ¢Â≠óÊÆµ -->
    <sql id="Base_Column_List">
        id, project_id, title, description, type, date, start_time, end_time, location,
        participants, target_participants, organizer, status, budget, actual_cost,
        manager, manager_contact, volunteer_needed, actual_volunteers, achievements,
        photos, notes, create_time, update_time, create_by, update_by, deleted
    </sql>

    <!-- Êü•ËØ¢Êù°‰ª∂ -->
    <sql id="Query_Where_Clause">
        <where>
            deleted = 0
            <if test="keyword != null and keyword != ''">
                AND (title LIKE CONCAT('%', #{keyword}, '%') 
                     OR organizer LIKE CONCAT('%', #{keyword}, '%')
                     OR location LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="type != null and type != ''">
                AND type = #{type}
            </if>
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
            <if test="startDate != null">
                AND date >= #{startDate}
            </if>
            <if test="endDate != null">
                AND date &lt;= #{endDate}
            </if>
        </where>
    </sql>

    <!-- Ê†πÊçÆÊü•ËØ¢Êù°‰ª∂Ëé∑ÂèñÂÖ¨ÁõäÊ¥ªÂä®ÂàóË°® -->
    <select id="selectByQuery" resultMap="CharityActivityResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_activities
        <include refid="Query_Where_Clause"/>
        ORDER BY date DESC, create_time DESC
        <if test="offset != null and limit != null">
            LIMIT #{limit} OFFSET #{offset}
        </if>
    </select>

    <!-- Ê†πÊçÆÊü•ËØ¢Êù°‰ª∂ÁªüËÆ°Ê¥ªÂä®ÊÄªÊï∞ -->
    <select id="countByQuery" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM charity_activities
        <include refid="Query_Where_Clause"/>
    </select>

    <!-- Ê†πÊçÆIDÊü•ËØ¢Ê¥ªÂä®ËØ¶ÊÉÖ -->
    <select id="selectById" resultMap="CharityActivityResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_activities
        WHERE id = #{id} AND deleted = 0
    </select>

    <!-- Ê†πÊçÆÈ°πÁõÆIDÊü•ËØ¢Ê¥ªÂä®ÂàóË°® -->
    <select id="selectByProjectId" resultMap="CharityActivityResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_activities
        WHERE project_id = #{projectId} AND deleted = 0
        ORDER BY date DESC
    </select>

    <!-- ÊèíÂÖ•Êñ∞Ê¥ªÂä?-->
    <insert id="insert" parameterType="com.yxrobot.entity.CharityActivity" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO charity_activities (
            project_id, title, description, type, date, start_time, end_time, location,
            participants, target_participants, organizer, status, budget, actual_cost,
            manager, manager_contact, volunteer_needed, actual_volunteers, achievements,
            photos, notes, create_time, update_time, create_by, update_by, deleted
        ) VALUES (
            #{projectId}, #{title}, #{description}, #{type}, #{date}, #{startTime}, #{endTime}, #{location},
            #{participants}, #{targetParticipants}, #{organizer}, #{status}, #{budget}, #{actualCost},
            #{manager}, #{managerContact}, #{volunteerNeeded}, #{actualVolunteers}, #{achievements},
            #{photos,typeHandler=com.yxrobot.config.StringArrayTypeHandler}, #{notes}, #{createTime}, #{updateTime}, #{createBy}, #{updateBy}, #{deleted}
        )
    </insert>

    <!-- Ê†πÊçÆIDÊõ¥Êñ∞Ê¥ªÂä®‰ø°ÊÅØ -->
    <update id="updateById" parameterType="com.yxrobot.entity.CharityActivity">
        UPDATE charity_activities
        SET project_id = #{projectId},
            title = #{title},
            description = #{description},
            type = #{type},
            date = #{date},
            start_time = #{startTime},
            end_time = #{endTime},
            location = #{location},
            participants = #{participants},
            target_participants = #{targetParticipants},
            organizer = #{organizer},
            status = #{status},
            budget = #{budget},
            actual_cost = #{actualCost},
            manager = #{manager},
            manager_contact = #{managerContact},
            volunteer_needed = #{volunteerNeeded},
            actual_volunteers = #{actualVolunteers},
            achievements = #{achievements},
            photos = #{photos,typeHandler=com.yxrobot.config.StringArrayTypeHandler},
            notes = #{notes},
            update_time = #{updateTime},
            update_by = #{updateBy}
        WHERE id = #{id} AND deleted = 0
    </update>

    <!-- Ê†πÊçÆIDËΩØÂà†Èô§Ê¥ªÂä?-->
    <update id="deleteById">
        UPDATE charity_activities
        SET deleted = 1, update_time = NOW()
        WHERE id = #{id} AND deleted = 0
    </update>

    <!-- ÊâπÈáèËΩØÂà†Èô§Ê¥ªÂä?-->
    <update id="batchDeleteByIds">
        UPDATE charity_activities
        SET deleted = 1, update_time = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND deleted = 0
    </update>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.CharityInstitutionMapper">

    <!-- ÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="CharityInstitutionResultMap" type="com.yxrobot.entity.CharityInstitution">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="type" property="type"/>
        <result column="location" property="location"/>
        <result column="address" property="address"/>
        <result column="contact_person" property="contactPerson"/>
        <result column="contact_phone" property="contactPhone"/>
        <result column="email" property="email"/>
        <result column="student_count" property="studentCount"/>
        <result column="cooperation_date" property="cooperationDate"/>
        <result column="status" property="status"/>
        <result column="device_count" property="deviceCount"/>
        <result column="last_visit_date" property="lastVisitDate"/>
        <result column="notes" property="notes"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="create_by" property="createBy"/>
        <result column="update_by" property="updateBy"/>
        <result column="deleted" property="deleted"/>
    </resultMap>

    <!-- Âü∫Á°ÄÊü•ËØ¢Â≠óÊÆµ -->
    <sql id="Base_Column_List">
        id, name, type, location, address, contact_person, contact_phone, email,
        student_count, cooperation_date, status, device_count, last_visit_date, notes,
        created_at as create_time, updated_at as update_time, created_by as create_by, updated_by as update_by, is_deleted as deleted
    </sql>

    <!-- Êü•ËØ¢Êù°‰ª∂ -->
    <sql id="Query_Where_Clause">
        <where>
            is_deleted = 0
            <if test="keyword != null and keyword != ''">
                AND (name LIKE CONCAT('%', #{keyword}, '%') 
                     OR contact_person LIKE CONCAT('%', #{keyword}, '%')
                     OR location LIKE CONCAT('%', #{keyword}, '%')
                     OR address LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="type != null and type != ''">
                AND type = #{type}
            </if>
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
        </where>
    </sql>

    <!-- Ê†πÊçÆÊü•ËØ¢Êù°‰ª∂Ëé∑ÂèñÂêà‰ΩúÊú∫ÊûÑÂàóË°® -->
    <select id="selectByQuery" resultMap="CharityInstitutionResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_institutions
        <include refid="Query_Where_Clause"/>
        ORDER BY created_at DESC
        <if test="offset != null and limit != null">
            LIMIT #{limit} OFFSET #{offset}
        </if>
    </select>

    <!-- Ê†πÊçÆÊü•ËØ¢Êù°‰ª∂ÁªüËÆ°Êú∫ÊûÑÊÄªÊï∞ -->
    <select id="countByQuery" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM charity_institutions
        <include refid="Query_Where_Clause"/>
    </select>

    <!-- Ê†πÊçÆIDÊü•ËØ¢Êú∫ÊûÑËØ¶ÊÉÖ -->
    <select id="selectById" resultMap="CharityInstitutionResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_institutions
        WHERE id = #{id} AND is_deleted = 0
    </select>

    <!-- ÊèíÂÖ•Êñ∞Êú∫Êû?-->
    <insert id="insert" parameterType="com.yxrobot.entity.CharityInstitution" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO charity_institutions (
            name, type, location, address, contact_person, contact_phone, email,
            student_count, cooperation_date, status, device_count, last_visit_date, notes,
            created_at, updated_at, created_by, updated_by, is_deleted
        ) VALUES (
            #{name}, #{type}, #{location}, #{address}, #{contactPerson}, #{contactPhone}, #{email},
            #{studentCount}, #{cooperationDate}, #{status}, #{deviceCount}, #{lastVisitDate}, #{notes},
            #{createTime}, #{updateTime}, #{createBy}, #{updateBy}, #{deleted}
        )
    </insert>

    <!-- Ê†πÊçÆIDÊõ¥Êñ∞Êú∫ÊûÑ‰ø°ÊÅØ -->
    <update id="updateById" parameterType="com.yxrobot.entity.CharityInstitution">
        UPDATE charity_institutions
        SET name = #{name},
            type = #{type},
            location = #{location},
            address = #{address},
            contact_person = #{contactPerson},
            contact_phone = #{contactPhone},
            email = #{email},
            student_count = #{studentCount},
            cooperation_date = #{cooperationDate},
            status = #{status},
            device_count = #{deviceCount},
            last_visit_date = #{lastVisitDate},
            notes = #{notes},
            updated_at = #{updateTime},
            updated_by = #{updateBy}
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- Ê†πÊçÆIDËΩØÂà†Èô§Êú∫Êû?-->
    <update id="deleteById">
        UPDATE charity_institutions
        SET is_deleted = 1, updated_at = NOW()
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- ÊâπÈáèËΩØÂà†Èô§Êú∫Êû?-->
    <update id="batchDeleteByIds">
        UPDATE charity_institutions
        SET is_deleted = 1, updated_at = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND is_deleted = 0
    </update>

    <!-- Ê£ÄÊü•Êú∫ÊûÑÂêçÁß∞ÊòØÂê¶Â≠òÂú?-->
    <select id="existsByName" resultType="java.lang.Boolean">
        SELECT COUNT(*) > 0
        FROM charity_institutions
        WHERE name = #{name} AND is_deleted = 0
    </select>

    <!-- Ê£ÄÊü•Êú∫ÊûÑÂêçÁß∞ÊòØÂê¶Â≠òÂú®ÔºàÊéíÈô§ÊåáÂÆöIDÔº?-->
    <select id="existsByNameExcludeId" resultType="java.lang.Boolean">
        SELECT COUNT(*) > 0
        FROM charity_institutions
        WHERE name = #{name} AND id != #{excludeId} AND is_deleted = 0
    </select>

    <!-- Ê†πÊçÆÁä∂ÊÄÅÁªüËÆ°Êú∫ÊûÑÊï∞Èá?-->
    <select id="countByStatus" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM charity_institutions
        WHERE status = #{status} AND is_deleted = 0
    </select>

    <!-- Ê†πÊçÆÁ±ªÂûãÁªüËÆ°Êú∫ÊûÑÊï∞Èáè -->
    <select id="countByType" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM charity_institutions
        WHERE type = #{type} AND is_deleted = 0
    </select>

    <!-- Ëé∑ÂèñÊâÄÊúâÊú∫ÊûÑÁä∂ÊÄÅÁªüËÆ?-->
    <select id="getStatusStatistics" resultType="java.util.Map">
        SELECT 
            status,
            COUNT(*) as count,
            CASE status
                WHEN 'active' THEN 'Ê¥ªË∑É'
                WHEN 'inactive' THEN 'ÈùûÊ¥ªË∑?
                WHEN 'suspended' THEN 'ÊöÇÂÅúÂêà‰Ωú'
                ELSE status
            END as statusName
        FROM charity_institutions
        WHERE is_deleted = 0
        GROUP BY status
        ORDER BY 
            CASE status
                WHEN 'active' THEN 1
                WHEN 'inactive' THEN 2
                WHEN 'suspended' THEN 3
                ELSE 4
            END
    </select>

    <!-- Ëé∑ÂèñÊâÄÊúâÊú∫ÊûÑÁ±ªÂûãÁªüËÆ?-->
    <select id="getTypeStatistics" resultType="java.util.Map">
        SELECT 
            type,
            COUNT(*) as count,
            CASE type
                WHEN 'school' THEN 'Â≠¶Ê†°'
                WHEN 'hospital' THEN 'ÂåªÈô¢'
                WHEN 'community' THEN 'Á§æÂå∫'
                WHEN 'ngo' THEN 'ÈùûÊîøÂ∫úÁªÑÁª?
                WHEN 'other' THEN 'ÂÖ∂‰ªñ'
                ELSE type
            END as typeName
        FROM charity_institutions
        WHERE is_deleted = 0
        GROUP BY type
        ORDER BY count DESC
    </select>

    <!-- Ëé∑ÂèñÂú∞Âå∫ÂàÜÂ∏ÉÁªüËÆ° -->
    <select id="getLocationStatistics" resultType="java.util.Map">
        SELECT 
            location,
            COUNT(*) as count
        FROM charity_institutions
        WHERE is_deleted = 0
        GROUP BY location
        ORDER BY count DESC
        LIMIT 10
    </select>

    <!-- Ëé∑ÂèñÊ¥ªË∑ÉÊú∫ÊûÑÂàóË°® -->
    <select id="selectActiveInstitutions" resultMap="CharityInstitutionResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_institutions
        WHERE is_deleted = 0 AND status = 'active'
        ORDER BY cooperation_date DESC
    </select>

    <!-- Ëé∑ÂèñÊúÄËøëÂêà‰ΩúÁöÑÊú∫ÊûÑ -->
    <select id="selectRecentCooperations" resultMap="CharityInstitutionResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_institutions
        WHERE is_deleted = 0
        ORDER BY cooperation_date DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- Êõ¥Êñ∞Êú∫ÊûÑÊúÄÂêéËÆøÈóÆÊó•Êú?-->
    <update id="updateLastVisitDate">
        UPDATE charity_institutions
        SET last_visit_date = #{lastVisitDate},
            updated_at = NOW()
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- ÊâπÈáèÊõ¥Êñ∞Êú∫ÊûÑÁä∂ÊÄ?-->
    <update id="batchUpdateStatus">
        UPDATE charity_institutions
        SET status = #{status},
            updated_at = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND is_deleted = 0
    </update>

    <!-- Ëé∑ÂèñÊú∫ÊûÑÂêà‰ΩúÊó∂ÈïøÁªüËÆ° -->
    <select id="getCooperationDurationStats" resultType="java.util.Map">
        SELECT 
            id,
            name,
            cooperation_date,
            DATEDIFF(COALESCE(last_visit_date, NOW()), cooperation_date) as cooperation_days,
            CASE 
                WHEN DATEDIFF(COALESCE(last_visit_date, NOW()), cooperation_date) >= 365 THEN 'ÈïøÊúüÂêà‰Ωú'
                WHEN DATEDIFF(COALESCE(last_visit_date, NOW()), cooperation_date) >= 90 THEN '‰∏≠ÊúüÂêà‰Ωú'
                ELSE 'Áü≠ÊúüÂêà‰Ωú'
            END as cooperation_type
        FROM charity_institutions
        WHERE is_deleted = 0
        ORDER BY cooperation_days DESC
    </select>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.CharityProjectMapper">

    <!-- ÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="CharityProjectResultMap" type="com.yxrobot.entity.CharityProject">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="description" property="description"/>
        <result column="type" property="type"/>
        <result column="status" property="status"/>
        <result column="start_date" property="startDate"/>
        <result column="end_date" property="endDate"/>
        <result column="target_beneficiaries" property="targetBeneficiaries"/>
        <result column="actual_beneficiaries" property="actualBeneficiaries"/>
        <result column="budget" property="budget"/>
        <result column="actual_cost" property="actualCost"/>
        <result column="manager" property="manager"/>
        <result column="manager_contact" property="managerContact"/>
        <result column="institution_id" property="institutionId"/>
        <result column="region" property="region"/>
        <result column="priority" property="priority"/>
        <result column="progress" property="progress"/>
        <result column="tags" property="tags"/>
        <result column="notes" property="notes"/>
        <result column="created_at" property="createTime"/>
        <result column="updated_at" property="updateTime"/>
        <result column="created_by" property="createBy"/>
        <result column="updated_by" property="updateBy"/>
        <result column="is_deleted" property="deleted"/>
    </resultMap>

    <!-- Âü∫Á°ÄÊü•ËØ¢Â≠óÊÆµ -->
    <sql id="Base_Column_List">
        id, name, description, type, status, start_date, end_date, target_beneficiaries,
        actual_beneficiaries, budget, actual_cost, manager, manager_contact, institution_id,
        region, priority, progress, tags, notes, created_at, updated_at, created_by, updated_by, is_deleted
    </sql>

    <!-- Êü•ËØ¢Êù°‰ª∂ -->
    <sql id="Query_Where_Clause">
        <where>
            is_deleted = 0
            <if test="keyword != null and keyword != ''">
                AND (name LIKE CONCAT('%', #{keyword}, '%') 
                     OR contact_person LIKE CONCAT('%', #{keyword}, '%')
                     OR location LIKE CONCAT('%', #{keyword}, '%')
                     OR description LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="type != null and type != ''">
                AND type = #{type}
            </if>
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
            <if test="region != null and region != ''">
                AND location = #{region}
            </if>
        </where>
    </sql>

    <!-- Ê†πÊçÆÊü•ËØ¢Êù°‰ª∂Ëé∑ÂèñÂÖ¨ÁõäÈ°πÁõÆÂàóË°® -->
    <select id="selectByQuery" resultMap="CharityProjectResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_projects
        <include refid="Query_Where_Clause"/>
        ORDER BY created_at DESC
        <if test="offset != null and limit != null">
            LIMIT #{limit} OFFSET #{offset}
        </if>
    </select>

    <!-- Ê†πÊçÆÊü•ËØ¢Êù°‰ª∂ÁªüËÆ°È°πÁõÆÊÄªÊï∞ -->
    <select id="countByQuery" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM charity_projects
        <include refid="Query_Where_Clause"/>
    </select>

    <!-- Ê†πÊçÆIDÊü•ËØ¢È°πÁõÆËØ¶ÊÉÖ -->
    <select id="selectById" resultMap="CharityProjectResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_projects
        WHERE id = #{id} AND is_deleted = 0
    </select>

    <!-- Ê†πÊçÆÊú∫ÊûÑIDÊü•ËØ¢È°πÁõÆÂàóË°® -->
    <select id="selectByInstitutionId" resultMap="CharityProjectResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_projects
        WHERE organizer = #{institutionId} AND is_deleted = 0
        ORDER BY created_at DESC
    </select>

    <!-- ÊèíÂÖ•Êñ∞È°πÁõ?-->
    <insert id="insert" parameterType="com.yxrobot.entity.CharityProject" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO charity_projects (
            name, description, type, status, start_date, end_date, target_beneficiaries,
            actual_beneficiaries, budget, actual_cost, manager, manager_contact, institution_id,
            region, priority, progress, tags, notes, created_at, updated_at, created_by, updated_by, is_deleted
        ) VALUES (
            #{name}, #{description}, #{type}, #{status}, #{startDate}, #{endDate}, #{targetBeneficiaries},
            #{actualBeneficiaries}, #{budget}, #{actualCost}, #{manager}, #{managerContact}, #{institutionId},
            #{region}, #{priority}, #{progress}, #{tags}, #{notes}, #{createTime}, #{updateTime}, #{createBy}, #{updateBy}, #{deleted}
        )
    </insert>

    <!-- Ê†πÊçÆIDÊõ¥Êñ∞È°πÁõÆ‰ø°ÊÅØ -->
    <update id="updateById" parameterType="com.yxrobot.entity.CharityProject">
        UPDATE charity_projects
        SET name = #{name},
            description = #{description},
            type = #{type},
            status = #{status},
            start_date = #{startDate},
            end_date = #{endDate},
            target_beneficiaries = #{targetBeneficiaries},
            actual_beneficiaries = #{actualBeneficiaries},
            budget = #{budget},
            actual_cost = #{actualCost},
            manager = #{manager},
            manager_contact = #{managerContact},
            institution_id = #{institutionId},
            region = #{region},
            priority = #{priority},
            progress = #{progress},
            tags = #{tags},
            notes = #{notes},
            updated_at = #{updateTime},
            updated_by = #{updateBy}
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- Ê†πÊçÆIDËΩØÂà†Èô§È°πÁõ?-->
    <update id="deleteById">
        UPDATE charity_projects
        SET is_deleted = 1, updated_at = NOW()
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- ÊâπÈáèËΩØÂà†Èô§È°πÁõ?-->
    <update id="batchDeleteByIds">
        UPDATE charity_projects
        SET is_deleted = 1, updated_at = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND is_deleted = 0
    </update>

    <!-- Ê£ÄÊü•È°πÁõÆÂêçÁß∞ÊòØÂê¶Â≠òÂú?-->
    <select id="existsByName" resultType="java.lang.Boolean">
        SELECT COUNT(*) > 0
        FROM charity_projects
        WHERE name = #{name} AND is_deleted = 0
    </select>

    <!-- Ê£ÄÊü•È°πÁõÆÂêçÁß∞ÊòØÂê¶Â≠òÂú®ÔºàÊéíÈô§ÊåáÂÆöIDÔº?-->
    <select id="existsByNameExcludeId" resultType="java.lang.Boolean">
        SELECT COUNT(*) > 0
        FROM charity_projects
        WHERE name = #{name} AND id != #{excludeId} AND is_deleted = 0
    </select>

    <!-- Ê†πÊçÆÁä∂ÊÄÅÁªüËÆ°È°πÁõÆÊï∞Èá?-->
    <select id="countByStatus" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM charity_projects
        WHERE status = #{status} AND is_deleted = 0
    </select>

    <!-- Ê†πÊçÆÁ±ªÂûãÁªüËÆ°È°πÁõÆÊï∞Èáè -->
    <select id="countByType" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM charity_projects
        WHERE type = #{type} AND is_deleted = 0
    </select>

    <!-- Ê†πÊçÆÂú∞Âå∫ÁªüËÆ°È°πÁõÆÊï∞Èáè -->
    <select id="countByRegion" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM charity_projects
        WHERE location = #{region} AND is_deleted = 0
    </select>

    <!-- Ëé∑ÂèñÊâÄÊúâÈ°πÁõÆÁä∂ÊÄÅÁªüËÆ?-->
    <select id="getStatusStatistics" resultType="java.util.Map">
        SELECT 
            status,
            COUNT(*) as count,
            CASE status
                WHEN 'planning' THEN 'ËßÑÂàí‰∏?
                WHEN 'active' THEN 'ËøõË°å‰∏?
                WHEN 'completed' THEN 'Â∑≤ÂÆåÊà?
                WHEN 'suspended' THEN 'ÊöÇÂÅú'
                WHEN 'cancelled' THEN 'Â∑≤ÂèñÊ∂?
                ELSE status
            END as statusName
        FROM charity_projects
        WHERE is_deleted = 0
        GROUP BY status
        ORDER BY 
            CASE status
                WHEN 'active' THEN 1
                WHEN 'planning' THEN 2
                WHEN 'completed' THEN 3
                WHEN 'suspended' THEN 4
                WHEN 'cancelled' THEN 5
                ELSE 6
            END
    </select>

    <!-- Ëé∑ÂèñÊâÄÊúâÈ°πÁõÆÁ±ªÂûãÁªüËÆ?-->
    <select id="getTypeStatistics" resultType="java.util.Map">
        SELECT 
            type,
            COUNT(*) as count,
            CASE type
                WHEN 'education' THEN 'ÊïôËÇ≤'
                WHEN 'medical' THEN 'ÂåªÁñó'
                WHEN 'environment' THEN 'ÁéØ‰øù'
                WHEN 'poverty' THEN 'Êâ∂Ë¥´'
                WHEN 'disaster' THEN 'ÊïëÁÅæ'
                WHEN 'other' THEN 'ÂÖ∂‰ªñ'
                ELSE type
            END as typeName
        FROM charity_projects
        WHERE is_deleted = 0
        GROUP BY type
        ORDER BY count DESC
    </select>

    <!-- Ëé∑ÂèñÂú∞Âå∫ÂàÜÂ∏ÉÁªüËÆ° -->
    <select id="getRegionStatistics" resultType="java.util.Map">
        SELECT 
            region,
            COUNT(*) as count
        FROM charity_projects
        WHERE is_deleted = 0
        GROUP BY location
        ORDER BY count DESC
        LIMIT 10
    </select>

    <!-- Ëé∑Âèñ‰ºòÂÖàÁ∫ßÂàÜÂ∏ÉÁªüËÆ?-->
    <select id="getPriorityStatistics" resultType="java.util.Map">
        SELECT 
            'normal' as priority,
            COUNT(*) as count,
            'ÊôÆÈÄöÈ°πÁõ? as priorityName
        FROM charity_projects
        WHERE is_deleted = 0
    </select>

    <!-- Ëé∑ÂèñÈ°πÁõÆËøõÂ∫¶ÁªüËÆ° -->
    <select id="getProgressStatistics" resultType="java.util.Map">
        SELECT 
            CASE status
                WHEN 'completed' THEN 'Â∑≤ÂÆåÊà?
                WHEN 'active' THEN 'ËøõË°å‰∏?
                WHEN 'planning' THEN 'ËßÑÂàí‰∏?
                ELSE 'ÂÖ∂‰ªñ'
            END as progress_range,
            COUNT(*) as count
        FROM charity_projects
        WHERE is_deleted = 0
        GROUP BY status
        ORDER BY 
            CASE status
                WHEN 'completed' THEN 1
                WHEN 'active' THEN 2
                WHEN 'planning' THEN 3
                ELSE 4
            END
    </select>

    <!-- Ëé∑ÂèñÊ¥ªË∑ÉÈ°πÁõÆÂàóË°® -->
    <select id="selectActiveProjects" resultMap="CharityProjectResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_projects
        WHERE is_deleted = 0 AND status = 'active'
        ORDER BY created_at DESC
    </select>

    <!-- Ëé∑ÂèñÂç≥Â∞ÜÁªìÊùüÁöÑÈ°πÁõ?-->
    <select id="selectProjectsEndingSoon" resultMap="CharityProjectResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_projects
        WHERE is_deleted = 0 
        AND status IN ('planning', 'active')
        AND end_date IS NOT NULL
        AND end_date BETWEEN NOW() AND DATE_ADD(NOW(), INTERVAL #{days} DAY)
        ORDER BY end_date ASC
    </select>

    <!-- Ëé∑ÂèñÊúÄËøëÂàõÂª∫ÁöÑÈ°πÁõÆ -->
    <select id="selectRecentProjects" resultMap="CharityProjectResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_projects
        WHERE is_deleted = 0
        ORDER BY created_at DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- Êõ¥Êñ∞È°πÁõÆÁä∂ÊÄ?-->
    <update id="updateStatus">
        UPDATE charity_projects
        SET status = #{status},
            updated_at = NOW()
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- Êõ¥Êñ∞È°πÁõÆËøõÂ∫¶ -->
    <update id="updateProgress">
        UPDATE charity_projects
        SET status = 'active',
            updated_at = NOW()
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- ÊâπÈáèÊõ¥Êñ∞È°πÁõÆÁä∂ÊÄ?-->
    <update id="batchUpdateStatus">
        UPDATE charity_projects
        SET status = #{status},
            updated_at = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND is_deleted = 0
    </update>

    <!-- Ëé∑ÂèñÈ°πÁõÆÈ¢ÑÁÆóÊâßË°åÁªüËÆ° -->
    <select id="getBudgetExecutionStats" resultType="java.util.Map">
        SELECT 
            type,
            COUNT(*) as project_count,
            SUM(target_amount) as total_budget,
            SUM(raised_amount) as total_cost,
            CASE 
                WHEN SUM(target_amount) > 0 
                THEN ROUND(SUM(raised_amount) * 100.0 / SUM(target_amount), 2)
                ELSE 0 
            END as execution_rate
        FROM charity_projects
        WHERE is_deleted = 0 
        AND status IN ('active', 'completed')
        AND target_amount > 0
        GROUP BY type
        ORDER BY execution_rate DESC
    </select>

    <!-- Ëé∑ÂèñÈ°πÁõÆÂèóÁõä‰∫∫ÁªüËÆ?-->
    <select id="getBeneficiaryStatistics" resultType="java.util.Map">
        SELECT 
            CASE 
                WHEN beneficiaries >= 10000 THEN '10000‰∫∫‰ª•‰∏?
                WHEN beneficiaries >= 5000 THEN '5000-9999‰∫?
                WHEN beneficiaries >= 1000 THEN '1000-4999‰∫?
                WHEN beneficiaries >= 500 THEN '500-999‰∫?
                WHEN beneficiaries >= 100 THEN '100-499‰∫?
                ELSE '100‰∫∫‰ª•‰∏?
            END as beneficiary_range,
            COUNT(*) as count
        FROM charity_projects
        WHERE is_deleted = 0 AND beneficiaries > 0
        GROUP BY 
            CASE 
                WHEN beneficiaries >= 10000 THEN '10000‰∫∫‰ª•‰∏?
                WHEN beneficiaries >= 5000 THEN '5000-9999‰∫?
                WHEN beneficiaries >= 1000 THEN '1000-4999‰∫?
                WHEN beneficiaries >= 500 THEN '500-999‰∫?
                WHEN beneficiaries >= 100 THEN '100-499‰∫?
                ELSE '100‰∫∫‰ª•‰∏?
            END
        ORDER BY 
            CASE 
                WHEN beneficiary_range = '10000‰∫∫‰ª•‰∏? THEN 1
                WHEN beneficiary_range = '5000-9999‰∫? THEN 2
                WHEN beneficiary_range = '1000-4999‰∫? THEN 3
                WHEN beneficiary_range = '500-999‰∫? THEN 4
                WHEN beneficiary_range = '100-499‰∫? THEN 5
                ELSE 6
            END
    </select>

    <!-- Ëé∑ÂèñÈ°πÁõÆÊó∂ÈïøÁªüËÆ° -->
    <select id="getProjectDurationStats" resultType="java.util.Map">
        SELECT 
            id,
            name,
            start_date,
            end_date,
            CASE 
                WHEN end_date IS NOT NULL 
                THEN DATEDIFF(end_date, start_date)
                ELSE DATEDIFF(NOW(), start_date)
            END as duration_days,
            CASE 
                WHEN end_date IS NOT NULL AND DATEDIFF(end_date, start_date) >= 365 THEN 'ÈïøÊúüÈ°πÁõÆ'
                WHEN end_date IS NOT NULL AND DATEDIFF(end_date, start_date) >= 90 THEN '‰∏≠ÊúüÈ°πÁõÆ'
                WHEN end_date IS NOT NULL THEN 'Áü≠ÊúüÈ°πÁõÆ'
                WHEN DATEDIFF(NOW(), start_date) >= 365 THEN 'ÈïøÊúüÈ°πÁõÆ'
                WHEN DATEDIFF(NOW(), start_date) >= 90 THEN '‰∏≠ÊúüÈ°πÁõÆ'
                ELSE 'Áü≠ÊúüÈ°πÁõÆ'
            END as duration_type
        FROM charity_projects
        WHERE is_deleted = 0
        ORDER BY duration_days DESC
    </select>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.CharityStatsLogMapper">

    <!-- ÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="CharityStatsLogResultMap" type="com.yxrobot.entity.CharityStatsLog">
        <id column="id" property="id"/>
        <result column="stats_id" property="statsId"/>
        <result column="operation_type" property="operationType"/>
        <result column="field_changes" property="updatedFields"/>
        <result column="before_data" property="beforeData"/>
        <result column="after_data" property="afterData"/>
        <result column="update_reason" property="updateReason"/>
        <result column="operator_id" property="operatorId"/>
        <result column="operator_name" property="operatorName"/>
        <result column="ip_address" property="operatorIp"/>
        <result column="operation_time" property="operationTime"/>
        <result column="data_version" property="dataVersion"/>
        <result column="operation_result" property="operationResult"/>
        <result column="error_message" property="errorMessage"/>
        <result column="notes" property="notes"/>
        <result column="created_at" property="createTime"/>
    </resultMap>

    <!-- Âü∫Á°ÄÊü•ËØ¢Â≠óÊÆµ -->
    <sql id="Base_Column_List">
        id, stats_id, operation_type, field_changes, before_data, after_data, update_reason,
        operator_id, operator_name, ip_address, operation_time, data_version, operation_result,
        error_message, notes, created_at
    </sql>

    <!-- ÊèíÂÖ•Êñ∞ÁöÑÊó•ÂøóËÆ∞ÂΩï -->
    <insert id="insert" parameterType="com.yxrobot.entity.CharityStatsLog" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO charity_stats_logs (
            stats_id, operation_type, field_changes, update_reason,
            operator_id, operator_name, ip_address, created_at
        ) VALUES (
            #{statsId}, #{operationType}, #{updatedFields}, #{updateReason},
            #{operatorId}, #{operatorName}, #{operatorIp}, #{createTime}
        )
    </insert>

    <!-- Ê†πÊçÆIDÊü•ËØ¢Êó•ÂøóËØ¶ÊÉÖ -->
    <select id="selectById" resultMap="CharityStatsLogResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_stats_logs
        WHERE id = #{id}
    </select>

    <!-- Ê†πÊçÆÁªüËÆ°Êï∞ÊçÆIDÊü•ËØ¢Êó•ÂøóÂàóË°® -->
    <select id="selectByStatsId" resultMap="CharityStatsLogResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_stats_logs
        WHERE stats_id = #{statsId}
        ORDER BY operation_time DESC
        <if test="offset != null and limit != null">
            LIMIT #{limit} OFFSET #{offset}
        </if>
    </select>

    <!-- Ê†πÊçÆÁªüËÆ°Êï∞ÊçÆIDÁªüËÆ°Êó•ÂøóÊÄªÊï∞ -->
    <select id="countByStatsId" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM charity_stats_logs
        WHERE stats_id = #{statsId}
    </select>

    <!-- Ê†πÊçÆÊìç‰Ωú‰∫∫Êü•ËØ¢Êó•ÂøóÂàóË°?-->
    <select id="selectByOperator" resultMap="CharityStatsLogResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_stats_logs
        WHERE operator_id = #{operatorId}
        ORDER BY operation_time DESC
        <if test="offset != null and limit != null">
            LIMIT #{limit} OFFSET #{offset}
        </if>
    </select>

    <!-- Ê†πÊçÆÊìç‰Ωú‰∫∫ÁªüËÆ°Êó•ÂøóÊÄªÊï∞ -->
    <select id="countByOperator" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM charity_stats_logs
        WHERE operator_id = #{operatorId}
    </select>

    <!-- Ê†πÊçÆÊó∂Èó¥ËåÉÂõ¥Êü•ËØ¢Êó•ÂøóÂàóË°® -->
    <select id="selectByTimeRange" resultMap="CharityStatsLogResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_stats_logs
        WHERE operation_time BETWEEN #{startTime} AND #{endTime}
        ORDER BY operation_time DESC
        <if test="offset != null and limit != null">
            LIMIT #{limit} OFFSET #{offset}
        </if>
    </select>

    <!-- Ê†πÊçÆÊó∂Èó¥ËåÉÂõ¥ÁªüËÆ°Êó•ÂøóÊÄªÊï∞ -->
    <select id="countByTimeRange" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM charity_stats_logs
        WHERE operation_time BETWEEN #{startTime} AND #{endTime}
    </select>

    <!-- Ê†πÊçÆÊìç‰ΩúÁ±ªÂûãÊü•ËØ¢Êó•ÂøóÂàóË°® -->
    <select id="selectByOperationType" resultMap="CharityStatsLogResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_stats_logs
        WHERE operation_type = #{operationType}
        ORDER BY operation_time DESC
        <if test="offset != null and limit != null">
            LIMIT #{limit} OFFSET #{offset}
        </if>
    </select>

    <!-- Ê†πÊçÆÊìç‰ΩúÁ±ªÂûãÁªüËÆ°Êó•ÂøóÊÄªÊï∞ -->
    <select id="countByOperationType" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM charity_stats_logs
        WHERE operation_type = #{operationType}
    </select>

    <!-- Ê†πÊçÆÊìç‰ΩúÁªìÊûúÊü•ËØ¢Êó•ÂøóÂàóË°® -->
    <select id="selectByOperationResult" resultMap="CharityStatsLogResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_stats_logs
        WHERE operation_result = #{operationResult}
        ORDER BY operation_time DESC
        <if test="offset != null and limit != null">
            LIMIT #{limit} OFFSET #{offset}
        </if>
    </select>

    <!-- Ê†πÊçÆÊìç‰ΩúÁªìÊûúÁªüËÆ°Êó•ÂøóÊÄªÊï∞ -->
    <select id="countByOperationResult" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM charity_stats_logs
        WHERE operation_result = #{operationResult}
    </select>

    <!-- Ëé∑ÂèñÊúÄÊñ∞ÁöÑÊó•ÂøóËÆ∞ÂΩï -->
    <select id="selectLatestLogs" resultMap="CharityStatsLogResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_stats_logs
        ORDER BY operation_time DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- Ëé∑ÂèñÊìç‰ΩúÁ±ªÂûãÁªüËÆ° -->
    <select id="getOperationTypeStatistics" resultType="java.util.Map">
        SELECT 
            operation_type,
            COUNT(*) as count,
            CASE operation_type
                WHEN 'create' THEN 'ÂàõÂª∫'
                WHEN 'update' THEN 'Êõ¥Êñ∞'
                WHEN 'delete' THEN 'Âà†Èô§'
                ELSE operation_type
            END as operationTypeName
        FROM charity_stats_logs
        GROUP BY operation_type
        ORDER BY count DESC
    </select>

    <!-- Ëé∑ÂèñÊìç‰ΩúÁªìÊûúÁªüËÆ° -->
    <select id="getOperationResultStatistics" resultType="java.util.Map">
        SELECT 
            operation_result,
            COUNT(*) as count,
            CASE operation_result
                WHEN 'success' THEN 'ÊàêÂäü'
                WHEN 'failed' THEN 'Â§±Ë¥•'
                ELSE operation_result
            END as operationResultName
        FROM charity_stats_logs
        GROUP BY operation_result
        ORDER BY 
            CASE operation_result
                WHEN 'success' THEN 1
                WHEN 'failed' THEN 2
                ELSE 3
            END
    </select>

    <!-- Ëé∑ÂèñÊìç‰Ωú‰∫∫ÁªüËÆ?-->
    <select id="getOperatorStatistics" resultType="java.util.Map">
        SELECT 
            operator_id,
            operator_name,
            COUNT(*) as operation_count,
            COUNT(CASE WHEN operation_result = 'success' THEN 1 END) as success_count,
            COUNT(CASE WHEN operation_result = 'failed' THEN 1 END) as failed_count
        FROM charity_stats_logs
        GROUP BY operator_id, operator_name
        ORDER BY operation_count DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- Ëé∑ÂèñÊØèÊó•Êìç‰ΩúÁªüËÆ° -->
    <select id="getDailyOperationStatistics" resultType="java.util.Map">
        SELECT 
            DATE(operation_time) as operation_date,
            COUNT(*) as total_operations,
            COUNT(CASE WHEN operation_result = 'success' THEN 1 END) as success_operations,
            COUNT(CASE WHEN operation_result = 'failed' THEN 1 END) as failed_operations,
            COUNT(CASE WHEN operation_type = 'create' THEN 1 END) as create_operations,
            COUNT(CASE WHEN operation_type = 'update' THEN 1 END) as update_operations,
            COUNT(CASE WHEN operation_type = 'delete' THEN 1 END) as delete_operations
        FROM charity_stats_logs
        WHERE operation_time >= DATE_SUB(NOW(), INTERVAL #{days} DAY)
        GROUP BY DATE(operation_time)
        ORDER BY operation_date DESC
    </select>

    <!-- Ëé∑ÂèñÂ§±Ë¥•Êìç‰ΩúÊó•Âøó -->
    <select id="selectFailedOperations" resultMap="CharityStatsLogResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_stats_logs
        WHERE operation_result = 'failed'
        ORDER BY operation_time DESC
        <if test="offset != null and limit != null">
            LIMIT #{limit} OFFSET #{offset}
        </if>
    </select>

    <!-- ÁªüËÆ°Â§±Ë¥•Êìç‰ΩúÊÄªÊï∞ -->
    <select id="countFailedOperations" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM charity_stats_logs
        WHERE operation_result = 'failed'
    </select>

    <!-- Ê†πÊçÆIPÂú∞ÂùÄÊü•ËØ¢Êó•ÂøóÂàóË°® -->
    <select id="selectByOperatorIp" resultMap="CharityStatsLogResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_stats_logs
        WHERE operator_ip = #{operatorIp}
        ORDER BY operation_time DESC
        <if test="offset != null and limit != null">
            LIMIT #{limit} OFFSET #{offset}
        </if>
    </select>

    <!-- Ê†πÊçÆIPÂú∞ÂùÄÁªüËÆ°Êó•ÂøóÊÄªÊï∞ -->
    <select id="countByOperatorIp" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM charity_stats_logs
        WHERE operator_ip = #{operatorIp}
    </select>

    <!-- Ê∏ÖÁêÜËøáÊúüÊó•Âøó -->
    <delete id="cleanExpiredLogs">
        DELETE FROM charity_stats_logs
        WHERE operation_time &lt; DATE_SUB(NOW(), INTERVAL #{days} DAY)
    </delete>

    <!-- Ëé∑ÂèñÊï∞ÊçÆÁâàÊú¨ÂèòÊõ¥ÂéÜÂè≤ -->
    <select id="selectVersionHistory" resultMap="CharityStatsLogResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_stats_logs
        WHERE stats_id = #{statsId}
        AND operation_type IN ('create', 'update')
        ORDER BY data_version ASC, operation_time ASC
    </select>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.CharityStatsMapper">

    <!-- ÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="CharityStatsResultMap" type="com.yxrobot.entity.CharityStats">
        <id column="id" property="id"/>
        <result column="total_beneficiaries" property="totalBeneficiaries"/>
        <result column="total_institutions" property="totalInstitutions"/>
        <result column="cooperating_institutions" property="cooperatingInstitutions"/>
        <result column="total_volunteers" property="totalVolunteers"/>
        <result column="active_volunteers" property="activeVolunteers"/>
        <result column="total_raised" property="totalRaised"/>
        <result column="total_donated" property="totalDonated"/>
        <result column="total_projects" property="totalProjects"/>
        <result column="active_projects" property="activeProjects"/>
        <result column="completed_projects" property="completedProjects"/>
        <result column="total_activities" property="totalActivities"/>
        <result column="this_month_activities" property="thisMonthActivities"/>
        <result column="created_at" property="createTime"/>
        <result column="updated_at" property="updateTime"/>
        <result column="deleted" property="deleted"/>
        <result column="version" property="version"/>
    </resultMap>

    <!-- Âü∫Á°ÄÊü•ËØ¢Â≠óÊÆµ -->
    <sql id="Base_Column_List">
        id, total_beneficiaries, total_institutions, cooperating_institutions, total_volunteers,
        active_volunteers, total_raised, total_donated, total_projects, active_projects, completed_projects,
        total_activities, this_month_activities, created_at, updated_at, 
        deleted, version
    </sql>

    <!-- Ëé∑ÂèñÊúÄÊñ∞ÁöÑÂÖ¨ÁõäÁªüËÆ°Êï∞ÊçÆ -->
    <select id="selectLatest" resultMap="CharityStatsResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_stats
        WHERE (deleted = 0 OR deleted IS NULL)
        ORDER BY created_at DESC
        LIMIT 1
    </select>

    <!-- Ê†πÊçÆIDÊü•ËØ¢ÁªüËÆ°Êï∞ÊçÆ -->
    <select id="selectById" resultMap="CharityStatsResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_stats
        WHERE id = #{id} AND (deleted = 0 OR deleted IS NULL)
    </select>

    <!-- ÊèíÂÖ•Êñ∞ÁöÑÁªüËÆ°Êï∞ÊçÆËÆ∞ÂΩï -->
    <insert id="insert" parameterType="com.yxrobot.entity.CharityStats" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO charity_stats (
            total_beneficiaries, total_institutions, cooperating_institutions, total_volunteers,
            total_raised, total_donated, total_projects, active_projects, completed_projects,
            total_activities, this_month_activities, created_at, updated_at, deleted, version
        ) VALUES (
            #{totalBeneficiaries}, #{totalInstitutions}, #{cooperatingInstitutions}, #{totalVolunteers},
            #{totalRaised}, #{totalDonated}, #{totalProjects}, #{activeProjects}, #{completedProjects},
            #{totalActivities}, #{thisMonthActivities}, NOW(), NOW(), 0, #{version}
        )
    </insert>

    <!-- Ê†πÊçÆIDÊõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆ -->
    <update id="updateById" parameterType="com.yxrobot.entity.CharityStats">
        UPDATE charity_stats
        SET total_beneficiaries = #{totalBeneficiaries},
            total_institutions = #{totalInstitutions},
            cooperating_institutions = #{cooperatingInstitutions},
            total_volunteers = #{totalVolunteers},
            total_raised = #{totalRaised},
            total_donated = #{totalDonated},
            total_projects = #{totalProjects},
            active_projects = #{activeProjects},
            completed_projects = #{completedProjects},
            total_activities = #{totalActivities},
            this_month_activities = #{thisMonthActivities},
            updated_at = NOW(),
            version = #{version}
        WHERE id = #{id}
    </update>

    <!-- Ê†πÊçÆÁâàÊú¨Âè∑Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆÔºà‰πêËßÇÈîÅÔºâ -->
    <update id="updateByVersion" parameterType="com.yxrobot.entity.CharityStats">
        UPDATE charity_stats
        SET total_beneficiaries = #{totalBeneficiaries},
            total_institutions = #{totalInstitutions},
            cooperating_institutions = #{cooperatingInstitutions},
            total_volunteers = #{totalVolunteers},
            total_raised = #{totalRaised},
            total_donated = #{totalDonated},
            total_projects = #{totalProjects},
            active_projects = #{activeProjects},
            completed_projects = #{completedProjects},
            total_activities = #{totalActivities},
            this_month_activities = #{thisMonthActivities},
            updated_at = NOW(),
            version = version + 1
        WHERE id = #{id} AND version = #{version}
    </update>

    <!-- Ëé∑ÂèñÁªüËÆ°Êï∞ÊçÆÂéÜÂè≤ËÆ∞ÂΩï -->
    <select id="selectHistory" resultMap="CharityStatsResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_stats
        WHERE (deleted = 0 OR deleted IS NULL)
        ORDER BY created_at DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- Ê£ÄÊü•ÁªüËÆ°Êï∞ÊçÆÊòØÂê¶Â≠òÂú?-->
    <select id="existsStats" resultType="java.lang.Boolean">
        SELECT COUNT(*) > 0
        FROM charity_stats
        WHERE (deleted = 0 OR deleted IS NULL)
    </select>

    <!-- ËÆ°ÁÆóÁªüËÆ°Êï∞ÊçÆÊ±áÊÄ?-->
    <select id="calculateStatsFromSource" resultMap="CharityStatsResultMap">
        SELECT 
            -- ÂèóÁõä‰∫∫Êï∞ÁªüËÆ°
            COALESCE(SUM(cp.beneficiaries), 0) as total_beneficiaries,
            -- Êú∫ÊûÑÁªüËÆ°
            (SELECT COUNT(*) FROM charity_institutions WHERE is_deleted = 0) as total_institutions,
            (SELECT COUNT(*) FROM charity_institutions WHERE is_deleted = 0 AND status = 'active') as cooperating_institutions,
            -- ÂøóÊÑøËÄÖÁªüËÆ?
            COALESCE(SUM(ca.participants), 0) as total_volunteers,
            -- ËµÑÈáëÁªüËÆ°
            COALESCE(SUM(cp.target_amount), 0) as total_raised,
            COALESCE(SUM(cp.raised_amount), 0) as total_donated,
            -- È°πÁõÆÁªüËÆ°
            (SELECT COUNT(*) FROM charity_projects WHERE is_deleted = 0) as total_projects,
            (SELECT COUNT(*) FROM charity_projects WHERE is_deleted = 0 AND status = 'active') as active_projects,
            (SELECT COUNT(*) FROM charity_projects WHERE is_deleted = 0 AND status = 'completed') as completed_projects,
            -- Ê¥ªÂä®ÁªüËÆ°
            (SELECT COUNT(*) FROM charity_activities WHERE deleted = 0) as total_activities,
            (SELECT COUNT(*) FROM charity_activities WHERE deleted = 0 AND YEAR(date) = YEAR(NOW()) AND MONTH(date) = MONTH(NOW())) as this_month_activities,
            NOW() as create_time,
            NOW() as update_time,
            0 as deleted,
            1 as version
        FROM charity_projects cp
        LEFT JOIN charity_activities ca ON cp.id = ca.project_id AND ca.deleted = 0
        WHERE cp.is_deleted = 0
    </select>

    <!-- ËΩØÂà†Èô§Áõ∏ÂÖ≥Êü•ËØ¢ÊñπÊ≥?-->
    
    <!-- Ëé∑ÂèñÊú™Âà†Èô§ÁöÑÊúÄÊñ∞ÁªüËÆ°Êï∞Êç?-->
    <select id="selectLatestNotDeleted" resultMap="CharityStatsResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_stats
        WHERE (deleted = 0 OR deleted IS NULL)
        ORDER BY created_at DESC
        LIMIT 1
    </select>

    <!-- Ëé∑ÂèñÊâÄÊúâÊú™Âà†Èô§ÁöÑÁªüËÆ°Êï∞Êç?-->
    <select id="selectAllNotDeleted" resultMap="CharityStatsResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_stats
        WHERE (deleted = 0 OR deleted IS NULL)
        ORDER BY created_at DESC
    </select>

    <!-- ËΩØÂà†Èô§ÁªüËÆ°Êï∞Êç?-->
    <update id="softDeleteById">
        UPDATE charity_stats
        SET deleted = 1,
            updated_at = NOW()
        WHERE id = #{id} AND (deleted = 0 OR deleted IS NULL)
    </update>

    <!-- ÊÅ¢Â§çËΩØÂà†Èô§ÁöÑÁªüËÆ°Êï∞ÊçÆ -->
    <update id="restoreById">
        UPDATE charity_stats
        SET deleted = 0,
            updated_at = NOW()
        WHERE id = #{id} AND deleted = 1
    </update>

    <!-- Ê†πÊçÆIDÊü•ËØ¢Êú™Âà†Èô§ÁöÑÁªüËÆ°Êï∞ÊçÆ -->
    <select id="selectByIdNotDeleted" resultMap="CharityStatsResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM charity_stats
        WHERE id = #{id} AND (deleted = 0 OR deleted IS NULL)
    </select>

    <!-- ÁªüËÆ°Êú™Âà†Èô§ËÆ∞ÂΩïÊï∞Èá?-->
    <select id="countNotDeleted" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM charity_stats
        WHERE (deleted = 0 OR deleted IS NULL)
    </select>

    <!-- ÂõæË°®Êï∞ÊçÆÊü•ËØ¢ÊñπÊ≥ï -->
    
    <!-- Ëé∑ÂèñÈ°πÁõÆÁä∂ÊÄÅÂàÜÂ∏ÉÊï∞Êç?-->
    <select id="selectProjectStatusDistribution" resultType="java.util.Map">
        SELECT 
            CASE 
                WHEN status = 'active' THEN 'ËøõË°å‰∏?
                WHEN status = 'completed' THEN 'Â∑≤ÂÆåÊà?
                WHEN status = 'planning' THEN 'ËßÑÂàí‰∏?
                WHEN status = 'suspended' THEN 'ÊöÇÂÅú'
                ELSE 'ÂÖ∂‰ªñ'
            END as statusName,
            COUNT(*) as count
        FROM charity_projects 
        WHERE is_deleted = 0
        GROUP BY status
        ORDER BY count DESC
    </select>

    <!-- Ëé∑ÂèñËµÑÈáëÁ≠πÈõÜË∂ãÂäøÊï∞ÊçÆ -->
    <select id="selectFundingTrend" resultType="java.util.Map">
        SELECT 
            DATE_FORMAT(created_at, '%Y-%m') as month,
            SUM(target_amount) as raised_amount,
            SUM(raised_amount) as donated_amount
        FROM charity_projects 
        WHERE is_deleted = 0 
            AND created_at >= DATE_SUB(NOW(), INTERVAL #{months} MONTH)
        GROUP BY DATE_FORMAT(created_at, '%Y-%m')
        ORDER BY month ASC
    </select>

    <!-- Ëé∑ÂèñÂú∞Âå∫ÂàÜÂ∏ÉÊï∞ÊçÆ -->
    <select id="selectRegionDistribution" resultType="java.util.Map">
        SELECT 
            CASE 
                WHEN location LIKE '%Âåó‰∫¨%' OR location LIKE '%Â§©Ê¥•%' OR location LIKE '%Ê≤≥Âåó%' OR location LIKE '%Â±±Ë•ø%' OR location LIKE '%ÂÜÖËíôÂè?' THEN 'ÂçéÂåó'
                WHEN location LIKE '%‰∏äÊµ∑%' OR location LIKE '%Ê±üËãè%' OR location LIKE '%ÊµôÊ±ü%' OR location LIKE '%ÂÆâÂæΩ%' OR location LIKE '%Á¶èÂª∫%' OR location LIKE '%Ê±üË•ø%' OR location LIKE '%Â±±‰∏ú%' THEN 'Âçé‰∏ú'
                WHEN location LIKE '%Âπø‰∏ú%' OR location LIKE '%ÂπøË•ø%' OR location LIKE '%Êµ∑Âçó%' THEN 'ÂçéÂçó'
                WHEN location LIKE '%Ê≤≥Âçó%' OR location LIKE '%ÊπñÂåó%' OR location LIKE '%ÊπñÂçó%' THEN 'Âçé‰∏≠'
                WHEN location LIKE '%ÈáçÂ∫Ü%' OR location LIKE '%ÂõõÂ∑ù%' OR location LIKE '%Ë¥µÂ∑û%' OR location LIKE '%‰∫ëÂçó%' OR location LIKE '%Ë•øËóè%' THEN 'Ë•øÂçó'
                WHEN location LIKE '%ÈôïË•ø%' OR location LIKE '%ÁîòËÇÉ%' OR location LIKE '%ÈùíÊµ∑%' OR location LIKE '%ÂÆÅÂ§è%' OR location LIKE '%Êñ∞ÁñÜ%' THEN 'Ë•øÂåó'
                WHEN location LIKE '%ËæΩÂÆÅ%' OR location LIKE '%ÂêâÊûó%' OR location LIKE '%ÈªëÈæôÊ±?' THEN '‰∏úÂåó'
                ELSE 'ÂÖ∂‰ªñ'
            END as regionName,
            COUNT(*) as count
        FROM charity_activities 
        WHERE deleted = 0 AND location IS NOT NULL
        GROUP BY regionName
        ORDER BY count DESC
    </select>

    <!-- Ëé∑ÂèñÂøóÊÑøËÄÖÊ¥ªÂä®ÁªüËÆ°Êï∞Êç?-->
    <select id="selectVolunteerActivityStats" resultType="java.util.Map">
        SELECT 
            DATE_FORMAT(date, '%Y-%m') as month,
            COUNT(*) as activity_count,
            SUM(participants) as volunteer_count
        FROM charity_activities 
        WHERE deleted = 0 
            AND date >= DATE_SUB(NOW(), INTERVAL #{months} MONTH)
        GROUP BY DATE_FORMAT(date, '%Y-%m')
        ORDER BY month ASC
    </select>

    <!-- Ëé∑ÂèñÊú∫ÊûÑÁ±ªÂûãÂàÜÂ∏ÉÊï∞ÊçÆ -->
    <select id="selectInstitutionTypeDistribution" resultType="java.util.Map">
        SELECT 
            CASE 
                WHEN type = 'foundation' THEN 'Âü∫Èáë‰º?
                WHEN type = 'ngo' THEN 'ÈùûËê•Âà©ÁªÑÁª?
                WHEN type = 'government' THEN 'ÊîøÂ∫úÊú∫ÊûÑ'
                WHEN type = 'enterprise' THEN '‰ºÅ‰∏ö'
                WHEN type = 'school' THEN 'Â≠¶Ê†°'
                ELSE 'ÂÖ∂‰ªñ'
            END as typeName,
            COUNT(*) as count
        FROM charity_institutions 
        WHERE is_deleted = 0
        GROUP BY type
        ORDER BY count DESC
    </select>

    <!-- Ëé∑ÂèñÊ¥ªÂä®Á±ªÂûãÂàÜÂ∏ÉÊï∞ÊçÆ -->
    <select id="selectActivityTypeDistribution" resultType="java.util.Map">
        SELECT 
            CASE 
                WHEN type = 'education' THEN 'ÊïôËÇ≤ÊîØÊåÅ'
                WHEN type = 'health' THEN 'ÂÅ•Â∫∑ÂåªÁñó'
                WHEN type = 'environment' THEN 'ÁéØÂ¢É‰øùÊä§'
                WHEN type = 'poverty' THEN 'Êâ∂Ë¥´ÊµéÂõ∞'
                WHEN type = 'disaster' THEN 'ÁÅæÂÆ≥ÊïëÂä©'
                WHEN type = 'elderly' THEN 'ÂÖªËÄÅÂä©ËÄ?
                WHEN type = 'children' THEN 'ÂÑøÁ´•ÂÖ≥Áà±'
                ELSE 'ÂÖ∂‰ªñ'
            END as typeName,
            COUNT(*) as count
        FROM charity_activities 
        WHERE deleted = 0
        GROUP BY type
        ORDER BY count DESC
    </select>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.CustomerAddressMapper">

    <!-- ÂÆ¢Êà∑Âú∞ÂùÄÂÆû‰ΩìÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="CustomerAddressResultMap" type="com.yxrobot.entity.CustomerAddress">
        <id column="id" property="id"/>
        <result column="customer_id" property="customerId"/>
        <result column="country" property="country"/>
        <result column="province" property="province"/>
        <result column="city" property="city"/>
        <result column="district" property="district"/>
        <result column="detail_address" property="detailAddress"/>
        <result column="zip_code" property="zipCode"/>
        <result column="is_default" property="isDefault"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="is_deleted" property="isDeleted"/>
    </resultMap>

    <!-- ÂÆ¢Êà∑Âú∞ÂùÄDTOÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="CustomerAddressDTOResultMap" type="com.yxrobot.dto.CustomerAddressDTO">
        <id column="id" property="id"/>
        <result column="customer_id" property="customerId"/>
        <result column="country" property="country"/>
        <result column="province" property="province"/>
        <result column="city" property="city"/>
        <result column="district" property="district"/>
        <result column="detail_address" property="detailAddress"/>
        <result column="zip_code" property="zipCode"/>
        <result column="is_default" property="isDefault"/>
    </resultMap>

    <!-- Âü∫Á°ÄSQLÁâáÊÆµ -->
    <sql id="customerAddressColumns">
        ca.id, ca.customer_id, ca.country, ca.province, ca.city, ca.district,
        ca.detail_address, ca.zip_code, ca.is_default, ca.created_at, ca.updated_at, ca.is_deleted
    </sql>

    <!-- ÂÆ¢Êà∑Âú∞ÂùÄDTOÊü•ËØ¢SQLÁâáÊÆµ -->
    <sql id="customerAddressDTOColumns">
        ca.id, ca.customer_id, ca.country, ca.province, ca.city, ca.district,
        ca.detail_address, ca.zip_code, ca.is_default
    </sql>

    <!-- ==================== Âü∫Á°ÄCRUDÊìç‰Ωú ==================== -->

    <!-- Ê†πÊçÆIDÊü•ËØ¢ÂÆ¢Êà∑Âú∞ÂùÄ -->
    <select id="selectById" resultMap="CustomerAddressResultMap">
        SELECT <include refid="customerAddressColumns"/>
        FROM customer_addresses ca
        WHERE ca.id = #{id} AND ca.is_deleted = 0
    </select>

    <!-- Ê†πÊçÆIDÊü•ËØ¢ÂÆ¢Êà∑Âú∞ÂùÄDTO -->
    <select id="selectDTOById" resultMap="CustomerAddressDTOResultMap">
        SELECT <include refid="customerAddressDTOColumns"/>
        FROM customer_addresses ca
        WHERE ca.id = #{id} AND ca.is_deleted = 0
    </select>

    <!-- Ê†πÊçÆÂÆ¢Êà∑IDÊü•ËØ¢Âú∞ÂùÄÂàóË°® -->
    <select id="selectByCustomerId" resultMap="CustomerAddressResultMap">
        SELECT <include refid="customerAddressColumns"/>
        FROM customer_addresses ca
        WHERE ca.customer_id = #{customerId} AND ca.is_deleted = 0
        ORDER BY ca.is_default DESC, ca.created_at DESC
    </select>

    <!-- Ê†πÊçÆÂÆ¢Êà∑IDÊü•ËØ¢Âú∞ÂùÄDTOÂàóË°® -->
    <select id="selectDTOByCustomerId" resultMap="CustomerAddressDTOResultMap">
        SELECT <include refid="customerAddressDTOColumns"/>
        FROM customer_addresses ca
        WHERE ca.customer_id = #{customerId} AND ca.is_deleted = 0
        ORDER BY ca.is_default DESC, ca.created_at DESC
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÁöÑÈªòËÆ§Âú∞ÂùÄ -->
    <select id="selectDefaultByCustomerId" resultMap="CustomerAddressResultMap">
        SELECT <include refid="customerAddressColumns"/>
        FROM customer_addresses ca
        WHERE ca.customer_id = #{customerId} AND ca.is_default = 1 AND ca.is_deleted = 0
        LIMIT 1
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÁöÑÈªòËÆ§Âú∞ÂùÄDTO -->
    <select id="selectDefaultDTOByCustomerId" resultMap="CustomerAddressDTOResultMap">
        SELECT <include refid="customerAddressDTOColumns"/>
        FROM customer_addresses ca
        WHERE ca.customer_id = #{customerId} AND ca.is_default = 1 AND ca.is_deleted = 0
        LIMIT 1
    </select>

    <!-- ÊèíÂÖ•ÂÆ¢Êà∑Âú∞ÂùÄ -->
    <insert id="insert" parameterType="com.yxrobot.entity.CustomerAddress" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO customer_addresses (
            customer_id, country, province, city, district, detail_address, zip_code, is_default,
            created_at, updated_at, is_deleted
        ) VALUES (
            #{customerId}, #{country}, #{province}, #{city}, #{district}, #{detailAddress}, #{zipCode}, #{isDefault},
            NOW(), NOW(), 0
        )
    </insert>

    <!-- Êõ¥Êñ∞ÂÆ¢Êà∑Âú∞ÂùÄ -->
    <update id="updateById" parameterType="com.yxrobot.entity.CustomerAddress">
        UPDATE customer_addresses SET
            country = #{country},
            province = #{province},
            city = #{city},
            district = #{district},
            detail_address = #{detailAddress},
            zip_code = #{zipCode},
            is_default = #{isDefault},
            updated_at = NOW()
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- Ê†πÊçÆIDËΩØÂà†Èô§ÂÆ¢Êà∑Âú∞ÂùÄ -->
    <update id="softDeleteById">
        UPDATE customer_addresses SET is_deleted = 1, updated_at = NOW()
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- Ê†πÊçÆÂÆ¢Êà∑IDËΩØÂà†Èô§ÊâÄÊúâÂú∞ÂùÄ -->
    <update id="softDeleteByCustomerId">
        UPDATE customer_addresses SET is_deleted = 1, updated_at = NOW()
        WHERE customer_id = #{customerId} AND is_deleted = 0
    </update>

    <!-- ==================== Âú∞ÂùÄÁÆ°ÁêÜÂäüËÉΩ ==================== -->

    <!-- ËÆæÁΩÆÈªòËÆ§Âú∞ÂùÄ -->
    <update id="setDefaultAddress">
        <!-- ÂÖàÊ∏ÖÈô§ËØ•ÂÆ¢Êà∑ÁöÑÊâÄÊúâÈªòËÆ§Âú∞ÂùÄÊ†áËÆ∞ -->
        UPDATE customer_addresses SET is_default = 0, updated_at = NOW()
        WHERE customer_id = #{customerId} AND is_deleted = 0;
        
        <!-- ÂÜçËÆæÁΩÆÊñ∞ÁöÑÈªòËÆ§Âú∞ÂùÄ -->
        UPDATE customer_addresses SET is_default = 1, updated_at = NOW()
        WHERE id = #{addressId} AND customer_id = #{customerId} AND is_deleted = 0;
    </update>

    <!-- Ê∏ÖÈô§ÂÆ¢Êà∑ÁöÑÊâÄÊúâÈªòËÆ§Âú∞ÂùÄÊ†áËÆ∞ -->
    <update id="clearDefaultAddress">
        UPDATE customer_addresses SET is_default = 0, updated_at = NOW()
        WHERE customer_id = #{customerId} AND is_deleted = 0
    </update>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑Âú∞ÂùÄÊï∞Èáè -->
    <select id="countByCustomerId" resultType="int">
        SELECT COUNT(*)
        FROM customer_addresses
        WHERE customer_id = #{customerId} AND is_deleted = 0
    </select>

    <!-- ==================== Âú∞Âå∫ÁªüËÆ°ÂäüËÉΩ ==================== -->

    <!-- Êü•ËØ¢ÁúÅ‰ªΩÂàÜÂ∏ÉÁªüËÆ° -->
    <select id="selectProvinceDistribution" resultType="java.util.Map">
        SELECT 
            province,
            COUNT(DISTINCT customer_id) as customer_count,
            COUNT(*) as address_count
        FROM customer_addresses 
        WHERE is_deleted = 0
        GROUP BY province
        ORDER BY customer_count DESC
    </select>

    <!-- Êü•ËØ¢ÂüéÂ∏ÇÂàÜÂ∏ÉÁªüËÆ° -->
    <select id="selectCityDistribution" resultType="java.util.Map">
        SELECT 
            city,
            COUNT(DISTINCT customer_id) as customer_count,
            COUNT(*) as address_count
        FROM customer_addresses 
        WHERE is_deleted = 0
        <if test="province != null and province != ''">
            AND province = #{province}
        </if>
        GROUP BY city
        ORDER BY customer_count DESC
    </select>

    <!-- Êü•ËØ¢Âú∞Âå∫ÂÆ¢Êà∑Êï∞ÈáèÁªüËÆ° -->
    <select id="selectRegionCustomerCount" resultType="java.util.Map">
        SELECT 
            CONCAT(province, '-', city) as region,
            province,
            city,
            COUNT(DISTINCT customer_id) as customer_count
        FROM customer_addresses 
        WHERE is_deleted = 0
        GROUP BY province, city
        ORDER BY customer_count DESC
    </select>

    <!-- ==================== Êï∞ÊçÆÈ™åËØÅÂäüËÉΩ ==================== -->

    <!-- Ê£ÄÊü•ÂÆ¢Êà∑ÊòØÂê¶Â∑≤ÊúâÈªòËÆ§Âú∞ÂùÄ -->
    <select id="hasDefaultAddress" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM customer_addresses
        WHERE customer_id = #{customerId} AND is_default = 1 AND is_deleted = 0
    </select>

    <!-- Ê£ÄÊü•Âú∞ÂùÄÊòØÂê¶Â±û‰∫éÊåáÂÆöÂÆ¢Êà∑ -->
    <select id="belongsToCustomer" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM customer_addresses
        WHERE id = #{addressId} AND customer_id = #{customerId} AND is_deleted = 0
    </select>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.CustomerDeviceMapper">

    <!-- ÂÆ¢Êà∑ËÆæÂ§áÂÖ≥ËÅîÂÆû‰ΩìÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="CustomerDeviceResultMap" type="com.yxrobot.entity.CustomerDevice">
        <id column="id" property="id"/>
        <result column="customer_id" property="customerId"/>
        <result column="device_id" property="deviceId"/>
        <result column="relation_type" property="relationType"/>
        <result column="start_date" property="startDate"/>
        <result column="end_date" property="endDate"/>
        <result column="warranty_end_date" property="warrantyEndDate"/>
        <result column="daily_rental_fee" property="dailyRentalFee"/>
        <result column="purchase_price" property="purchasePrice"/>
        <result column="relation_notes" property="relationNotes"/>
        <result column="created_time" property="createdTime"/>
        <result column="updated_time" property="updatedTime"/>
        <result column="status" property="status"/>
        <!-- ÂÖ≥ËÅîÁöÑËÆæÂ§á‰ø°ÊÅ?-->
        <association property="device" javaType="com.yxrobot.entity.Device">
            <id column="device_id" property="id"/>
            <result column="device_device_id" property="deviceId"/>
            <result column="device_serial_number" property="serialNumber"/>
            <result column="device_model" property="deviceModel"/>
            <result column="device_name" property="deviceName"/>
            <result column="device_status" property="deviceStatus"/>
            <result column="device_firmware_version" property="firmwareVersion"/>
            <result column="device_health_score" property="healthScore"/>
        </association>
    </resultMap>

    <!-- ÂÆ¢Êà∑ËÆæÂ§áÂÖ≥ËÅîDTOÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="CustomerDeviceDTOResultMap" type="com.yxrobot.dto.CustomerDeviceDTO">
        <id column="id" property="id"/>
        <result column="device_serial_number" property="serialNumber"/>
        <result column="device_model" property="deviceModel"/>
        <result column="device_name" property="deviceName"/>
        <result column="relation_type" property="relationType"/>
        <result column="device_status" property="deviceStatus"/>
        <result column="device_activated_at" property="activatedAt"/>
        <result column="device_last_online_at" property="lastOnlineAt"/>
        <result column="device_firmware_version" property="firmwareVersion"/>
        <result column="device_health_score" property="healthScore"/>
        <result column="relation_notes" property="notes"/>
        <result column="start_date" property="startDate"/>
        <result column="end_date" property="endDate"/>
        <result column="warranty_end_date" property="warrantyEndDate"/>
        <result column="daily_rental_fee" property="dailyRentalFee"/>
        <result column="purchase_price" property="purchasePrice"/>
        <!-- ‰ΩøÁî®ÁªüËÆ°‰ø°ÊÅØÔºàÂèØ‰ª•ÈÄöËøáÈ¢ùÂ§ñÊü•ËØ¢Â°´ÂÖÖÔº?-->
        <association property="usageStats" javaType="com.yxrobot.dto.CustomerDeviceDTO$DeviceUsageStatsDTO">
            <result column="total_usage_hours" property="totalUsageHours"/>
            <result column="daily_average_usage" property="dailyAverageUsage"/>
            <result column="last_used_at" property="lastUsedAt"/>
            <result column="courses_completed" property="coursesCompleted"/>
            <result column="characters_written" property="charactersWritten"/>
        </association>
    </resultMap>

    <!-- ËÆæÂ§áÂÆû‰ΩìÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="DeviceResultMap" type="com.yxrobot.entity.Device">
        <id column="id" property="id"/>
        <result column="device_id" property="deviceId"/>
        <result column="serial_number" property="serialNumber"/>
        <result column="device_model" property="deviceModel"/>
        <result column="device_name" property="deviceName"/>
        <result column="device_category" property="deviceCategory"/>
        <result column="device_status" property="deviceStatus"/>
        <result column="firmware_version" property="firmwareVersion"/>
        <result column="health_score" property="healthScore"/>
        <result column="region" property="region"/>
        <result column="is_active" property="isActive"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="is_deleted" property="isDeleted"/>
    </resultMap>

    <!-- Âü∫Á°ÄSQLÁâáÊÆµ -->
    <sql id="customerDeviceColumns">
        cdr.id, cdr.customer_id, cdr.device_id, cdr.relation_type, cdr.start_date, cdr.end_date,
        cdr.warranty_end_date, cdr.daily_rental_fee, cdr.purchase_price, cdr.relation_notes,
        cdr.created_time, cdr.updated_time, cdr.status
    </sql>

    <!-- ÂÆ¢Êà∑ËÆæÂ§áÂÖ≥ËÅîDTOÊü•ËØ¢SQLÁâáÊÆµÔºàÂåÖÂê´ËÆæÂ§á‰ø°ÊÅØÔºâ -->
    <sql id="customerDeviceDTOColumns">
        cdr.id, cdr.relation_type, cdr.start_date, cdr.end_date, cdr.warranty_end_date,
        cdr.daily_rental_fee, cdr.purchase_price, cdr.relation_notes,
        d.device_id as device_device_id, d.serial_number as device_serial_number,
        d.device_model, d.device_name, d.device_status,
        d.activated_at as device_activated_at, d.last_online_at as device_last_online_at,
        d.firmware_version as device_firmware_version, d.health_score as device_health_score
    </sql>

    <!-- ËÆæÂ§á‰ø°ÊÅØSQLÁâáÊÆµ -->
    <sql id="deviceColumns">
        d.id, d.device_id, d.serial_number, d.device_model, d.device_name, d.device_category,
        d.device_status, d.firmware_version, d.health_score, d.region, d.is_active,
        d.created_at, d.updated_at, d.is_deleted
    </sql>

    <!-- ==================== Âü∫Á°ÄCRUDÊìç‰Ωú ==================== -->

    <!-- Ê†πÊçÆIDÊü•ËØ¢ÂÆ¢Êà∑ËÆæÂ§áÂÖ≥ËÅî -->
    <select id="selectById" resultMap="CustomerDeviceResultMap">
        SELECT <include refid="customerDeviceColumns"/>,
               <include refid="deviceColumns"/>
        FROM customer_device_relation cdr
        LEFT JOIN devices d ON cdr.device_id = d.id AND d.is_deleted = 0
        WHERE cdr.id = #{id} AND cdr.status = 1
    </select>

    <!-- Ê†πÊçÆIDÊü•ËØ¢ÂÆ¢Êà∑ËÆæÂ§áÂÖ≥ËÅîDTO -->
    <select id="selectDTOById" resultMap="CustomerDeviceDTOResultMap">
        SELECT <include refid="customerDeviceDTOColumns"/>
        FROM customer_device_relation cdr
        INNER JOIN devices d ON cdr.device_id = d.id AND d.is_deleted = 0
        WHERE cdr.id = #{id} AND cdr.status = 1
    </select>

    <!-- Ê†πÊçÆÂÆ¢Êà∑IDÊü•ËØ¢ËÆæÂ§áÂÖ≥ËÅîÂàóË°® -->
    <select id="selectByCustomerId" resultMap="CustomerDeviceResultMap">
        SELECT <include refid="customerDeviceColumns"/>,
               <include refid="deviceColumns"/>
        FROM customer_device_relation cdr
        LEFT JOIN devices d ON cdr.device_id = d.id AND d.is_deleted = 0
        WHERE cdr.customer_id = #{customerId} AND cdr.status = 1
        ORDER BY cdr.created_time DESC
    </select>

    <!-- Ê†πÊçÆÂÆ¢Êà∑IDÊü•ËØ¢ËÆæÂ§áÂÖ≥ËÅîDTOÂàóË°® -->
    <select id="selectDTOByCustomerId" resultMap="CustomerDeviceDTOResultMap">
        SELECT <include refid="customerDeviceDTOColumns"/>
        FROM customer_device_relation cdr
        INNER JOIN devices d ON cdr.device_id = d.id AND d.is_deleted = 0
        WHERE cdr.customer_id = #{customerId} AND cdr.status = 1
        ORDER BY cdr.created_time DESC
    </select>

    <!-- Ê†πÊçÆËÆæÂ§áIDÊü•ËØ¢ÂÆ¢Êà∑ÂÖ≥ËÅîÂàóË°® -->
    <select id="selectByDeviceId" resultMap="CustomerDeviceResultMap">
        SELECT <include refid="customerDeviceColumns"/>
        FROM customer_device_relation cdr
        WHERE cdr.device_id = #{deviceId} AND cdr.status = 1
        ORDER BY cdr.created_time DESC
    </select>

    <!-- ÊèíÂÖ•ÂÆ¢Êà∑ËÆæÂ§áÂÖ≥ËÅî -->
    <insert id="insert" parameterType="com.yxrobot.entity.CustomerDevice" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO customer_device_relation (
            customer_id, device_id, relation_type, start_date, end_date, warranty_end_date,
            daily_rental_fee, purchase_price, relation_notes, created_time, updated_time, status
        ) VALUES (
            #{customerId}, #{deviceId}, #{relationType}, #{startDate}, #{endDate}, #{warrantyEndDate},
            #{dailyRentalFee}, #{purchasePrice}, #{relationNotes}, NOW(), NOW(), 1
        )
    </insert>

    <!-- Êõ¥Êñ∞ÂÆ¢Êà∑ËÆæÂ§áÂÖ≥ËÅî -->
    <update id="updateById" parameterType="com.yxrobot.entity.CustomerDevice">
        UPDATE customer_device_relation SET
            relation_type = #{relationType},
            start_date = #{startDate},
            end_date = #{endDate},
            warranty_end_date = #{warrantyEndDate},
            daily_rental_fee = #{dailyRentalFee},
            purchase_price = #{purchasePrice},
            relation_notes = #{relationNotes},
            updated_time = NOW()
        WHERE id = #{id} AND status = 1
    </update>

    <!-- Ê†πÊçÆIDÂà†Èô§ÂÆ¢Êà∑ËÆæÂ§áÂÖ≥ËÅî -->
    <update id="deleteById">
        UPDATE customer_device_relation SET status = 0, updated_time = NOW()
        WHERE id = #{id} AND status = 1
    </update>

    <!-- Ê†πÊçÆÂÆ¢Êà∑IDÂíåËÆæÂ§áIDÂà†Èô§ÂÖ≥ËÅî -->
    <update id="deleteByCustomerAndDevice">
        UPDATE customer_device_relation SET status = 0, updated_time = NOW()
        WHERE customer_id = #{customerId} AND device_id = #{deviceId} AND status = 1
    </update>

    <!-- ==================== ÂÖ≥ËÅîÊü•ËØ¢ÂäüËÉΩ ==================== -->

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÁöÑÊâÄÊúâËÆæÂ§?-->
    <select id="selectDevicesByCustomerId" resultMap="DeviceResultMap">
        SELECT <include refid="deviceColumns"/>
        FROM devices d
        INNER JOIN customer_device_relation cdr ON d.id = cdr.device_id
        WHERE cdr.customer_id = #{customerId} AND cdr.status = 1 AND d.is_deleted = 0
        ORDER BY cdr.created_time DESC
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÁöÑË¥≠‰π∞ËÆæÂ§áÂàóË°?-->
    <select id="selectPurchasedDevicesByCustomerId" resultMap="CustomerDeviceDTOResultMap">
        SELECT <include refid="customerDeviceDTOColumns"/>
        FROM customer_device_relation cdr
        INNER JOIN devices d ON cdr.device_id = d.id AND d.is_deleted = 0
        WHERE cdr.customer_id = #{customerId} AND cdr.relation_type = 'purchased' AND cdr.status = 1
        ORDER BY cdr.created_time DESC
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÁöÑÁßüËµÅËÆæÂ§áÂàóË°?-->
    <select id="selectRentalDevicesByCustomerId" resultMap="CustomerDeviceDTOResultMap">
        SELECT <include refid="customerDeviceDTOColumns"/>
        FROM customer_device_relation cdr
        INNER JOIN devices d ON cdr.device_id = d.id AND d.is_deleted = 0
        WHERE cdr.customer_id = #{customerId} AND cdr.relation_type = 'rental' AND cdr.status = 1
        ORDER BY cdr.created_time DESC
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÁöÑÊ¥ªË∑ÉËÆæÂ§áÂàóË°?-->
    <select id="selectActiveDevicesByCustomerId" resultMap="CustomerDeviceDTOResultMap">
        SELECT <include refid="customerDeviceDTOColumns"/>
        FROM customer_device_relation cdr
        INNER JOIN devices d ON cdr.device_id = d.id AND d.is_deleted = 0
        WHERE cdr.customer_id = #{customerId} AND cdr.status = 1 
        AND d.device_status = 'active'
        ORDER BY d.last_online_at DESC
    </select>

    <!-- ==================== ÁªüËÆ°Êü•ËØ¢ÂäüËÉΩ ==================== -->

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ËÆæÂ§áÁªüËÆ°‰ø°ÊÅØ -->
    <select id="selectCustomerDeviceStats" resultType="java.util.Map">
        SELECT 
            COUNT(*) as total_devices,
            COUNT(CASE WHEN cdr.relation_type = 'purchased' THEN 1 END) as purchased_devices,
            COUNT(CASE WHEN cdr.relation_type = 'rental' THEN 1 END) as rental_devices,
            COUNT(CASE WHEN d.device_status = 'active' THEN 1 END) as active_devices,
            COUNT(CASE WHEN d.device_status = 'offline' THEN 1 END) as offline_devices,
            COUNT(CASE WHEN d.device_status = 'maintenance' THEN 1 END) as maintenance_devices,
            COALESCE(SUM(cdr.purchase_price), 0) as total_purchase_value,
            COALESCE(SUM(cdr.daily_rental_fee), 0) as total_daily_rental_fee,
            COALESCE(AVG(d.health_score), 0) as avg_health_score
        FROM customer_device_relation cdr
        INNER JOIN devices d ON cdr.device_id = d.id AND d.is_deleted = 0
        WHERE cdr.customer_id = #{customerId} AND cdr.status = 1
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ËÆæÂ§áÊï∞ÈáèÁªüËÆ° -->
    <select id="selectCustomerDeviceCount" resultType="java.util.Map">
        SELECT 
            COUNT(*) as total,
            COUNT(CASE WHEN cdr.relation_type = 'purchased' THEN 1 END) as purchased,
            COUNT(CASE WHEN cdr.relation_type = 'rental' THEN 1 END) as rental
        FROM customer_device_relation cdr
        INNER JOIN devices d ON cdr.device_id = d.id AND d.is_deleted = 0
        WHERE cdr.customer_id = #{customerId} AND cdr.status = 1
    </select>

    <!-- Êü•ËØ¢ËÆæÂ§áÁ±ªÂûãÂàÜÂ∏ÉÁªüËÆ° -->
    <select id="selectDeviceTypeDistribution" resultType="java.util.Map">
        SELECT 
            d.device_category as device_type,
            COUNT(*) as count,
            ROUND(COUNT(*) * 100.0 / (
                SELECT COUNT(*) 
                FROM customer_device_relation cdr2 
                INNER JOIN devices d2 ON cdr2.device_id = d2.id AND d2.is_deleted = 0
                WHERE cdr2.customer_id = #{customerId} AND cdr2.status = 1
            ), 2) as percentage
        FROM customer_device_relation cdr
        INNER JOIN devices d ON cdr.device_id = d.id AND d.is_deleted = 0
        WHERE cdr.customer_id = #{customerId} AND cdr.status = 1
        GROUP BY d.device_category
        ORDER BY count DESC
    </select>

    <!-- ==================== Êï∞ÊçÆÈ™åËØÅÂäüËÉΩ ==================== -->

    <!-- Ê£ÄÊü•ÂÆ¢Êà∑ËÆæÂ§áÂÖ≥ËÅîÊòØÂê¶Â≠òÂú?-->
    <select id="existsByCustomerAndDevice" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM customer_device_relation
        WHERE customer_id = #{customerId} AND device_id = #{deviceId} 
        AND relation_type = #{relationType} AND status = 1
    </select>

    <!-- Ê£ÄÊü•ËÆæÂ§áÊòØÂê¶Â∑≤Ë¢´ÂÖ∂‰ªñÂÆ¢Êà∑ÂÖ≥ËÅ?-->
    <select id="isDeviceOccupied" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM customer_device_relation
        WHERE device_id = #{deviceId} AND relation_type = #{relationType} AND status = 1
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ËÆæÂ§áÂÖ≥ËÅîÊï∞Èáè -->
    <select id="countByCustomerId" resultType="int">
        SELECT COUNT(*)
        FROM customer_device_relation
        WHERE customer_id = #{customerId} AND status = 1
    </select>

    <!-- Êü•ËØ¢ËÆæÂ§áÂÖ≥ËÅîÊï∞Èáè -->
    <select id="countByDeviceId" resultType="int">
        SELECT COUNT(*)
        FROM customer_device_relation
        WHERE device_id = #{deviceId} AND status = 1
    </select>

    <!-- ==================== ËÆæÂ§áÁÆ°ÁêÜÂäüËÉΩ ==================== -->

    <!-- Êü•ËØ¢Âç≥Â∞ÜÂà∞ÊúüÁöÑÁßüËµÅËÆæÂ§?-->
    <select id="selectExpiringRentalDevices" resultMap="CustomerDeviceDTOResultMap">
        SELECT <include refid="customerDeviceDTOColumns"/>
        FROM customer_device_relation cdr
        INNER JOIN devices d ON cdr.device_id = d.id AND d.is_deleted = 0
        WHERE cdr.relation_type = 'rental' AND cdr.status = 1
        AND cdr.end_date IS NOT NULL 
        AND cdr.end_date BETWEEN CURDATE() AND DATE_ADD(CURDATE(), INTERVAL #{days} DAY)
        ORDER BY cdr.end_date ASC
    </select>

    <!-- Êü•ËØ¢‰øù‰øÆÂç≥Â∞ÜÂà∞ÊúüÁöÑË¥≠‰π∞ËÆæÂ§?-->
    <select id="selectExpiringWarrantyDevices" resultMap="CustomerDeviceDTOResultMap">
        SELECT <include refid="customerDeviceDTOColumns"/>
        FROM customer_device_relation cdr
        INNER JOIN devices d ON cdr.device_id = d.id AND d.is_deleted = 0
        WHERE cdr.relation_type = 'purchased' AND cdr.status = 1
        AND cdr.warranty_end_date IS NOT NULL 
        AND cdr.warranty_end_date BETWEEN CURDATE() AND DATE_ADD(CURDATE(), INTERVAL #{days} DAY)
        ORDER BY cdr.warranty_end_date ASC
    </select>

    <!-- Êõ¥Êñ∞ËÆæÂ§áÂÖ≥ËÅîÁä∂ÊÄ?-->
    <update id="updateRelationStatus">
        UPDATE customer_device_relation SET status = #{status}, updated_time = NOW()
        WHERE id = #{id}
    </update>

    <!-- ÊâπÈáèÊõ¥Êñ∞ËÆæÂ§áÂÖ≥ËÅîÁä∂ÊÄ?-->
    <update id="batchUpdateRelationStatus">
        UPDATE customer_device_relation SET status = #{status}, updated_time = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.CustomerMapper">

    <!-- ÂÆ¢Êà∑ÂÆû‰ΩìÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="CustomerResultMap" type="com.yxrobot.entity.Customer">
        <id column="id" property="id"/>
        <result column="customer_name" property="customerName"/>
        <result column="customer_type" property="customerType"/>
        <result column="customer_level" property="customerLevel"/>
        <result column="customer_status" property="customerStatus"/>
        <result column="contact_person" property="contactPerson"/>
        <result column="phone" property="phone"/>
        <result column="email" property="email"/>
        <result column="avatar_url" property="avatarUrl"/>
        <!-- <result column="customer_tags" property="customerTags"/> ÊöÇÊó∂Ê≥®ÈáäÊéâÔºåÈúÄË¶ÅTypeHandlerÊîØÊåÅ -->
        <result column="notes" property="notes"/>
        <result column="address" property="address"/>
        <result column="region" property="region"/>
        <result column="industry" property="industry"/>
        <result column="credit_level" property="creditLevel"/>
        <result column="total_spent" property="totalSpent"/>
        <result column="customer_value" property="customerValue"/>
        <result column="registered_at" property="registeredAt"/>
        <result column="last_active_at" property="lastActiveAt"/>
        <result column="is_active" property="isActive"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="is_deleted" property="isDeleted"/>
        <!-- ÁªüËÆ°Â≠óÊÆµ -->
        <result column="total_orders" property="totalOrders"/>
        <result column="total_sales_amount" property="totalSalesAmount"/>
        <result column="last_order_date" property="lastOrderDate"/>
        <result column="device_count" property="deviceCount"/>
        <result column="purchased_device_count" property="purchasedDeviceCount"/>
        <result column="rental_device_count" property="rentalDeviceCount"/>
    </resultMap>

    <!-- ÂÆ¢Êà∑DTOÁªìÊûúÊò†Â∞ÑÔºàÈÄÇÈÖçÂâçÁ´ØÊé•Âè£Ôº?-->
    <resultMap id="CustomerDTOResultMap" type="com.yxrobot.dto.CustomerDTO">
        <id column="id" property="id"/>
        <!-- Âü∫Êú¨‰ø°ÊÅØÂ≠óÊÆµÊò†Â∞Ñ - ÈÄÇÈÖçÂâçÁ´ØÂ≠óÊÆµÂê?-->
        <result column="customer_name" property="customerName"/>
        <result column="customer_level" property="customerLevel"/>
        <result column="customer_status" property="customerStatus"/>
        <result column="contact_person" property="contactPerson"/>
        <result column="phone" property="phone"/>
        <result column="email" property="email"/>
        <result column="avatar_url" property="avatarUrl"/>
        <!-- <result column="customer_tags" property="tags" /> ÊöÇÊó∂Ê≥®ÈáäÊé?-->
        <result column="notes" property="notes"/>
        <!-- ÁªüËÆ°‰ø°ÊÅØÂ≠óÊÆµ -->
        <result column="total_spent" property="totalSpent"/>
        <result column="customer_value" property="customerValue"/>
        <!-- Êó∂Èó¥Â≠óÊÆµ -->
        <result column="registered_at" property="registeredAt"/>
        <result column="last_active_at" property="lastActiveAt"/>
        <!-- ‰øùÊåÅÁé∞ÊúâÂ≠óÊÆµÂÖºÂÆπÊÄ?-->
        <result column="customer_type" property="customerType"/>
        <result column="region" property="region"/>
        <result column="industry" property="industry"/>
        <result column="credit_level" property="creditLevel"/>
        <result column="is_active" property="isActive"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="total_orders" property="totalOrders"/>
        <result column="total_sales_amount" property="totalSalesAmount"/>
        <result column="last_order_date" property="lastOrderDate"/>
        <!-- ËÆæÂ§áÁªüËÆ°Â≠óÊÆµ -->
        <result column="device_total" property="deviceCount.total"/>
        <result column="device_purchased" property="deviceCount.purchased"/>
        <result column="device_rental" property="deviceCount.rental"/>
        <!-- Âú∞ÂùÄ‰ø°ÊÅØÂ≠óÊÆµ -->
        <result column="address_province" property="address.province"/>
        <result column="address_city" property="address.city"/>
        <result column="address_detail" property="address.detail"/>
    </resultMap>

    <!-- ÂÆ¢Êà∑ÁªüËÆ°DTOÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="CustomerStatsDTOResultMap" type="com.yxrobot.dto.CustomerStatsDTO">
        <result column="total" property="total"/>
        <result column="regular" property="regular"/>
        <result column="vip" property="vip"/>
        <result column="premium" property="premium"/>
        <result column="active_devices" property="activeDevices"/>
        <result column="total_revenue" property="totalRevenue"/>
        <result column="new_this_month" property="newThisMonth"/>
    </resultMap>

    <!-- Âü∫Á°ÄSQLÁâáÊÆµ -->
    <sql id="customerColumns">
        c.id, c.customer_name, c.customer_type, c.customer_level, c.customer_status,
        c.contact_person, c.phone, c.email, c.avatar_url, c.customer_tags, c.notes,
        c.address, c.region, c.industry, c.credit_level, c.total_spent, c.customer_value,
        c.registered_at, c.last_active_at, c.is_active, c.created_at, c.updated_at, c.is_deleted
    </sql>

    <!-- ÂÆ¢Êà∑DTOÊü•ËØ¢SQLÁâáÊÆµÔºàÂåÖÂê´ÂÖ≥ËÅîÁªüËÆ°Ôºâ -->
    <sql id="customerDTOColumns">
        c.id, c.customer_name, c.customer_level, c.customer_status,
        c.contact_person, c.phone, c.email, c.avatar_url, c.customer_tags, c.notes,
        c.total_spent, c.customer_value, c.registered_at, c.last_active_at,
        c.customer_type, c.region, c.industry, c.credit_level, c.is_active,
        c.created_at, c.updated_at,
        <!-- Âú∞ÂùÄ‰ø°ÊÅØËß£Êûê -->
        SUBSTRING_INDEX(c.region, '-', 1) as address_province,
        SUBSTRING_INDEX(c.region, '-', -1) as address_city,
        c.address as address_detail,
        <!-- ËÆæÂ§áÁªüËÆ°‰ø°ÊÅØ -->
        COALESCE(ds.device_total, 0) as device_total,
        COALESCE(ds.device_purchased, 0) as device_purchased,
        COALESCE(ds.device_rental, 0) as device_rental
    </sql>

    <!-- ËÆæÂ§áÁªüËÆ°Â≠êÊü•ËØ?-->
    <sql id="deviceStatsSubquery">
        LEFT JOIN (
            SELECT 
                cdr.customer_id,
                COUNT(*) as device_total,
                COUNT(CASE WHEN cdr.relation_type = 'purchased' THEN 1 END) as device_purchased,
                COUNT(CASE WHEN cdr.relation_type = 'rental' THEN 1 END) as device_rental
            FROM customer_device_relation cdr
            INNER JOIN devices d ON cdr.device_id = d.id AND d.is_deleted = 0
            WHERE cdr.status = 1
            GROUP BY cdr.customer_id
        ) ds ON c.id = ds.customer_id
    </sql>

    <!-- Êü•ËØ¢Êù°‰ª∂SQLÁâáÊÆµ -->
    <sql id="whereConditions">
        <where>
            c.is_deleted = 0
            <if test="query != null">
                <!-- ÂÖ≥ÈîÆËØçÊêúÁ¥?-->
                <if test="query.keyword != null and query.keyword != ''">
                    AND (c.customer_name LIKE CONCAT('%', #{query.keyword}, '%')
                    OR c.phone LIKE CONCAT('%', #{query.keyword}, '%')
                    OR c.email LIKE CONCAT('%', #{query.keyword}, '%')
                    OR c.contact_person LIKE CONCAT('%', #{query.keyword}, '%'))
                </if>
                
                <!-- Âü∫Á°ÄÁ≠õÈÄâÊù°‰ª?-->
                <if test="query.customerLevel != null and query.customerLevel != ''">
                    AND c.customer_level = #{query.customerLevel}
                </if>
                <if test="query.customerStatus != null and query.customerStatus != ''">
                    AND c.customer_status = #{query.customerStatus}
                </if>
                <if test="query.region != null and query.region != ''">
                    AND c.region LIKE CONCAT('%', #{query.region}, '%')
                </if>
                <if test="query.industry != null and query.industry != ''">
                    AND c.industry = #{query.industry}
                </if>
                <if test="query.creditLevel != null and query.creditLevel != ''">
                    AND c.credit_level = #{query.creditLevel}
                </if>
                <if test="query.isActive != null">
                    AND c.is_active = #{query.isActive}
                </if>
                
                <!-- Êó∂Èó¥ËåÉÂõ¥Á≠õÈÄ?-->
                <if test="query.startDate != null and query.startDate != ''">
                    AND c.created_at >= #{query.startDate}
                </if>
                <if test="query.endDate != null and query.endDate != ''">
                    AND c.created_at &lt;= #{query.endDate}
                </if>
                <if test="query.registeredStartDate != null and query.registeredStartDate != ''">
                    AND c.registered_at >= #{query.registeredStartDate}
                </if>
                <if test="query.registeredEndDate != null and query.registeredEndDate != ''">
                    AND c.registered_at &lt;= #{query.registeredEndDate}
                </if>
                <if test="query.lastActiveStartDate != null and query.lastActiveStartDate != ''">
                    AND c.last_active_at >= #{query.lastActiveStartDate}
                </if>
                <if test="query.lastActiveEndDate != null and query.lastActiveEndDate != ''">
                    AND c.last_active_at &lt;= #{query.lastActiveEndDate}
                </if>
                
                <!-- ÈáëÈ¢ùËåÉÂõ¥Á≠õÈÄ?-->
                <if test="query.minSpent != null and query.minSpent != ''">
                    AND c.total_spent >= #{query.minSpent}
                </if>
                <if test="query.maxSpent != null and query.maxSpent != ''">
                    AND c.total_spent &lt;= #{query.maxSpent}
                </if>
                <if test="query.minCustomerValue != null and query.minCustomerValue != ''">
                    AND c.customer_value >= #{query.minCustomerValue}
                </if>
                <if test="query.maxCustomerValue != null and query.maxCustomerValue != ''">
                    AND c.customer_value &lt;= #{query.maxCustomerValue}
                </if>
                
                <!-- Ê†áÁ≠æÁ≠õÈÄ?-->
                <if test="query.tags != null and query.tags != ''">
                    AND JSON_CONTAINS(c.customer_tags, JSON_ARRAY(#{query.tags}))
                </if>
                
                <!-- ËÆæÂ§áÁ±ªÂûãÁ≠õÈÄ?-->
                <if test="query.deviceType != null and query.deviceType != ''">
                    AND EXISTS (
                        SELECT 1 FROM customer_device_relation cdr
                        INNER JOIN devices d ON cdr.device_id = d.id
                        WHERE cdr.customer_id = c.id 
                        AND d.device_type = #{query.deviceType}
                        AND d.is_deleted = 0 
                        AND cdr.status = 1
                    )
                </if>
                
                <!-- È´òÁ∫ßÁ≠õÈÄâÊù°‰ª?-->
                <if test="query.hasDevices != null">
                    <choose>
                        <when test="query.hasDevices == true">
                            AND EXISTS (
                                SELECT 1 FROM customer_device_relation cdr
                                INNER JOIN devices d ON cdr.device_id = d.id
                                WHERE cdr.customer_id = c.id 
                                AND d.is_deleted = 0 
                                AND cdr.status = 1
                            )
                        </when>
                        <otherwise>
                            AND NOT EXISTS (
                                SELECT 1 FROM customer_device_relation cdr
                                INNER JOIN devices d ON cdr.device_id = d.id
                                WHERE cdr.customer_id = c.id 
                                AND d.is_deleted = 0 
                                AND cdr.status = 1
                            )
                        </otherwise>
                    </choose>
                </if>
                
                <if test="query.hasOrders != null">
                    <choose>
                        <when test="query.hasOrders == true">
                            AND EXISTS (
                                SELECT 1 FROM customer_order_relation cor
                                INNER JOIN orders o ON cor.order_id = o.id
                                WHERE cor.customer_id = c.id 
                                AND o.is_deleted = 0
                            )
                        </when>
                        <otherwise>
                            AND NOT EXISTS (
                                SELECT 1 FROM customer_order_relation cor
                                INNER JOIN orders o ON cor.order_id = o.id
                                WHERE cor.customer_id = c.id 
                                AND o.is_deleted = 0
                            )
                        </otherwise>
                    </choose>
                </if>
                
                <if test="query.hasServiceRecords != null">
                    <choose>
                        <when test="query.hasServiceRecords == true">
                            AND EXISTS (
                                SELECT 1 FROM customer_service_relation csr
                                INNER JOIN service_records sr ON csr.service_record_id = sr.id
                                WHERE csr.customer_id = c.id 
                                AND sr.is_deleted = 0
                            )
                        </when>
                        <otherwise>
                            AND NOT EXISTS (
                                SELECT 1 FROM customer_service_relation csr
                                INNER JOIN service_records sr ON csr.service_record_id = sr.id
                                WHERE csr.customer_id = c.id 
                                AND sr.is_deleted = 0
                            )
                        </otherwise>
                    </choose>
                </if>
            </if>
        </where>
    </sql>

    <!-- ÊéíÂ∫èSQLÁâáÊÆµ -->
    <sql id="orderByClause">
        <choose>
            <when test="query != null and query.sortBy != null and query.sortBy != ''">
                ORDER BY 
                <choose>
                    <when test="query.sortBy == 'name' or query.sortBy == 'customerName'">c.customer_name</when>
                    <when test="query.sortBy == 'level' or query.sortBy == 'customerLevel'">c.customer_level</when>
                    <when test="query.sortBy == 'totalSpent'">c.total_spent</when>
                    <when test="query.sortBy == 'customerValue'">c.customer_value</when>
                    <when test="query.sortBy == 'registeredAt'">c.registered_at</when>
                    <when test="query.sortBy == 'lastActiveAt'">c.last_active_at</when>
                    <when test="query.sortBy == 'createdAt'">c.created_at</when>
                    <when test="query.sortBy == 'updatedAt'">c.updated_at</when>
                    <otherwise>c.created_at</otherwise>
                </choose>
                <choose>
                    <when test="query.sortOrder != null and query.sortOrder.toUpperCase() == 'ASC'">ASC</when>
                    <otherwise>DESC</otherwise>
                </choose>
                <!-- Ê¨°Ë¶ÅÊéíÂ∫èÂ≠óÊÆµ -->
                <if test="query.secondarySortBy != null and query.secondarySortBy != '' and query.secondarySortBy != query.sortBy">
                    ,
                    <choose>
                        <when test="query.secondarySortBy == 'name' or query.secondarySortBy == 'customerName'">c.customer_name</when>
                        <when test="query.secondarySortBy == 'level' or query.secondarySortBy == 'customerLevel'">c.customer_level</when>
                        <when test="query.secondarySortBy == 'totalSpent'">c.total_spent</when>
                        <when test="query.secondarySortBy == 'customerValue'">c.customer_value</when>
                        <when test="query.secondarySortBy == 'registeredAt'">c.registered_at</when>
                        <when test="query.secondarySortBy == 'lastActiveAt'">c.last_active_at</when>
                        <when test="query.secondarySortBy == 'createdAt'">c.created_at</when>
                        <when test="query.secondarySortBy == 'updatedAt'">c.updated_at</when>
                        <otherwise>c.created_at</otherwise>
                    </choose>
                    <choose>
                        <when test="query.secondarySortOrder != null and query.secondarySortOrder.toUpperCase() == 'ASC'">ASC</when>
                        <otherwise>DESC</otherwise>
                    </choose>
                </if>
            </when>
            <otherwise>ORDER BY c.created_at DESC</otherwise>
        </choose>
    </sql>

    <!-- ==================== Âü∫Á°ÄCRUDÊìç‰Ωú ==================== -->

    <!-- Ê†πÊçÆIDÊü•ËØ¢ÂÆ¢Êà∑ -->
    <select id="selectById" resultMap="CustomerResultMap">
        SELECT <include refid="customerColumns"/>
        FROM customers c
        WHERE c.id = #{id} AND c.is_deleted = 0
    </select>

    <!-- Ê†πÊçÆIDÊü•ËØ¢ÂÆ¢Êà∑DTO -->
    <select id="selectDTOById" resultMap="CustomerDTOResultMap">
        SELECT <include refid="customerDTOColumns"/>
        FROM customers c
        <include refid="deviceStatsSubquery"/>
        WHERE c.id = #{id} AND c.is_deleted = 0
    </select>

    <!-- ÂàÜÈ°µÊü•ËØ¢ÂÆ¢Êà∑ÂàóË°® -->
    <select id="selectList" resultMap="CustomerResultMap">
        SELECT <include refid="customerColumns"/>
        FROM customers c
        <include refid="whereConditions"/>
        <include refid="orderByClause"/>
        <if test="query != null and query.page != null and query.pageSize != null">
            LIMIT #{query.pageSize} OFFSET #{query.offset}
        </if>
    </select>

    <!-- ÂàÜÈ°µÊü•ËØ¢ÂÆ¢Êà∑DTOÂàóË°® -->
    <select id="selectDTOList" resultMap="CustomerDTOResultMap">
        SELECT <include refid="customerDTOColumns"/>
        FROM customers c
        <include refid="deviceStatsSubquery"/>
        <include refid="whereConditions"/>
        <include refid="orderByClause"/>
        <if test="query != null and query.page != null and query.pageSize != null">
            LIMIT #{query.pageSize} OFFSET #{query.offset}
        </if>
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÊÄªÊï∞ -->
    <select id="selectCount" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM customers c
        <include refid="whereConditions"/>
    </select>

    <!-- ÊèíÂÖ•ÂÆ¢Êà∑ -->
    <insert id="insert" parameterType="com.yxrobot.entity.Customer" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO customers (
            customer_name, customer_type, customer_level, customer_status,
            contact_person, phone, email, avatar_url, customer_tags, notes,
            address, region, industry, credit_level, total_spent, customer_value,
            registered_at, last_active_at, is_active, created_at, updated_at, is_deleted
        ) VALUES (
            #{customerName}, #{customerType}, #{customerLevel}, #{customerStatus},
            #{contactPerson}, #{phone}, #{email}, #{avatarUrl}, 
            NULL, #{notes},
            #{address}, #{region}, #{industry}, #{creditLevel}, #{totalSpent}, #{customerValue},
            #{registeredAt}, #{lastActiveAt}, #{isActive}, NOW(), NOW(), 0
        )
    </insert>

    <!-- Êõ¥Êñ∞ÂÆ¢Êà∑‰ø°ÊÅØ -->
    <update id="updateById" parameterType="com.yxrobot.entity.Customer">
        UPDATE customers SET
            customer_name = #{customerName},
            customer_type = #{customerType},
            customer_level = #{customerLevel},
            customer_status = #{customerStatus},
            contact_person = #{contactPerson},
            phone = #{phone},
            email = #{email},
            avatar_url = #{avatarUrl},
            customer_tags = NULL,
            notes = #{notes},
            address = #{address},
            region = #{region},
            industry = #{industry},
            credit_level = #{creditLevel},
            total_spent = #{totalSpent},
            customer_value = #{customerValue},
            last_active_at = #{lastActiveAt},
            is_active = #{isActive},
            updated_at = NOW()
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- Ê†πÊçÆIDËΩØÂà†Èô§ÂÆ¢Êà?-->
    <update id="softDeleteById">
        UPDATE customers SET is_deleted = 1, updated_at = NOW()
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- ÊâπÈáèËΩØÂà†Èô§ÂÆ¢Êà?-->
    <update id="softDeleteByIds">
        UPDATE customers SET is_deleted = 1, updated_at = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND is_deleted = 0
    </update>

    <!-- ==================== ÂÆ¢Êà∑ÁªüËÆ°ÂäüËÉΩ ==================== -->

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÁªüËÆ°Êï∞ÊçÆ -->
    <select id="selectCustomerStats" resultMap="CustomerStatsDTOResultMap">
        SELECT 
            COUNT(*) as total,
            COUNT(CASE WHEN customer_level = 'regular' THEN 1 END) as regular,
            COUNT(CASE WHEN customer_level = 'vip' THEN 1 END) as vip,
            COUNT(CASE WHEN customer_level = 'premium' THEN 1 END) as premium,
            (SELECT COUNT(DISTINCT d.id) 
             FROM devices d 
             INNER JOIN customer_device_relation cdr ON d.id = cdr.device_id 
             WHERE d.device_status = 'active' AND d.is_deleted = 0 AND cdr.status = 1) as active_devices,
            COALESCE(SUM(total_spent), 0) as total_revenue,
            COUNT(CASE WHEN DATE(registered_at) >= DATE_SUB(CURDATE(), INTERVAL 30 DAY) THEN 1 END) as new_this_month
        FROM customers 
        WHERE is_deleted = 0
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑Á≠âÁ∫ßÂàÜÂ∏ÉÁªüËÆ° -->
    <select id="selectCustomerLevelStats" resultType="java.util.Map">
        SELECT 
            customer_level as level,
            COUNT(*) as count,
            ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM customers WHERE is_deleted = 0), 2) as percentage
        FROM customers 
        WHERE is_deleted = 0
        GROUP BY customer_level
        ORDER BY 
            CASE customer_level 
                WHEN 'premium' THEN 1 
                WHEN 'vip' THEN 2 
                WHEN 'regular' THEN 3 
                ELSE 4 
            END
    </select>

    <!-- Êü•ËØ¢Êú¨ÊúàÊñ∞Â¢ûÂÆ¢Êà∑Êï?-->
    <select id="selectNewCustomersThisMonth" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM customers 
        WHERE is_deleted = 0 
        AND DATE(registered_at) >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
    </select>

    <!-- Êü•ËØ¢Ê¥ªË∑ÉËÆæÂ§áÊÄªÊï∞ -->
    <select id="selectActiveDeviceCount" resultType="java.lang.Integer">
        SELECT COUNT(DISTINCT d.id)
        FROM devices d 
        INNER JOIN customer_device_relation cdr ON d.id = cdr.device_id 
        WHERE d.device_status = 'active' AND d.is_deleted = 0 AND cdr.status = 1
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÊÄªÊî∂ÂÖ?-->
    <select id="selectTotalRevenue" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(total_spent), 0)
        FROM customers 
        WHERE is_deleted = 0
    </select>

    <!-- ==================== ÊêúÁ¥¢ÂíåÁ≠õÈÄâÂäüËÉ?==================== -->

    <!-- Ê†πÊçÆÂÖ≥ÈîÆËØçÊêúÁ¥¢ÂÆ¢Êà?-->
    <select id="searchCustomers" resultMap="CustomerDTOResultMap">
        SELECT <include refid="customerDTOColumns"/>
        FROM customers c
        <include refid="deviceStatsSubquery"/>
        WHERE c.is_deleted = 0
        AND (c.customer_name LIKE CONCAT('%', #{keyword}, '%')
        OR c.phone LIKE CONCAT('%', #{keyword}, '%')
        OR c.email LIKE CONCAT('%', #{keyword}, '%'))
        ORDER BY c.customer_name
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- Ê†πÊçÆÂÆ¢Êà∑Á≠âÁ∫ßÁ≠õÈÄâÂÆ¢Êà?-->
    <select id="selectByCustomerLevel" resultMap="CustomerDTOResultMap">
        SELECT <include refid="customerDTOColumns"/>
        FROM customers c
        <include refid="deviceStatsSubquery"/>
        WHERE c.is_deleted = 0 AND c.customer_level = #{level}
        <include refid="orderByClause"/>
        <if test="query != null and query.page != null and query.pageSize != null">
            LIMIT #{query.pageSize} OFFSET #{query.offset}
        </if>
    </select>

    <!-- Ê†πÊçÆÂú∞Âå∫Á≠õÈÄâÂÆ¢Êà?-->
    <select id="selectByRegion" resultMap="CustomerDTOResultMap">
        SELECT <include refid="customerDTOColumns"/>
        FROM customers c
        <include refid="deviceStatsSubquery"/>
        WHERE c.is_deleted = 0 AND c.region LIKE CONCAT('%', #{region}, '%')
        <include refid="orderByClause"/>
        <if test="query != null and query.page != null and query.pageSize != null">
            LIMIT #{query.pageSize} OFFSET #{query.offset}
        </if>
    </select>

    <!-- Ê†πÊçÆËÆæÂ§áÁ±ªÂûãÁ≠õÈÄâÂÆ¢Êà?-->
    <select id="selectByDeviceType" resultMap="CustomerDTOResultMap">
        SELECT <include refid="customerDTOColumns"/>
        FROM customers c
        <include refid="deviceStatsSubquery"/>
        WHERE c.is_deleted = 0 
        AND EXISTS (
            SELECT 1 FROM customer_device_relation cdr
            INNER JOIN devices d ON cdr.device_id = d.id
            WHERE cdr.customer_id = c.id 
            AND d.device_type = #{deviceType}
            AND d.is_deleted = 0 
            AND cdr.status = 1
        )
        <include refid="orderByClause"/>
        <if test="query != null and query.page != null and query.pageSize != null">
            LIMIT #{query.pageSize} OFFSET #{query.offset}
        </if>
    </select>

    <!-- Ê†πÊçÆÊ≥®ÂÜåÊó∂Èó¥ËåÉÂõ¥Á≠õÈÄâÂÆ¢Êà?-->
    <select id="selectByRegisteredDateRange" resultMap="CustomerDTOResultMap">
        SELECT <include refid="customerDTOColumns"/>
        FROM customers c
        <include refid="deviceStatsSubquery"/>
        WHERE c.is_deleted = 0
        <if test="startDate != null">
            AND c.registered_at >= #{startDate}
        </if>
        <if test="endDate != null">
            AND c.registered_at &lt;= #{endDate}
        </if>
        <include refid="orderByClause"/>
        <if test="query != null and query.page != null and query.pageSize != null">
            LIMIT #{query.pageSize} OFFSET #{query.offset}
        </if>
    </select>

    <!-- È´òÁ∫ßÊêúÁ¥¢ - Â§öÊù°‰ª∂ÁªÑÂêàÊü•ËØ?-->
    <select id="advancedSearch" resultMap="CustomerDTOResultMap">
        SELECT <include refid="customerDTOColumns"/>
        FROM customers c
        <include refid="deviceStatsSubquery"/>
        <include refid="whereConditions"/>
        <include refid="orderByClause"/>
        <if test="query != null and query.page != null and query.pageSize != null">
            LIMIT #{query.pageSize} OFFSET #{query.offset}
        </if>
    </select>

    <!-- È´òÁ∫ßÊêúÁ¥¢ - ÁªüËÆ°ÊÄªÊï∞ -->
    <select id="advancedSearchCount" resultType="java.lang.Long">
        SELECT COUNT(DISTINCT c.id)
        FROM customers c
        <if test="query != null and (query.deviceType != null or query.hasDevices != null or query.hasOrders != null or query.hasServiceRecords != null)">
            <if test="query.deviceType != null or query.hasDevices != null">
                LEFT JOIN customer_device_relation cdr ON c.id = cdr.customer_id AND cdr.status = 1
                LEFT JOIN devices d ON cdr.device_id = d.id AND d.is_deleted = 0
            </if>
            <if test="query.hasOrders != null">
                LEFT JOIN customer_order_relation cor ON c.id = cor.customer_id
                LEFT JOIN orders o ON cor.order_id = o.id AND o.is_deleted = 0
            </if>
            <if test="query.hasServiceRecords != null">
                LEFT JOIN customer_service_relation csr ON c.id = csr.customer_id
                LEFT JOIN service_records sr ON csr.service_record_id = sr.id AND sr.is_deleted = 0
            </if>
        </if>
        <include refid="whereConditions"/>
    </select>

    <!-- ==================== Êï∞ÊçÆÈ™åËØÅÂäüËÉΩ ==================== -->

    <!-- Ê£ÄÊü•ÂÆ¢Êà∑ÂßìÂêçÊòØÂê¶Â≠òÂú?-->
    <select id="existsByCustomerName" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM customers 
        WHERE customer_name = #{customerName} AND is_deleted = 0
    </select>

    <!-- Ê£ÄÊü•ÁîµËØùÂè∑Á†ÅÊòØÂê¶Â≠òÂú?-->
    <select id="existsByPhone" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM customers 
        WHERE phone = #{phone} AND is_deleted = 0
    </select>

    <!-- Ê£ÄÊü•ÈÇÆÁÆ±ÊòØÂê¶Â≠òÂú?-->
    <select id="existsByEmail" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM customers 
        WHERE email = #{email} AND is_deleted = 0
    </select>

    <!-- Ê£ÄÊü•ÂÆ¢Êà∑ÂßìÂêçÊòØÂê¶Â≠òÂú®ÔºàÊéíÈô§ÊåáÂÆöIDÔº?-->
    <select id="existsByCustomerNameExcludeId" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM customers 
        WHERE customer_name = #{customerName} AND id != #{id} AND is_deleted = 0
    </select>

    <!-- Ê£ÄÊü•ÁîµËØùÂè∑Á†ÅÊòØÂê¶Â≠òÂú®ÔºàÊéíÈô§ÊåáÂÆöIDÔº?-->
    <select id="existsByPhoneExcludeId" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM customers 
        WHERE phone = #{phone} AND id != #{id} AND is_deleted = 0
    </select>

    <!-- Ê£ÄÊü•ÈÇÆÁÆ±ÊòØÂê¶Â≠òÂú®ÔºàÊéíÈô§ÊåáÂÆöIDÔº?-->
    <select id="existsByEmailExcludeId" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM customers 
        WHERE email = #{email} AND id != #{id} AND is_deleted = 0
    </select>

    <!-- Ê†πÊçÆÁîµËØùÂè∑Á†ÅÊü•ËØ¢ÂÆ¢Êà∑ -->
    <select id="selectByPhone" resultMap="CustomerResultMap">
        SELECT <include refid="customerColumns"/>
        FROM customers c
        WHERE c.phone = #{phone} AND c.is_deleted = 0
    </select>

    <!-- Ê†πÊçÆÈÇÆÁÆ±Êü•ËØ¢ÂÆ¢Êà∑ -->
    <select id="selectByEmail" resultMap="CustomerResultMap">
        SELECT <include refid="customerColumns"/>
        FROM customers c
        WHERE c.email = #{email} AND c.is_deleted = 0
    </select>

    <!-- ==================== È´òÁ∫ßÊü•ËØ¢ÂäüËÉΩ ==================== -->

    <!-- Êü•ËØ¢È´ò‰ª∑ÂÄºÂÆ¢Êà?-->
    <select id="selectHighValueCustomers" resultMap="CustomerDTOResultMap">
        SELECT <include refid="customerDTOColumns"/>
        FROM customers c
        <include refid="deviceStatsSubquery"/>
        WHERE c.is_deleted = 0 AND c.customer_value >= #{minValue}
        ORDER BY c.customer_value DESC, c.total_spent DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- Êü•ËØ¢Ê¥ªË∑ÉÂÆ¢Êà∑ -->
    <select id="selectActiveCustomers" resultMap="CustomerDTOResultMap">
        SELECT <include refid="customerDTOColumns"/>
        FROM customers c
        <include refid="deviceStatsSubquery"/>
        WHERE c.is_deleted = 0 
        AND c.is_active = 1
        AND c.last_active_at >= DATE_SUB(NOW(), INTERVAL #{days} DAY)
        ORDER BY c.last_active_at DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- Êü•ËØ¢Ê≤âÁù°ÂÆ¢Êà∑ -->
    <select id="selectInactiveCustomers" resultMap="CustomerDTOResultMap">
        SELECT <include refid="customerDTOColumns"/>
        FROM customers c
        <include refid="deviceStatsSubquery"/>
        WHERE c.is_deleted = 0 
        AND (c.last_active_at IS NULL OR c.last_active_at &lt; DATE_SUB(NOW(), INTERVAL #{days} DAY))
        ORDER BY c.last_active_at ASC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- Êü•ËØ¢VIPÂÆ¢Êà∑ÂàóË°® -->
    <select id="selectVipCustomers" resultMap="CustomerDTOResultMap">
        SELECT <include refid="customerDTOColumns"/>
        FROM customers c
        <include refid="deviceStatsSubquery"/>
        WHERE c.is_deleted = 0 AND c.customer_level IN ('vip', 'premium')
        <include refid="orderByClause"/>
        <if test="query != null and query.page != null and query.pageSize != null">
            LIMIT #{query.pageSize} OFFSET #{query.offset}
        </if>
    </select>

    <!-- Êü•ËØ¢Êñ∞Ê≥®ÂÜåÂÆ¢Êà?-->
    <select id="selectNewCustomers" resultMap="CustomerDTOResultMap">
        SELECT <include refid="customerDTOColumns"/>
        FROM customers c
        <include refid="deviceStatsSubquery"/>
        WHERE c.is_deleted = 0 
        AND c.registered_at >= DATE_SUB(NOW(), INTERVAL #{days} DAY)
        ORDER BY c.registered_at DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- ==================== Á≠õÈÄâÈÄâÈ°πÊï∞ÊçÆ ==================== -->

    <!-- Ëé∑ÂèñÂÆ¢Êà∑Á≠âÁ∫ßÁ≠õÈÄâÈÄâÈ°π -->
    <select id="getCustomerLevelOptions" resultType="java.util.Map">
        SELECT 
            customer_level as value,
            customer_level as label,
            COUNT(*) as count
        FROM customers 
        WHERE is_deleted = 0
        GROUP BY customer_level
        ORDER BY 
            CASE customer_level 
                WHEN 'premium' THEN 1 
                WHEN 'vip' THEN 2 
                WHEN 'regular' THEN 3 
                ELSE 4 
            END
    </select>

    <!-- Ëé∑ÂèñÂú∞Âå∫Á≠õÈÄâÈÄâÈ°π -->
    <select id="getRegionOptions" resultType="java.util.Map">
        SELECT 
            region as value,
            region as label,
            COUNT(*) as count
        FROM customers 
        WHERE is_deleted = 0 AND region IS NOT NULL AND region != ''
        GROUP BY region
        ORDER BY count DESC, region
    </select>

    <!-- Ëé∑ÂèñË°å‰∏öÁ≠õÈÄâÈÄâÈ°π -->
    <select id="getIndustryOptions" resultType="java.util.Map">
        SELECT 
            industry as value,
            industry as label,
            COUNT(*) as count
        FROM customers 
        WHERE is_deleted = 0 AND industry IS NOT NULL AND industry != ''
        GROUP BY industry
        ORDER BY count DESC, industry
    </select>

    <!-- Ëé∑ÂèñÂÆ¢Êà∑Ê†áÁ≠æÁ≠õÈÄâÈÄâÈ°π -->
    <select id="getCustomerTagOptions" resultType="java.util.Map">
        SELECT 
            tag as value,
            tag as label,
            COUNT(*) as count
        FROM (
            SELECT JSON_UNQUOTE(JSON_EXTRACT(customer_tags, CONCAT('$[', numbers.n, ']'))) as tag
            FROM customers
            CROSS JOIN (
                SELECT 0 as n UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4
                UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9
            ) numbers
            WHERE is_deleted = 0 
            AND customer_tags IS NOT NULL 
            AND JSON_LENGTH(customer_tags) > numbers.n
        ) tag_list
        WHERE tag IS NOT NULL AND tag != 'null'
        GROUP BY tag
        ORDER BY count DESC, tag
    </select>

    <!-- ==================== ÂÆ¢Êà∑‰ª∑ÂÄºÂíåÁ≠âÁ∫ßÁÆ°ÁêÜ ==================== -->

    <!-- Êõ¥Êñ∞ÂÆ¢Êà∑‰ª∑ÂÄºËØÑÂà?-->
    <update id="updateCustomerValue">
        UPDATE customers 
        SET customer_value = #{customerValue}, updated_at = NOW()
        WHERE id = #{customerId} AND is_deleted = 0
    </update>

    <!-- Êõ¥Êñ∞ÂÆ¢Êà∑Á≠âÁ∫ß -->
    <update id="updateCustomerLevel">
        UPDATE customers 
        SET customer_level = #{customerLevel}, updated_at = NOW()
        WHERE id = #{customerId} AND is_deleted = 0
    </update>

    <!-- Êõ¥Êñ∞ÂÆ¢Êà∑Á¥ØËÆ°Ê∂àË¥πÈáëÈ¢ù -->
    <update id="updateTotalSpent">
        UPDATE customers 
        SET total_spent = #{totalSpent}, updated_at = NOW()
        WHERE id = #{customerId} AND is_deleted = 0
    </update>

    <!-- Êõ¥Êñ∞ÂÆ¢Êà∑ÊúÄÂêéÊ¥ªË∑ÉÊó∂Èó?-->
    <update id="updateLastActiveAt">
        UPDATE customers 
        SET last_active_at = #{lastActiveAt}, updated_at = NOW()
        WHERE id = #{customerId} AND is_deleted = 0
    </update>

    <!-- ÊâπÈáèÊõ¥Êñ∞ÂÆ¢Êà∑Á≠âÁ∫ß -->
    <update id="batchUpdateCustomerLevel">
        UPDATE customers 
        SET customer_level = #{customerLevel}, updated_at = NOW()
        WHERE id IN
        <foreach collection="customerIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND is_deleted = 0
    </update>

    <!-- ==================== ÂÖ≥ËÅîÊü•ËØ¢ÂäüËÉΩ ==================== -->

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÁöÑËÆæÂ§áÁªüËÆ°‰ø°ÊÅ?-->
    <select id="selectCustomerDeviceStats" resultType="java.util.Map">
        SELECT 
            COUNT(*) as total_devices,
            COUNT(CASE WHEN cdr.relation_type = 'purchased' THEN 1 END) as purchased_devices,
            COUNT(CASE WHEN cdr.relation_type = 'rental' THEN 1 END) as rental_devices,
            COUNT(CASE WHEN d.device_status = 'active' THEN 1 END) as active_devices
        FROM customer_device_relation cdr
        INNER JOIN devices d ON cdr.device_id = d.id AND d.is_deleted = 0
        WHERE cdr.customer_id = #{customerId} AND cdr.status = 1
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÁöÑËÆ¢ÂçïÁªüËÆ°‰ø°ÊÅ?-->
    <select id="selectCustomerOrderStats" resultType="java.util.Map">
        SELECT 
            COUNT(*) as total_orders,
            COALESCE(SUM(o.total_amount), 0) as total_amount,
            COUNT(CASE WHEN o.order_status = 'completed' THEN 1 END) as completed_orders,
            MAX(o.created_at) as last_order_date
        FROM customer_order_relation cor
        INNER JOIN orders o ON cor.order_id = o.id AND o.is_deleted = 0
        WHERE cor.customer_id = #{customerId}
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÁöÑÊúçÂä°ËÆ∞ÂΩïÁªüËÆ°‰ø°ÊÅ?-->
    <select id="selectCustomerServiceStats" resultType="java.util.Map">
        SELECT 
            COUNT(*) as total_services,
            COUNT(CASE WHEN sr.status = 'completed' THEN 1 END) as completed_services,
            COUNT(CASE WHEN sr.status = 'pending' THEN 1 END) as pending_services,
            MAX(sr.created_at) as last_service_date
        FROM customer_service_relation csr
        INNER JOIN service_records sr ON csr.service_record_id = sr.id AND sr.is_deleted = 0
        WHERE csr.customer_id = #{customerId}
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÁöÑÂÆåÊï¥ÁªüËÆ°‰ø°ÊÅ?-->
    <select id="selectCustomerFullStats" resultType="java.util.Map">
        SELECT 
            c.id,
            c.customer_name,
            c.total_spent,
            c.customer_value,
            COALESCE(ds.total_devices, 0) as total_devices,
            COALESCE(ds.active_devices, 0) as active_devices,
            COALESCE(os.total_orders, 0) as total_orders,
            COALESCE(os.total_amount, 0) as total_order_amount,
            COALESCE(ss.total_services, 0) as total_services
        FROM customers c
        LEFT JOIN (
            SELECT 
                cdr.customer_id,
                COUNT(*) as total_devices,
                COUNT(CASE WHEN d.device_status = 'active' THEN 1 END) as active_devices
            FROM customer_device_relation cdr
            INNER JOIN devices d ON cdr.device_id = d.id AND d.is_deleted = 0
            WHERE cdr.status = 1
            GROUP BY cdr.customer_id
        ) ds ON c.id = ds.customer_id
        LEFT JOIN (
            SELECT 
                cor.customer_id,
                COUNT(*) as total_orders,
                COALESCE(SUM(o.total_amount), 0) as total_amount
            FROM customer_order_relation cor
            INNER JOIN orders o ON cor.order_id = o.id AND o.is_deleted = 0
            GROUP BY cor.customer_id
        ) os ON c.id = os.customer_id
        LEFT JOIN (
            SELECT 
                csr.customer_id,
                COUNT(*) as total_services
            FROM customer_service_relation csr
            INNER JOIN service_records sr ON csr.service_record_id = sr.id AND sr.is_deleted = 0
            GROUP BY csr.customer_id
        ) ss ON c.id = ss.customer_id
        WHERE c.id = #{customerId} AND c.is_deleted = 0
    </select>

    <!-- ==================== ÊÄßËÉΩ‰ºòÂåñÊü•ËØ¢ ==================== -->

    <!-- ‰ºòÂåñÁöÑÂÆ¢Êà∑ÂàóË°®Êü•ËØ¢ÔºàÂ∏¶Á¥¢ÂºïÊèêÁ§∫Ôºâ -->
    <select id="selectListOptimized" resultMap="CustomerDTOResultMap">
        SELECT /*+ USE_INDEX(c, idx_customer_level_status) */ <include refid="customerDTOColumns"/>
        FROM customers c
        <include refid="deviceStatsSubquery"/>
        <include refid="whereConditions"/>
        <include refid="orderByClause"/>
        <if test="query != null and query.page != null and query.pageSize != null">
            LIMIT #{query.pageSize} OFFSET #{query.offset}
        </if>
    </select>

    <!-- ‰ºòÂåñÁöÑÂÆ¢Êà∑ÁªüËÆ°Êü•ËØ?-->
    <select id="selectCustomerStatsOptimized" resultMap="CustomerStatsDTOResultMap">
        SELECT /*+ USE_INDEX(customers, idx_customer_level_status) */
            COUNT(*) as total,
            COUNT(CASE WHEN customer_level = 'regular' THEN 1 END) as regular,
            COUNT(CASE WHEN customer_level = 'vip' THEN 1 END) as vip,
            COUNT(CASE WHEN customer_level = 'premium' THEN 1 END) as premium,
            (SELECT /*+ USE_INDEX(d, idx_device_status) */ COUNT(DISTINCT d.id) 
             FROM devices d 
             INNER JOIN customer_device_relation cdr ON d.id = cdr.device_id 
             WHERE d.device_status = 'active' AND d.is_deleted = 0 AND cdr.status = 1) as active_devices,
            COALESCE(SUM(total_spent), 0) as total_revenue,
            COUNT(CASE WHEN registered_at >= DATE_SUB(CURDATE(), INTERVAL 30 DAY) THEN 1 END) as new_this_month
        FROM customers 
        WHERE is_deleted = 0
    </select>

    <!-- ÁºìÂ≠òÂèãÂ•ΩÁöÑÂÆ¢Êà∑Âü∫Êú¨‰ø°ÊÅØÊü•ËØ?-->
    <select id="selectBasicInfoForCache" resultType="java.util.Map">
        SELECT 
            id,
            customer_name,
            customer_level,
            customer_status,
            phone,
            email,
            total_spent,
            customer_value,
            last_active_at
        FROM customers 
        WHERE is_deleted = 0 
        AND is_active = 1
        ORDER BY updated_at DESC
        LIMIT 1000
    </select>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.CustomerOrderMapper">

    <!-- ÂÆ¢Êà∑ËÆ¢ÂçïÂÖ≥ËÅîÂÆû‰ΩìÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="CustomerOrderResultMap" type="com.yxrobot.entity.CustomerOrder">
        <id column="id" property="id"/>
        <result column="customer_id" property="customerId"/>
        <result column="order_id" property="orderId"/>
        <result column="customer_role" property="customerRole"/>
        <result column="relation_notes" property="relationNotes"/>
        <result column="created_time" property="createdTime"/>
        <result column="updated_time" property="updatedTime"/>
        <result column="status" property="status"/>
        <!-- ÂÖ≥ËÅîÁöÑËÆ¢Âçï‰ø°ÊÅ?-->
        <association property="order" javaType="com.yxrobot.entity.Order">
            <id column="order_id" property="id"/>
            <result column="order_number" property="orderNumber"/>
            <result column="order_type" property="orderType"/>
            <result column="order_status" property="orderStatus"/>
            <result column="total_amount" property="totalAmount"/>
            <result column="currency" property="currency"/>
            <result column="payment_status" property="paymentStatus"/>
            <result column="order_date" property="orderDate"/>
            <result column="delivery_date" property="deliveryDate"/>
        </association>
    </resultMap>

    <!-- ÂÆ¢Êà∑ËÆ¢ÂçïÂÖ≥ËÅîDTOÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="CustomerOrderDTOResultMap" type="com.yxrobot.dto.CustomerOrderDTO">
        <id column="id" property="id"/>
        <result column="order_number" property="orderNumber"/>
        <result column="order_type" property="orderType"/>
        <result column="order_status" property="orderStatus"/>
        <result column="total_amount" property="totalAmount"/>
        <result column="currency" property="currency"/>
        <result column="payment_status" property="paymentStatus"/>
        <result column="payment_method" property="paymentMethod"/>
        <result column="order_date" property="orderDate"/>
        <result column="delivery_date" property="deliveryDate"/>
        <result column="shipping_address" property="shippingAddress"/>
        <result column="shipping_fee" property="shippingFee"/>
        <result column="discount_amount" property="discountAmount"/>
        <result column="order_notes" property="notes"/>
        <result column="order_created_at" property="createdAt"/>
        <result column="order_updated_at" property="updatedAt"/>
        <!-- ËÆ¢ÂçïÂïÜÂìÅÊòéÁªÜÔºàÈÄöËøácollectionÊò†Â∞ÑÔº?-->
        <collection property="items" ofType="com.yxrobot.dto.CustomerOrderDTO$OrderItemInfo">
            <id column="item_id" property="id"/>
            <result column="product_id" property="productId"/>
            <result column="product_name" property="productName"/>
            <result column="product_model" property="productModel"/>
            <result column="quantity" property="quantity"/>
            <result column="unit_price" property="unitPrice"/>
            <result column="total_price" property="totalPrice"/>
        </collection>
    </resultMap>

    <!-- ËÆ¢ÂçïÂÆû‰ΩìÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="OrderResultMap" type="com.yxrobot.entity.Order">
        <id column="id" property="id"/>
        <result column="order_number" property="orderNumber"/>
        <result column="order_type" property="orderType"/>
        <result column="order_status" property="orderStatus"/>
        <result column="total_amount" property="totalAmount"/>
        <result column="currency" property="currency"/>
        <result column="payment_status" property="paymentStatus"/>
        <result column="payment_method" property="paymentMethod"/>
        <result column="order_date" property="orderDate"/>
        <result column="delivery_date" property="deliveryDate"/>
        <result column="shipping_address" property="shippingAddress"/>
        <result column="shipping_fee" property="shippingFee"/>
        <result column="discount_amount" property="discountAmount"/>
        <result column="order_notes" property="orderNotes"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="is_deleted" property="isDeleted"/>
    </resultMap>

    <!-- Âü∫Á°ÄSQLÁâáÊÆµ -->
    <sql id="customerOrderColumns">
        cor.id, cor.customer_id, cor.order_id, cor.customer_role, cor.relation_notes,
        cor.created_time, cor.updated_time, cor.status
    </sql>

    <!-- ÂÆ¢Êà∑ËÆ¢ÂçïÂÖ≥ËÅîDTOÊü•ËØ¢SQLÁâáÊÆµÔºàÂåÖÂê´ËÆ¢Âçï‰ø°ÊÅØÔºâ -->
    <sql id="customerOrderDTOColumns">
        cor.id, cor.customer_role, cor.relation_notes,
        o.order_number, o.order_type, o.order_status, o.total_amount, o.currency,
        o.payment_status, o.payment_method, o.order_date, o.delivery_date,
        o.shipping_address, o.shipping_fee, o.discount_amount, o.order_notes,
        o.created_at as order_created_at, o.updated_at as order_updated_at
    </sql>

    <!-- ËÆ¢Âçï‰ø°ÊÅØSQLÁâáÊÆµ -->
    <sql id="orderColumns">
        o.id, o.order_number, o.order_type, o.order_status, o.total_amount, o.currency,
        o.payment_status, o.payment_method, o.order_date, o.delivery_date,
        o.shipping_address, o.shipping_fee, o.discount_amount, o.order_notes,
        o.created_at, o.updated_at, o.is_deleted
    </sql>

    <!-- ==================== Âü∫Á°ÄCRUDÊìç‰Ωú ==================== -->

    <!-- Ê†πÊçÆIDÊü•ËØ¢ÂÆ¢Êà∑ËÆ¢ÂçïÂÖ≥ËÅî -->
    <select id="selectById" resultMap="CustomerOrderResultMap">
        SELECT <include refid="customerOrderColumns"/>,
               <include refid="orderColumns"/>
        FROM customer_order_relation cor
        LEFT JOIN orders o ON cor.order_id = o.id AND o.is_deleted = 0
        WHERE cor.id = #{id} AND cor.status = 1
    </select>

    <!-- Ê†πÊçÆIDÊü•ËØ¢ÂÆ¢Êà∑ËÆ¢ÂçïÂÖ≥ËÅîDTO -->
    <select id="selectDTOById" resultMap="CustomerOrderDTOResultMap">
        SELECT <include refid="customerOrderDTOColumns"/>
        FROM customer_order_relation cor
        INNER JOIN orders o ON cor.order_id = o.id AND o.is_deleted = 0
        WHERE cor.id = #{id} AND cor.status = 1
    </select>

    <!-- Ê†πÊçÆÂÆ¢Êà∑IDÊü•ËØ¢ËÆ¢ÂçïÂÖ≥ËÅîÂàóË°® -->
    <select id="selectByCustomerId" resultMap="CustomerOrderResultMap">
        SELECT <include refid="customerOrderColumns"/>,
               <include refid="orderColumns"/>
        FROM customer_order_relation cor
        LEFT JOIN orders o ON cor.order_id = o.id AND o.is_deleted = 0
        WHERE cor.customer_id = #{customerId} AND cor.status = 1
        ORDER BY cor.created_time DESC
    </select>

    <!-- Ê†πÊçÆÂÆ¢Êà∑IDÊü•ËØ¢ËÆ¢ÂçïÂÖ≥ËÅîDTOÂàóË°® -->
    <select id="selectDTOByCustomerId" resultMap="CustomerOrderDTOResultMap">
        SELECT <include refid="customerOrderDTOColumns"/>,
               oi.id as item_id, oi.product_id, oi.product_name, oi.product_model,
               oi.quantity, oi.unit_price, oi.total_price
        FROM customer_order_relation cor
        INNER JOIN orders o ON cor.order_id = o.id AND o.is_deleted = 0
        LEFT JOIN order_items oi ON o.id = oi.order_id
        WHERE cor.customer_id = #{customerId} AND cor.status = 1
        ORDER BY cor.created_time DESC, oi.id ASC
    </select>

    <!-- Ê†πÊçÆËÆ¢ÂçïIDÊü•ËØ¢ÂÆ¢Êà∑ÂÖ≥ËÅîÂàóË°® -->
    <select id="selectByOrderId" resultMap="CustomerOrderResultMap">
        SELECT <include refid="customerOrderColumns"/>
        FROM customer_order_relation cor
        WHERE cor.order_id = #{orderId} AND cor.status = 1
        ORDER BY cor.created_time DESC
    </select>

    <!-- ÊèíÂÖ•ÂÆ¢Êà∑ËÆ¢ÂçïÂÖ≥ËÅî -->
    <insert id="insert" parameterType="com.yxrobot.entity.CustomerOrder" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO customer_order_relation (
            customer_id, order_id, customer_role, relation_notes, created_time, updated_time, status
        ) VALUES (
            #{customerId}, #{orderId}, #{customerRole}, #{relationNotes}, NOW(), NOW(), 1
        )
    </insert>

    <!-- Êõ¥Êñ∞ÂÆ¢Êà∑ËÆ¢ÂçïÂÖ≥ËÅî -->
    <update id="updateById" parameterType="com.yxrobot.entity.CustomerOrder">
        UPDATE customer_order_relation SET
            customer_role = #{customerRole},
            relation_notes = #{relationNotes},
            updated_time = NOW()
        WHERE id = #{id} AND status = 1
    </update>

    <!-- Ê†πÊçÆIDÂà†Èô§ÂÆ¢Êà∑ËÆ¢ÂçïÂÖ≥ËÅî -->
    <update id="deleteById">
        UPDATE customer_order_relation SET status = 0, updated_time = NOW()
        WHERE id = #{id} AND status = 1
    </update>

    <!-- Ê†πÊçÆÂÆ¢Êà∑IDÂíåËÆ¢ÂçïIDÂà†Èô§ÂÖ≥ËÅî -->
    <update id="deleteByCustomerAndOrder">
        UPDATE customer_order_relation SET status = 0, updated_time = NOW()
        WHERE customer_id = #{customerId} AND order_id = #{orderId} AND status = 1
    </update>

    <!-- ==================== ÂÖ≥ËÅîÊü•ËØ¢ÂäüËÉΩ ==================== -->

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÁöÑÊâÄÊúâËÆ¢Âç?-->
    <select id="selectOrdersByCustomerId" resultMap="OrderResultMap">
        SELECT <include refid="orderColumns"/>
        FROM orders o
        INNER JOIN customer_order_relation cor ON o.id = cor.order_id
        WHERE cor.customer_id = #{customerId} AND cor.status = 1 AND o.is_deleted = 0
        ORDER BY o.order_date DESC
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÁöÑË¥≠‰π∞ËÆ¢ÂçïÂàóË°?-->
    <select id="selectPurchaseOrdersByCustomerId" resultMap="CustomerOrderDTOResultMap">
        SELECT <include refid="customerOrderDTOColumns"/>
        FROM customer_order_relation cor
        INNER JOIN orders o ON cor.order_id = o.id AND o.is_deleted = 0
        WHERE cor.customer_id = #{customerId} AND o.order_type = 'purchase' AND cor.status = 1
        ORDER BY o.order_date DESC
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÁöÑÁßüËµÅËÆ¢ÂçïÂàóË°?-->
    <select id="selectRentalOrdersByCustomerId" resultMap="CustomerOrderDTOResultMap">
        SELECT <include refid="customerOrderDTOColumns"/>
        FROM customer_order_relation cor
        INNER JOIN orders o ON cor.order_id = o.id AND o.is_deleted = 0
        WHERE cor.customer_id = #{customerId} AND o.order_type = 'rental' AND cor.status = 1
        ORDER BY o.order_date DESC
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÁöÑÂ∑≤ÂÆåÊàêËÆ¢ÂçïÂàóË°® -->
    <select id="selectCompletedOrdersByCustomerId" resultMap="CustomerOrderDTOResultMap">
        SELECT <include refid="customerOrderDTOColumns"/>
        FROM customer_order_relation cor
        INNER JOIN orders o ON cor.order_id = o.id AND o.is_deleted = 0
        WHERE cor.customer_id = #{customerId} AND o.order_status = 'completed' AND cor.status = 1
        ORDER BY o.order_date DESC
    </select>

    <!-- ==================== ÁªüËÆ°Êü•ËØ¢ÂäüËÉΩ ==================== -->

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ËÆ¢ÂçïÁªüËÆ°‰ø°ÊÅØ -->
    <select id="selectCustomerOrderStats" resultType="java.util.Map">
        SELECT 
            COUNT(*) as total_orders,
            COUNT(CASE WHEN o.order_type = 'purchase' THEN 1 END) as purchase_orders,
            COUNT(CASE WHEN o.order_type = 'rental' THEN 1 END) as rental_orders,
            COUNT(CASE WHEN o.order_status = 'completed' THEN 1 END) as completed_orders,
            COUNT(CASE WHEN o.order_status = 'pending' THEN 1 END) as pending_orders,
            COUNT(CASE WHEN o.order_status = 'processing' THEN 1 END) as processing_orders,
            COUNT(CASE WHEN o.order_status = 'cancelled' THEN 1 END) as cancelled_orders,
            COALESCE(SUM(o.total_amount), 0) as total_amount,
            COALESCE(AVG(o.total_amount), 0) as avg_order_value,
            COALESCE(MAX(o.total_amount), 0) as max_order_value,
            COALESCE(MIN(o.total_amount), 0) as min_order_value
        FROM customer_order_relation cor
        INNER JOIN orders o ON cor.order_id = o.id AND o.is_deleted = 0
        WHERE cor.customer_id = #{customerId} AND cor.status = 1
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ËÆ¢ÂçïÊï∞ÈáèÁªüËÆ° -->
    <select id="selectCustomerOrderCount" resultType="java.util.Map">
        SELECT 
            COUNT(*) as total,
            COUNT(CASE WHEN o.order_type = 'purchase' THEN 1 END) as purchase,
            COUNT(CASE WHEN o.order_type = 'rental' THEN 1 END) as rental
        FROM customer_order_relation cor
        INNER JOIN orders o ON cor.order_id = o.id AND o.is_deleted = 0
        WHERE cor.customer_id = #{customerId} AND cor.status = 1
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ËÆ¢ÂçïÈáëÈ¢ùÁªüËÆ° -->
    <select id="selectCustomerOrderAmountStats" resultType="java.util.Map">
        SELECT 
            COALESCE(SUM(o.total_amount), 0) as total_amount,
            COALESCE(AVG(o.total_amount), 0) as avg_amount,
            COALESCE(SUM(CASE WHEN o.order_type = 'purchase' THEN o.total_amount ELSE 0 END), 0) as purchase_amount,
            COALESCE(SUM(CASE WHEN o.order_type = 'rental' THEN o.total_amount ELSE 0 END), 0) as rental_amount,
            COALESCE(SUM(CASE WHEN o.order_status = 'completed' THEN o.total_amount ELSE 0 END), 0) as completed_amount
        FROM customer_order_relation cor
        INNER JOIN orders o ON cor.order_id = o.id AND o.is_deleted = 0
        WHERE cor.customer_id = #{customerId} AND cor.status = 1
    </select>

    <!-- Êü•ËØ¢ËÆ¢ÂçïÁ±ªÂûãÂàÜÂ∏ÉÁªüËÆ° -->
    <select id="selectOrderTypeDistribution" resultType="java.util.Map">
        SELECT 
            o.order_type as order_type,
            COUNT(*) as count,
            COALESCE(SUM(o.total_amount), 0) as total_amount,
            ROUND(COUNT(*) * 100.0 / (
                SELECT COUNT(*) 
                FROM customer_order_relation cor2 
                INNER JOIN orders o2 ON cor2.order_id = o2.id AND o2.is_deleted = 0
                WHERE cor2.customer_id = #{customerId} AND cor2.status = 1
            ), 2) as percentage
        FROM customer_order_relation cor
        INNER JOIN orders o ON cor.order_id = o.id AND o.is_deleted = 0
        WHERE cor.customer_id = #{customerId} AND cor.status = 1
        GROUP BY o.order_type
        ORDER BY count DESC
    </select>

    <!-- ==================== Êï∞ÊçÆÈ™åËØÅÂäüËÉΩ ==================== -->

    <!-- Ê£ÄÊü•ÂÆ¢Êà∑ËÆ¢ÂçïÂÖ≥ËÅîÊòØÂê¶Â≠òÂú?-->
    <select id="existsByCustomerAndOrder" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM customer_order_relation
        WHERE customer_id = #{customerId} AND order_id = #{orderId} 
        AND customer_role = #{customerRole} AND status = 1
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ËÆ¢ÂçïÂÖ≥ËÅîÊï∞Èáè -->
    <select id="countByCustomerId" resultType="int">
        SELECT COUNT(*)
        FROM customer_order_relation
        WHERE customer_id = #{customerId} AND status = 1
    </select>

    <!-- Êü•ËØ¢ËÆ¢ÂçïÂÖ≥ËÅîÊï∞Èáè -->
    <select id="countByOrderId" resultType="int">
        SELECT COUNT(*)
        FROM customer_order_relation
        WHERE order_id = #{orderId} AND status = 1
    </select>

    <!-- ==================== ËÆ¢ÂçïÁÆ°ÁêÜÂäüËÉΩ ==================== -->

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÊúÄËøëÁöÑËÆ¢Âçï -->
    <select id="selectRecentOrdersByCustomerId" resultMap="CustomerOrderDTOResultMap">
        SELECT <include refid="customerOrderDTOColumns"/>
        FROM customer_order_relation cor
        INNER JOIN orders o ON cor.order_id = o.id AND o.is_deleted = 0
        WHERE cor.customer_id = #{customerId} AND cor.status = 1
        ORDER BY o.order_date DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÁöÑÂ§ßÈ¢ùËÆ¢Âç?-->
    <select id="selectHighValueOrders" resultMap="CustomerOrderDTOResultMap">
        SELECT <include refid="customerOrderDTOColumns"/>
        FROM customer_order_relation cor
        INNER JOIN orders o ON cor.order_id = o.id AND o.is_deleted = 0
        WHERE cor.customer_id = #{customerId} AND cor.status = 1
        AND o.total_amount >= #{minAmount}
        ORDER BY o.total_amount DESC
    </select>

    <!-- Êü•ËØ¢ÊåáÂÆöÊó•ÊúüËåÉÂõ¥ÂÜÖÁöÑÂÆ¢Êà∑ËÆ¢Âçï -->
    <select id="selectOrdersByDateRange" resultMap="CustomerOrderDTOResultMap">
        SELECT <include refid="customerOrderDTOColumns"/>
        FROM customer_order_relation cor
        INNER JOIN orders o ON cor.order_id = o.id AND o.is_deleted = 0
        WHERE cor.customer_id = #{customerId} AND cor.status = 1
        AND o.order_date BETWEEN #{startDate} AND #{endDate}
        ORDER BY o.order_date DESC
    </select>

    <!-- Êõ¥Êñ∞ËÆ¢ÂçïÂÖ≥ËÅîÁä∂ÊÄ?-->
    <update id="updateRelationStatus">
        UPDATE customer_order_relation SET status = #{status}, updated_time = NOW()
        WHERE id = #{id}
    </update>

    <!-- ÊâπÈáèÊõ¥Êñ∞ËÆ¢ÂçïÂÖ≥ËÅîÁä∂ÊÄ?-->
    <update id="batchUpdateRelationStatus">
        UPDATE customer_order_relation SET status = #{status}, updated_time = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- ==================== È´òÁ∫ßÊü•ËØ¢ÂäüËÉΩ ==================== -->

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÁöÑÂπ≥ÂùáËÆ¢Âçï‰ª∑ÂÄ?-->
    <select id="selectAverageOrderValue" resultType="java.math.BigDecimal">
        SELECT COALESCE(AVG(o.total_amount), 0)
        FROM customer_order_relation cor
        INNER JOIN orders o ON cor.order_id = o.id AND o.is_deleted = 0
        WHERE cor.customer_id = #{customerId} AND cor.status = 1
        AND o.order_status = 'completed'
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÊúàÂ∫¶ËÆ¢ÂçïÁªüËÆ° -->
    <select id="selectMonthlyOrderStats" resultType="java.util.Map">
        SELECT 
            DATE_FORMAT(o.order_date, '%Y-%m') as month,
            COUNT(*) as order_count,
            COALESCE(SUM(o.total_amount), 0) as total_amount,
            COALESCE(AVG(o.total_amount), 0) as avg_amount
        FROM customer_order_relation cor
        INNER JOIN orders o ON cor.order_id = o.id AND o.is_deleted = 0
        WHERE cor.customer_id = #{customerId} AND cor.status = 1
        AND o.order_date >= DATE_SUB(CURDATE(), INTERVAL #{months} MONTH)
        GROUP BY DATE_FORMAT(o.order_date, '%Y-%m')
        ORDER BY month DESC
    </select>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.CustomerServiceRecordMapper">

    <!-- ÂÆ¢Êà∑ÊúçÂä°ËÆ∞ÂΩïÂÖ≥ËÅîÂÆû‰ΩìÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="CustomerServiceRecordResultMap" type="com.yxrobot.entity.CustomerServiceRecord">
        <id column="id" property="id"/>
        <result column="customer_id" property="customerId"/>
        <result column="service_id" property="serviceId"/>
        <result column="customer_role" property="customerRole" />
        <result column="relation_notes" property="relationNotes"/>
        <result column="created_time" property="createdTime"/>
        <result column="updated_time" property="updatedTime"/>
        <result column="status" property="status"/>
        <!-- ÂÖ≥ËÅîÁöÑÊúçÂä°ËÆ∞ÂΩï‰ø°ÊÅ?-->
        <association property="serviceRecord" javaType="com.yxrobot.entity.ServiceRecord">
            <id column="service_id" property="id"/>
            <result column="service_number" property="serviceNumber"/>
            <result column="service_type" property="serviceType" />
            <result column="service_title" property="serviceTitle"/>
            <result column="service_description" property="serviceDescription"/>
            <result column="service_status" property="serviceStatus" />
            <result column="priority" property="priority" />
            <result column="service_cost" property="serviceCost"/>
            <result column="service_date" property="serviceDate"/>
        </association>
    </resultMap>

    <!-- ÊúçÂä°ËÆ∞ÂΩïDTOÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="ServiceRecordDTOResultMap" type="com.yxrobot.dto.ServiceRecordDTO">
        <id column="id" property="id"/>
        <result column="service_number" property="serviceNumber"/>
        <result column="service_type" property="serviceType"/>
        <result column="service_title" property="serviceTitle"/>
        <result column="service_description" property="serviceDescription"/>
        <result column="service_staff" property="serviceStaff"/>
        <result column="service_cost" property="serviceCost"/>
        <result column="service_status" property="serviceStatus"/>
        <result column="priority" property="priority"/>
        <result column="assigned_to" property="assignedTo"/>
        <result column="resolved_at" property="resolvedAt"/>
        <result column="service_date" property="serviceDate"/>
        <result column="service_created_at" property="createdAt"/>
        <result column="service_updated_at" property="updatedAt"/>
        <result column="customer_role" property="customerRole"/>
        <result column="relation_notes" property="notes"/>
    </resultMap>

    <!-- ÊúçÂä°ËÆ∞ÂΩïÂÆû‰ΩìÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="ServiceRecordResultMap" type="com.yxrobot.entity.ServiceRecord">
        <id column="id" property="id"/>
        <result column="service_number" property="serviceNumber"/>
        <result column="service_type" property="serviceType" />
        <result column="service_title" property="serviceTitle"/>
        <result column="service_description" property="serviceDescription"/>
        <result column="service_staff" property="serviceStaff"/>
        <result column="service_cost" property="serviceCost"/>
        <result column="service_status" property="serviceStatus" />
        <result column="priority" property="priority" />
        <result column="assigned_to" property="assignedTo"/>
        <result column="resolved_at" property="resolvedAt"/>
        <result column="service_date" property="serviceDate"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="is_deleted" property="isDeleted"/>
    </resultMap>

    <!-- Âü∫Á°ÄSQLÁâáÊÆµ -->
    <sql id="customerServiceRecordColumns">
        csr.id, csr.customer_id, csr.service_id, csr.customer_role, csr.relation_notes,
        csr.created_time, csr.updated_time, csr.status
    </sql>

    <!-- ÊúçÂä°ËÆ∞ÂΩïDTOÊü•ËØ¢SQLÁâáÊÆµÔºàÂåÖÂê´ÊúçÂä°ËÆ∞ÂΩï‰ø°ÊÅØÔºâ -->
    <sql id="serviceRecordDTOColumns">
        csr.id, csr.customer_role, csr.relation_notes,
        sr.service_number, sr.service_type, sr.service_title, sr.service_description,
        sr.service_staff, sr.service_cost, sr.service_status, sr.priority,
        sr.assigned_to, sr.resolved_at, sr.service_date,
        sr.created_at as service_created_at, sr.updated_at as service_updated_at
    </sql>

    <!-- ÊúçÂä°ËÆ∞ÂΩï‰ø°ÊÅØSQLÁâáÊÆµ -->
    <sql id="serviceRecordColumns">
        sr.id, sr.service_number, sr.service_type, sr.service_title, sr.service_description,
        sr.service_staff, sr.service_cost, sr.service_status, sr.priority,
        sr.assigned_to, sr.resolved_at, sr.service_date,
        sr.created_at, sr.updated_at, sr.is_deleted
    </sql>

    <!-- ==================== Âü∫Á°ÄCRUDÊìç‰Ωú ==================== -->

    <!-- Ê†πÊçÆIDÊü•ËØ¢ÂÆ¢Êà∑ÊúçÂä°ËÆ∞ÂΩïÂÖ≥ËÅî -->
    <select id="selectById" resultMap="CustomerServiceRecordResultMap">
        SELECT <include refid="customerServiceRecordColumns"/>,
               <include refid="serviceRecordColumns"/>
        FROM customer_service_relation csr
        LEFT JOIN service_records sr ON csr.service_id = sr.id AND sr.is_deleted = 0
        WHERE csr.id = #{id} AND csr.status = 1
    </select>

    <!-- Ê†πÊçÆIDÊü•ËØ¢ÊúçÂä°ËÆ∞ÂΩïDTO -->
    <select id="selectDTOById" resultMap="ServiceRecordDTOResultMap">
        SELECT <include refid="serviceRecordDTOColumns"/>
        FROM customer_service_relation csr
        INNER JOIN service_records sr ON csr.service_id = sr.id AND sr.is_deleted = 0
        WHERE csr.id = #{id} AND csr.status = 1
    </select>

    <!-- Ê†πÊçÆÂÆ¢Êà∑IDÊü•ËØ¢ÊúçÂä°ËÆ∞ÂΩïÂÖ≥ËÅîÂàóË°® -->
    <select id="selectByCustomerId" resultMap="CustomerServiceRecordResultMap">
        SELECT <include refid="customerServiceRecordColumns"/>,
               <include refid="serviceRecordColumns"/>
        FROM customer_service_relation csr
        LEFT JOIN service_records sr ON csr.service_id = sr.id AND sr.is_deleted = 0
        WHERE csr.customer_id = #{customerId} AND csr.status = 1
        ORDER BY csr.created_time DESC
    </select>

    <!-- Ê†πÊçÆÂÆ¢Êà∑IDÊü•ËØ¢ÊúçÂä°ËÆ∞ÂΩïDTOÂàóË°® -->
    <select id="selectDTOByCustomerId" resultMap="ServiceRecordDTOResultMap">
        SELECT <include refid="serviceRecordDTOColumns"/>
        FROM customer_service_relation csr
        INNER JOIN service_records sr ON csr.service_id = sr.id AND sr.is_deleted = 0
        WHERE csr.customer_id = #{customerId} AND csr.status = 1
        ORDER BY sr.service_date DESC, csr.created_time DESC
    </select>

    <!-- Ê†πÊçÆÊúçÂä°ËÆ∞ÂΩïIDÊü•ËØ¢ÂÆ¢Êà∑ÂÖ≥ËÅîÂàóË°® -->
    <select id="selectByServiceId" resultMap="CustomerServiceRecordResultMap">
        SELECT <include refid="customerServiceRecordColumns"/>
        FROM customer_service_relation csr
        WHERE csr.service_id = #{serviceId} AND csr.status = 1
        ORDER BY csr.created_time DESC
    </select>

    <!-- ÊèíÂÖ•ÂÆ¢Êà∑ÊúçÂä°ËÆ∞ÂΩïÂÖ≥ËÅî -->
    <insert id="insert" parameterType="com.yxrobot.entity.CustomerServiceRecord" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO customer_service_relation (
            customer_id, service_id, customer_role, relation_notes, created_time, updated_time, status
        ) VALUES (
            #{customerId}, #{serviceId}, #{customerRole}, #{relationNotes}, NOW(), NOW(), 1
        )
    </insert>

    <!-- Êõ¥Êñ∞ÂÆ¢Êà∑ÊúçÂä°ËÆ∞ÂΩïÂÖ≥ËÅî -->
    <update id="updateById" parameterType="com.yxrobot.entity.CustomerServiceRecord">
        UPDATE customer_service_relation SET
            customer_role = #{customerRole},
            relation_notes = #{relationNotes},
            updated_time = NOW()
        WHERE id = #{id} AND status = 1
    </update>

    <!-- Ê†πÊçÆIDÂà†Èô§ÂÆ¢Êà∑ÊúçÂä°ËÆ∞ÂΩïÂÖ≥ËÅî -->
    <update id="deleteById">
        UPDATE customer_service_relation SET status = 0, updated_time = NOW()
        WHERE id = #{id} AND status = 1
    </update>

    <!-- Ê†πÊçÆÂÆ¢Êà∑IDÂíåÊúçÂä°ËÆ∞ÂΩïIDÂà†Èô§ÂÖ≥ËÅî -->
    <update id="deleteByCustomerAndService">
        UPDATE customer_service_relation SET status = 0, updated_time = NOW()
        WHERE customer_id = #{customerId} AND service_id = #{serviceId} AND status = 1
    </update>

    <!-- ==================== ÂÖ≥ËÅîÊü•ËØ¢ÂäüËÉΩ ==================== -->

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÁöÑÊâÄÊúâÊúçÂä°ËÆ∞ÂΩ?-->
    <select id="selectServiceRecordsByCustomerId" resultMap="ServiceRecordResultMap">
        SELECT <include refid="serviceRecordColumns"/>
        FROM service_records sr
        INNER JOIN customer_service_relation csr ON sr.id = csr.service_id
        WHERE csr.customer_id = #{customerId} AND csr.status = 1 AND sr.is_deleted = 0
        ORDER BY sr.service_date DESC
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÁöÑÁª¥Êä§ÊúçÂä°ËÆ∞ÂΩïÂàóË°?-->
    <select id="selectMaintenanceServicesByCustomerId" resultMap="ServiceRecordDTOResultMap">
        SELECT <include refid="serviceRecordDTOColumns"/>
        FROM customer_service_relation csr
        INNER JOIN service_records sr ON csr.service_id = sr.id AND sr.is_deleted = 0
        WHERE csr.customer_id = #{customerId} AND sr.service_type = 'maintenance' AND csr.status = 1
        ORDER BY sr.service_date DESC
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÁöÑÂçáÁ∫ßÊúçÂä°ËÆ∞ÂΩïÂàóË°?-->
    <select id="selectUpgradeServicesByCustomerId" resultMap="ServiceRecordDTOResultMap">
        SELECT <include refid="serviceRecordDTOColumns"/>
        FROM customer_service_relation csr
        INNER JOIN service_records sr ON csr.service_id = sr.id AND sr.is_deleted = 0
        WHERE csr.customer_id = #{customerId} AND sr.service_type = 'upgrade' AND csr.status = 1
        ORDER BY sr.service_date DESC
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÁöÑÂí®ËØ¢ÊúçÂä°ËÆ∞ÂΩïÂàóË°?-->
    <select id="selectConsultationServicesByCustomerId" resultMap="ServiceRecordDTOResultMap">
        SELECT <include refid="serviceRecordDTOColumns"/>
        FROM customer_service_relation csr
        INNER JOIN service_records sr ON csr.service_id = sr.id AND sr.is_deleted = 0
        WHERE csr.customer_id = #{customerId} AND sr.service_type = 'consultation' AND csr.status = 1
        ORDER BY sr.service_date DESC
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÁöÑÊäïËØâÂ§ÑÁêÜËÆ∞ÂΩïÂàóË°?-->
    <select id="selectComplaintServicesByCustomerId" resultMap="ServiceRecordDTOResultMap">
        SELECT <include refid="serviceRecordDTOColumns"/>
        FROM customer_service_relation csr
        INNER JOIN service_records sr ON csr.service_id = sr.id AND sr.is_deleted = 0
        WHERE csr.customer_id = #{customerId} AND sr.service_type = 'complaint' AND csr.status = 1
        ORDER BY sr.service_date DESC
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÁöÑËøõË°å‰∏≠ÊúçÂä°ËÆ∞ÂΩïÂàóË°® -->
    <select id="selectInProgressServicesByCustomerId" resultMap="ServiceRecordDTOResultMap">
        SELECT <include refid="serviceRecordDTOColumns"/>
        FROM customer_service_relation csr
        INNER JOIN service_records sr ON csr.service_id = sr.id AND sr.is_deleted = 0
        WHERE csr.customer_id = #{customerId} AND sr.service_status = 'in_progress' AND csr.status = 1
        ORDER BY sr.service_date DESC
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÁöÑÂ∑≤ÂÆåÊàêÊúçÂä°ËÆ∞ÂΩïÂàóË°® -->
    <select id="selectCompletedServicesByCustomerId" resultMap="ServiceRecordDTOResultMap">
        SELECT <include refid="serviceRecordDTOColumns"/>
        FROM customer_service_relation csr
        INNER JOIN service_records sr ON csr.service_id = sr.id AND sr.is_deleted = 0
        WHERE csr.customer_id = #{customerId} AND sr.service_status = 'completed' AND csr.status = 1
        ORDER BY sr.resolved_at DESC
    </select>

    <!-- ==================== ÁªüËÆ°Êü•ËØ¢ÂäüËÉΩ ==================== -->

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÊúçÂä°ËÆ∞ÂΩïÁªüËÆ°‰ø°ÊÅØ -->
    <select id="selectCustomerServiceStats" resultType="java.util.Map">
        SELECT 
            COUNT(*) as total_services,
            COUNT(CASE WHEN sr.service_type = 'maintenance' THEN 1 END) as maintenance_services,
            COUNT(CASE WHEN sr.service_type = 'upgrade' THEN 1 END) as upgrade_services,
            COUNT(CASE WHEN sr.service_type = 'consultation' THEN 1 END) as consultation_services,
            COUNT(CASE WHEN sr.service_type = 'complaint' THEN 1 END) as complaint_services,
            COUNT(CASE WHEN sr.service_status = 'completed' THEN 1 END) as completed_services,
            COUNT(CASE WHEN sr.service_status = 'in_progress' THEN 1 END) as in_progress_services,
            COUNT(CASE WHEN sr.service_status = 'cancelled' THEN 1 END) as cancelled_services,
            COUNT(CASE WHEN sr.priority = 'urgent' THEN 1 END) as urgent_services,
            COUNT(CASE WHEN sr.priority = 'high' THEN 1 END) as high_priority_services,
            COALESCE(SUM(sr.service_cost), 0) as total_service_cost,
            COALESCE(AVG(sr.service_cost), 0) as avg_service_cost,
            COALESCE(MAX(sr.service_cost), 0) as max_service_cost
        FROM customer_service_relation csr
        INNER JOIN service_records sr ON csr.service_id = sr.id AND sr.is_deleted = 0
        WHERE csr.customer_id = #{customerId} AND csr.status = 1
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÊúçÂä°ËÆ∞ÂΩïÊï∞ÈáèÁªüËÆ° -->
    <select id="selectCustomerServiceCount" resultType="java.util.Map">
        SELECT 
            COUNT(*) as total,
            COUNT(CASE WHEN sr.service_type = 'maintenance' THEN 1 END) as maintenance,
            COUNT(CASE WHEN sr.service_type = 'upgrade' THEN 1 END) as upgrade,
            COUNT(CASE WHEN sr.service_type = 'consultation' THEN 1 END) as consultation,
            COUNT(CASE WHEN sr.service_type = 'complaint' THEN 1 END) as complaint
        FROM customer_service_relation csr
        INNER JOIN service_records sr ON csr.service_id = sr.id AND sr.is_deleted = 0
        WHERE csr.customer_id = #{customerId} AND csr.status = 1
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÊúçÂä°Ë¥πÁî®ÁªüËÆ° -->
    <select id="selectCustomerServiceCostStats" resultType="java.util.Map">
        SELECT 
            COALESCE(SUM(sr.service_cost), 0) as total_cost,
            COALESCE(AVG(sr.service_cost), 0) as avg_cost,
            COALESCE(SUM(CASE WHEN sr.service_type = 'maintenance' THEN sr.service_cost ELSE 0 END), 0) as maintenance_cost,
            COALESCE(SUM(CASE WHEN sr.service_type = 'upgrade' THEN sr.service_cost ELSE 0 END), 0) as upgrade_cost,
            COALESCE(SUM(CASE WHEN sr.service_status = 'completed' THEN sr.service_cost ELSE 0 END), 0) as completed_cost
        FROM customer_service_relation csr
        INNER JOIN service_records sr ON csr.service_id = sr.id AND sr.is_deleted = 0
        WHERE csr.customer_id = #{customerId} AND csr.status = 1
    </select>

    <!-- Êü•ËØ¢ÊúçÂä°Á±ªÂûãÂàÜÂ∏ÉÁªüËÆ° -->
    <select id="selectServiceTypeDistribution" resultType="java.util.Map">
        SELECT 
            sr.service_type as service_type,
            COUNT(*) as count,
            COALESCE(SUM(sr.service_cost), 0) as total_cost,
            ROUND(COUNT(*) * 100.0 / (
                SELECT COUNT(*) 
                FROM customer_service_relation csr2 
                INNER JOIN service_records sr2 ON csr2.service_id = sr2.id AND sr2.is_deleted = 0
                WHERE csr2.customer_id = #{customerId} AND csr2.status = 1
            ), 2) as percentage
        FROM customer_service_relation csr
        INNER JOIN service_records sr ON csr.service_id = sr.id AND sr.is_deleted = 0
        WHERE csr.customer_id = #{customerId} AND csr.status = 1
        GROUP BY sr.service_type
        ORDER BY count DESC
    </select>

    <!-- ==================== Êï∞ÊçÆÈ™åËØÅÂäüËÉΩ ==================== -->

    <!-- Ê£ÄÊü•ÂÆ¢Êà∑ÊúçÂä°ËÆ∞ÂΩïÂÖ≥ËÅîÊòØÂê¶Â≠òÂú?-->
    <select id="existsByCustomerAndService" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM customer_service_relation
        WHERE customer_id = #{customerId} AND service_id = #{serviceId} 
        AND customer_role = #{customerRole} AND status = 1
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÊúçÂä°ËÆ∞ÂΩïÂÖ≥ËÅîÊï∞Èáè -->
    <select id="countByCustomerId" resultType="int">
        SELECT COUNT(*)
        FROM customer_service_relation
        WHERE customer_id = #{customerId} AND status = 1
    </select>

    <!-- Êü•ËØ¢ÊúçÂä°ËÆ∞ÂΩïÂÖ≥ËÅîÊï∞Èáè -->
    <select id="countByServiceId" resultType="int">
        SELECT COUNT(*)
        FROM customer_service_relation
        WHERE service_id = #{serviceId} AND status = 1
    </select>

    <!-- ==================== ÊúçÂä°ÁÆ°ÁêÜÂäüËÉΩ ==================== -->

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÊúÄËøëÁöÑÊúçÂä°ËÆ∞ÂΩï -->
    <select id="selectRecentServicesByCustomerId" resultMap="ServiceRecordDTOResultMap">
        SELECT <include refid="serviceRecordDTOColumns"/>
        FROM customer_service_relation csr
        INNER JOIN service_records sr ON csr.service_id = sr.id AND sr.is_deleted = 0
        WHERE csr.customer_id = #{customerId} AND csr.status = 1
        ORDER BY sr.service_date DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÁöÑÈ´ò‰ºòÂÖàÁ∫ßÊúçÂä°ËÆ∞ÂΩ?-->
    <select id="selectHighPriorityServices" resultMap="ServiceRecordDTOResultMap">
        SELECT <include refid="serviceRecordDTOColumns"/>
        FROM customer_service_relation csr
        INNER JOIN service_records sr ON csr.service_id = sr.id AND sr.is_deleted = 0
        WHERE csr.customer_id = #{customerId} AND csr.status = 1
        AND sr.priority IN ('high', 'urgent')
        ORDER BY 
            CASE sr.priority 
                WHEN 'urgent' THEN 1 
                WHEN 'high' THEN 2 
                ELSE 3 
            END, sr.service_date DESC
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÁöÑÁ¥ßÊÄ•ÊúçÂä°ËÆ∞ÂΩ?-->
    <select id="selectUrgentServices" resultMap="ServiceRecordDTOResultMap">
        SELECT <include refid="serviceRecordDTOColumns"/>
        FROM customer_service_relation csr
        INNER JOIN service_records sr ON csr.service_id = sr.id AND sr.is_deleted = 0
        WHERE csr.customer_id = #{customerId} AND csr.status = 1
        AND sr.priority = 'urgent'
        ORDER BY sr.service_date DESC
    </select>

    <!-- Êü•ËØ¢ÊåáÂÆöÊó•ÊúüËåÉÂõ¥ÂÜÖÁöÑÂÆ¢Êà∑ÊúçÂä°ËÆ∞ÂΩï -->
    <select id="selectServicesByDateRange" resultMap="ServiceRecordDTOResultMap">
        SELECT <include refid="serviceRecordDTOColumns"/>
        FROM customer_service_relation csr
        INNER JOIN service_records sr ON csr.service_id = sr.id AND sr.is_deleted = 0
        WHERE csr.customer_id = #{customerId} AND csr.status = 1
        AND sr.service_date BETWEEN #{startDate} AND #{endDate}
        ORDER BY sr.service_date DESC
    </select>

    <!-- Êü•ËØ¢ÈúÄË¶ÅË∑üËøõÁöÑÊúçÂä°ËÆ∞ÂΩï -->
    <select id="selectServicesNeedingFollowUp" resultMap="ServiceRecordDTOResultMap">
        SELECT <include refid="serviceRecordDTOColumns"/>
        FROM customer_service_relation csr
        INNER JOIN service_records sr ON csr.service_id = sr.id AND sr.is_deleted = 0
        WHERE csr.customer_id = #{customerId} AND csr.status = 1
        AND sr.service_status = 'in_progress'
        ORDER BY sr.priority DESC, sr.service_date ASC
    </select>

    <!-- Êõ¥Êñ∞ÊúçÂä°ËÆ∞ÂΩïÂÖ≥ËÅîÁä∂ÊÄ?-->
    <update id="updateRelationStatus">
        UPDATE customer_service_relation SET status = #{status}, updated_time = NOW()
        WHERE id = #{id}
    </update>

    <!-- ÊâπÈáèÊõ¥Êñ∞ÊúçÂä°ËÆ∞ÂΩïÂÖ≥ËÅîÁä∂ÊÄ?-->
    <update id="batchUpdateRelationStatus">
        UPDATE customer_service_relation SET status = #{status}, updated_time = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- ==================== È´òÁ∫ßÊü•ËØ¢ÂäüËÉΩ ==================== -->

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÁöÑÂπ≥ÂùáÊúçÂä°Ë¥πÁî?-->
    <select id="selectAverageServiceCost" resultType="java.math.BigDecimal">
        SELECT COALESCE(AVG(sr.service_cost), 0)
        FROM customer_service_relation csr
        INNER JOIN service_records sr ON csr.service_id = sr.id AND sr.is_deleted = 0
        WHERE csr.customer_id = #{customerId} AND csr.status = 1
        AND sr.service_status = 'completed'
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÊúàÂ∫¶ÊúçÂä°ÁªüËÆ° -->
    <select id="selectMonthlyServiceStats" resultType="java.util.Map">
        SELECT 
            DATE_FORMAT(sr.service_date, '%Y-%m') as month,
            COUNT(*) as service_count,
            COALESCE(SUM(sr.service_cost), 0) as total_cost,
            COALESCE(AVG(sr.service_cost), 0) as avg_cost
        FROM customer_service_relation csr
        INNER JOIN service_records sr ON csr.service_id = sr.id AND sr.is_deleted = 0
        WHERE csr.customer_id = #{customerId} AND csr.status = 1
        AND sr.service_date >= DATE_SUB(CURDATE(), INTERVAL #{months} MONTH)
        GROUP BY DATE_FORMAT(sr.service_date, '%Y-%m')
        ORDER BY month DESC
    </select>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.CustomerStatsMapper">

    <!-- ÂÆ¢Êà∑ÁªüËÆ°ÂÆû‰ΩìÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="CustomerStatsResultMap" type="com.yxrobot.entity.CustomerStats">
        <id column="id" property="id"/>
        <result column="stat_date" property="statDate"/>
        <result column="total_customers" property="totalCustomers"/>
        <result column="regular_customers" property="regularCustomers"/>
        <result column="vip_customers" property="vipCustomers"/>
        <result column="premium_customers" property="premiumCustomers"/>
        <result column="active_devices" property="activeDevices"/>
        <result column="total_revenue" property="totalRevenue"/>
        <result column="new_customers_this_month" property="newCustomersThisMonth"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <!-- ÂÆ¢Êà∑ÁªüËÆ°DTOÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="CustomerStatsDTOResultMap" type="com.yxrobot.dto.CustomerStatsDTO">
        <result column="total" property="total"/>
        <result column="regular" property="regular"/>
        <result column="vip" property="vip"/>
        <result column="premium" property="premium"/>
        <result column="active_devices" property="activeDevices"/>
        <result column="total_revenue" property="totalRevenue"/>
        <result column="new_this_month" property="newThisMonth"/>
    </resultMap>

    <!-- Âü∫Á°ÄSQLÁâáÊÆµ -->
    <sql id="customerStatsColumns">
        cs.id, cs.stat_date, cs.total_customers, cs.regular_customers, cs.vip_customers,
        cs.premium_customers, cs.active_devices, cs.total_revenue, cs.new_customers_this_month,
        cs.created_at, cs.updated_at
    </sql>

    <!-- ==================== Âü∫Á°ÄCRUDÊìç‰Ωú ==================== -->

    <!-- Ê†πÊçÆIDÊü•ËØ¢ÂÆ¢Êà∑ÁªüËÆ° -->
    <select id="selectById" resultMap="CustomerStatsResultMap">
        SELECT <include refid="customerStatsColumns"/>
        FROM customer_stats cs
        WHERE cs.id = #{id}
    </select>

    <!-- Ê†πÊçÆÁªüËÆ°Êó•ÊúüÊü•ËØ¢ÂÆ¢Êà∑ÁªüËÆ° -->
    <select id="selectByStatDate" resultMap="CustomerStatsResultMap">
        SELECT <include refid="customerStatsColumns"/>
        FROM customer_stats cs
        WHERE cs.stat_date = #{statDate}
    </select>

    <!-- Êü•ËØ¢ÊúÄÊñ∞ÁöÑÂÆ¢Êà∑ÁªüËÆ°Êï∞ÊçÆ -->
    <select id="selectLatest" resultMap="CustomerStatsResultMap">
        SELECT <include refid="customerStatsColumns"/>
        FROM customer_stats cs
        ORDER BY cs.stat_date DESC
        LIMIT 1
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÁªüËÆ°DTO -->
    <select id="selectStatsDTO" resultMap="CustomerStatsDTOResultMap">
        SELECT 
            total_customers as total,
            regular_customers as regular,
            vip_customers as vip,
            premium_customers as premium,
            active_devices,
            total_revenue,
            new_customers_this_month as new_this_month
        FROM customer_stats
        ORDER BY stat_date DESC
        LIMIT 1
    </select>

    <!-- Êü•ËØ¢ÊåáÂÆöÊó•ÊúüÁöÑÂÆ¢Êà∑ÁªüËÆ°DTO -->
    <select id="selectStatsDTOByDate" resultMap="CustomerStatsDTOResultMap">
        SELECT 
            total_customers as total,
            regular_customers as regular,
            vip_customers as vip,
            premium_customers as premium,
            active_devices,
            total_revenue,
            new_customers_this_month as new_this_month
        FROM customer_stats
        WHERE stat_date = #{statDate}
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÁªüËÆ°ÂàóË°® -->
    <select id="selectList" resultMap="CustomerStatsResultMap">
        SELECT <include refid="customerStatsColumns"/>
        FROM customer_stats cs
        WHERE cs.stat_date BETWEEN #{startDate} AND #{endDate}
        ORDER BY cs.stat_date DESC
    </select>

    <!-- ÊèíÂÖ•ÂÆ¢Êà∑ÁªüËÆ° -->
    <insert id="insert" parameterType="com.yxrobot.entity.CustomerStats" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO customer_stats (
            stat_date, total_customers, regular_customers, vip_customers, premium_customers,
            active_devices, total_revenue, new_customers_this_month, created_at, updated_at
        ) VALUES (
            #{statDate}, #{totalCustomers}, #{regularCustomers}, #{vipCustomers}, #{premiumCustomers},
            #{activeDevices}, #{totalRevenue}, #{newCustomersThisMonth}, NOW(), NOW()
        )
    </insert>

    <!-- Êõ¥Êñ∞ÂÆ¢Êà∑ÁªüËÆ° -->
    <update id="updateById" parameterType="com.yxrobot.entity.CustomerStats">
        UPDATE customer_stats SET
            stat_date = #{statDate},
            total_customers = #{totalCustomers},
            regular_customers = #{regularCustomers},
            vip_customers = #{vipCustomers},
            premium_customers = #{premiumCustomers},
            active_devices = #{activeDevices},
            total_revenue = #{totalRevenue},
            new_customers_this_month = #{newCustomersThisMonth},
            updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- Ê†πÊçÆÁªüËÆ°Êó•ÊúüÊõ¥Êñ∞ÂÆ¢Êà∑ÁªüËÆ° -->
    <update id="updateByStatDate" parameterType="com.yxrobot.entity.CustomerStats">
        UPDATE customer_stats SET
            total_customers = #{totalCustomers},
            regular_customers = #{regularCustomers},
            vip_customers = #{vipCustomers},
            premium_customers = #{premiumCustomers},
            active_devices = #{activeDevices},
            total_revenue = #{totalRevenue},
            new_customers_this_month = #{newCustomersThisMonth},
            updated_at = NOW()
        WHERE stat_date = #{statDate}
    </update>

    <!-- Âà†Èô§ÂÆ¢Êà∑ÁªüËÆ° -->
    <delete id="deleteById">
        DELETE FROM customer_stats WHERE id = #{id}
    </delete>

    <!-- Ê†πÊçÆÁªüËÆ°Êó•ÊúüÂà†Èô§ÂÆ¢Êà∑ÁªüËÆ° -->
    <delete id="deleteByStatDate">
        DELETE FROM customer_stats WHERE stat_date = #{statDate}
    </delete>

    <!-- ==================== ÂÆûÊó∂ÁªüËÆ°ËÆ°ÁÆó ==================== -->

    <!-- ËÆ°ÁÆóÂπ∂ËøîÂõûÂÆûÊó∂ÂÆ¢Êà∑ÁªüËÆ°Êï∞Êç?-->
    <select id="calculateRealTimeStats" resultMap="CustomerStatsDTOResultMap">
        SELECT 
            COUNT(*) as total,
            COUNT(CASE WHEN customer_level = 'regular' THEN 1 END) as regular,
            COUNT(CASE WHEN customer_level = 'vip' THEN 1 END) as vip,
            COUNT(CASE WHEN customer_level = 'premium' THEN 1 END) as premium,
            (SELECT COUNT(DISTINCT d.id) 
             FROM devices d 
             INNER JOIN customer_device_relation cdr ON d.id = cdr.device_id 
             WHERE d.device_status = 'active' AND d.is_deleted = 0 AND cdr.status = 1) as active_devices,
            COALESCE(SUM(total_spent), 0) as total_revenue,
            COUNT(CASE WHEN DATE(registered_at) >= DATE_SUB(CURDATE(), INTERVAL 30 DAY) THEN 1 END) as new_this_month
        FROM customers 
        WHERE is_deleted = 0
    </select>

    <!-- ËÆ°ÁÆóÊÄªÂÆ¢Êà∑Êï∞ -->
    <select id="calculateTotalCustomers" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM customers 
        WHERE is_deleted = 0
    </select>

    <!-- ËÆ°ÁÆóÂêÑÁ≠âÁ∫ßÂÆ¢Êà∑Êï∞Èá?-->
    <select id="calculateCustomerLevelCounts" resultType="java.util.Map">
        SELECT 
            'regular' as level, COUNT(CASE WHEN customer_level = 'regular' THEN 1 END) as count
        FROM customers WHERE is_deleted = 0
        UNION ALL
        SELECT 
            'vip' as level, COUNT(CASE WHEN customer_level = 'vip' THEN 1 END) as count
        FROM customers WHERE is_deleted = 0
        UNION ALL
        SELECT 
            'premium' as level, COUNT(CASE WHEN customer_level = 'premium' THEN 1 END) as count
        FROM customers WHERE is_deleted = 0
    </select>

    <!-- ËÆ°ÁÆóÊ¥ªË∑ÉËÆæÂ§áÊï?-->
    <select id="calculateActiveDeviceCount" resultType="java.lang.Integer">
        SELECT COUNT(DISTINCT d.id)
        FROM devices d 
        INNER JOIN customer_device_relation cdr ON d.id = cdr.device_id 
        WHERE d.device_status = 'active' AND d.is_deleted = 0 AND cdr.status = 1
    </select>

    <!-- ËÆ°ÁÆóÊÄªÊî∂ÂÖ?-->
    <select id="calculateTotalRevenue" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(total_spent), 0)
        FROM customers 
        WHERE is_deleted = 0
    </select>

    <!-- ËÆ°ÁÆóÊú¨ÊúàÊñ∞Â¢ûÂÆ¢Êà∑Êï?-->
    <select id="calculateNewCustomersThisMonth" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM customers 
        WHERE is_deleted = 0 
        AND DATE(registered_at) >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
    </select>

    <!-- ËÆ°ÁÆóÊåáÂÆöÊúà‰ªΩÊñ∞Â¢ûÂÆ¢Êà∑Êï?-->
    <select id="calculateNewCustomersByMonth" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM customers 
        WHERE is_deleted = 0 
        AND YEAR(registered_at) = #{year}
        AND MONTH(registered_at) = #{month}
    </select>

    <!-- ==================== ÁªüËÆ°Êï∞ÊçÆÁîüÊàê ==================== -->

    <!-- ÁîüÊàêÊåáÂÆöÊó•ÊúüÁöÑÂÆ¢Êà∑ÁªüËÆ°Êï∞Êç?-->
    <insert id="generateStatsForDate">
        INSERT INTO customer_stats (
            stat_date, total_customers, regular_customers, vip_customers, premium_customers,
            active_devices, total_revenue, new_customers_this_month, created_at, updated_at
        )
        SELECT 
            #{statDate} as stat_date,
            COUNT(*) as total_customers,
            COUNT(CASE WHEN customer_level = 'regular' THEN 1 END) as regular_customers,
            COUNT(CASE WHEN customer_level = 'vip' THEN 1 END) as vip_customers,
            COUNT(CASE WHEN customer_level = 'premium' THEN 1 END) as premium_customers,
            (SELECT COUNT(DISTINCT d.id) 
             FROM devices d 
             INNER JOIN customer_device_relation cdr ON d.id = cdr.device_id 
             WHERE d.device_status = 'active' AND d.is_deleted = 0 AND cdr.status = 1) as active_devices,
            COALESCE(SUM(total_spent), 0) as total_revenue,
            COUNT(CASE WHEN DATE(registered_at) >= DATE_SUB(#{statDate}, INTERVAL 30 DAY) THEN 1 END) as new_customers_this_month,
            NOW() as created_at,
            NOW() as updated_at
        FROM customers 
        WHERE is_deleted = 0
        AND created_at <= DATE_ADD(#{statDate}, INTERVAL 1 DAY)
    </insert>

    <!-- ÁîüÊàê‰ªäÊó•ÂÆ¢Êà∑ÁªüËÆ°Êï∞ÊçÆ -->
    <insert id="generateTodayStats">
        INSERT INTO customer_stats (
            stat_date, total_customers, regular_customers, vip_customers, premium_customers,
            active_devices, total_revenue, new_customers_this_month, created_at, updated_at
        )
        SELECT 
            CURDATE() as stat_date,
            COUNT(*) as total_customers,
            COUNT(CASE WHEN customer_level = 'regular' THEN 1 END) as regular_customers,
            COUNT(CASE WHEN customer_level = 'vip' THEN 1 END) as vip_customers,
            COUNT(CASE WHEN customer_level = 'premium' THEN 1 END) as premium_customers,
            (SELECT COUNT(DISTINCT d.id) 
             FROM devices d 
             INNER JOIN customer_device_relation cdr ON d.id = cdr.device_id 
             WHERE d.device_status = 'active' AND d.is_deleted = 0 AND cdr.status = 1) as active_devices,
            COALESCE(SUM(total_spent), 0) as total_revenue,
            COUNT(CASE WHEN DATE(registered_at) >= DATE_SUB(CURDATE(), INTERVAL 30 DAY) THEN 1 END) as new_customers_this_month,
            NOW() as created_at,
            NOW() as updated_at
        FROM customers 
        WHERE is_deleted = 0
        ON DUPLICATE KEY UPDATE
            total_customers = VALUES(total_customers),
            regular_customers = VALUES(regular_customers),
            vip_customers = VALUES(vip_customers),
            premium_customers = VALUES(premium_customers),
            active_devices = VALUES(active_devices),
            total_revenue = VALUES(total_revenue),
            new_customers_this_month = VALUES(new_customers_this_month),
            updated_at = NOW()
    </insert>

    <!-- Êõ¥Êñ∞ÊàñÊèíÂÖ•ÂÆ¢Êà∑ÁªüËÆ°Êï∞Êç?-->
    <insert id="upsertStats" parameterType="com.yxrobot.entity.CustomerStats">
        INSERT INTO customer_stats (
            stat_date, total_customers, regular_customers, vip_customers, premium_customers,
            active_devices, total_revenue, new_customers_this_month, created_at, updated_at
        ) VALUES (
            #{statDate}, #{totalCustomers}, #{regularCustomers}, #{vipCustomers}, #{premiumCustomers},
            #{activeDevices}, #{totalRevenue}, #{newCustomersThisMonth}, NOW(), NOW()
        )
        ON DUPLICATE KEY UPDATE
            total_customers = VALUES(total_customers),
            regular_customers = VALUES(regular_customers),
            vip_customers = VALUES(vip_customers),
            premium_customers = VALUES(premium_customers),
            active_devices = VALUES(active_devices),
            total_revenue = VALUES(total_revenue),
            new_customers_this_month = VALUES(new_customers_this_month),
            updated_at = NOW()
    </insert>

    <!-- ==================== Ë∂ãÂäøÂàÜÊûêÊü•ËØ¢ ==================== -->

    <!-- Êü•ËØ¢ÂÆ¢Êà∑Êï∞ÈáèË∂ãÂäøÔºàÊåâÊó•Ôºâ -->
    <select id="selectCustomerTrendByDay" resultType="java.util.Map">
        SELECT 
            stat_date as date,
            total_customers as total,
            regular_customers as regular,
            vip_customers as vip,
            premium_customers as premium
        FROM customer_stats
        WHERE stat_date >= DATE_SUB(CURDATE(), INTERVAL #{days} DAY)
        ORDER BY stat_date ASC
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑Êï∞ÈáèË∂ãÂäøÔºàÊåâÊúàÔºâ -->
    <select id="selectCustomerTrendByMonth" resultType="java.util.Map">
        SELECT 
            DATE_FORMAT(stat_date, '%Y-%m') as month,
            AVG(total_customers) as avg_total,
            AVG(regular_customers) as avg_regular,
            AVG(vip_customers) as avg_vip,
            AVG(premium_customers) as avg_premium,
            MAX(total_customers) as max_total,
            MIN(total_customers) as min_total
        FROM customer_stats
        WHERE stat_date >= DATE_SUB(CURDATE(), INTERVAL #{months} MONTH)
        GROUP BY DATE_FORMAT(stat_date, '%Y-%m')
        ORDER BY month ASC
    </select>

    <!-- Êü•ËØ¢Êî∂ÂÖ•Ë∂ãÂäø -->
    <select id="selectRevenueTrend" resultType="java.util.Map">
        SELECT 
            DATE_FORMAT(stat_date, '%Y-%m') as month,
            AVG(total_revenue) as avg_revenue,
            MAX(total_revenue) as max_revenue,
            MIN(total_revenue) as min_revenue
        FROM customer_stats
        WHERE stat_date >= DATE_SUB(CURDATE(), INTERVAL #{months} MONTH)
        GROUP BY DATE_FORMAT(stat_date, '%Y-%m')
        ORDER BY month ASC
    </select>

    <!-- Êü•ËØ¢Êñ∞Â¢ûÂÆ¢Êà∑Ë∂ãÂäø -->
    <select id="selectNewCustomerTrend" resultType="java.util.Map">
        SELECT 
            DATE_FORMAT(stat_date, '%Y-%m') as month,
            AVG(new_customers_this_month) as avg_new_customers,
            MAX(new_customers_this_month) as max_new_customers,
            MIN(new_customers_this_month) as min_new_customers
        FROM customer_stats
        WHERE stat_date >= DATE_SUB(CURDATE(), INTERVAL #{months} MONTH)
        GROUP BY DATE_FORMAT(stat_date, '%Y-%m')
        ORDER BY month ASC
    </select>

    <!-- ==================== Êï∞ÊçÆÈ™åËØÅÂíåÁª¥Êä?==================== -->

    <!-- Ê£ÄÊü•ÊåáÂÆöÊó•ÊúüÁöÑÁªüËÆ°Êï∞ÊçÆÊòØÂê¶Â≠òÂú® -->
    <select id="existsByStatDate" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM customer_stats
        WHERE stat_date = #{statDate}
    </select>

    <!-- Êü•ËØ¢ÁªüËÆ°Êï∞ÊçÆÁöÑÊó•ÊúüËåÉÂõ?-->
    <select id="selectDateRange" resultType="java.util.Map">
        SELECT 
            MIN(stat_date) as min_date,
            MAX(stat_date) as max_date,
            COUNT(*) as total_records
        FROM customer_stats
    </select>

    <!-- Ê∏ÖÁêÜËøáÊúüÁöÑÁªüËÆ°Êï∞Êç?-->
    <delete id="cleanupOldStats">
        DELETE FROM customer_stats 
        WHERE stat_date &lt; DATE_SUB(CURDATE(), INTERVAL #{keepDays} DAY)
    </delete>

    <!-- ==================== ÁºìÂ≠òÊîØÊåÅÊü•ËØ¢ ==================== -->

    <!-- Êü•ËØ¢Áî®‰∫éÁºìÂ≠òÁöÑÂü∫Á°ÄÁªüËÆ°Êï∞ÊçÆ -->
    <select id="selectBasicStatsForCache" resultType="java.util.Map">
        SELECT 
            total_customers,
            regular_customers,
            vip_customers,
            premium_customers,
            active_devices,
            total_revenue,
            new_customers_this_month,
            stat_date
        FROM customer_stats
        ORDER BY stat_date DESC
        LIMIT 1
    </select>

    <!-- Êü•ËØ¢Áî®‰∫éÁºìÂ≠òÁöÑË∂ãÂäøÊï∞Êç?-->
    <select id="selectTrendDataForCache" resultType="java.util.Map">
        SELECT 
            stat_date as date,
            total_customers as total,
            regular_customers as regular,
            vip_customers as vip,
            premium_customers as premium,
            total_revenue as revenue
        FROM customer_stats
        WHERE stat_date >= DATE_SUB(CURDATE(), INTERVAL #{days} DAY)
        ORDER BY stat_date ASC
    </select>

    <!-- Êü•ËØ¢Áî®‰∫éÁºìÂ≠òÁöÑÂàÜÂ∏ÉÊï∞Êç?-->
    <select id="selectDistributionDataForCache" resultType="java.util.Map">
        SELECT 
            'level_distribution' as type,
            JSON_OBJECT(
                'regular', regular_customers,
                'vip', vip_customers,
                'premium', premium_customers
            ) as data
        FROM customer_stats
        ORDER BY stat_date DESC
        LIMIT 1
    </select>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.LinkClickLogMapper">

    <!-- ÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="LinkClickLogResultMap" type="com.yxrobot.entity.LinkClickLog">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="link_id" property="linkId" jdbcType="BIGINT"/>
        <result column="user_ip" property="userIp" jdbcType="VARCHAR"/>
        <result column="user_agent" property="userAgent" jdbcType="VARCHAR"/>
        <result column="referer" property="referer" jdbcType="VARCHAR"/>
        <result column="clicked_at" property="clickedAt" jdbcType="TIMESTAMP"/>
        <result column="is_conversion" property="isConversion" jdbcType="TINYINT"/>
        <result column="conversion_type" property="conversionType" jdbcType="VARCHAR"/>
        <result column="conversion_value" property="conversionValue" jdbcType="DECIMAL"/>
    </resultMap>

    <!-- Âü∫Á°ÄÂà?-->
    <sql id="Base_Column_List">
        id, link_id, user_ip, user_agent, referer, clicked_at, 
        is_conversion, conversion_type, conversion_value
    </sql>

    <!-- Ê†πÊçÆIDÊü•ËØ¢ -->
    <select id="selectById" resultMap="LinkClickLogResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM link_click_logs
        WHERE id = #{id}
    </select>

    <!-- Ê†πÊçÆÈìæÊé•IDÊü•ËØ¢ÁÇπÂáªÊó•ÂøóÂàóË°® -->
    <select id="selectByLinkId" resultMap="LinkClickLogResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM link_click_logs
        WHERE link_id = #{linkId}
        ORDER BY clicked_at DESC
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>

    <!-- ÊèíÂÖ•ÁÇπÂáªÊó•Âøó -->
    <insert id="insert" parameterType="com.yxrobot.entity.LinkClickLog" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO link_click_logs (
            link_id, user_ip, user_agent, referer, clicked_at, 
            is_conversion, conversion_type, conversion_value
        ) VALUES (
            #{linkId}, #{userIp}, #{userAgent}, #{referer}, #{clickedAt},
            #{isConversion}, #{conversionType}, #{conversionValue}
        )
    </insert>

    <!-- ÊâπÈáèÊèíÂÖ•ÁÇπÂáªÊó•Âøó -->
    <insert id="batchInsert" parameterType="list">
        INSERT INTO link_click_logs (
            link_id, user_ip, user_agent, referer, clicked_at, 
            is_conversion, conversion_type, conversion_value
        ) VALUES
        <foreach collection="logs" item="log" separator=",">
            (#{log.linkId}, #{log.userIp}, #{log.userAgent}, #{log.referer}, #{log.clickedAt},
             #{log.isConversion}, #{log.conversionType}, #{log.conversionValue})
        </foreach>
    </insert>

    <!-- Êõ¥Êñ∞ËΩ¨Âåñ‰ø°ÊÅØ -->
    <update id="updateConversion">
        UPDATE link_click_logs
        SET is_conversion = 1,
            conversion_type = #{conversionType},
            conversion_value = #{conversionValue}
        WHERE id = #{id}
    </update>

    <!-- Âà†Èô§ÊåáÂÆöÊó∂Èó¥‰πãÂâçÁöÑÊó•Âø?-->
    <delete id="deleteBeforeTime">
        DELETE FROM link_click_logs
        WHERE clicked_at &lt; #{beforeTime}
    </delete>

    <!-- ÁªüËÆ°ÈìæÊé•ÁÇπÂáªÈá?-->
    <select id="selectClickCount" resultType="long">
        SELECT COUNT(*)
        FROM link_click_logs
        <where>
            <if test="linkId != null">
                AND link_id = #{linkId}
            </if>
            <if test="startTime != null">
                AND clicked_at &gt;= #{startTime}
            </if>
            <if test="endTime != null">
                AND clicked_at &lt;= #{endTime}
            </if>
        </where>
    </select>

    <!-- ÁªüËÆ°ÈìæÊé•ËΩ¨ÂåñÈá?-->
    <select id="selectConversionCount" resultType="long">
        SELECT COUNT(*)
        FROM link_click_logs
        <where>
            is_conversion = 1
            <if test="linkId != null">
                AND link_id = #{linkId}
            </if>
            <if test="startTime != null">
                AND clicked_at &gt;= #{startTime}
            </if>
            <if test="endTime != null">
                AND clicked_at &lt;= #{endTime}
            </if>
        </where>
    </select>

    <!-- Ëé∑ÂèñÁÇπÂáªË∂ãÂäøÊï∞ÊçÆ -->
    <select id="selectClickTrends" resultType="map">
        SELECT 
            DATE(clicked_at) as date,
            COUNT(*) as clickCount,
            COUNT(DISTINCT user_ip) as uniqueVisitors
        FROM link_click_logs
        WHERE clicked_at &gt;= DATE_SUB(CURDATE(), INTERVAL #{days} DAY)
        <if test="linkId != null">
            AND link_id = #{linkId}
        </if>
        GROUP BY DATE(clicked_at)
        ORDER BY date DESC
    </select>

    <!-- Ëé∑ÂèñËΩ¨ÂåñË∂ãÂäøÊï∞ÊçÆ -->
    <select id="selectConversionTrends" resultType="map">
        SELECT 
            DATE(clicked_at) as date,
            COUNT(*) as conversionCount,
            COALESCE(SUM(conversion_value), 0) as totalValue
        FROM link_click_logs
        WHERE is_conversion = 1
          AND clicked_at &gt;= DATE_SUB(CURDATE(), INTERVAL #{days} DAY)
        <if test="linkId != null">
            AND link_id = #{linkId}
        </if>
        GROUP BY DATE(clicked_at)
        ORDER BY date DESC
    </select>

    <!-- Ëé∑ÂèñÁî®Êà∑ËÆæÂ§áÁªüËÆ° -->
    <select id="selectDeviceStats" resultType="map">
        SELECT 
            CASE 
                WHEN LOWER(user_agent) LIKE '%mobile%' OR LOWER(user_agent) LIKE '%android%' OR LOWER(user_agent) LIKE '%iphone%' THEN 'ÁßªÂä®ËÆæÂ§á'
                WHEN LOWER(user_agent) LIKE '%tablet%' OR LOWER(user_agent) LIKE '%ipad%' THEN 'Âπ≥ÊùøËÆæÂ§á'
                ELSE 'Ê°åÈù¢ËÆæÂ§á'
            END as deviceType,
            COUNT(*) as clickCount,
            COUNT(CASE WHEN is_conversion = 1 THEN 1 END) as conversionCount
        FROM link_click_logs
        <where>
            user_agent IS NOT NULL
            <if test="linkId != null">
                AND link_id = #{linkId}
            </if>
            <if test="startTime != null">
                AND clicked_at &gt;= #{startTime}
            </if>
            <if test="endTime != null">
                AND clicked_at &lt;= #{endTime}
            </if>
        </where>
        GROUP BY deviceType
        ORDER BY clickCount DESC
    </select>

    <!-- Ëé∑ÂèñÊù•Ê∫êÁªüËÆ° -->
    <select id="selectRefererStats" resultType="map">
        SELECT 
            CASE 
                WHEN referer IS NULL OR referer = '' THEN 'Áõ¥Êé•ËÆøÈóÆ'
                WHEN referer LIKE '%google%' THEN 'Google'
                WHEN referer LIKE '%baidu%' THEN 'ÁôæÂ∫¶'
                WHEN referer LIKE '%bing%' THEN 'Bing'
                WHEN referer LIKE '%facebook%' THEN 'Facebook'
                WHEN referer LIKE '%twitter%' THEN 'Twitter'
                ELSE 'ÂÖ∂‰ªñÁΩëÁ´ô'
            END as refererSource,
            COUNT(*) as clickCount,
            COUNT(CASE WHEN is_conversion = 1 THEN 1 END) as conversionCount
        FROM link_click_logs
        <where>
            <if test="linkId != null">
                AND link_id = #{linkId}
            </if>
            <if test="startTime != null">
                AND clicked_at &gt;= #{startTime}
            </if>
            <if test="endTime != null">
                AND clicked_at &lt;= #{endTime}
            </if>
        </where>
        GROUP BY refererSource
        ORDER BY clickCount DESC
    </select>

    <!-- Êõ¥Êñ∞ÈìæÊé•ÁöÑÁÇπÂáªÁªüËÆ?-->
    <update id="updateLinkClickStats">
        UPDATE platform_links pl
        SET 
            click_count = (
                SELECT COUNT(*) 
                FROM link_click_logs 
                WHERE link_id = #{linkId}
            ),
            conversion_count = (
                SELECT COUNT(*) 
                FROM link_click_logs 
                WHERE link_id = #{linkId} AND is_conversion = 1
            ),
            updated_at = NOW()
        WHERE id = #{linkId} AND is_deleted = 0
    </update>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.LinkValidationLogMapper">

    <!-- ÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="LinkValidationLogResultMap" type="com.yxrobot.entity.LinkValidationLog">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="link_id" property="linkId" jdbcType="BIGINT"/>
        <result column="is_valid" property="isValid" jdbcType="TINYINT"/>
        <result column="status_code" property="statusCode" jdbcType="INTEGER"/>
        <result column="response_time" property="responseTime" jdbcType="INTEGER"/>
        <result column="error_message" property="errorMessage" jdbcType="VARCHAR"/>
        <result column="checked_at" property="checkedAt" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!-- Âü∫Á°ÄÂà?-->
    <sql id="Base_Column_List">
        id, link_id, is_valid, status_code, response_time, error_message, checked_at
    </sql>

    <!-- Ê†πÊçÆIDÊü•ËØ¢ -->
    <select id="selectById" resultMap="LinkValidationLogResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM link_validation_logs
        WHERE id = #{id}
    </select>

    <!-- Ê†πÊçÆÈìæÊé•IDÊü•ËØ¢È™åËØÅÊó•ÂøóÂàóË°® -->
    <select id="selectByLinkId" resultMap="LinkValidationLogResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM link_validation_logs
        WHERE link_id = #{linkId}
        ORDER BY checked_at DESC
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>

    <!-- Êü•ËØ¢ÊúÄÊñ∞ÁöÑÈ™åËØÅÊó•Âøó -->
    <select id="selectLatestByLinkId" resultMap="LinkValidationLogResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM link_validation_logs
        WHERE link_id = #{linkId}
        ORDER BY checked_at DESC
        LIMIT 1
    </select>

    <!-- ÊèíÂÖ•È™åËØÅÊó•Âøó -->
    <insert id="insert" parameterType="com.yxrobot.entity.LinkValidationLog" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO link_validation_logs (
            link_id, is_valid, status_code, response_time, error_message, checked_at
        ) VALUES (
            #{linkId}, #{isValid}, #{statusCode}, #{responseTime}, #{errorMessage}, #{checkedAt}
        )
    </insert>

    <!-- ÊâπÈáèÊèíÂÖ•È™åËØÅÊó•Âøó -->
    <insert id="batchInsert" parameterType="list">
        INSERT INTO link_validation_logs (
            link_id, is_valid, status_code, response_time, error_message, checked_at
        ) VALUES
        <foreach collection="logs" item="log" separator=",">
            (#{log.linkId}, #{log.isValid}, #{log.statusCode}, #{log.responseTime}, #{log.errorMessage}, #{log.checkedAt})
        </foreach>
    </insert>

    <!-- Âà†Èô§ÊåáÂÆöÊó∂Èó¥‰πãÂâçÁöÑÊó•Âø?-->
    <delete id="deleteBeforeTime">
        DELETE FROM link_validation_logs
        WHERE checked_at &lt; #{beforeTime}
    </delete>

    <!-- ÁªüËÆ°È™åËØÅÊàêÂäüÁé?-->
    <select id="selectSuccessRate" resultType="double">
        SELECT 
            CASE 
                WHEN COUNT(*) = 0 THEN 0.0
                ELSE ROUND((SUM(CASE WHEN is_valid = 1 THEN 1 ELSE 0 END) * 100.0 / COUNT(*)), 2)
            END as successRate
        FROM link_validation_logs
        <where>
            <if test="linkId != null">
                AND link_id = #{linkId}
            </if>
            <if test="startTime != null">
                AND checked_at &gt;= #{startTime}
            </if>
            <if test="endTime != null">
                AND checked_at &lt;= #{endTime}
            </if>
        </where>
    </select>

    <!-- ÁªüËÆ°Âπ≥ÂùáÂìçÂ∫îÊó∂Èó¥ -->
    <select id="selectAverageResponseTime" resultType="double">
        SELECT 
            CASE 
                WHEN COUNT(*) = 0 THEN 0.0
                ELSE ROUND(AVG(response_time), 2)
            END as avgResponseTime
        FROM link_validation_logs
        <where>
            response_time IS NOT NULL
            <if test="linkId != null">
                AND link_id = #{linkId}
            </if>
            <if test="startTime != null">
                AND checked_at &gt;= #{startTime}
            </if>
            <if test="endTime != null">
                AND checked_at &lt;= #{endTime}
            </if>
        </where>
    </select>

    <!-- Êü•ËØ¢È™åËØÅÂéÜÂè≤ÁªüËÆ° -->
    <select id="selectValidationHistory" resultType="map">
        SELECT 
            DATE(checked_at) as date,
            COUNT(*) as totalChecks,
            SUM(CASE WHEN is_valid = 1 THEN 1 ELSE 0 END) as successfulChecks,
            ROUND((SUM(CASE WHEN is_valid = 1 THEN 1 ELSE 0 END) * 100.0 / COUNT(*)), 2) as successRate,
            ROUND(AVG(CASE WHEN response_time IS NOT NULL THEN response_time END), 2) as avgResponseTime
        FROM link_validation_logs
        WHERE link_id = #{linkId}
          AND checked_at &gt;= DATE_SUB(CURDATE(), INTERVAL #{days} DAY)
        GROUP BY DATE(checked_at)
        ORDER BY date DESC
    </select>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.NewsCategoryMapper">

    <!-- ÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="NewsCategoryResultMap" type="com.yxrobot.entity.NewsCategory">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="name" property="name" jdbcType="VARCHAR"/>
        <result column="description" property="description" jdbcType="VARCHAR"/>
        <result column="sort_order" property="sortOrder" jdbcType="INTEGER"/>
        <result column="is_enabled" property="isEnabled" jdbcType="TINYINT"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!-- Âü∫Á°ÄÂ≠óÊÆµ -->
    <sql id="Base_Column_List">
        id, name, description, sort_order, is_enabled, created_at, updated_at
    </sql>

    <!-- ÊèíÂÖ•Êñ∞ÈóªÂàÜÁ±ª -->
    <insert id="insert" parameterType="com.yxrobot.entity.NewsCategory" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO news_categories (
            name, description, sort_order, is_enabled, created_at, updated_at
        ) VALUES (
            #{name}, #{description}, #{sortOrder}, #{isEnabled}, NOW(), NOW()
        )
    </insert>

    <!-- Ê†πÊçÆIDÂà†Èô§Êñ∞ÈóªÂàÜÁ±ª -->
    <delete id="deleteById" parameterType="java.lang.Long">
        DELETE FROM news_categories WHERE id = #{id}
    </delete>

    <!-- Êõ¥Êñ∞Êñ∞ÈóªÂàÜÁ±ª -->
    <update id="updateById" parameterType="com.yxrobot.entity.NewsCategory">
        UPDATE news_categories
        <set>
            <if test="name != null and name != ''">name = #{name},</if>
            <if test="description != null">description = #{description},</if>
            <if test="sortOrder != null">sort_order = #{sortOrder},</if>
            <if test="isEnabled != null">is_enabled = #{isEnabled},</if>
            updated_at = NOW()
        </set>
        WHERE id = #{id}
    </update>

    <!-- Ê†πÊçÆIDÊü•ËØ¢Êñ∞ÈóªÂàÜÁ±ª -->
    <select id="selectById" parameterType="java.lang.Long" resultMap="NewsCategoryResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM news_categories
        WHERE id = #{id}
    </select>

    <!-- Ê†πÊçÆÂêçÁß∞Êü•ËØ¢Êñ∞ÈóªÂàÜÁ±ª -->
    <select id="selectByName" parameterType="java.lang.String" resultMap="NewsCategoryResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM news_categories
        WHERE name = #{name}
    </select>

    <!-- Êü•ËØ¢ÊâÄÊúâÂêØÁî®ÁöÑÊñ∞ÈóªÂàÜÁ±ª -->
    <select id="selectAllEnabled" resultMap="NewsCategoryResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM news_categories
        WHERE is_enabled = 1
        ORDER BY sort_order ASC, created_at DESC
    </select>

    <!-- Êü•ËØ¢ÊâÄÊúâÊñ∞ÈóªÂàÜÁ±?-->
    <select id="selectAll" resultMap="NewsCategoryResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM news_categories
        ORDER BY sort_order ASC, created_at DESC
    </select>

    <!-- ÂàÜÈ°µÊü•ËØ¢Êñ∞ÈóªÂàÜÁ±ª -->
    <select id="selectByPage" resultMap="NewsCategoryResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM news_categories
        ORDER BY sort_order ASC, created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- ÁªüËÆ°Êñ∞ÈóªÂàÜÁ±ªÊÄªÊï∞ -->
    <select id="countAll" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM news_categories
    </select>

    <!-- ÁªüËÆ°ÂêØÁî®ÁöÑÊñ∞ÈóªÂàÜÁ±ªÊï∞Èá?-->
    <select id="countEnabled" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM news_categories WHERE is_enabled = 1
    </select>

    <!-- Ê£ÄÊü•ÂàÜÁ±ªÂêçÁß∞ÊòØÂê¶Â≠òÂú?-->
    <select id="existsByName" parameterType="java.lang.String" resultType="java.lang.Boolean">
        SELECT COUNT(*) > 0 FROM news_categories WHERE name = #{name}
    </select>

    <!-- Ê£ÄÊü•ÂàÜÁ±ªÂêçÁß∞ÊòØÂê¶Â≠òÂú®ÔºàÊéíÈô§ÊåáÂÆöIDÔº?-->
    <select id="existsByNameExcludeId" resultType="java.lang.Boolean">
        SELECT COUNT(*) > 0 FROM news_categories 
        WHERE name = #{name} AND id != #{id}
    </select>

    <!-- ÊâπÈáèÊõ¥Êñ∞ÊéíÂ∫èÊùÉÈáç -->
    <update id="batchUpdateSortOrder">
        <foreach collection="categories" item="category" separator=";">
            UPDATE news_categories 
            SET sort_order = #{category.sortOrder}, updated_at = NOW()
            WHERE id = #{category.id}
        </foreach>
    </update>

    <!-- ÂêØÁî®/Á¶ÅÁî®ÂàÜÁ±ª -->
    <update id="updateEnabledStatus">
        UPDATE news_categories 
        SET is_enabled = #{isEnabled}, updated_at = NOW()
        WHERE id = #{id}
    </update>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.NewsInteractionMapper">

    <!-- ÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="NewsInteractionResultMap" type="com.yxrobot.entity.NewsInteraction">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="news_id" property="newsId" jdbcType="BIGINT"/>
        <result column="interaction_type" property="interactionType" jdbcType="VARCHAR" />
        <result column="user_id" property="userId" jdbcType="BIGINT"/>
        <result column="ip_address" property="ipAddress" jdbcType="VARCHAR"/>
        <result column="user_agent" property="userAgent" jdbcType="VARCHAR"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!-- Âü∫Á°ÄÂ≠óÊÆµ -->
    <sql id="Base_Column_List">
        id, news_id, interaction_type, user_id, ip_address, user_agent, created_at
    </sql>

    <!-- ÊèíÂÖ•Êñ∞Èóª‰∫íÂä®ËÆ∞ÂΩï -->
    <insert id="insert" parameterType="com.yxrobot.entity.NewsInteraction" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO news_interactions (
            news_id, interaction_type, user_id, ip_address, user_agent, created_at
        ) VALUES (
            #{newsId}, #{interactionType}, #{userId}, #{ipAddress}, #{userAgent}, NOW()
        )
    </insert>

    <!-- ÊâπÈáèÊèíÂÖ•Êñ∞Èóª‰∫íÂä®ËÆ∞ÂΩï -->
    <insert id="batchInsert">
        INSERT INTO news_interactions (news_id, interaction_type, user_id, ip_address, user_agent, created_at)
        VALUES
        <foreach collection="interactions" item="interaction" separator=",">
            (#{interaction.newsId}, #{interaction.interactionType}, #{interaction.userId}, 
             #{interaction.ipAddress}, #{interaction.userAgent}, NOW())
        </foreach>
    </insert>

    <!-- Ê†πÊçÆIDÂà†Èô§‰∫íÂä®ËÆ∞ÂΩï -->
    <delete id="deleteById" parameterType="java.lang.Long">
        DELETE FROM news_interactions WHERE id = #{id}
    </delete>

    <!-- Ê†πÊçÆÊñ∞ÈóªIDÂà†Èô§ÊâÄÊúâ‰∫íÂä®ËÆ∞ÂΩ?-->
    <delete id="deleteByNewsId" parameterType="java.lang.Long">
        DELETE FROM news_interactions WHERE news_id = #{newsId}
    </delete>

    <!-- Ê†πÊçÆIDÊü•ËØ¢‰∫íÂä®ËÆ∞ÂΩï -->
    <select id="selectById" parameterType="java.lang.Long" resultMap="NewsInteractionResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM news_interactions
        WHERE id = #{id}
    </select>

    <!-- Ê†πÊçÆÊñ∞ÈóªIDÊü•ËØ¢‰∫íÂä®ËÆ∞ÂΩï -->
    <select id="selectByNewsId" resultMap="NewsInteractionResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM news_interactions
        WHERE news_id = #{newsId}
        ORDER BY created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- Ê†πÊçÆÊñ∞ÈóªIDÂíå‰∫íÂä®Á±ªÂûãÊü•ËØ¢ËÆ∞ÂΩ?-->
    <select id="selectByNewsIdAndType" resultMap="NewsInteractionResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM news_interactions
        WHERE news_id = #{newsId} AND interaction_type = #{interactionType}
        ORDER BY created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- Ê†πÊçÆÁî®Êà∑IDÊü•ËØ¢‰∫íÂä®ËÆ∞ÂΩï -->
    <select id="selectByUserId" resultMap="NewsInteractionResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM news_interactions
        WHERE user_id = #{userId}
        ORDER BY created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- Ê†πÊçÆIPÂú∞ÂùÄÊü•ËØ¢‰∫íÂä®ËÆ∞ÂΩï -->
    <select id="selectByIpAddress" resultMap="NewsInteractionResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM news_interactions
        WHERE ip_address = #{ipAddress}
        ORDER BY created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- Ê†πÊçÆÊó∂Èó¥ËåÉÂõ¥Êü•ËØ¢‰∫íÂä®ËÆ∞ÂΩï -->
    <select id="selectByDateRange" resultMap="NewsInteractionResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM news_interactions
        WHERE created_at BETWEEN #{startDate} AND #{endDate}
        ORDER BY created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- ÁªüËÆ°Êñ∞ÈóªÁöÑ‰∫íÂä®ÊÄªÊï∞ -->
    <select id="countByNewsId" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM news_interactions WHERE news_id = #{newsId}
    </select>

    <!-- ÁªüËÆ°Êñ∞ÈóªÊåáÂÆöÁ±ªÂûãÁöÑ‰∫íÂä®Êï∞Èá?-->
    <select id="countByNewsIdAndType" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM news_interactions 
        WHERE news_id = #{newsId} AND interaction_type = #{interactionType}
    </select>

    <!-- ÁªüËÆ°Áî®Êà∑ÁöÑ‰∫íÂä®ÊÄªÊï∞ -->
    <select id="countByUserId" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM news_interactions WHERE user_id = #{userId}
    </select>

    <!-- ÁªüËÆ°IPÂú∞ÂùÄÁöÑ‰∫íÂä®ÊÄªÊï∞ -->
    <select id="countByIpAddress" parameterType="java.lang.String" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM news_interactions WHERE ip_address = #{ipAddress}
    </select>

    <!-- ÁªüËÆ°Êó∂Èó¥ËåÉÂõ¥ÂÜÖÁöÑ‰∫íÂä®ÊÄªÊï∞ -->
    <select id="countByDateRange" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM news_interactions 
        WHERE created_at BETWEEN #{startDate} AND #{endDate}
    </select>

    <!-- Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶ÂØπÊñ∞ÈóªËøõË°åËøáÊåáÂÆöÁ±ªÂûãÁöÑ‰∫íÂä® -->
    <select id="existsByUserIdAndNewsIdAndType" resultType="java.lang.Boolean">
        SELECT COUNT(*) > 0 FROM news_interactions 
        WHERE user_id = #{userId} AND news_id = #{newsId} AND interaction_type = #{interactionType}
    </select>

    <!-- Ê£ÄÊü•IPÊòØÂê¶ÂØπÊñ∞ÈóªËøõË°åËøáÊåáÂÆöÁ±ªÂûãÁöÑ‰∫íÂä?-->
    <select id="existsByIpAndNewsIdAndType" resultType="java.lang.Boolean">
        SELECT COUNT(*) > 0 FROM news_interactions 
        WHERE ip_address = #{ipAddress} AND news_id = #{newsId} AND interaction_type = #{interactionType}
    </select>

    <!-- Ëé∑ÂèñÊñ∞ÈóªÁöÑ‰∫íÂä®ÁªüËÆ?-->
    <select id="getInteractionStatsByNewsId" parameterType="java.lang.Long" resultType="java.util.Map">
        SELECT 
            COUNT(*) as total,
            SUM(CASE WHEN interaction_type = 'VIEW' THEN 1 ELSE 0 END) as views,
            SUM(CASE WHEN interaction_type = 'LIKE' THEN 1 ELSE 0 END) as likes,
            SUM(CASE WHEN interaction_type = 'COMMENT' THEN 1 ELSE 0 END) as comments,
            SUM(CASE WHEN interaction_type = 'SHARE' THEN 1 ELSE 0 END) as shares
        FROM news_interactions 
        WHERE news_id = #{newsId}
    </select>

    <!-- Ëé∑ÂèñÊåâÊó•ÊúüÁªüËÆ°ÁöÑ‰∫íÂä®Êï∞ÊçÆ -->
    <select id="getInteractionStatsByDate" resultType="java.util.Map">
        SELECT 
            DATE(created_at) as date,
            COUNT(*) as total,
            SUM(CASE WHEN interaction_type = 'VIEW' THEN 1 ELSE 0 END) as views,
            SUM(CASE WHEN interaction_type = 'LIKE' THEN 1 ELSE 0 END) as likes,
            SUM(CASE WHEN interaction_type = 'COMMENT' THEN 1 ELSE 0 END) as comments,
            SUM(CASE WHEN interaction_type = 'SHARE' THEN 1 ELSE 0 END) as shares
        FROM news_interactions 
        WHERE created_at BETWEEN #{startDate} AND #{endDate}
        GROUP BY DATE(created_at)
        ORDER BY date DESC
    </select>

    <!-- Ëé∑ÂèñÊåâÊñ∞ÈóªÁªüËÆ°ÁöÑ‰∫íÂä®Êï∞ÊçÆ -->
    <select id="getInteractionStatsByNews" resultType="java.util.Map">
        SELECT 
            ni.news_id as newsId,
            n.title as newsTitle,
            COUNT(*) as total,
            SUM(CASE WHEN ni.interaction_type = 'VIEW' THEN 1 ELSE 0 END) as views,
            SUM(CASE WHEN ni.interaction_type = 'LIKE' THEN 1 ELSE 0 END) as likes,
            SUM(CASE WHEN ni.interaction_type = 'COMMENT' THEN 1 ELSE 0 END) as comments,
            SUM(CASE WHEN ni.interaction_type = 'SHARE' THEN 1 ELSE 0 END) as shares
        FROM news_interactions ni
        INNER JOIN news n ON ni.news_id = n.id
        WHERE n.is_deleted = 0
        GROUP BY ni.news_id, n.title
        ORDER BY total DESC
        LIMIT #{limit}
    </select>

    <!-- Ëé∑ÂèñÊåâ‰∫íÂä®Á±ªÂûãÁªüËÆ°ÁöÑÊï∞ÊçÆ -->
    <select id="getInteractionStatsByType" resultType="java.util.Map">
        SELECT 
            interaction_type as type,
            COUNT(*) as count
        FROM news_interactions 
        GROUP BY interaction_type
        ORDER BY count DESC
    </select>

    <!-- Ëé∑ÂèñÁÉ≠Èó®Êñ∞ÈóªÔºàÊåâ‰∫íÂä®Êï∞ÊéíÂ∫èÔºâ -->
    <select id="getHotNewsByInteractions" resultType="java.util.Map">
        SELECT 
            ni.news_id as newsId,
            n.title as newsTitle,
            COUNT(*) as interactionCount
        FROM news_interactions ni
        INNER JOIN news n ON ni.news_id = n.id
        WHERE ni.interaction_type = #{interactionType} AND n.is_deleted = 0
        GROUP BY ni.news_id, n.title
        ORDER BY interactionCount DESC
        LIMIT #{limit}
    </select>

    <!-- Âà†Èô§ËøáÊúüÁöÑ‰∫íÂä®ËÆ∞ÂΩ?-->
    <delete id="deleteExpiredRecords">
        DELETE FROM news_interactions 
        WHERE created_at &lt; #{expireDate}
    </delete>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.NewsMapper">

    <!-- ÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="NewsResultMap" type="com.yxrobot.entity.News">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="title" property="title" jdbcType="VARCHAR"/>
        <result column="excerpt" property="excerpt" jdbcType="VARCHAR"/>
        <result column="content" property="content" jdbcType="LONGVARCHAR"/>
        <result column="category_id" property="categoryId" jdbcType="BIGINT"/>
        <result column="author" property="author" jdbcType="VARCHAR"/>
        <result column="status" property="status" jdbcType="VARCHAR" />
        <result column="cover_image" property="coverImage" jdbcType="VARCHAR"/>
        <result column="publish_time" property="publishTime" jdbcType="TIMESTAMP"/>
        <result column="views" property="views" jdbcType="INTEGER"/>
        <result column="comments" property="comments" jdbcType="INTEGER"/>
        <result column="likes" property="likes" jdbcType="INTEGER"/>
        <result column="is_featured" property="isFeatured" jdbcType="TINYINT"/>
        <result column="sort_order" property="sortOrder" jdbcType="INTEGER"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP"/>
        <result column="is_deleted" property="isDeleted" jdbcType="TINYINT"/>
    </resultMap>

    <!-- ÂåÖÂê´ÂàÜÁ±ª‰ø°ÊÅØÁöÑÁªìÊûúÊò†Â∞?-->
    <resultMap id="NewsWithCategoryResultMap" type="com.yxrobot.entity.News" extends="NewsResultMap">
        <association property="category" javaType="com.yxrobot.entity.NewsCategory">
            <id column="category_id" property="id" jdbcType="BIGINT"/>
            <result column="category_name" property="name" jdbcType="VARCHAR"/>
            <result column="category_description" property="description" jdbcType="VARCHAR"/>
        </association>
    </resultMap>

    <!-- ÂåÖÂê´ÂàÜÁ±ªÂíåÊ†áÁ≠æ‰ø°ÊÅØÁöÑÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="NewsWithDetailsResultMap" type="com.yxrobot.entity.News" extends="NewsWithCategoryResultMap">
        <collection property="tags" ofType="com.yxrobot.entity.NewsTag">
            <id column="tag_id" property="id" jdbcType="BIGINT"/>
            <result column="tag_name" property="name" jdbcType="VARCHAR"/>
            <result column="tag_color" property="color" jdbcType="VARCHAR"/>
        </collection>
    </resultMap>

    <!-- Âü∫Á°ÄÂ≠óÊÆµ -->
    <sql id="Base_Column_List">
        id, title, excerpt, content, category_id, author, status, cover_image, 
        publish_time, views, comments, likes, is_featured, sort_order, 
        created_at, updated_at, is_deleted
    </sql>

    <!-- ÂåÖÂê´ÂàÜÁ±ª‰ø°ÊÅØÁöÑÂ≠óÊÆ?-->
    <sql id="News_With_Category_Column_List">
        n.id, n.title, n.excerpt, n.content, n.category_id, n.author, n.status, n.cover_image,
        n.publish_time, n.views, n.comments, n.likes, n.is_featured, n.sort_order,
        n.created_at, n.updated_at, n.is_deleted,
        c.name as category_name, c.description as category_description
    </sql>

    <!-- ÈÄöÁî®Êü•ËØ¢Êù°‰ª∂ -->
    <sql id="Common_Where_Clause">
        <where>
            <if test="conditions.title != null and conditions.title != ''">
                AND title LIKE CONCAT('%', #{conditions.title}, '%')
            </if>
            <if test="conditions.author != null and conditions.author != ''">
                AND author = #{conditions.author}
            </if>
            <if test="conditions.status != null">
                AND status = #{conditions.status}
            </if>
            <if test="conditions.categoryId != null">
                AND category_id = #{conditions.categoryId}
            </if>
            <if test="conditions.isFeatured != null">
                AND is_featured = #{conditions.isFeatured}
            </if>
            <if test="conditions.startDate != null">
                AND created_at >= #{conditions.startDate}
            </if>
            <if test="conditions.endDate != null">
                AND created_at &lt;= #{conditions.endDate}
            </if>
            <if test="conditions.keyword != null and conditions.keyword != ''">
                AND (title LIKE CONCAT('%', #{conditions.keyword}, '%') 
                     OR content LIKE CONCAT('%', #{conditions.keyword}, '%'))
            </if>
            AND is_deleted = 0
        </where>
    </sql>

    <!-- ÊèíÂÖ•Êñ∞Èóª -->
    <insert id="insert" parameterType="com.yxrobot.entity.News" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO news (
            title, excerpt, content, category_id, author, status, cover_image,
            publish_time, views, comments, likes, is_featured, sort_order,
            created_at, updated_at, is_deleted
        ) VALUES (
            #{title}, #{excerpt}, #{content}, #{categoryId}, #{author}, #{status}, #{coverImage},
            #{publishTime}, #{views}, #{comments}, #{likes}, #{isFeatured}, #{sortOrder},
            NOW(), NOW(), #{isDeleted}
        )
    </insert>

    <!-- Ê†πÊçÆIDÂà†Èô§Êñ∞ÈóªÔºàÁâ©ÁêÜÂà†Èô§Ôºâ -->
    <delete id="deleteById" parameterType="java.lang.Long">
        DELETE FROM news WHERE id = #{id}
    </delete>

    <!-- Ê†πÊçÆIDËΩØÂà†Èô§Êñ∞Èó?-->
    <update id="softDeleteById" parameterType="java.lang.Long">
        UPDATE news SET is_deleted = 1, updated_at = NOW() WHERE id = #{id}
    </update>

    <!-- Êõ¥Êñ∞Êñ∞Èóª -->
    <update id="updateById" parameterType="com.yxrobot.entity.News">
        UPDATE news
        <set>
            <if test="title != null and title != ''">title = #{title},</if>
            <if test="excerpt != null">excerpt = #{excerpt},</if>
            <if test="content != null and content != ''">content = #{content},</if>
            <if test="categoryId != null">category_id = #{categoryId},</if>
            <if test="author != null and author != ''">author = #{author},</if>
            <if test="status != null">status = #{status},</if>
            <if test="coverImage != null">cover_image = #{coverImage},</if>
            <if test="publishTime != null">publish_time = #{publishTime},</if>
            <if test="views != null">views = #{views},</if>
            <if test="comments != null">comments = #{comments},</if>
            <if test="likes != null">likes = #{likes},</if>
            <if test="isFeatured != null">is_featured = #{isFeatured},</if>
            <if test="sortOrder != null">sort_order = #{sortOrder},</if>
            updated_at = NOW()
        </set>
        WHERE id = #{id}
    </update>

    <!-- Ê†πÊçÆIDÊü•ËØ¢Êñ∞Èóª -->
    <select id="selectById" parameterType="java.lang.Long" resultMap="NewsResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM news
        WHERE id = #{id} AND is_deleted = 0
    </select>

    <!-- Ê†πÊçÆIDÊü•ËØ¢Êñ∞ÈóªÔºàÂåÖÂê´ÂàÜÁ±ªÂíåÊ†áÁ≠æ‰ø°ÊÅØÔº?-->
    <select id="selectByIdWithDetails" parameterType="java.lang.Long" resultMap="NewsWithDetailsResultMap">
        SELECT 
            <include refid="News_With_Category_Column_List"/>,
            t.id as tag_id, t.name as tag_name, t.color as tag_color
        FROM news n
        LEFT JOIN news_categories c ON n.category_id = c.id
        LEFT JOIN news_tag_relations ntr ON n.id = ntr.news_id
        LEFT JOIN news_tags t ON ntr.tag_id = t.id
        WHERE n.id = #{id} AND n.is_deleted = 0
    </select>

    <!-- ÂàÜÈ°µÊü•ËØ¢Êñ∞ÈóªÂàóË°® -->
    <select id="selectByPage" resultMap="NewsWithCategoryResultMap">
        SELECT <include refid="News_With_Category_Column_List"/>
        FROM news n
        LEFT JOIN news_categories c ON n.category_id = c.id
        WHERE n.is_deleted = 0
        ORDER BY n.is_featured DESC, n.sort_order DESC, n.created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- Êù°‰ª∂Êü•ËØ¢Êñ∞ÈóªÂàóË°® -->
    <select id="selectByConditions" resultMap="NewsWithCategoryResultMap">
        SELECT <include refid="News_With_Category_Column_List"/>
        FROM news n
        LEFT JOIN news_categories c ON n.category_id = c.id
        <include refid="Common_Where_Clause"/>
        ORDER BY n.is_featured DESC, n.sort_order DESC, n.created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- Ê†πÊçÆÁä∂ÊÄÅÊü•ËØ¢Êñ∞ÈóªÂàóË°?-->
    <select id="selectByStatus" resultMap="NewsWithCategoryResultMap">
        SELECT <include refid="News_With_Category_Column_List"/>
        FROM news n
        LEFT JOIN news_categories c ON n.category_id = c.id
        WHERE n.status = #{status} AND n.is_deleted = 0
        ORDER BY n.is_featured DESC, n.sort_order DESC, n.created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- Ê†πÊçÆÂàÜÁ±ªIDÊü•ËØ¢Êñ∞ÈóªÂàóË°® -->
    <select id="selectByCategoryId" resultMap="NewsWithCategoryResultMap">
        SELECT <include refid="News_With_Category_Column_List"/>
        FROM news n
        LEFT JOIN news_categories c ON n.category_id = c.id
        WHERE n.category_id = #{categoryId} AND n.is_deleted = 0
        ORDER BY n.is_featured DESC, n.sort_order DESC, n.created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- Ê†πÊçÆ‰ΩúËÄÖÊü•ËØ¢Êñ∞ÈóªÂàóË°?-->
    <select id="selectByAuthor" resultMap="NewsWithCategoryResultMap">
        SELECT <include refid="News_With_Category_Column_List"/>
        FROM news n
        LEFT JOIN news_categories c ON n.category_id = c.id
        WHERE n.author = #{author} AND n.is_deleted = 0
        ORDER BY n.is_featured DESC, n.sort_order DESC, n.created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- ÊêúÁ¥¢Êñ∞ÈóªÔºàÊ†áÈ¢òÂíåÂÜÖÂÆπÔº?-->
    <select id="searchByKeyword" resultMap="NewsWithCategoryResultMap">
        SELECT <include refid="News_With_Category_Column_List"/>
        FROM news n
        LEFT JOIN news_categories c ON n.category_id = c.id
        WHERE (n.title LIKE CONCAT('%', #{keyword}, '%') 
               OR n.content LIKE CONCAT('%', #{keyword}, '%'))
              AND n.is_deleted = 0
        ORDER BY n.is_featured DESC, n.sort_order DESC, n.created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- Êü•ËØ¢Êé®ËçêÊñ∞Èóª -->
    <select id="selectFeatured" resultMap="NewsWithCategoryResultMap">
        SELECT <include refid="News_With_Category_Column_List"/>
        FROM news n
        LEFT JOIN news_categories c ON n.category_id = c.id
        WHERE n.is_featured = 1 AND n.status = 'PUBLISHED' AND n.is_deleted = 0
        ORDER BY n.sort_order DESC, n.created_at DESC
        LIMIT #{limit}
    </select>

    <!-- Êü•ËØ¢ÁÉ≠Èó®Êñ∞ÈóªÔºàÊåâÊµèËßàÈáèÊéíÂ∫èÔºâ -->
    <select id="selectHotNews" resultMap="NewsWithCategoryResultMap">
        SELECT <include refid="News_With_Category_Column_List"/>
        FROM news n
        LEFT JOIN news_categories c ON n.category_id = c.id
        WHERE n.status = 'PUBLISHED' AND n.is_deleted = 0
        ORDER BY n.views DESC, n.created_at DESC
        LIMIT #{limit}
    </select>

    <!-- Êü•ËØ¢ÊúÄÊñ∞ÂèëÂ∏ÉÁöÑÊñ∞Èóª -->
    <select id="selectLatestPublished" resultMap="NewsWithCategoryResultMap">
        SELECT <include refid="News_With_Category_Column_List"/>
        FROM news n
        LEFT JOIN news_categories c ON n.category_id = c.id
        WHERE n.status = 'PUBLISHED' AND n.is_deleted = 0
        ORDER BY n.publish_time DESC, n.created_at DESC
        LIMIT #{limit}
    </select>

    <!-- Êü•ËØ¢Áõ∏ÂÖ≥Êñ∞ÈóªÔºàÂêåÂàÜÁ±ªÔº?-->
    <select id="selectRelatedNews" resultMap="NewsWithCategoryResultMap">
        SELECT <include refid="News_With_Category_Column_List"/>
        FROM news n
        LEFT JOIN news_categories c ON n.category_id = c.id
        WHERE n.category_id = #{categoryId} 
              AND n.id != #{newsId} 
              AND n.status = 'PUBLISHED' 
              AND n.is_deleted = 0
        ORDER BY n.views DESC, n.created_at DESC
        LIMIT #{limit}
    </select>

    <!-- ÁªüËÆ°Êñ∞ÈóªÊÄªÊï∞ -->
    <select id="countAll" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM news WHERE is_deleted = 0
    </select>

    <!-- Ê†πÊçÆÊù°‰ª∂ÁªüËÆ°Êñ∞ÈóªÊï∞Èáè -->
    <select id="countByConditions" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM news n
        <include refid="Common_Where_Clause"/>
    </select>

    <!-- Ê†πÊçÆÁä∂ÊÄÅÁªüËÆ°Êñ∞ÈóªÊï∞Èá?-->
    <select id="countByStatus" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM news 
        WHERE status = #{status} AND is_deleted = 0
    </select>

    <!-- Ê†πÊçÆÂàÜÁ±ªÁªüËÆ°Êñ∞ÈóªÊï∞Èáè -->
    <select id="countByCategoryId" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM news 
        WHERE category_id = #{categoryId} AND is_deleted = 0
    </select>

    <!-- Ê†πÊçÆ‰ΩúËÄÖÁªüËÆ°Êñ∞ÈóªÊï∞Èá?-->
    <select id="countByAuthor" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM news 
        WHERE author = #{author} AND is_deleted = 0
    </select>

    <!-- ÊêúÁ¥¢Êñ∞ÈóªÊï∞ÈáèÁªüËÆ° -->
    <select id="countByKeyword" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM news 
        WHERE (title LIKE CONCAT('%', #{keyword}, '%') 
               OR content LIKE CONCAT('%', #{keyword}, '%'))
              AND is_deleted = 0
    </select>

    <!-- Êõ¥Êñ∞Êñ∞ÈóªÁä∂ÊÄ?-->
    <update id="updateStatus">
        UPDATE news 
        SET status = #{status}, 
            <if test="publishTime != null">
                publish_time = #{publishTime},
            </if>
            updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- ÊâπÈáèÊõ¥Êñ∞Êñ∞ÈóªÁä∂ÊÄ?-->
    <update id="batchUpdateStatus">
        UPDATE news 
        SET status = #{status}, updated_at = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- Êõ¥Êñ∞ÂèëÂ∏ÉÊó∂Èó¥ -->
    <update id="updatePublishTime">
        UPDATE news 
        SET publish_time = #{publishTime}, updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- Â¢ûÂä†ÊµèËßàÈá?-->
    <update id="incrementViews" parameterType="java.lang.Long">
        UPDATE news 
        SET views = views + 1, updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- Â¢ûÂä†ËØÑËÆ∫Êï?-->
    <update id="incrementComments" parameterType="java.lang.Long">
        UPDATE news 
        SET comments = comments + 1, updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- Â¢ûÂä†ÁÇπËµûÊï?-->
    <update id="incrementLikes" parameterType="java.lang.Long">
        UPDATE news 
        SET likes = likes + 1, updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- ÂáèÂ∞ëÁÇπËµûÊï?-->
    <update id="decrementLikes" parameterType="java.lang.Long">
        UPDATE news 
        SET likes = GREATEST(0, likes - 1), updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- Êõ¥Êñ∞Êé®ËçêÁä∂ÊÄ?-->
    <update id="updateFeaturedStatus">
        UPDATE news 
        SET is_featured = #{isFeatured}, updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- ÊâπÈáèÊõ¥Êñ∞Êé®ËçêÁä∂ÊÄ?-->
    <update id="batchUpdateFeaturedStatus">
        UPDATE news 
        SET is_featured = #{isFeatured}, updated_at = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- Ëé∑ÂèñÊñ∞ÈóªÁªüËÆ°Êï∞ÊçÆ -->
    <select id="getNewsStats" resultType="java.util.Map">
        SELECT 
            COUNT(*) as total,
            SUM(CASE WHEN status = 'PUBLISHED' THEN 1 ELSE 0 END) as published,
            SUM(CASE WHEN status = 'DRAFT' THEN 1 ELSE 0 END) as draft,
            SUM(CASE WHEN status = 'OFFLINE' THEN 1 ELSE 0 END) as offline,
            SUM(views) as totalViews,
            SUM(comments) as totalComments,
            SUM(likes) as totalLikes
        FROM news 
        WHERE is_deleted = 0
    </select>

    <!-- Ëé∑ÂèñÊåâÊó•ÊúüÁªüËÆ°ÁöÑÊñ∞ÈóªÊï∞ÊçÆ -->
    <select id="getNewsStatsByDate" resultType="java.util.Map">
        SELECT 
            DATE(created_at) as date,
            COUNT(*) as count,
            SUM(CASE WHEN status = 'PUBLISHED' THEN 1 ELSE 0 END) as published
        FROM news 
        WHERE created_at BETWEEN #{startDate} AND #{endDate}
              AND is_deleted = 0
        GROUP BY DATE(created_at)
        ORDER BY date DESC
    </select>

    <!-- Ëé∑ÂèñÊåâÂàÜÁ±ªÁªüËÆ°ÁöÑÊñ∞ÈóªÊï∞ÊçÆ -->
    <select id="getNewsStatsByCategory" resultType="java.util.Map">
        SELECT 
            c.name as categoryName,
            COUNT(n.id) as count,
            SUM(CASE WHEN n.status = 'PUBLISHED' THEN 1 ELSE 0 END) as published
        FROM news_categories c
        LEFT JOIN news n ON c.id = n.category_id AND n.is_deleted = 0
        GROUP BY c.id, c.name
        ORDER BY count DESC
    </select>

    <!-- Ëé∑ÂèñÊåâ‰ΩúËÄÖÁªüËÆ°ÁöÑÊñ∞ÈóªÊï∞ÊçÆ -->
    <select id="getNewsStatsByAuthor" resultType="java.util.Map">
        SELECT 
            author,
            COUNT(*) as count,
            SUM(CASE WHEN status = 'PUBLISHED' THEN 1 ELSE 0 END) as published,
            SUM(views) as totalViews
        FROM news 
        WHERE is_deleted = 0
        GROUP BY author
        ORDER BY count DESC
    </select>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.NewsStatusLogMapper">

    <!-- ÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="NewsStatusLogResultMap" type="com.yxrobot.entity.NewsStatusLog">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="news_id" property="newsId" jdbcType="BIGINT"/>
        <result column="from_status" property="fromStatus" jdbcType="VARCHAR" />
        <result column="to_status" property="toStatus" jdbcType="VARCHAR" />
        <result column="reason" property="reason" jdbcType="VARCHAR"/>
        <result column="operator" property="operator" jdbcType="VARCHAR"/>
        <result column="change_time" property="changeTime" jdbcType="TIMESTAMP"/>
        <result column="remark" property="remark" jdbcType="VARCHAR"/>
    </resultMap>

    <!-- Âü∫Á°ÄÂ≠óÊÆµÂàóË°® -->
    <sql id="Base_Column_List">
        id, news_id, from_status, to_status, reason, operator, change_time, remark
    </sql>

    <!-- ÊèíÂÖ•Áä∂ÊÄÅÂèòÊõ¥Êó•Âø?-->
    <insert id="insert" parameterType="com.yxrobot.entity.NewsStatusLog" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO news_status_logs (
            news_id, from_status, to_status, reason, operator, change_time, remark
        ) VALUES (
            #{newsId}, #{fromStatus}, #{toStatus}, #{reason}, #{operator}, #{changeTime}, #{remark}
        )
    </insert>

    <!-- Ê†πÊçÆÊñ∞ÈóªIDÊü•ËØ¢Áä∂ÊÄÅÂèòÊõ¥Êó•Âø?-->
    <select id="selectByNewsId" resultMap="NewsStatusLogResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM news_status_logs
        WHERE news_id = #{newsId}
        ORDER BY change_time DESC
    </select>

    <!-- Ê†πÊçÆÊñ∞ÈóªIDÊü•ËØ¢ÊúÄÊñ∞ÁöÑÁä∂ÊÄÅÂèòÊõ¥Êó•Âø?-->
    <select id="selectLatestByNewsId" resultMap="NewsStatusLogResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM news_status_logs
        WHERE news_id = #{newsId}
        ORDER BY change_time DESC
        LIMIT 1
    </select>

    <!-- ÂàÜÈ°µÊü•ËØ¢Áä∂ÊÄÅÂèòÊõ¥Êó•Âø?-->
    <select id="selectByPage" resultMap="NewsStatusLogResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM news_status_logs
        ORDER BY change_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- ÁªüËÆ°Êó•ÂøóÊÄªÊï∞ -->
    <select id="countAll" resultType="int">
        SELECT COUNT(*)
        FROM news_status_logs
    </select>

    <!-- Ê†πÊçÆÊñ∞ÈóªIDÁªüËÆ°Êó•ÂøóÊï∞Èáè -->
    <select id="countByNewsId" resultType="int">
        SELECT COUNT(*)
        FROM news_status_logs
        WHERE news_id = #{newsId}
    </select>

    <!-- Ê†πÊçÆÊìç‰Ωú‰∫∫Êü•ËØ¢Êó•Âø?-->
    <select id="selectByOperator" resultMap="NewsStatusLogResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM news_status_logs
        WHERE operator = #{operator}
        ORDER BY change_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- Âà†Èô§ÊåáÂÆöÊñ∞ÈóªÁöÑÊâÄÊúâÁä∂ÊÄÅÊó•Âø?-->
    <delete id="deleteByNewsId">
        DELETE FROM news_status_logs
        WHERE news_id = #{newsId}
    </delete>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.NewsTagMapper">

    <!-- ÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="NewsTagResultMap" type="com.yxrobot.entity.NewsTag">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="name" property="name" jdbcType="VARCHAR"/>
        <result column="color" property="color" jdbcType="VARCHAR"/>
        <result column="usage_count" property="usageCount" jdbcType="INTEGER"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!-- Âü∫Á°ÄÂ≠óÊÆµ -->
    <sql id="Base_Column_List">
        id, name, color, usage_count, created_at, updated_at
    </sql>

    <!-- ÊèíÂÖ•Êñ∞ÈóªÊ†áÁ≠æ -->
    <insert id="insert" parameterType="com.yxrobot.entity.NewsTag" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO news_tags (
            name, color, usage_count, created_at, updated_at
        ) VALUES (
            #{name}, #{color}, #{usageCount}, NOW(), NOW()
        )
    </insert>

    <!-- Ê†πÊçÆIDÂà†Èô§Êñ∞ÈóªÊ†áÁ≠æ -->
    <delete id="deleteById" parameterType="java.lang.Long">
        DELETE FROM news_tags WHERE id = #{id}
    </delete>

    <!-- Êõ¥Êñ∞Êñ∞ÈóªÊ†áÁ≠æ -->
    <update id="updateById" parameterType="com.yxrobot.entity.NewsTag">
        UPDATE news_tags
        <set>
            <if test="name != null and name != ''">name = #{name},</if>
            <if test="color != null and color != ''">color = #{color},</if>
            <if test="usageCount != null">usage_count = #{usageCount},</if>
            updated_at = NOW()
        </set>
        WHERE id = #{id}
    </update>

    <!-- Ê†πÊçÆIDÊü•ËØ¢Êñ∞ÈóªÊ†áÁ≠æ -->
    <select id="selectById" parameterType="java.lang.Long" resultMap="NewsTagResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM news_tags
        WHERE id = #{id}
    </select>

    <!-- Ê†πÊçÆÂêçÁß∞Êü•ËØ¢Êñ∞ÈóªÊ†áÁ≠æ -->
    <select id="selectByName" parameterType="java.lang.String" resultMap="NewsTagResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM news_tags
        WHERE name = #{name}
    </select>

    <!-- Êü•ËØ¢ÊâÄÊúâÊñ∞ÈóªÊ†áÁ≠?-->
    <select id="selectAll" resultMap="NewsTagResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM news_tags
        ORDER BY usage_count DESC, created_at DESC
    </select>

    <!-- ÂàÜÈ°µÊü•ËØ¢Êñ∞ÈóªÊ†áÁ≠æ -->
    <select id="selectByPage" resultMap="NewsTagResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM news_tags
        ORDER BY usage_count DESC, created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- Ê†πÊçÆ‰ΩøÁî®Ê¨°Êï∞ÊéíÂ∫èÊü•ËØ¢Ê†áÁ≠æ -->
    <select id="selectByUsageCount" resultMap="NewsTagResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM news_tags
        ORDER BY usage_count DESC, created_at DESC
        LIMIT #{limit}
    </select>

    <!-- Ê†πÊçÆÂêçÁß∞Ê®°Á≥äÊü•ËØ¢Ê†áÁ≠æ -->
    <select id="selectByNameLike" parameterType="java.lang.String" resultMap="NewsTagResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM news_tags
        WHERE name LIKE CONCAT('%', #{name}, '%')
        ORDER BY usage_count DESC, created_at DESC
    </select>

    <!-- Ê†πÊçÆIDÂàóË°®Êü•ËØ¢Ê†áÁ≠æ -->
    <select id="selectByIds" resultMap="NewsTagResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM news_tags
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        ORDER BY usage_count DESC, created_at DESC
    </select>

    <!-- ÁªüËÆ°Ê†áÁ≠æÊÄªÊï∞ -->
    <select id="countAll" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM news_tags
    </select>

    <!-- Ê£ÄÊü•Ê†áÁ≠æÂêçÁß∞ÊòØÂê¶Â≠òÂú?-->
    <select id="existsByName" parameterType="java.lang.String" resultType="java.lang.Boolean">
        SELECT COUNT(*) > 0 FROM news_tags WHERE name = #{name}
    </select>

    <!-- Ê£ÄÊü•Ê†áÁ≠æÂêçÁß∞ÊòØÂê¶Â≠òÂú®ÔºàÊéíÈô§ÊåáÂÆöIDÔº?-->
    <select id="existsByNameExcludeId" resultType="java.lang.Boolean">
        SELECT COUNT(*) > 0 FROM news_tags 
        WHERE name = #{name} AND id != #{id}
    </select>

    <!-- Â¢ûÂä†Ê†áÁ≠æ‰ΩøÁî®Ê¨°Êï∞ -->
    <update id="incrementUsageCount" parameterType="java.lang.Long">
        UPDATE news_tags 
        SET usage_count = usage_count + 1, updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- ÂáèÂ∞ëÊ†áÁ≠æ‰ΩøÁî®Ê¨°Êï∞ -->
    <update id="decrementUsageCount" parameterType="java.lang.Long">
        UPDATE news_tags 
        SET usage_count = GREATEST(0, usage_count - 1), updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- ÊâπÈáèÂ¢ûÂä†Ê†áÁ≠æ‰ΩøÁî®Ê¨°Êï∞ -->
    <update id="batchIncrementUsageCount">
        UPDATE news_tags 
        SET usage_count = usage_count + 1, updated_at = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- ÊâπÈáèÂáèÂ∞ëÊ†áÁ≠æ‰ΩøÁî®Ê¨°Êï∞ -->
    <update id="batchDecrementUsageCount">
        UPDATE news_tags 
        SET usage_count = GREATEST(0, usage_count - 1), updated_at = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- ÈáçÁΩÆÊ†áÁ≠æ‰ΩøÁî®Ê¨°Êï∞ -->
    <update id="resetUsageCount" parameterType="java.lang.Long">
        UPDATE news_tags 
        SET usage_count = 0, updated_at = NOW()
        WHERE id = #{id}
    </update>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.NewsTagRelationMapper">

    <!-- ÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="NewsTagRelationResultMap" type="com.yxrobot.entity.NewsTagRelation">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="news_id" property="newsId" jdbcType="BIGINT"/>
        <result column="tag_id" property="tagId" jdbcType="BIGINT"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!-- Ê†áÁ≠æÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="NewsTagResultMap" type="com.yxrobot.entity.NewsTag">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="name" property="name" jdbcType="VARCHAR"/>
        <result column="color" property="color" jdbcType="VARCHAR"/>
        <result column="usage_count" property="usageCount" jdbcType="INTEGER"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!-- Âü∫Á°ÄÂ≠óÊÆµ -->
    <sql id="Base_Column_List">
        id, news_id, tag_id, created_at
    </sql>

    <!-- ÊèíÂÖ•Êñ∞ÈóªÊ†áÁ≠æÂÖ≥ËÅî -->
    <insert id="insert" parameterType="com.yxrobot.entity.NewsTagRelation" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO news_tag_relations (
            news_id, tag_id, created_at
        ) VALUES (
            #{newsId}, #{tagId}, NOW()
        )
    </insert>

    <!-- ÊâπÈáèÊèíÂÖ•Êñ∞ÈóªÊ†áÁ≠æÂÖ≥ËÅî -->
    <insert id="batchInsert">
        INSERT INTO news_tag_relations (news_id, tag_id, created_at)
        VALUES
        <foreach collection="relations" item="relation" separator=",">
            (#{relation.newsId}, #{relation.tagId}, NOW())
        </foreach>
    </insert>

    <!-- Ê†πÊçÆIDÂà†Èô§ÂÖ≥ËÅî -->
    <delete id="deleteById" parameterType="java.lang.Long">
        DELETE FROM news_tag_relations WHERE id = #{id}
    </delete>

    <!-- Ê†πÊçÆÊñ∞ÈóªIDÂà†Èô§ÊâÄÊúâÂÖ≥ËÅ?-->
    <delete id="deleteByNewsId" parameterType="java.lang.Long">
        DELETE FROM news_tag_relations WHERE news_id = #{newsId}
    </delete>

    <!-- Ê†πÊçÆÊ†áÁ≠æIDÂà†Èô§ÊâÄÊúâÂÖ≥ËÅ?-->
    <delete id="deleteByTagId" parameterType="java.lang.Long">
        DELETE FROM news_tag_relations WHERE tag_id = #{tagId}
    </delete>

    <!-- Âà†Èô§ÊåáÂÆöÊñ∞ÈóªÂíåÊ†áÁ≠æÁöÑÂÖ≥ËÅî -->
    <delete id="deleteByNewsIdAndTagId">
        DELETE FROM news_tag_relations 
        WHERE news_id = #{newsId} AND tag_id = #{tagId}
    </delete>

    <!-- ÊâπÈáèÂà†Èô§Êñ∞ÈóªÁöÑÊ†áÁ≠æÂÖ≥ËÅ?-->
    <delete id="batchDeleteByNewsIdAndTagIds">
        DELETE FROM news_tag_relations 
        WHERE news_id = #{newsId} AND tag_id IN
        <foreach collection="tagIds" item="tagId" open="(" separator="," close=")">
            #{tagId}
        </foreach>
    </delete>

    <!-- Ê†πÊçÆÊñ∞ÈóªIDÊü•ËØ¢ÂÖ≥ËÅîÁöÑÊ†áÁ≠?-->
    <select id="selectTagsByNewsId" parameterType="java.lang.Long" resultMap="NewsTagResultMap">
        SELECT t.id, t.name, t.color, t.usage_count, t.created_at, t.updated_at
        FROM news_tag_relations ntr
        INNER JOIN news_tags t ON ntr.tag_id = t.id
        WHERE ntr.news_id = #{newsId}
        ORDER BY t.usage_count DESC, t.created_at DESC
    </select>

    <!-- Ê†πÊçÆÊ†áÁ≠æIDÊü•ËØ¢ÂÖ≥ËÅîÁöÑÊñ∞ÈóªIDÂàóË°® -->
    <select id="selectNewsIdsByTagId" parameterType="java.lang.Long" resultType="java.lang.Long">
        SELECT news_id
        FROM news_tag_relations
        WHERE tag_id = #{tagId}
        ORDER BY created_at DESC
    </select>

    <!-- Ê†πÊçÆÊñ∞ÈóªIDÊü•ËØ¢Ê†áÁ≠æIDÂàóË°® -->
    <select id="selectTagIdsByNewsId" parameterType="java.lang.Long" resultType="java.lang.Long">
        SELECT tag_id
        FROM news_tag_relations
        WHERE news_id = #{newsId}
        ORDER BY created_at DESC
    </select>

    <!-- Ê£ÄÊü•Êñ∞ÈóªÂíåÊ†áÁ≠æÁöÑÂÖ≥ËÅîÊòØÂê¶Â≠òÂú?-->
    <select id="existsByNewsIdAndTagId" resultType="java.lang.Boolean">
        SELECT COUNT(*) > 0 
        FROM news_tag_relations 
        WHERE news_id = #{newsId} AND tag_id = #{tagId}
    </select>

    <!-- ÁªüËÆ°Êñ∞ÈóªÁöÑÊ†áÁ≠æÊï∞Èá?-->
    <select id="countTagsByNewsId" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT COUNT(*) 
        FROM news_tag_relations 
        WHERE news_id = #{newsId}
    </select>

    <!-- ÁªüËÆ°Ê†áÁ≠æÂÖ≥ËÅîÁöÑÊñ∞ÈóªÊï∞Èá?-->
    <select id="countNewsByTagId" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT COUNT(*) 
        FROM news_tag_relations 
        WHERE tag_id = #{tagId}
    </select>

    <!-- ÊâπÈáèÊü•ËØ¢Êñ∞ÈóªÁöÑÊ†áÁ≠?-->
    <select id="selectTagsByNewsIds" resultMap="NewsTagResultMap">
        SELECT DISTINCT t.id, t.name, t.color, t.usage_count, t.created_at, t.updated_at
        FROM news_tag_relations ntr
        INNER JOIN news_tags t ON ntr.tag_id = t.id
        WHERE ntr.news_id IN
        <foreach collection="newsIds" item="newsId" open="(" separator="," close=")">
            #{newsId}
        </foreach>
        ORDER BY t.usage_count DESC, t.created_at DESC
    </select>

    <!-- Êõ¥Êñ∞Êñ∞ÈóªÁöÑÊ†áÁ≠æÂÖ≥ËÅîÔºàÂÖàÂà†Èô§ÂêéÊèíÂÖ•Ôº?-->
    <update id="updateNewsTagRelations">
        <!-- ÂÖàÂà†Èô§Áé∞ÊúâÂÖ≥ËÅ?-->
        DELETE FROM news_tag_relations WHERE news_id = #{newsId};
        
        <!-- ÊèíÂÖ•Êñ∞ÁöÑÂÖ≥ËÅî -->
        <if test="tagIds != null and tagIds.size() > 0">
            INSERT INTO news_tag_relations (news_id, tag_id, created_at)
            VALUES
            <foreach collection="tagIds" item="tagId" separator=",">
                (#{newsId}, #{tagId}, NOW())
            </foreach>
        </if>
    </update>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.PlatformLinkMapper">

    <!-- ÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="PlatformLinkResultMap" type="com.yxrobot.entity.PlatformLink">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="platform_name" property="platformName" jdbcType="VARCHAR"/>
        <result column="platform_type" property="platformType" jdbcType="VARCHAR" 
                />
        <result column="link_url" property="linkUrl" jdbcType="VARCHAR"/>
        <result column="region" property="region" jdbcType="VARCHAR"/>
        <result column="country" property="country" jdbcType="VARCHAR"/>
        <result column="language_code" property="languageCode" jdbcType="VARCHAR"/>
        <result column="language_name" property="languageName" jdbcType="VARCHAR"/>
        <result column="is_enabled" property="isEnabled" jdbcType="TINYINT"/>
        <result column="link_status" property="linkStatus" jdbcType="VARCHAR" 
                />
        <result column="last_checked_at" property="lastCheckedAt" jdbcType="TIMESTAMP"/>
        <result column="click_count" property="clickCount" jdbcType="INTEGER"/>
        <result column="conversion_count" property="conversionCount" jdbcType="INTEGER"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP"/>
        <result column="is_deleted" property="isDeleted" jdbcType="TINYINT"/>
    </resultMap>

    <!-- Âü∫Á°ÄÂà?-->
    <sql id="Base_Column_List">
        id, platform_name, platform_type, link_url, region, country, 
        language_code, language_name, is_enabled, link_status, 
        last_checked_at, click_count, conversion_count, 
        created_at, updated_at, is_deleted
    </sql>

    <!-- Êü•ËØ¢Êù°‰ª∂ -->
    <sql id="Where_Clause">
        <where>
            is_deleted = 0
            <if test="params.platformType != null and params.platformType != ''">
                AND platform_type = #{params.platformType}
            </if>
            <if test="params.region != null and params.region != ''">
                AND region = #{params.region}
            </if>
            <if test="params.languageCode != null and params.languageCode != ''">
                AND language_code = #{params.languageCode}
            </if>
            <if test="params.linkStatus != null and params.linkStatus != ''">
                AND link_status = #{params.linkStatus}
            </if>
            <if test="params.isEnabled != null">
                AND is_enabled = #{params.isEnabled}
            </if>
            <if test="params.keyword != null and params.keyword != ''">
                AND (platform_name LIKE CONCAT('%', #{params.keyword}, '%') 
                     OR link_url LIKE CONCAT('%', #{params.keyword}, '%'))
            </if>
        </where>
    </sql>

    <!-- Ê†πÊçÆIDÊü•ËØ¢ -->
    <select id="selectById" resultMap="PlatformLinkResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM platform_links
        WHERE id = #{id} AND is_deleted = 0
    </select>

    <!-- ÂàÜÈ°µÊü•ËØ¢ÂàóË°® -->
    <select id="selectList" resultMap="PlatformLinkResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM platform_links
        <include refid="Where_Clause"/>
        ORDER BY 
        <choose>
            <when test="params.orderBy != null and params.orderBy != ''">
                ${params.orderBy}
                <if test="params.orderDirection != null and params.orderDirection != ''">
                    ${params.orderDirection}
                </if>
            </when>
            <otherwise>
                created_at DESC
            </otherwise>
        </choose>
        <if test="params.offset != null and params.limit != null">
            LIMIT #{params.offset}, #{params.limit}
        </if>
    </select>

    <!-- Êü•ËØ¢ÊÄªÊï∞ -->
    <select id="selectCount" resultType="int">
        SELECT COUNT(*)
        FROM platform_links
        <include refid="Where_Clause"/>
    </select>

    <!-- ÊèíÂÖ• -->
    <insert id="insert" parameterType="com.yxrobot.entity.PlatformLink" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO platform_links (
            platform_name, platform_type, link_url, region, country,
            language_code, language_name, is_enabled, link_status,
            click_count, conversion_count, created_at, updated_at, is_deleted
        ) VALUES (
            #{platformName}, #{platformType}, #{linkUrl}, #{region}, #{country},
            #{languageCode}, #{languageName}, #{isEnabled}, #{linkStatus},
            #{clickCount}, #{conversionCount}, NOW(), NOW(), #{isDeleted}
        )
    </insert>

    <!-- Êõ¥Êñ∞ -->
    <update id="update" parameterType="com.yxrobot.entity.PlatformLink">
        UPDATE platform_links
        <set>
            <if test="platformName != null and platformName != ''">
                platform_name = #{platformName},
            </if>
            <if test="platformType != null">
                platform_type = #{platformType},
            </if>
            <if test="linkUrl != null and linkUrl != ''">
                link_url = #{linkUrl},
            </if>
            <if test="region != null and region != ''">
                region = #{region},
            </if>
            <if test="country != null and country != ''">
                country = #{country},
            </if>
            <if test="languageCode != null and languageCode != ''">
                language_code = #{languageCode},
            </if>
            <if test="languageName != null and languageName != ''">
                language_name = #{languageName},
            </if>
            <if test="isEnabled != null">
                is_enabled = #{isEnabled},
            </if>
            <if test="linkStatus != null">
                link_status = #{linkStatus},
            </if>
            <if test="lastCheckedAt != null">
                last_checked_at = #{lastCheckedAt},
            </if>
            <if test="clickCount != null">
                click_count = #{clickCount},
            </if>
            <if test="conversionCount != null">
                conversion_count = #{conversionCount},
            </if>
            updated_at = NOW()
        </set>
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- ËΩØÂà†Èô?-->
    <update id="deleteById">
        UPDATE platform_links 
        SET is_deleted = 1, updated_at = NOW()
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- Êõ¥Êñ∞ÂêØÁî®Áä∂ÊÄ?-->
    <update id="updateEnabledStatus">
        UPDATE platform_links 
        SET is_enabled = #{isEnabled}, updated_at = NOW()
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- Êõ¥Êñ∞ÈìæÊé•Áä∂ÊÄ?-->
    <update id="updateLinkStatus">
        UPDATE platform_links 
        SET link_status = #{linkStatus}, last_checked_at = NOW(), updated_at = NOW()
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- Êõ¥Êñ∞ÁÇπÂáªÈá?-->
    <update id="updateClickCount">
        UPDATE platform_links 
        SET click_count = #{clickCount}, updated_at = NOW()
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- Êõ¥Êñ∞ËΩ¨ÂåñÈá?-->
    <update id="updateConversionCount">
        UPDATE platform_links 
        SET conversion_count = #{conversionCount}, updated_at = NOW()
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- Ëé∑ÂèñÁªüËÆ°Êï∞ÊçÆ -->
    <select id="selectStats" resultType="map">
        SELECT 
            COUNT(*) as totalLinks,
            SUM(CASE WHEN is_enabled = 1 AND link_status = 'active' THEN 1 ELSE 0 END) as activeLinks,
            SUM(CASE WHEN is_enabled = 0 OR link_status != 'active' THEN 1 ELSE 0 END) as inactiveLinks,
            COALESCE(SUM(click_count), 0) as totalClicks,
            COALESCE(SUM(conversion_count), 0) as totalConversions,
            CASE 
                WHEN SUM(click_count) > 0 THEN ROUND((SUM(conversion_count) * 100.0 / SUM(click_count)), 2)
                ELSE 0.0 
            END as conversionRate
        FROM platform_links 
        WHERE is_deleted = 0
    </select>

    <!-- Ëé∑ÂèñÂú∞Âå∫ÁªüËÆ°Êï∞ÊçÆ -->
    <select id="selectRegionStats" resultType="map">
        SELECT 
            region,
            COUNT(*) as linkCount,
            COALESCE(SUM(click_count), 0) as clickCount,
            COALESCE(SUM(conversion_count), 0) as conversionCount
        FROM platform_links 
        WHERE is_deleted = 0
        GROUP BY region
        ORDER BY linkCount DESC, clickCount DESC
    </select>

    <!-- Ëé∑ÂèñËØ≠Ë®ÄÁªüËÆ°Êï∞ÊçÆ -->
    <select id="selectLanguageStats" resultType="map">
        SELECT 
            language_code as languageCode,
            language_name as languageName,
            COUNT(*) as linkCount,
            COALESCE(SUM(click_count), 0) as clickCount,
            COALESCE(SUM(conversion_count), 0) as conversionCount
        FROM platform_links 
        WHERE is_deleted = 0
        GROUP BY language_code, language_name
        ORDER BY linkCount DESC, clickCount DESC
    </select>

    <!-- Ëé∑ÂèñË°®Áé∞ÊúÄ‰Ω≥ÁöÑÈìæÊé• -->
    <select id="selectTopPerformingLinks" resultType="map">
        SELECT 
            id,
            platform_name as platformName,
            region,
            click_count as clickCount,
            conversion_count as conversionCount,
            CASE 
                WHEN click_count > 0 THEN ROUND((conversion_count * 100.0 / click_count), 2)
                ELSE 0.0 
            END as conversionRate
        FROM platform_links 
        WHERE is_deleted = 0 AND click_count > 0
        ORDER BY click_count DESC, conversion_count DESC
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>

    <!-- Ê£ÄÊü•ÊòØÂê¶Â≠òÂú?-->
    <select id="checkExists" resultType="int">
        SELECT COUNT(*)
        FROM platform_links
        WHERE platform_name = #{platformName} 
          AND region = #{region} 
          AND language_code = #{languageCode}
          AND is_deleted = 0
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
    </select>

    <!-- Ê†πÊçÆÂú∞Âå∫ÂíåËØ≠Ë®ÄÊü•ËØ¢ -->
    <select id="selectByRegionAndLanguage" resultMap="PlatformLinkResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM platform_links
        WHERE region = #{region} 
          AND language_code = #{languageCode}
          AND is_deleted = 0
        ORDER BY platform_name
    </select>

    <!-- Ê†πÊçÆÂπ≥Âè∞Á±ªÂûãÊü•ËØ¢ -->
    <select id="selectByPlatformType" resultMap="PlatformLinkResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM platform_links
        WHERE platform_type = #{platformType}
          AND is_deleted = 0
        ORDER BY created_at DESC
    </select>

    <!-- Êü•ËØ¢ÈúÄË¶ÅÊ£ÄÊü•ÁöÑÈìæÊé• -->
    <select id="selectLinksForCheck" resultMap="PlatformLinkResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM platform_links
        WHERE is_deleted = 0 
          AND is_enabled = 1
          AND (last_checked_at IS NULL 
               OR last_checked_at &lt; DATE_SUB(NOW(), INTERVAL 1 HOUR))
        ORDER BY 
            CASE WHEN last_checked_at IS NULL THEN 0 ELSE 1 END,
            last_checked_at ASC
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.ProductMapper">

    <!-- ÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="ProductResultMap" type="com.yxrobot.entity.Product">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="name" property="name" jdbcType="VARCHAR"/>
        <result column="model" property="model" jdbcType="VARCHAR"/>
        <result column="description" property="description" jdbcType="CLOB"/>
        <result column="price" property="price" jdbcType="DECIMAL"/>
        <result column="cover_image_url" property="coverImageUrl" jdbcType="VARCHAR"/>
        <result column="status" property="status" jdbcType="VARCHAR"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP"/>
        <result column="is_deleted" property="isDeleted" jdbcType="TINYINT"/>
    </resultMap>

    <!-- Âü∫Á°ÄÂ≠óÊÆµ -->
    <sql id="Base_Column_List">
        id, name, model, description, price, cover_image_url, status, created_at, updated_at, is_deleted
    </sql>

    <!-- Ê†πÊçÆIDÊü•ËØ¢‰∫ßÂìÅ -->
    <select id="selectById" parameterType="java.lang.Long" resultMap="ProductResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM products
        WHERE id = #{id} AND is_deleted = 0
    </select>

    <!-- Ê†πÊçÆ‰∫ßÂìÅÂûãÂè∑Êü•ËØ¢‰∫ßÂìÅ -->
    <select id="selectByModel" parameterType="java.lang.String" resultMap="ProductResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM products
        WHERE model = #{model} AND is_deleted = 0
    </select>

    <!-- Êü•ËØ¢ÊâÄÊúâ‰∫ßÂì?-->
    <select id="selectAll" resultMap="ProductResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM products
        WHERE is_deleted = 0
        ORDER BY created_at DESC
    </select>

    <!-- Ê†πÊçÆÁä∂ÊÄÅÊü•ËØ¢‰∫ßÂì?-->
    <select id="selectByStatus" parameterType="java.lang.String" resultMap="ProductResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM products
        WHERE status = #{status} AND is_deleted = 0
        ORDER BY name ASC
    </select>

    <!-- ÂàÜÈ°µÊü•ËØ¢‰∫ßÂìÅ -->
    <select id="selectWithPagination" resultMap="ProductResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM products
        WHERE is_deleted = 0
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        ORDER BY created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- Ê†πÊçÆÊù°‰ª∂ÊêúÁ¥¢‰∫ßÂìÅ -->
    <select id="searchProducts" resultMap="ProductResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM products
        <where>
            <if test="name != null and name != ''">
                AND name LIKE CONCAT('%', #{name}, '%')
            </if>
            <if test="model != null and model != ''">
                AND model LIKE CONCAT('%', #{model}, '%')
            </if>
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
            <if test="minPrice != null">
                AND price >= #{minPrice}
            </if>
            <if test="maxPrice != null">
                AND price &lt;= #{maxPrice}
            </if>
            AND is_deleted = 0
        </where>
        ORDER BY name ASC
    </select>

    <!-- ÁªüËÆ°‰∫ßÂìÅÊÄªÊï∞ -->
    <select id="countAll" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM products
        WHERE is_deleted = 0
    </select>

    <!-- Ê†πÊçÆÁä∂ÊÄÅÁªüËÆ°‰∫ßÂìÅÊï∞Èá?-->
    <select id="countByStatus" parameterType="java.lang.String" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM products
        WHERE status = #{status} AND is_deleted = 0
    </select>

    <!-- ÁªüËÆ°ÊêúÁ¥¢ÁªìÊûúÊï∞Èáè -->
    <select id="countSearchResults" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM products
        <where>
            <if test="name != null and name != ''">
                AND name LIKE CONCAT('%', #{name}, '%')
            </if>
            <if test="model != null and model != ''">
                AND model LIKE CONCAT('%', #{model}, '%')
            </if>
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
            <if test="minPrice != null">
                AND price >= #{minPrice}
            </if>
            <if test="maxPrice != null">
                AND price &lt;= #{maxPrice}
            </if>
            AND is_deleted = 0
        </where>
    </select>

    <!-- ÊèíÂÖ•Êñ∞‰∫ßÂì?-->
    <insert id="insert" parameterType="com.yxrobot.entity.Product" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO products (
            name, model, description, price, cover_image_url, status, created_at, updated_at, is_deleted
        ) VALUES (
            #{name}, #{model}, #{description}, #{price}, #{coverImageUrl}, #{status}, NOW(), NOW(), #{isDeleted}
        )
    </insert>

    <!-- Êõ¥Êñ∞‰∫ßÂìÅ‰ø°ÊÅØ -->
    <update id="update" parameterType="com.yxrobot.entity.Product">
        UPDATE products
        <set>
            <if test="name != null and name != ''">
                name = #{name},
            </if>
            <if test="model != null and model != ''">
                model = #{model},
            </if>
            <if test="description != null">
                description = #{description},
            </if>
            <if test="price != null">
                price = #{price},
            </if>
            <if test="coverImageUrl != null">
                cover_image_url = #{coverImageUrl},
            </if>
            <if test="status != null and status != ''">
                status = #{status},
            </if>
            updated_at = NOW()
        </set>
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- Êõ¥Êñ∞‰∫ßÂìÅÁä∂ÊÄ?-->
    <update id="updateStatus">
        UPDATE products
        SET status = #{status}, updated_at = NOW()
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- Êõ¥Êñ∞‰∫ßÂìÅ‰ª∑Ê†º -->
    <update id="updatePrice">
        UPDATE products
        SET price = #{price}, updated_at = NOW()
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- ËΩØÂà†Èô§‰∫ßÂì?-->
    <update id="deleteById" parameterType="java.lang.Long">
        UPDATE products
        SET is_deleted = 1, updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- ÊâπÈáèËΩØÂà†Èô§‰∫ßÂì?-->
    <update id="deleteBatch">
        UPDATE products
        SET is_deleted = 1, updated_at = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- ÊÅ¢Â§çÂ∑≤Âà†Èô§ÁöÑ‰∫ßÂìÅ -->
    <update id="restoreById" parameterType="java.lang.Long">
        UPDATE products
        SET is_deleted = 0, updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- Ê£ÄÊü•‰∫ßÂìÅÂûãÂè∑ÊòØÂê¶Â≠òÂú?-->
    <select id="existsByModel" parameterType="java.lang.String" resultType="java.lang.Boolean">
        SELECT COUNT(*) > 0
        FROM products
        WHERE model = #{model} AND is_deleted = 0
    </select>

    <!-- Ê£ÄÊü•‰∫ßÂìÅÂûãÂè∑ÊòØÂê¶Â≠òÂú®ÔºàÊéíÈô§ÊåáÂÆöIDÔº?-->
    <select id="existsByModelExcludeId" resultType="java.lang.Boolean">
        SELECT COUNT(*) > 0
        FROM products
        WHERE model = #{model} AND id != #{id} AND is_deleted = 0
    </select>

    <!-- Ê∑ªÂä†ÊµãËØï‰ª£Á†ÅÊúüÊúõÁöÑÊñπÊ≥ïÂÆûÁé?-->
    
    <!-- Ê†πÊçÆÊü•ËØ¢Êù°‰ª∂Êü•ËØ¢‰∫ßÂìÅ -->
    <select id="selectByQuery" parameterType="com.yxrobot.dto.ProductQueryDTO" resultMap="ProductResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM products
        <where>
            <if test="name != null and name != ''">
                AND name LIKE CONCAT('%', #{name}, '%')
            </if>
            <if test="model != null and model != ''">
                AND model LIKE CONCAT('%', #{model}, '%')
            </if>
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
            <if test="minPrice != null">
                AND price >= #{minPrice}
            </if>
            <if test="maxPrice != null">
                AND price &lt;= #{maxPrice}
            </if>
            AND is_deleted = 0
        </where>
        ORDER BY created_at DESC
    </select>
    
    <!-- Ê†πÊçÆÊü•ËØ¢Êù°‰ª∂ÁªüËÆ°‰∫ßÂìÅÊï∞Èáè -->
    <select id="countByQuery" parameterType="com.yxrobot.dto.ProductQueryDTO" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM products
        <where>
            <if test="name != null and name != ''">
                AND name LIKE CONCAT('%', #{name}, '%')
            </if>
            <if test="model != null and model != ''">
                AND model LIKE CONCAT('%', #{model}, '%')
            </if>
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
            <if test="minPrice != null">
                AND price >= #{minPrice}
            </if>
            <if test="maxPrice != null">
                AND price &lt;= #{maxPrice}
            </if>
            AND is_deleted = 0
        </where>
    </select>
    
    <!-- Ê†πÊçÆIDÊõ¥Êñ∞‰∫ßÂìÅ -->
    <update id="updateById" parameterType="com.yxrobot.entity.Product">
        UPDATE products
        <set>
            <if test="name != null and name != ''">
                name = #{name},
            </if>
            <if test="model != null and model != ''">
                model = #{model},
            </if>
            <if test="description != null">
                description = #{description},
            </if>
            <if test="price != null">
                price = #{price},
            </if>
            <if test="coverImageUrl != null">
                cover_image_url = #{coverImageUrl},
            </if>
            <if test="status != null and status != ''">
                status = #{status},
            </if>
            updated_at = NOW()
        </set>
        WHERE id = #{id} AND is_deleted = 0
    </update>
    
    <!-- ÊâπÈáèÂà†Èô§‰∫ßÂìÅ -->
    <update id="batchDeleteByIds">
        UPDATE products
        SET is_deleted = 1, updated_at = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>
    
    <!-- Ëé∑ÂèñÁä∂ÊÄÅÁªüËÆ?-->
    <select id="getStatusStatistics" resultType="java.util.HashMap">
        SELECT 
            'published' as status, COUNT(*) as count
        FROM products 
        WHERE status = 'published' AND is_deleted = 0
        UNION ALL
        SELECT 
            'draft' as status, COUNT(*) as count
        FROM products 
        WHERE status = 'draft' AND is_deleted = 0
        UNION ALL
        SELECT 
            'total' as status, COUNT(*) as count
        FROM products 
        WHERE is_deleted = 0
    </select>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.ProductMediaMapper">

    <!-- ÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="ProductMediaResultMap" type="com.yxrobot.entity.ProductMedia">
        <id column="id" property="id"/>
        <result column="product_id" property="productId"/>
        <result column="media_type" property="mediaType"/>
        <result column="media_url" property="mediaUrl"/>
        <result column="sort_order" property="sortOrder"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="is_deleted" property="isDeleted"/>
    </resultMap>

    <!-- Âü∫Á°ÄÊü•ËØ¢Â≠óÊÆµ -->
    <sql id="Base_Column_List">
        id, product_id, media_type, media_url, sort_order, created_at, updated_at, is_deleted
    </sql>

    <!-- Ê†πÊçÆ‰∫ßÂìÅIDËé∑ÂèñÂ™í‰ΩìÂàóË°® -->
    <select id="selectByProductId" resultMap="ProductMediaResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM product_media
        WHERE product_id = #{productId} AND is_deleted = 0
        ORDER BY media_type, sort_order ASC
    </select>

    <!-- Ê†πÊçÆ‰∫ßÂìÅIDÂíåÂ™í‰ΩìÁ±ªÂûãËé∑ÂèñÂ™í‰ΩìÂàóË°?-->
    <select id="selectByProductIdAndType" resultMap="ProductMediaResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM product_media
        WHERE product_id = #{productId} AND media_type = #{mediaType} AND is_deleted = 0
        ORDER BY sort_order ASC
    </select>

    <!-- Ê†πÊçÆIDÊü•ËØ¢Â™í‰ΩìËØ¶ÊÉÖ -->
    <select id="selectById" resultMap="ProductMediaResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM product_media
        WHERE id = #{id} AND is_deleted = 0
    </select>

    <!-- ÊèíÂÖ•Êñ∞Â™í‰ΩìËÆ∞ÂΩ?-->
    <insert id="insert" parameterType="com.yxrobot.entity.ProductMedia" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO product_media (
            product_id, media_type, media_url, sort_order, created_at, updated_at, is_deleted
        ) VALUES (
            #{productId}, #{mediaType}, #{mediaUrl}, #{sortOrder}, 
            #{createdAt}, #{updatedAt}, #{isDeleted}
        )
    </insert>

    <!-- Ê†πÊçÆIDÊõ¥Êñ∞Â™í‰Ωì‰ø°ÊÅØ -->
    <update id="updateById" parameterType="com.yxrobot.entity.ProductMedia">
        UPDATE product_media
        SET media_type = #{mediaType},
            media_url = #{mediaUrl},
            sort_order = #{sortOrder},
            updated_at = #{updatedAt}
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- Ê†πÊçÆIDËΩØÂà†Èô§Â™í‰Ω?-->
    <update id="deleteById">
        UPDATE product_media
        SET is_deleted = 1, updated_at = NOW()
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- Ê†πÊçÆ‰∫ßÂìÅIDÂà†Èô§ÊâÄÊúâÂ™í‰Ω?-->
    <update id="deleteByProductId">
        UPDATE product_media
        SET is_deleted = 1, updated_at = NOW()
        WHERE product_id = #{productId} AND is_deleted = 0
    </update>

    <!-- ÊâπÈáèÂà†Èô§Â™í‰Ωì -->
    <update id="batchDeleteByIds">
        UPDATE product_media
        SET is_deleted = 1, updated_at = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND is_deleted = 0
    </update>

    <!-- ÁªüËÆ°‰∫ßÂìÅÁöÑÂ™í‰ΩìÊï∞Èá?-->
    <select id="countByProductId" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM product_media
        WHERE product_id = #{productId} AND is_deleted = 0
    </select>

    <!-- ÁªüËÆ°‰∫ßÂìÅÊåáÂÆöÁ±ªÂûãÁöÑÂ™í‰ΩìÊï∞Èá?-->
    <select id="countByProductIdAndType" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM product_media
        WHERE product_id = #{productId} AND media_type = #{mediaType} AND is_deleted = 0
    </select>

    <!-- Ëé∑Âèñ‰∫ßÂìÅÂ™í‰ΩìÁöÑÊúÄÂ§ßÊéíÂ∫èÂÄ?-->
    <select id="getMaxSortOrder" resultType="java.lang.Integer">
        SELECT COALESCE(MAX(sort_order), 0)
        FROM product_media
        WHERE product_id = #{productId} AND media_type = #{mediaType} AND is_deleted = 0
    </select>

    <!-- Êõ¥Êñ∞Â™í‰ΩìÊéíÂ∫èÂÄ?-->
    <update id="updateSortOrder">
        UPDATE product_media
        SET sort_order = #{sortOrder}, updated_at = NOW()
        WHERE id = #{id} AND is_deleted = 0
    </update>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.RegionConfigMapper">

    <!-- ÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="RegionConfigResultMap" type="com.yxrobot.entity.RegionConfig">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="region" property="region" jdbcType="VARCHAR"/>
        <result column="country" property="country" jdbcType="VARCHAR"/>
        <result column="language_code" property="languageCode" jdbcType="VARCHAR"/>
        <result column="language_name" property="languageName" jdbcType="VARCHAR"/>
        <result column="is_active" property="isActive" jdbcType="TINYINT"/>
        <result column="sort_order" property="sortOrder" jdbcType="INTEGER"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!-- Âü∫Á°ÄÂà?-->
    <sql id="Base_Column_List">
        id, region, country, language_code, language_name, 
        is_active, sort_order, created_at, updated_at
    </sql>

    <!-- Ê†πÊçÆIDÊü•ËØ¢ -->
    <select id="selectById" resultMap="RegionConfigResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM region_configs
        WHERE id = #{id}
    </select>

    <!-- Êü•ËØ¢ÊâÄÊúâÊøÄÊ¥ªÁöÑÂå∫ÂüüÈÖçÁΩÆ -->
    <select id="selectAllActive" resultMap="RegionConfigResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM region_configs
        WHERE is_active = TRUE
        ORDER BY sort_order ASC, region ASC, language_name ASC
    </select>

    <!-- Ê†πÊçÆÂú∞Âå∫Êü•ËØ¢ÈÖçÁΩÆ -->
    <select id="selectByRegion" resultMap="RegionConfigResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM region_configs
        WHERE region = #{region} AND is_active = 1
        ORDER BY sort_order ASC, language_name ASC
    </select>

    <!-- Ê†πÊçÆÂõΩÂÆ∂Êü•ËØ¢ÈÖçÁΩÆ -->
    <select id="selectByCountry" resultMap="RegionConfigResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM region_configs
        WHERE country = #{country} AND is_active = 1
        ORDER BY sort_order ASC, region ASC, language_name ASC
    </select>

    <!-- Ê†πÊçÆËØ≠Ë®Ä‰ª£Á†ÅÊü•ËØ¢ÈÖçÁΩÆ -->
    <select id="selectByLanguageCode" resultMap="RegionConfigResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM region_configs
        WHERE language_code = #{languageCode} AND is_active = 1
        ORDER BY sort_order ASC, region ASC
    </select>

    <!-- Êü•ËØ¢ÊâÄÊúâ‰∏çÈáçÂ§çÁöÑÂú∞Âå?-->
    <select id="selectDistinctRegions" resultType="string">
        SELECT DISTINCT region
        FROM region_configs
        WHERE is_active = 1
        ORDER BY region ASC
    </select>

    <!-- Êü•ËØ¢ÊâÄÊúâ‰∏çÈáçÂ§çÁöÑÂõΩÂÆ?-->
    <select id="selectDistinctCountries" resultType="string">
        SELECT DISTINCT country
        FROM region_configs
        WHERE is_active = 1
        ORDER BY country ASC
    </select>

    <!-- Êü•ËØ¢ÊâÄÊúâ‰∏çÈáçÂ§çÁöÑËØ≠Ë®Ä -->
    <select id="selectDistinctLanguages" resultType="map">
        SELECT DISTINCT 
            language_code as code,
            language_name as name
        FROM region_configs
        WHERE is_active = 1
        ORDER BY language_name ASC
    </select>

    <!-- ÊèíÂÖ•Âå∫ÂüüÈÖçÁΩÆ -->
    <insert id="insert" parameterType="com.yxrobot.entity.RegionConfig" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO region_configs (
            region, country, language_code, language_name, 
            is_active, sort_order, created_at, updated_at
        ) VALUES (
            #{region}, #{country}, #{languageCode}, #{languageName},
            #{isActive}, #{sortOrder}, NOW(), NOW()
        )
    </insert>

    <!-- Êõ¥Êñ∞Âå∫ÂüüÈÖçÁΩÆ -->
    <update id="update" parameterType="com.yxrobot.entity.RegionConfig">
        UPDATE region_configs
        <set>
            <if test="region != null and region != ''">
                region = #{region},
            </if>
            <if test="country != null and country != ''">
                country = #{country},
            </if>
            <if test="languageCode != null and languageCode != ''">
                language_code = #{languageCode},
            </if>
            <if test="languageName != null and languageName != ''">
                language_name = #{languageName},
            </if>
            <if test="isActive != null">
                is_active = #{isActive},
            </if>
            <if test="sortOrder != null">
                sort_order = #{sortOrder},
            </if>
            updated_at = NOW()
        </set>
        WHERE id = #{id}
    </update>

    <!-- Âà†Èô§Âå∫ÂüüÈÖçÁΩÆ -->
    <delete id="deleteById">
        DELETE FROM region_configs
        WHERE id = #{id}
    </delete>

    <!-- Êõ¥Êñ∞ÊøÄÊ¥ªÁä∂ÊÄ?-->
    <update id="updateActiveStatus">
        UPDATE region_configs
        SET is_active = #{isActive}, updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- Ê£ÄÊü•Âå∫ÂüüÂíåËØ≠Ë®ÄÁªÑÂêàÊòØÂê¶Â∑≤Â≠òÂú?-->
    <select id="checkExists" resultType="int">
        SELECT COUNT(*)
        FROM region_configs
        WHERE region = #{region} 
          AND language_code = #{languageCode}
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
    </select>

    <!-- ÊâπÈáèÊèíÂÖ•Âå∫ÂüüÈÖçÁΩÆ -->
    <insert id="batchInsert" parameterType="list">
        INSERT INTO region_configs (
            region, country, language_code, language_name, 
            is_active, sort_order, created_at, updated_at
        ) VALUES
        <foreach collection="configs" item="config" separator=",">
            (#{config.region}, #{config.country}, #{config.languageCode}, #{config.languageName},
             #{config.isActive}, #{config.sortOrder}, NOW(), NOW())
        </foreach>
    </insert>

    <!-- È™åËØÅÂú∞Âå∫ÂíåËØ≠Ë®ÄÈÖçÁΩÆÊòØÂê¶ÊúâÊïà -->
    <select id="validateRegionLanguage" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM region_configs
        WHERE region = #{region} 
          AND language_code = #{languageCode}
          AND is_active = 1
    </select>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.RentalCustomerMapper">

    <!-- ÁßüËµÅÂÆ¢Êà∑ÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="RentalCustomerResultMap" type="com.yxrobot.entity.RentalCustomer">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="customer_name" property="customerName" jdbcType="VARCHAR"/>
        <result column="customer_type" property="customerType" jdbcType="VARCHAR"/>
        <result column="contact_person" property="contactPerson" jdbcType="VARCHAR"/>
        <result column="phone" property="phone" jdbcType="VARCHAR"/>
        <result column="email" property="email" jdbcType="VARCHAR"/>
        <result column="address" property="address" jdbcType="VARCHAR"/>
        <result column="region" property="region" jdbcType="VARCHAR"/>
        <result column="industry" property="industry" jdbcType="VARCHAR"/>
        <result column="credit_level" property="creditLevel" jdbcType="VARCHAR"/>
        <result column="total_rental_amount" property="totalRentalAmount" jdbcType="DECIMAL"/>
        <result column="total_rental_days" property="totalRentalDays" jdbcType="INTEGER"/>
        <result column="last_rental_date" property="lastRentalDate" jdbcType="DATE"/>
        <result column="is_active" property="isActive" jdbcType="TINYINT"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP"/>
        <result column="is_deleted" property="isDeleted" jdbcType="TINYINT"/>
    </resultMap>

    <!-- Âü∫Á°ÄÊü•ËØ¢Â≠óÊÆµ -->
    <sql id="Base_Column_List">
        id, customer_name, customer_type, contact_person, phone, email, address,
        region, industry, credit_level, total_rental_amount, total_rental_days,
        last_rental_date, is_active, created_at, updated_at, is_deleted
    </sql>

    <!-- Êü•ËØ¢Êù°‰ª∂ -->
    <sql id="Where_Clause">
        <where>
            is_deleted = 0
            <if test="params.keyword != null and params.keyword != ''">
                AND (customer_name LIKE CONCAT('%', #{params.keyword}, '%')
                OR contact_person LIKE CONCAT('%', #{params.keyword}, '%')
                OR phone LIKE CONCAT('%', #{params.keyword}, '%'))
            </if>
            <if test="params.customerType != null and params.customerType != ''">
                AND customer_type = #{params.customerType}
            </if>
            <if test="params.region != null and params.region != ''">
                AND region = #{params.region}
            </if>
            <if test="params.creditLevel != null and params.creditLevel != ''">
                AND credit_level = #{params.creditLevel}
            </if>
            <if test="params.isActive != null">
                AND is_active = #{params.isActive}
            </if>
        </where>
    </sql>

    <!-- Ê†πÊçÆIDÊü•ËØ¢ -->
    <select id="selectById" resultMap="RentalCustomerResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM rental_customers
        WHERE id = #{id} AND is_deleted = 0
    </select>

    <!-- Ê†πÊçÆÂÆ¢Êà∑ÂêçÁß∞Êü•ËØ¢ -->
    <select id="selectByName" resultMap="RentalCustomerResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM rental_customers
        WHERE customer_name = #{customerName} AND is_deleted = 0
    </select>

    <!-- ÂàÜÈ°µÊü•ËØ¢ÂàóË°® -->
    <select id="selectList" resultMap="RentalCustomerResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM rental_customers
        <include refid="Where_Clause"/>
        ORDER BY total_rental_amount DESC, created_at DESC
        <if test="params.page != null and params.pageSize != null">
            LIMIT #{params.pageSize} OFFSET #{params.offset}
        </if>
    </select>

    <!-- Êü•ËØ¢ÊÄªÊï∞ -->
    <select id="selectCount" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM rental_customers
        <include refid="Where_Clause"/>
    </select>

    <!-- ÊèíÂÖ•ÂÆ¢Êà∑ -->
    <insert id="insert" parameterType="com.yxrobot.entity.RentalCustomer" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO rental_customers (
            customer_name, customer_type, contact_person, phone, email, address,
            region, industry, credit_level, total_rental_amount, total_rental_days,
            last_rental_date, is_active, created_at, updated_at, is_deleted
        ) VALUES (
            #{customerName}, #{customerType}, #{contactPerson}, #{phone}, #{email}, #{address},
            #{region}, #{industry}, #{creditLevel}, #{totalRentalAmount}, #{totalRentalDays},
            #{lastRentalDate}, #{isActive}, NOW(), NOW(), 0
        )
    </insert>

    <!-- Êõ¥Êñ∞ÂÆ¢Êà∑ -->
    <update id="updateById" parameterType="com.yxrobot.entity.RentalCustomer">
        UPDATE rental_customers
        SET customer_name = #{customerName},
            customer_type = #{customerType},
            contact_person = #{contactPerson},
            phone = #{phone},
            email = #{email},
            address = #{address},
            region = #{region},
            industry = #{industry},
            credit_level = #{creditLevel},
            total_rental_amount = #{totalRentalAmount},
            total_rental_days = #{totalRentalDays},
            last_rental_date = #{lastRentalDate},
            is_active = #{isActive},
            updated_at = NOW()
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- ËΩØÂà†Èô?-->
    <update id="deleteById">
        UPDATE rental_customers
        SET is_deleted = 1, updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- ÊâπÈáèËΩØÂà†Èô?-->
    <update id="deleteBatchByIds">
        UPDATE rental_customers
        SET is_deleted = 1, updated_at = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑Á±ªÂûãÂàÜÂ∏É -->
    <select id="selectCustomerTypeDistribution" resultType="java.util.Map">
        SELECT 
            customer_type as name,
            COUNT(*) as value,
            COALESCE(SUM(total_rental_amount), 0) as totalAmount
        FROM rental_customers
        WHERE is_deleted = 0 AND is_active = 1
        GROUP BY customer_type
        ORDER BY value DESC
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑Âú∞Âå∫ÂàÜÂ∏É -->
    <select id="selectCustomerRegionDistribution" resultType="java.util.Map">
        SELECT 
            region as name,
            COUNT(*) as value,
            COALESCE(SUM(total_rental_amount), 0) as totalAmount
        FROM rental_customers
        WHERE is_deleted = 0 AND is_active = 1 AND region IS NOT NULL
        GROUP BY region
        ORDER BY totalAmount DESC
    </select>

    <!-- Êõ¥Êñ∞ÂÆ¢Êà∑ÁßüËµÅÁªüËÆ° -->
    <update id="updateRentalStats">
        UPDATE rental_customers
        SET total_rental_amount = #{totalRentalAmount},
            total_rental_days = #{totalRentalDays},
            last_rental_date = CURDATE(),
            updated_at = NOW()
        WHERE id = #{customerId} AND is_deleted = 0
    </update>

    <!-- Êü•ËØ¢Ê¥ªË∑ÉÂÆ¢Êà∑Êï?-->
    <select id="selectActiveCustomerCount" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM rental_customers
        WHERE is_deleted = 0 AND is_active = 1
    </select>

    <!-- Êü•ËØ¢Êñ∞ÂÆ¢Êà∑Êï∞ -->
    <select id="selectNewCustomerCount" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM rental_customers
        WHERE is_deleted = 0 
        AND DATE(created_at) BETWEEN #{startDate} AND #{endDate}
    </select>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.RentalDeviceMapper">

    <!-- ÁßüËµÅËÆæÂ§áÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="RentalDeviceResultMap" type="com.yxrobot.entity.RentalDevice">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="device_id" property="deviceId" jdbcType="VARCHAR"/>
        <result column="device_model" property="deviceModel" jdbcType="VARCHAR"/>
        <result column="device_name" property="deviceName" jdbcType="VARCHAR"/>
        <result column="device_category" property="deviceCategory" jdbcType="VARCHAR"/>
        <result column="serial_number" property="serialNumber" jdbcType="VARCHAR"/>
        <result column="purchase_date" property="purchaseDate" jdbcType="DATE"/>
        <result column="purchase_price" property="purchasePrice" jdbcType="DECIMAL"/>
        <result column="daily_rental_price" property="dailyRentalPrice" jdbcType="DECIMAL"/>
        <result column="current_status" property="currentStatus" jdbcType="VARCHAR"/>
        <result column="location" property="location" jdbcType="VARCHAR"/>
        <result column="region" property="region" jdbcType="VARCHAR"/>
        <result column="performance_score" property="performanceScore" jdbcType="INTEGER"/>
        <result column="signal_strength" property="signalStrength" jdbcType="INTEGER"/>
        <result column="maintenance_status" property="maintenanceStatus" jdbcType="VARCHAR"/>
        <result column="last_maintenance_date" property="lastMaintenanceDate" jdbcType="DATE"/>
        <result column="next_maintenance_date" property="nextMaintenanceDate" jdbcType="DATE"/>
        <result column="total_rental_days" property="totalRentalDays" jdbcType="INTEGER"/>
        <result column="total_available_days" property="totalAvailableDays" jdbcType="INTEGER"/>
        <result column="utilization_rate" property="utilizationRate" jdbcType="DECIMAL"/>
        <result column="last_rental_date" property="lastRentalDate" jdbcType="DATE"/>
        <result column="is_active" property="isActive" jdbcType="TINYINT"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP"/>
        <result column="is_deleted" property="isDeleted" jdbcType="TINYINT"/>
    </resultMap>

    <!-- ËÆæÂ§áÂà©Áî®ÁéáDTOÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="DeviceUtilizationResultMap" type="com.yxrobot.dto.DeviceUtilizationDTO">
        <result column="device_id" property="deviceId" jdbcType="VARCHAR"/>
        <result column="device_model" property="deviceModel" jdbcType="VARCHAR"/>
        <result column="utilization_rate" property="utilizationRate" jdbcType="DECIMAL"/>
        <result column="total_rental_days" property="totalRentalDays" jdbcType="INTEGER"/>
        <result column="total_available_days" property="totalAvailableDays" jdbcType="INTEGER"/>
        <result column="current_status" property="currentStatus" jdbcType="VARCHAR"/>
        <result column="last_rental_date" property="lastRentalDate" jdbcType="VARCHAR"/>
        <result column="region" property="region" jdbcType="VARCHAR"/>
        <result column="performance_score" property="performanceScore" jdbcType="INTEGER"/>
        <result column="signal_strength" property="signalStrength" jdbcType="INTEGER"/>
        <result column="maintenance_status" property="maintenanceStatus" jdbcType="VARCHAR"/>
    </resultMap>

    <!-- Âü∫Á°ÄÊü•ËØ¢Â≠óÊÆµ -->
    <sql id="Base_Column_List">
        id, device_id, device_model, device_name, device_category, serial_number,
        purchase_date, purchase_price, daily_rental_price, current_status, location,
        region, performance_score, signal_strength, maintenance_status,
        last_maintenance_date, next_maintenance_date, total_rental_days,
        total_available_days, utilization_rate, last_rental_date, is_active,
        created_at, updated_at, is_deleted
    </sql>

    <!-- Êü•ËØ¢Êù°‰ª∂ -->
    <sql id="Where_Clause">
        <where>
            is_deleted = 0
            <if test="params.keyword != null and params.keyword != ''">
                AND (device_id LIKE CONCAT('%', #{params.keyword}, '%')
                OR device_model LIKE CONCAT('%', #{params.keyword}, '%')
                OR device_name LIKE CONCAT('%', #{params.keyword}, '%'))
            </if>
            <if test="params.deviceModel != null and params.deviceModel != ''">
                AND device_model = #{params.deviceModel}
            </if>
            <if test="params.currentStatus != null and params.currentStatus != ''">
                AND current_status = #{params.currentStatus}
            </if>
            <if test="params.region != null and params.region != ''">
                AND region = #{params.region}
            </if>
            <if test="params.isActive != null">
                AND is_active = #{params.isActive}
            </if>
        </where>
    </sql>

    <!-- È´òÁ∫ßÊêúÁ¥¢Êü•ËØ¢Êù°‰ª∂ -->
    <sql id="Advanced_Where_Clause">
        <where>
            is_deleted = 0
            <!-- ÂÖ≥ÈîÆËØçÊêúÁ¥?-->
            <if test="params.keyword != null and params.keyword != ''">
                AND (device_id LIKE CONCAT('%', #{params.keyword}, '%')
                OR device_model LIKE CONCAT('%', #{params.keyword}, '%')
                OR device_name LIKE CONCAT('%', #{params.keyword}, '%')
                OR location LIKE CONCAT('%', #{params.keyword}, '%'))
            </if>
            
            <!-- ËÆæÂ§áÂûãÂè∑Á≠õÈÄâÔºàÊîØÊåÅÂ§öÈÄâÔºâ -->
            <if test="params.deviceModels != null and params.deviceModels.size() > 0">
                AND device_model IN
                <foreach collection="params.deviceModels" item="model" open="(" separator="," close=")">
                    #{model}
                </foreach>
            </if>
            <if test="params.deviceModel != null and params.deviceModel != ''">
                AND device_model = #{params.deviceModel}
            </if>
            
            <!-- ËÆæÂ§áÁä∂ÊÄÅÁ≠õÈÄâÔºàÊîØÊåÅÂ§öÈÄâÔºâ -->
            <if test="params.statuses != null and params.statuses.size() > 0">
                AND current_status IN
                <foreach collection="params.statuses" item="status" open="(" separator="," close=")">
                    #{status}
                </foreach>
            </if>
            <if test="params.currentStatus != null and params.currentStatus != ''">
                AND current_status = #{params.currentStatus}
            </if>
            
            <!-- Âú∞Âå∫Á≠õÈÄâÔºàÊîØÊåÅÂ§öÈÄâÔºâ -->
            <if test="params.regions != null and params.regions.size() > 0">
                AND region IN
                <foreach collection="params.regions" item="region" open="(" separator="," close=")">
                    #{region}
                </foreach>
            </if>
            <if test="params.region != null and params.region != ''">
                AND region = #{params.region}
            </if>
            
            <!-- Âà©Áî®ÁéáËåÉÂõ¥Á≠õÈÄ?-->
            <if test="params.minUtilization != null">
                AND utilization_rate >= #{params.minUtilization}
            </if>
            <if test="params.maxUtilization != null">
                AND utilization_rate &lt;= #{params.maxUtilization}
            </if>
            
            <!-- ÁßüËµÅÂ§©Êï∞ËåÉÂõ¥Á≠õÈÄ?-->
            <if test="params.minRentalDays != null">
                AND total_rental_days >= #{params.minRentalDays}
            </if>
            <if test="params.maxRentalDays != null">
                AND total_rental_days &lt;= #{params.maxRentalDays}
            </if>
            
            <!-- Êó∂Èó¥ËåÉÂõ¥Á≠õÈÄ?-->
            <if test="params.startDate != null">
                AND last_rental_date >= #{params.startDate}
            </if>
            <if test="params.endDate != null">
                AND last_rental_date &lt;= #{params.endDate}
            </if>
            
            <!-- Áª¥Êä§Áä∂ÊÄÅÁ≠õÈÄ?-->
            <if test="params.maintenanceStatus != null and params.maintenanceStatus != ''">
                AND maintenance_status = #{params.maintenanceStatus}
            </if>
            
            <!-- ÊÄßËÉΩËØÑÂàÜËåÉÂõ¥Á≠õÈÄ?-->
            <if test="params.minPerformanceScore != null">
                AND performance_score >= #{params.minPerformanceScore}
            </if>
            <if test="params.maxPerformanceScore != null">
                AND performance_score &lt;= #{params.maxPerformanceScore}
            </if>
            
            <!-- ‰ø°Âè∑Âº∫Â∫¶ËåÉÂõ¥Á≠õÈÄ?-->
            <if test="params.minSignalStrength != null">
                AND signal_strength >= #{params.minSignalStrength}
            </if>
            <if test="params.maxSignalStrength != null">
                AND signal_strength &lt;= #{params.maxSignalStrength}
            </if>
            
            <!-- ÊòØÂê¶Ê¥ªË∑ÉÁ≠õÈÄ?-->
            <if test="params.isActive != null">
                AND is_active = #{params.isActive}
            </if>
        </where>
    </sql>

    <!-- Ê†πÊçÆIDÊü•ËØ¢ -->
    <select id="selectById" resultMap="RentalDeviceResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM rental_devices
        WHERE id = #{id} AND is_deleted = 0
    </select>

    <!-- Ê†πÊçÆËÆæÂ§áÁºñÂè∑Êü•ËØ¢ -->
    <select id="selectByDeviceId" resultMap="RentalDeviceResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM rental_devices
        WHERE device_id = #{deviceId} AND is_deleted = 0
    </select>

    <!-- ÂàÜÈ°µÊü•ËØ¢ÂàóË°® -->
    <select id="selectList" resultMap="RentalDeviceResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM rental_devices
        <include refid="Where_Clause"/>
        ORDER BY utilization_rate DESC, created_at DESC
        <if test="params.page != null and params.pageSize != null">
            LIMIT #{params.pageSize} OFFSET #{params.offset}
        </if>
    </select>

    <!-- Êü•ËØ¢ÊÄªÊï∞ -->
    <select id="selectCount" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM rental_devices
        <include refid="Where_Clause"/>
    </select>

    <!-- Êü•ËØ¢ËÆæÂ§áÂà©Áî®ÁéáÊï∞ÊçÆÔºàÈÄÇÈÖçÂâçÁ´ØË°®Ê†ºÔº?-->
    <select id="selectDeviceUtilizationList" resultMap="DeviceUtilizationResultMap">
        SELECT 
            device_id,
            device_model,
            utilization_rate,
            total_rental_days,
            total_available_days,
            current_status,
            DATE_FORMAT(last_rental_date, '%Y-%m-%d') as last_rental_date,
            region,
            performance_score,
            signal_strength,
            maintenance_status
        FROM rental_devices
        <include refid="Where_Clause"/>
        ORDER BY utilization_rate DESC, device_id ASC
        <if test="params.page != null and params.pageSize != null">
            LIMIT #{params.pageSize} OFFSET #{params.offset}
        </if>
    </select>

    <!-- Êü•ËØ¢ËÆæÂ§áÂà©Áî®ÁéáÊï∞ÊçÆÊÄªÊï∞ -->
    <select id="selectDeviceUtilizationCount" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM rental_devices
        <include refid="Where_Clause"/>
    </select>

    <!-- ÊèíÂÖ•ËÆæÂ§á -->
    <insert id="insert" parameterType="com.yxrobot.entity.RentalDevice" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO rental_devices (
            device_id, device_model, device_name, device_category, serial_number,
            purchase_date, purchase_price, daily_rental_price, current_status, location,
            region, performance_score, signal_strength, maintenance_status,
            last_maintenance_date, next_maintenance_date, total_rental_days,
            total_available_days, utilization_rate, last_rental_date, is_active,
            created_at, updated_at, is_deleted
        ) VALUES (
            #{deviceId}, #{deviceModel}, #{deviceName}, #{deviceCategory}, #{serialNumber},
            #{purchaseDate}, #{purchasePrice}, #{dailyRentalPrice}, #{currentStatus}, #{location},
            #{region}, #{performanceScore}, #{signalStrength}, #{maintenanceStatus},
            #{lastMaintenanceDate}, #{nextMaintenanceDate}, #{totalRentalDays},
            #{totalAvailableDays}, #{utilizationRate}, #{lastRentalDate}, #{isActive},
            NOW(), NOW(), 0
        )
    </insert>

    <!-- Êõ¥Êñ∞ËÆæÂ§á -->
    <update id="updateById" parameterType="com.yxrobot.entity.RentalDevice">
        UPDATE rental_devices
        SET device_id = #{deviceId},
            device_model = #{deviceModel},
            device_name = #{deviceName},
            device_category = #{deviceCategory},
            serial_number = #{serialNumber},
            purchase_date = #{purchaseDate},
            purchase_price = #{purchasePrice},
            daily_rental_price = #{dailyRentalPrice},
            current_status = #{currentStatus},
            location = #{location},
            region = #{region},
            performance_score = #{performanceScore},
            signal_strength = #{signalStrength},
            maintenance_status = #{maintenanceStatus},
            last_maintenance_date = #{lastMaintenanceDate},
            next_maintenance_date = #{nextMaintenanceDate},
            total_rental_days = #{totalRentalDays},
            total_available_days = #{totalAvailableDays},
            utilization_rate = #{utilizationRate},
            last_rental_date = #{lastRentalDate},
            is_active = #{isActive},
            updated_at = NOW()
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- ËΩØÂà†Èô?-->
    <update id="deleteById">
        UPDATE rental_devices
        SET is_deleted = 1, updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- ÊâπÈáèËΩØÂà†Èô?-->
    <update id="deleteBatchByIds">
        UPDATE rental_devices
        SET is_deleted = 1, updated_at = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- Êü•ËØ¢ËÆæÂ§áÁä∂ÊÄÅÁªüËÆ?-->
    <select id="selectDeviceStatusStats" resultType="java.util.Map">
        SELECT 
            COUNT(CASE WHEN current_status = 'active' THEN 1 END) as active,
            COUNT(CASE WHEN current_status = 'idle' THEN 1 END) as idle,
            COUNT(CASE WHEN current_status = 'maintenance' THEN 1 END) as maintenance
        FROM rental_devices
        WHERE is_deleted = 0 AND is_active = 1
    </select>

    <!-- Êü•ËØ¢Âà©Áî®ÁéáTOPËÆæÂ§á -->
    <select id="selectTopDevicesByUtilization" resultMap="DeviceUtilizationResultMap">
        SELECT 
            device_id,
            device_model,
            utilization_rate,
            total_rental_days,
            total_available_days,
            current_status,
            DATE_FORMAT(last_rental_date, '%Y-%m-%d') as last_rental_date,
            region,
            performance_score,
            signal_strength,
            maintenance_status
        FROM rental_devices
        WHERE is_deleted = 0 AND is_active = 1
        ORDER BY utilization_rate DESC
        LIMIT #{limit}
    </select>

    <!-- Êü•ËØ¢ËÆæÂ§áÂûãÂè∑ÂàÜÂ∏É -->
    <select id="selectDeviceModelDistribution" resultType="java.util.Map">
        SELECT 
            device_model as name,
            COUNT(*) as value,
            COALESCE(AVG(utilization_rate), 0) as avgUtilization
        FROM rental_devices
        WHERE is_deleted = 0 AND is_active = 1
        GROUP BY device_model
        ORDER BY value DESC
    </select>

    <!-- Êü•ËØ¢ËÆæÂ§áÂà©Áî®ÁéáÊéíË°åÊï∞Êç?-->
    <select id="selectUtilizationRanking" resultType="java.util.Map">
        SELECT 
            CONCAT(device_id, ' (', device_model, ')') as name,
            utilization_rate as value
        FROM rental_devices
        WHERE is_deleted = 0 AND is_active = 1
        ORDER BY utilization_rate DESC
        LIMIT #{limit}
    </select>

    <!-- Êõ¥Êñ∞ËÆæÂ§áÂà©Áî®Áé?-->
    <update id="updateUtilizationRate">
        UPDATE rental_devices
        SET utilization_rate = #{utilizationRate},
            total_rental_days = #{totalRentalDays},
            total_available_days = #{totalAvailableDays},
            updated_at = NOW()
        WHERE id = #{deviceId} AND is_deleted = 0
    </update>

    <!-- Êü•ËØ¢ÊâÄÊúâËÆæÂ§áÂûãÂè?-->
    <select id="selectAllDeviceModels" resultType="java.lang.String">
        SELECT DISTINCT device_model
        FROM rental_devices
        WHERE is_deleted = 0 AND is_active = 1
        ORDER BY device_model
    </select>

    <!-- Êü•ËØ¢ÊâÄÊúâÂú∞Âå?-->
    <select id="selectAllRegions" resultType="java.lang.String">
        SELECT DISTINCT region
        FROM rental_devices
        WHERE is_deleted = 0 AND is_active = 1 AND region IS NOT NULL
        ORDER BY region
    </select>

    <!-- Êõ¥Êñ∞ËÆæÂ§áÁä∂ÊÄÅÔºàÊ†πÊçÆËÆæÂ§áÁºñÂè∑Ôº?-->
    <update id="updateDeviceStatus">
        UPDATE rental_devices
        SET current_status = #{currentStatus},
            updated_at = NOW()
        WHERE device_id = #{deviceId} AND is_deleted = 0
    </update>

    <!-- Êõ¥Êñ∞ËÆæÂ§áÁª¥Êä§Áä∂ÊÄÅÔºàÊ†πÊçÆËÆæÂ§áÁºñÂè∑Ôº?-->
    <update id="updateMaintenanceStatus">
        UPDATE rental_devices
        SET maintenance_status = #{maintenanceStatus},
            updated_at = NOW()
        WHERE device_id = #{deviceId} AND is_deleted = 0
    </update>

    <!-- ËΩØÂà†Èô§ËÆæÂ§áÔºàÊ†πÊçÆËÆæÂ§áÁºñÂè∑Ôº?-->
    <update id="softDeleteByDeviceId">
        UPDATE rental_devices
        SET is_deleted = 1, updated_at = NOW()
        WHERE device_id = #{deviceId}
    </update>

    <!-- ÊâπÈáèÊõ¥Êñ∞ËÆæÂ§áÁä∂ÊÄ?-->
    <update id="batchUpdateDeviceStatus">
        UPDATE rental_devices
        SET current_status = #{currentStatus},
            updated_at = NOW()
        WHERE device_id IN
        <foreach collection="deviceIds" item="deviceId" open="(" separator="," close=")">
            #{deviceId}
        </foreach>
        AND is_deleted = 0
    </update>

    <!-- ÊâπÈáèÊõ¥Êñ∞ËÆæÂ§áÁª¥Êä§Áä∂ÊÄ?-->
    <update id="batchUpdateMaintenanceStatus">
        UPDATE rental_devices
        SET maintenance_status = #{maintenanceStatus},
            updated_at = NOW()
        WHERE device_id IN
        <foreach collection="deviceIds" item="deviceId" open="(" separator="," close=")">
            #{deviceId}
        </foreach>
        AND is_deleted = 0
    </update>

    <!-- ÊâπÈáèËΩØÂà†Èô§ËÆæÂ§áÔºàÊ†πÊçÆËÆæÂ§áÁºñÂè∑Ôº?-->
    <update id="batchSoftDeleteByDeviceIds">
        UPDATE rental_devices
        SET is_deleted = 1, updated_at = NOW()
        WHERE device_id IN
        <foreach collection="deviceIds" item="deviceId" open="(" separator="," close=")">
            #{deviceId}
        </foreach>
    </update>

    <!-- È´òÁ∫ßÊêúÁ¥¢ËÆæÂ§áÂà©Áî®ÁéáÊï∞Êç?-->
    <select id="selectDeviceUtilizationWithAdvancedSearch" resultMap="DeviceUtilizationResultMap">
        SELECT 
            device_id,
            device_model,
            utilization_rate,
            total_rental_days,
            total_available_days,
            current_status,
            DATE_FORMAT(last_rental_date, '%Y-%m-%d') as last_rental_date,
            region,
            performance_score,
            signal_strength,
            maintenance_status
        FROM rental_devices
        <include refid="Advanced_Where_Clause"/>
        <choose>
            <when test="params.sortBy != null and params.sortBy != ''">
                ORDER BY ${params.sortBy}
                <if test="params.sortOrder != null and params.sortOrder != ''">
                    ${params.sortOrder}
                </if>
            </when>
            <otherwise>
                ORDER BY utilization_rate DESC, device_id ASC
            </otherwise>
        </choose>
        <if test="params.page != null and params.pageSize != null">
            LIMIT #{params.pageSize} OFFSET #{params.offset}
        </if>
    </select>

    <!-- È´òÁ∫ßÊêúÁ¥¢ËÆæÂ§áÂà©Áî®ÁéáÊï∞ÊçÆÊÄªÊï∞ -->
    <select id="selectDeviceUtilizationCountWithAdvancedSearch" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM rental_devices
        <include refid="Advanced_Where_Clause"/>
    </select>

    <!-- ÊåâÊó∂Èó¥ËåÉÂõ¥Êü•ËØ¢ËÆæÂ§áÂà©Áî®ÁéáÊï∞ÊçÆ -->
    <select id="selectDeviceUtilizationByDateRange" resultMap="DeviceUtilizationResultMap">
        SELECT 
            device_id,
            device_model,
            utilization_rate,
            total_rental_days,
            total_available_days,
            current_status,
            DATE_FORMAT(last_rental_date, '%Y-%m-%d') as last_rental_date,
            region,
            performance_score,
            signal_strength,
            maintenance_status
        FROM rental_devices
        WHERE is_deleted = 0
        <if test="params.startDate != null">
            AND last_rental_date >= #{params.startDate}
        </if>
        <if test="params.endDate != null">
            AND last_rental_date &lt;= #{params.endDate}
        </if>
        <if test="params.keyword != null and params.keyword != ''">
            AND (device_id LIKE CONCAT('%', #{params.keyword}, '%')
            OR device_model LIKE CONCAT('%', #{params.keyword}, '%'))
        </if>
        ORDER BY last_rental_date DESC, utilization_rate DESC
        <if test="params.page != null and params.pageSize != null">
            LIMIT #{params.pageSize} OFFSET #{params.offset}
        </if>
    </select>

    <!-- ÊåâÂ§ö‰∏™ËÆæÂ§áÂûãÂè∑Êü•ËØ?-->
    <select id="selectDeviceUtilizationByModels" resultMap="DeviceUtilizationResultMap">
        SELECT 
            device_id,
            device_model,
            utilization_rate,
            total_rental_days,
            total_available_days,
            current_status,
            DATE_FORMAT(last_rental_date, '%Y-%m-%d') as last_rental_date,
            region,
            performance_score,
            signal_strength,
            maintenance_status
        FROM rental_devices
        WHERE is_deleted = 0
        AND device_model IN
        <foreach collection="deviceModels" item="model" open="(" separator="," close=")">
            #{model}
        </foreach>
        <if test="params.keyword != null and params.keyword != ''">
            AND (device_id LIKE CONCAT('%', #{params.keyword}, '%')
            OR device_name LIKE CONCAT('%', #{params.keyword}, '%'))
        </if>
        <if test="params.region != null and params.region != ''">
            AND region = #{params.region}
        </if>
        ORDER BY device_model, utilization_rate DESC
        <if test="params.page != null and params.pageSize != null">
            LIMIT #{params.pageSize} OFFSET #{params.offset}
        </if>
    </select>

    <!-- ÊåâÂ§ö‰∏™Áä∂ÊÄÅÊü•ËØ?-->
    <select id="selectDeviceUtilizationByStatuses" resultMap="DeviceUtilizationResultMap">
        SELECT 
            device_id,
            device_model,
            utilization_rate,
            total_rental_days,
            total_available_days,
            current_status,
            DATE_FORMAT(last_rental_date, '%Y-%m-%d') as last_rental_date,
            region,
            performance_score,
            signal_strength,
            maintenance_status
        FROM rental_devices
        WHERE is_deleted = 0
        AND current_status IN
        <foreach collection="statuses" item="status" open="(" separator="," close=")">
            #{status}
        </foreach>
        <if test="params.keyword != null and params.keyword != ''">
            AND (device_id LIKE CONCAT('%', #{params.keyword}, '%')
            OR device_model LIKE CONCAT('%', #{params.keyword}, '%'))
        </if>
        ORDER BY current_status, utilization_rate DESC
        <if test="params.page != null and params.pageSize != null">
            LIMIT #{params.pageSize} OFFSET #{params.offset}
        </if>
    </select>

    <!-- ÊåâÂà©Áî®ÁéáËåÉÂõ¥Êü•ËØ¢ -->
    <select id="selectDeviceUtilizationByUtilizationRange" resultMap="DeviceUtilizationResultMap">
        SELECT 
            device_id,
            device_model,
            utilization_rate,
            total_rental_days,
            total_available_days,
            current_status,
            DATE_FORMAT(last_rental_date, '%Y-%m-%d') as last_rental_date,
            region,
            performance_score,
            signal_strength,
            maintenance_status
        FROM rental_devices
        WHERE is_deleted = 0
        <if test="minUtilization != null">
            AND utilization_rate >= #{minUtilization}
        </if>
        <if test="maxUtilization != null">
            AND utilization_rate &lt;= #{maxUtilization}
        </if>
        <if test="params.keyword != null and params.keyword != ''">
            AND (device_id LIKE CONCAT('%', #{params.keyword}, '%')
            OR device_model LIKE CONCAT('%', #{params.keyword}, '%'))
        </if>
        ORDER BY utilization_rate DESC
        <if test="params.page != null and params.pageSize != null">
            LIMIT #{params.pageSize} OFFSET #{params.offset}
        </if>
    </select>

    <!-- Ëé∑ÂèñÊêúÁ¥¢Âª∫ËÆÆÔºàËá™Âä®ÂÆåÊàêÔºâ -->
    <select id="selectSearchSuggestions" resultType="java.lang.String">
        <choose>
            <when test="type == 'deviceId'">
                SELECT DISTINCT device_id
                FROM rental_devices
                WHERE is_deleted = 0 AND device_id LIKE CONCAT('%', #{keyword}, '%')
                ORDER BY device_id
                LIMIT 10
            </when>
            <when test="type == 'deviceModel'">
                SELECT DISTINCT device_model
                FROM rental_devices
                WHERE is_deleted = 0 AND device_model LIKE CONCAT('%', #{keyword}, '%')
                ORDER BY device_model
                LIMIT 10
            </when>
            <when test="type == 'region'">
                SELECT DISTINCT region
                FROM rental_devices
                WHERE is_deleted = 0 AND region LIKE CONCAT('%', #{keyword}, '%')
                ORDER BY region
                LIMIT 10
            </when>
            <otherwise>
                SELECT DISTINCT device_id
                FROM rental_devices
                WHERE is_deleted = 0 
                AND (device_id LIKE CONCAT('%', #{keyword}, '%')
                OR device_model LIKE CONCAT('%', #{keyword}, '%')
                OR device_name LIKE CONCAT('%', #{keyword}, '%'))
                ORDER BY device_id
                LIMIT 10
            </otherwise>
        </choose>
    </select>

    <!-- Ëé∑ÂèñÁ≠õÈÄâÈÄâÈ°πÁªüËÆ° -->
    <select id="selectFilterOptionsStats" resultType="java.util.Map">
        SELECT 
            'deviceModels' as category,
            JSON_ARRAYAGG(
                JSON_OBJECT(
                    'value', device_model,
                    'label', device_model,
                    'count', model_count
                )
            ) as options
        FROM (
            SELECT device_model, COUNT(*) as model_count
            FROM rental_devices
            WHERE is_deleted = 0 AND is_active = 1
            GROUP BY device_model
            ORDER BY model_count DESC
        ) model_stats
        
        UNION ALL
        
        SELECT 
            'statuses' as category,
            JSON_ARRAYAGG(
                JSON_OBJECT(
                    'value', current_status,
                    'label', CASE current_status
                        WHEN 'active' THEN 'ËøêË°å‰∏?
                        WHEN 'idle' THEN 'Á©∫Èó≤'
                        WHEN 'maintenance' THEN 'Áª¥Êä§‰∏?
                        WHEN 'retired' THEN 'Â∑≤ÈÄÄÂΩ?
                        ELSE current_status
                    END,
                    'count', status_count
                )
            ) as options
        FROM (
            SELECT current_status, COUNT(*) as status_count
            FROM rental_devices
            WHERE is_deleted = 0 AND is_active = 1
            GROUP BY current_status
            ORDER BY status_count DESC
        ) status_stats
        
        UNION ALL
        
        SELECT 
            'regions' as category,
            JSON_ARRAYAGG(
                JSON_OBJECT(
                    'value', region,
                    'label', region,
                    'count', region_count
                )
            ) as options
        FROM (
            SELECT region, COUNT(*) as region_count
            FROM rental_devices
            WHERE is_deleted = 0 AND is_active = 1 AND region IS NOT NULL
            GROUP BY region
            ORDER BY region_count DESC
        ) region_stats
    </select>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.RentalRecordMapper">

    <!-- ÁßüËµÅËÆ∞ÂΩïÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="RentalRecordResultMap" type="com.yxrobot.entity.RentalRecord">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="rental_order_number" property="rentalOrderNumber" jdbcType="VARCHAR"/>
        <result column="device_id" property="deviceId" jdbcType="BIGINT"/>
        <result column="customer_id" property="customerId" jdbcType="BIGINT"/>
        <result column="rental_start_date" property="rentalStartDate" jdbcType="DATE"/>
        <result column="rental_end_date" property="rentalEndDate" jdbcType="DATE"/>
        <result column="planned_end_date" property="plannedEndDate" jdbcType="DATE"/>
        <result column="rental_period" property="rentalPeriod" jdbcType="INTEGER"/>
        <result column="daily_rental_fee" property="dailyRentalFee" jdbcType="DECIMAL"/>
        <result column="total_rental_fee" property="totalRentalFee" jdbcType="DECIMAL"/>
        <result column="deposit_amount" property="depositAmount" jdbcType="DECIMAL"/>
        <result column="actual_payment" property="actualPayment" jdbcType="DECIMAL"/>
        <result column="payment_status" property="paymentStatus" jdbcType="VARCHAR"/>
        <result column="rental_status" property="rentalStatus" jdbcType="VARCHAR"/>
        <result column="delivery_method" property="deliveryMethod" jdbcType="VARCHAR"/>
        <result column="delivery_address" property="deliveryAddress" jdbcType="VARCHAR"/>
        <result column="return_date" property="returnDate" jdbcType="DATE"/>
        <result column="return_condition" property="returnCondition" jdbcType="VARCHAR"/>
        <result column="notes" property="notes" jdbcType="VARCHAR"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP"/>
        <result column="is_deleted" property="isDeleted" jdbcType="TINYINT"/>
    </resultMap>

    <!-- ÁßüËµÅË∂ãÂäøÊï∞ÊçÆÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="RentalTrendResultMap" type="com.yxrobot.dto.RentalTrendDTO">
        <result column="date" property="date" jdbcType="VARCHAR"/>
        <result column="revenue" property="revenue" jdbcType="DECIMAL"/>
        <result column="order_count" property="orderCount" jdbcType="INTEGER"/>
        <result column="device_count" property="deviceCount" jdbcType="INTEGER"/>
        <result column="utilization_rate" property="utilizationRate" jdbcType="DECIMAL"/>
    </resultMap>

    <!-- Âü∫Á°ÄÊü•ËØ¢Â≠óÊÆµ -->
    <sql id="Base_Column_List">
        id, rental_order_number, device_id, customer_id, rental_start_date, rental_end_date,
        planned_end_date, rental_period, daily_rental_fee, total_rental_fee, deposit_amount,
        actual_payment, payment_status, rental_status, delivery_method, delivery_address,
        return_date, return_condition, notes, created_at, updated_at, is_deleted
    </sql>

    <!-- Êü•ËØ¢Êù°‰ª∂ -->
    <sql id="Where_Clause">
        <where>
            is_deleted = 0
            <if test="params.startDate != null">
                AND rental_start_date &gt;= #{params.startDate}
            </if>
            <if test="params.endDate != null">
                AND rental_start_date &lt;= #{params.endDate}
            </if>
            <if test="params.keyword != null and params.keyword != ''">
                AND (rental_order_number LIKE CONCAT('%', #{params.keyword}, '%')
                OR delivery_address LIKE CONCAT('%', #{params.keyword}, '%'))
            </if>
            <if test="params.rentalStatus != null and params.rentalStatus != ''">
                AND rental_status = #{params.rentalStatus}
            </if>
            <if test="params.paymentStatus != null and params.paymentStatus != ''">
                AND payment_status = #{params.paymentStatus}
            </if>
            <if test="params.deviceId != null">
                AND device_id = #{params.deviceId}
            </if>
            <if test="params.customerId != null">
                AND customer_id = #{params.customerId}
            </if>
        </where>
    </sql>

    <!-- Ê†πÊçÆIDÊü•ËØ¢ -->
    <select id="selectById" resultMap="RentalRecordResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM rental_records
        WHERE id = #{id} AND is_deleted = 0
    </select>

    <!-- Ê†πÊçÆËÆ¢ÂçïÂè∑Êü•ËØ?-->
    <select id="selectByOrderNumber" resultMap="RentalRecordResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM rental_records
        WHERE rental_order_number = #{orderNumber} AND is_deleted = 0
    </select>

    <!-- ÂàÜÈ°µÊü•ËØ¢ÂàóË°® -->
    <select id="selectList" resultMap="RentalRecordResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM rental_records
        <include refid="Where_Clause"/>
        ORDER BY created_at DESC
        <if test="params.page != null and params.pageSize != null">
            LIMIT #{params.pageSize} OFFSET #{params.offset}
        </if>
    </select>

    <!-- Êü•ËØ¢ÊÄªÊï∞ -->
    <select id="selectCount" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM rental_records
        <include refid="Where_Clause"/>
    </select>

    <!-- ÊèíÂÖ•ËÆ∞ÂΩï -->
    <insert id="insert" parameterType="com.yxrobot.entity.RentalRecord" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO rental_records (
            rental_order_number, device_id, customer_id, rental_start_date, rental_end_date,
            planned_end_date, rental_period, daily_rental_fee, total_rental_fee, deposit_amount,
            actual_payment, payment_status, rental_status, delivery_method, delivery_address,
            return_date, return_condition, notes, created_at, updated_at, is_deleted
        ) VALUES (
            #{rentalOrderNumber}, #{deviceId}, #{customerId}, #{rentalStartDate}, #{rentalEndDate},
            #{plannedEndDate}, #{rentalPeriod}, #{dailyRentalFee}, #{totalRentalFee}, #{depositAmount},
            #{actualPayment}, #{paymentStatus}, #{rentalStatus}, #{deliveryMethod}, #{deliveryAddress},
            #{returnDate}, #{returnCondition}, #{notes}, NOW(), NOW(), 0
        )
    </insert>

    <!-- Êõ¥Êñ∞ËÆ∞ÂΩï -->
    <update id="updateById" parameterType="com.yxrobot.entity.RentalRecord">
        UPDATE rental_records
        SET rental_order_number = #{rentalOrderNumber},
            device_id = #{deviceId},
            customer_id = #{customerId},
            rental_start_date = #{rentalStartDate},
            rental_end_date = #{rentalEndDate},
            planned_end_date = #{plannedEndDate},
            rental_period = #{rentalPeriod},
            daily_rental_fee = #{dailyRentalFee},
            total_rental_fee = #{totalRentalFee},
            deposit_amount = #{depositAmount},
            actual_payment = #{actualPayment},
            payment_status = #{paymentStatus},
            rental_status = #{rentalStatus},
            delivery_method = #{deliveryMethod},
            delivery_address = #{deliveryAddress},
            return_date = #{returnDate},
            return_condition = #{returnCondition},
            notes = #{notes},
            updated_at = NOW()
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- ËΩØÂà†Èô?-->
    <update id="deleteById">
        UPDATE rental_records
        SET is_deleted = 1, updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- ÊâπÈáèËΩØÂà†Èô?-->
    <update id="deleteBatchByIds">
        UPDATE rental_records
        SET is_deleted = 1, updated_at = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- Êü•ËØ¢ÁßüËµÅÁªüËÆ°Êï∞ÊçÆ -->
    <select id="selectRentalStats" resultType="java.util.Map">
        SELECT 
            COALESCE(SUM(total_rental_fee), 0) as totalRentalRevenue,
            COUNT(*) as totalRentalOrders,
            COUNT(DISTINCT device_id) as totalRentalDevices,
            COUNT(CASE WHEN rental_status = 'active' THEN 1 END) as activeRentalDevices,
            COALESCE(AVG(rental_period), 0) as averageRentalPeriod,
            COALESCE(AVG(total_rental_fee), 0) as averageOrderValue
        FROM rental_records
        WHERE is_deleted = 0
        <if test="startDate != null">
            AND rental_start_date &gt;= #{startDate}
        </if>
        <if test="endDate != null">
            AND rental_start_date &lt;= #{endDate}
        </if>
    </select>

    <!-- Êü•ËØ¢ÁßüËµÅË∂ãÂäøÊï∞ÊçÆ -->
    <select id="selectRentalTrends" resultMap="RentalTrendResultMap">
        SELECT 
            DATE_FORMAT(rental_start_date, 
                <choose>
                    <when test="period == 'daily'">
                        '%Y-%m-%d'
                    </when>
                    <when test="period == 'weekly'">
                        '%Y-%u'
                    </when>
                    <when test="period == 'monthly'">
                        '%Y-%m'
                    </when>
                    <otherwise>
                        '%Y-%m-%d'
                    </otherwise>
                </choose>
            ) as date,
            COALESCE(SUM(total_rental_fee), 0) as revenue,
            COUNT(*) as order_count,
            COUNT(DISTINCT device_id) as device_count,
            COALESCE(AVG(
                CASE 
                    WHEN rental_status = 'active' THEN 80.0
                    WHEN rental_status = 'completed' THEN 75.0
                    ELSE 60.0
                END
            ), 0) as utilization_rate
        FROM rental_records
        WHERE is_deleted = 0
        <if test="startDate != null">
            AND rental_start_date &gt;= #{startDate}
        </if>
        <if test="endDate != null">
            AND rental_start_date &lt;= #{endDate}
        </if>
        GROUP BY DATE_FORMAT(rental_start_date, 
            <choose>
                <when test="period == 'daily'">
                    '%Y-%m-%d'
                </when>
                <when test="period == 'weekly'">
                    '%Y-%u'
                </when>
                <when test="period == 'monthly'">
                    '%Y-%m'
                </when>
                <otherwise>
                    '%Y-%m-%d'
                </otherwise>
            </choose>
        )
        ORDER BY date ASC
    </select>

    <!-- Êü•ËØ¢‰ªäÊó•ÁªüËÆ° -->
    <select id="selectTodayStats" resultType="java.util.Map">
        SELECT 
            COALESCE(SUM(total_rental_fee), 0) as revenue,
            COUNT(*) as orders,
            COUNT(DISTINCT device_id) as activeDevices,
            COALESCE(AVG(
                CASE 
                    WHEN rental_status = 'active' THEN 80.0
                    WHEN rental_status = 'completed' THEN 75.0
                    ELSE 60.0
                END
            ), 0) as avgUtilization
        FROM rental_records
        WHERE is_deleted = 0
        AND DATE(rental_start_date) = #{today}
    </select>

    <!-- Êü•ËØ¢Âú∞Âå∫ÂàÜÂ∏É -->
    <select id="selectRegionDistribution" resultType="java.util.Map">
        SELECT 
            COALESCE(delivery_address, 'Êú™Áü•Âú∞Âå∫') as region,
            COALESCE(SUM(total_rental_fee), 0) as revenue,
            COUNT(*) as orderCount
        FROM rental_records
        WHERE is_deleted = 0
        <if test="startDate != null">
            AND rental_start_date &gt;= #{startDate}
        </if>
        <if test="endDate != null">
            AND rental_start_date &lt;= #{endDate}
        </if>
        GROUP BY delivery_address
        ORDER BY revenue DESC
        LIMIT 10
    </select>

    <!-- Êü•ËØ¢Ê∏†ÈÅìÂàÜÊûê -->
    <select id="selectChannelAnalysis" resultType="java.util.Map">
        SELECT 
            COALESCE(delivery_method, 'Êú™Áü•Ê∏†ÈÅì') as channel,
            COALESCE(SUM(total_rental_fee), 0) as revenue,
            COUNT(*) as orderCount
        FROM rental_records
        WHERE is_deleted = 0
        <if test="startDate != null">
            AND rental_start_date &gt;= #{startDate}
        </if>
        <if test="endDate != null">
            AND rental_start_date &lt;= #{endDate}
        </if>
        GROUP BY delivery_method
        ORDER BY revenue DESC
    </select>

    <!-- Êü•ËØ¢Êî∂ÂÖ•Â¢ûÈïøÁé?-->
    <select id="selectRevenueGrowthRate" resultType="java.util.Map">
        SELECT 
            COALESCE(
                (SELECT SUM(total_rental_fee) FROM rental_records 
                 WHERE is_deleted = 0 AND DATE_FORMAT(rental_start_date, '%Y-%m') = DATE_FORMAT(#{currentMonth}, '%Y-%m')), 
                0
            ) as currentRevenue,
            COALESCE(
                (SELECT SUM(total_rental_fee) FROM rental_records 
                 WHERE is_deleted = 0 AND DATE_FORMAT(rental_start_date, '%Y-%m') = DATE_FORMAT(#{previousMonth}, '%Y-%m')), 
                0
            ) as previousRevenue
    </select>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.SalesProductMapper">

    <!-- ÁªìÊûúÊò†Â∞Ñ -->
    <resultMap id="BaseResultMap" type="com.yxrobot.entity.SalesProduct">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="product_name" property="productName" jdbcType="VARCHAR"/>
        <result column="product_code" property="productCode" jdbcType="VARCHAR"/>
        <result column="category" property="category" jdbcType="VARCHAR"/>
        <result column="brand" property="brand" jdbcType="VARCHAR"/>
        <result column="model" property="model" jdbcType="VARCHAR"/>
        <result column="unit_price" property="unitPrice" jdbcType="DECIMAL"/>
        <result column="cost_price" property="costPrice" jdbcType="DECIMAL"/>
        <result column="stock_quantity" property="stockQuantity" jdbcType="INTEGER"/>
        <result column="unit" property="unit" jdbcType="VARCHAR"/>
        <result column="description" property="description" jdbcType="LONGVARCHAR"/>
        <result column="specifications" property="specifications" jdbcType="LONGVARCHAR"/>
        <result column="is_active" property="isActive" jdbcType="BOOLEAN"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP"/>
        <result column="is_deleted" property="isDeleted" jdbcType="BOOLEAN"/>
    </resultMap>

    <!-- Âü∫Á°ÄÂà?-->
    <sql id="Base_Column_List">
        id, product_name, product_code, category, brand, model, 
        unit_price, cost_price, stock_quantity, unit, description, 
        specifications, is_active, created_at, updated_at, is_deleted
    </sql>

    <!-- ÊèíÂÖ•ÈîÄÂîÆ‰∫ßÂìÅËÆ∞ÂΩ?-->
    <insert id="insert" parameterType="com.yxrobot.entity.SalesProduct" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO sales_products (
            product_name, product_code, category, brand, model,
            unit_price, cost_price, stock_quantity, unit, description,
            specifications, is_active, created_at, updated_at, is_deleted
        ) VALUES (
            #{productName}, #{productCode}, #{category}, #{brand}, #{model},
            #{unitPrice}, #{costPrice}, #{stockQuantity}, #{unit}, #{description},
            #{specifications}, #{isActive}, #{createdAt}, #{updatedAt}, #{isDeleted}
        )
    </insert>

    <!-- ÊâπÈáèÊèíÂÖ•ÈîÄÂîÆ‰∫ßÂìÅËÆ∞ÂΩ?-->
    <insert id="insertBatch" parameterType="java.util.List">
        INSERT INTO sales_products (
            product_name, product_code, category, brand, model,
            unit_price, cost_price, stock_quantity, unit, description,
            specifications, is_active, created_at, updated_at, is_deleted
        ) VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.productName}, #{item.productCode}, #{item.category}, #{item.brand}, #{item.model},
             #{item.unitPrice}, #{item.costPrice}, #{item.stockQuantity}, #{item.unit}, #{item.description},
             #{item.specifications}, #{item.isActive}, #{item.createdAt}, #{item.updatedAt}, #{item.isDeleted})
        </foreach>
    </insert>

    <!-- Ê†πÊçÆIDÊü•ËØ¢ÈîÄÂîÆ‰∫ßÂì?-->
    <select id="selectById" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sales_products
        WHERE id = #{id} AND is_deleted = 0
    </select>

    <!-- Ê†πÊçÆ‰∫ßÂìÅÁºñÁ†ÅÊü•ËØ¢ -->
    <select id="selectByProductCode" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sales_products
        WHERE product_code = #{productCode} AND is_deleted = 0
    </select>

    <!-- Ê†πÊçÆÁ±ªÂà´Êü•ËØ¢‰∫ßÂìÅÂàóË°® -->
    <select id="selectByCategory" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sales_products
        WHERE category = #{category} AND is_deleted = 0 AND is_active = 1
        ORDER BY product_name ASC
    </select>

    <!-- Êü•ËØ¢ÊâÄÊúâÂêØÁî®ÁöÑÈîÄÂîÆ‰∫ßÂì?-->
    <select id="selectAllActive" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sales_products
        WHERE is_deleted = 0 AND is_active = 1
        ORDER BY category ASC, product_name ASC
    </select>

    <!-- Êü•ËØ¢ÊâÄÊúâÈîÄÂîÆ‰∫ßÂìÅËÆ∞ÂΩ?-->
    <select id="selectAll" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sales_products
        WHERE is_deleted = 0
        ORDER BY created_at DESC
    </select>

    <!-- ÂàÜÈ°µÊü•ËØ¢ÈîÄÂîÆ‰∫ßÂì?-->
    <select id="selectByPage" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sales_products
        WHERE is_deleted = 0
        <if test="category != null and category != ''">
            AND category = #{category}
        </if>
        <if test="productName != null and productName != ''">
            AND product_name LIKE CONCAT('%', #{productName}, '%')
        </if>
        <if test="isActive != null">
            AND is_active = #{isActive}
        </if>
        ORDER BY created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- ÁªüËÆ°‰∫ßÂìÅÊï∞Èáè -->
    <select id="countByCondition" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM sales_products
        WHERE is_deleted = 0
        <if test="category != null and category != ''">
            AND category = #{category}
        </if>
        <if test="productName != null and productName != ''">
            AND product_name LIKE CONCAT('%', #{productName}, '%')
        </if>
        <if test="isActive != null">
            AND is_active = #{isActive}
        </if>
    </select>

    <!-- Êõ¥Êñ∞ÈîÄÂîÆ‰∫ßÂìÅËÆ∞ÂΩ?-->
    <update id="updateById" parameterType="com.yxrobot.entity.SalesProduct">
        UPDATE sales_products
        SET product_name = #{productName},
            product_code = #{productCode},
            category = #{category},
            brand = #{brand},
            model = #{model},
            unit_price = #{unitPrice},
            cost_price = #{costPrice},
            stock_quantity = #{stockQuantity},
            unit = #{unit},
            description = #{description},
            specifications = #{specifications},
            is_active = #{isActive},
            updated_at = #{updatedAt}
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- Êõ¥Êñ∞Â∫ìÂ≠òÊï∞Èáè -->
    <update id="updateStockQuantity">
        UPDATE sales_products
        SET stock_quantity = stock_quantity + #{quantity},
            updated_at = NOW()
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- Ê†πÊçÆIDÂà†Èô§ÈîÄÂîÆ‰∫ßÂìÅËÆ∞ÂΩïÔºàÈÄªËæëÂà†Èô§Ôº?-->
    <update id="deleteById" parameterType="java.lang.Long">
        UPDATE sales_products
        SET is_deleted = 1, updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- ÂêØÁî®/Á¶ÅÁî®‰∫ßÂìÅ -->
    <update id="updateActiveStatus">
        UPDATE sales_products
        SET is_active = #{isActive}, updated_at = NOW()
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- Êü•ËØ¢‰ΩéÂ∫ìÂ≠ò‰∫ßÂì?-->
    <select id="selectLowStockProducts" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sales_products
        WHERE is_deleted = 0 AND is_active = 1 AND stock_quantity &lt;= #{threshold}
        ORDER BY stock_quantity ASC
    </select>

    <!-- Ê†πÊçÆÂìÅÁâåÊü•ËØ¢‰∫ßÂìÅ -->
    <select id="selectByBrand" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sales_products
        WHERE brand = #{brand} AND is_deleted = 0 AND is_active = 1
        ORDER BY product_name ASC
    </select>

    <!-- Êü•ËØ¢‰∫ßÂìÅÁ±ªÂà´ÂàóË°® -->
    <select id="selectDistinctCategories" resultType="java.lang.String">
        SELECT DISTINCT category
        FROM sales_products
        WHERE is_deleted = 0 AND is_active = 1
        ORDER BY category ASC
    </select>

    <!-- Êü•ËØ¢ÂìÅÁâåÂàóË°® -->
    <select id="selectDistinctBrands" resultType="java.lang.String">
        SELECT DISTINCT brand
        FROM sales_products
        WHERE is_deleted = 0 AND is_active = 1 AND brand IS NOT NULL
        ORDER BY brand ASC
    </select>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.SalesRecordMapper">

    <!-- ÈîÄÂîÆËÆ∞ÂΩïÁªìÊûúÊò†Â∞?-->
    <resultMap id="SalesRecordResultMap" type="com.yxrobot.entity.SalesRecord">
        <id column="id" property="id"/>
        <result column="order_number" property="orderNumber"/>
        <result column="customer_id" property="customerId"/>
        <result column="product_id" property="productId"/>
        <result column="sales_staff_id" property="salesStaffId"/>
        <result column="sales_amount" property="salesAmount"/>
        <result column="quantity" property="quantity"/>
        <result column="unit_price" property="unitPrice"/>
        <result column="discount_amount" property="discountAmount"/>
        <result column="order_date" property="orderDate"/>
        <result column="delivery_date" property="deliveryDate"/>
        <result column="status" property="status" />
        <result column="payment_status" property="paymentStatus" />
        <result column="payment_method" property="paymentMethod"/>
        <result column="region" property="region"/>
        <result column="channel" property="channel"/>
        <result column="notes" property="notes"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="is_deleted" property="isDeleted"/>
    </resultMap>

    <!-- ÈîÄÂîÆËÆ∞ÂΩïDTOÁªìÊûúÊò†Â∞ÑÔºàÂåÖÂê´ÂÖ≥ËÅîÊï∞ÊçÆÔºâ -->
    <resultMap id="SalesRecordDTOResultMap" type="com.yxrobot.dto.SalesRecordDTO">
        <id column="id" property="id"/>
        <result column="order_number" property="orderNumber"/>
        <result column="customer_id" property="customerId"/>
        <result column="product_id" property="productId"/>
        <result column="sales_staff_id" property="salesStaffId"/>
        <result column="sales_amount" property="salesAmount"/>
        <result column="quantity" property="quantity"/>
        <result column="unit_price" property="unitPrice"/>
        <result column="discount_amount" property="discountAmount"/>
        <result column="order_date" property="orderDate"/>
        <result column="delivery_date" property="deliveryDate"/>
        <result column="status" property="status" />
        <result column="payment_status" property="paymentStatus" />
        <result column="payment_method" property="paymentMethod"/>
        <result column="region" property="region"/>
        <result column="channel" property="channel"/>
        <result column="notes" property="notes"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <!-- ÂÖ≥ËÅîÊï∞ÊçÆÂ≠óÊÆµ - ÂåπÈÖçÂâçÁ´ØÈúÄÊ±?-->
        <result column="customer_name" property="customerName"/>
        <result column="customer_phone" property="customerPhone"/>
        <result column="product_name" property="productName"/>
        <result column="staff_name" property="staffName"/>
    </resultMap>

    <!-- Âü∫Á°ÄÊü•ËØ¢Â≠óÊÆµ -->
    <sql id="Base_Column_List">
        id, order_number, customer_id, product_id, sales_staff_id, sales_amount, 
        quantity, unit_price, discount_amount, order_date, delivery_date, status, 
        payment_status, payment_method, region, channel, notes, created_at, updated_at, is_deleted
    </sql>

    <!-- Â∏¶ÂÖ≥ËÅî‰ø°ÊÅØÁöÑÊü•ËØ¢Â≠óÊÆµ - ÂåπÈÖçÂâçÁ´ØDTOÈúÄÊ±?-->
    <sql id="Detail_Column_List">
        sr.id, sr.order_number, sr.customer_id, sr.product_id, sr.sales_staff_id, 
        sr.sales_amount, sr.quantity, sr.unit_price, sr.discount_amount, sr.order_date, 
        sr.delivery_date, sr.status, sr.payment_status, sr.payment_method, sr.region, 
        sr.channel, sr.notes, sr.created_at, sr.updated_at, sr.is_deleted,
        -- ÂÖ≥ËÅîÊï∞ÊçÆÂ≠óÊÆµÔºåÂåπÈÖçÂâçÁ´ØÈúÄÊ±?
        c.customer_name,
        c.phone as customer_phone,
        p.product_name,
        ss.staff_name
    </sql>

    <!-- Êü•ËØ¢Êù°‰ª∂ -->
    <sql id="Query_Where_Clause">
        <where>
            sr.is_deleted = 0
            <!-- ËÆ¢ÂçïÂè∑ÊêúÁ¥?- ÊîØÊåÅÁ≤æÁ°ÆÂåπÈÖçÂíåÊ®°Á≥äÊêúÁ¥?-->
            <if test="query.orderNumber != null and query.orderNumber != ''">
                <choose>
                    <when test="query.orderNumber.length() >= 8">
                        <!-- ÈïøÂ∫¶>=8Êó∂‰ºòÂÖàÁ≤æÁ°ÆÂåπÈÖçÔºåÊèêÈ´òÊÄßËÉΩ -->
                        AND (sr.order_number = #{query.orderNumber} OR sr.order_number LIKE CONCAT('%', #{query.orderNumber}, '%'))
                    </when>
                    <otherwise>
                        AND sr.order_number LIKE CONCAT('%', #{query.orderNumber}, '%')
                    </otherwise>
                </choose>
            </if>
            <!-- ÂÆ¢Êà∑Á≠õÈÄ?- ÊîØÊåÅIDÂíåÂêçÁß∞ÊêúÁ¥?-->
            <if test="query.customerId != null">
                AND sr.customer_id = #{query.customerId}
            </if>
            <if test="query.customerName != null and query.customerName != ''">
                AND c.customer_name LIKE CONCAT('%', #{query.customerName}, '%')
            </if>
            <!-- ‰∫ßÂìÅÁ≠õÈÄ?- ÊîØÊåÅIDÂíåÂêçÁß∞ÊêúÁ¥?-->
            <if test="query.productId != null">
                AND sr.product_id = #{query.productId}
            </if>
            <if test="query.productName != null and query.productName != ''">
                AND p.product_name LIKE CONCAT('%', #{query.productName}, '%')
            </if>
            <!-- ÈîÄÂîÆ‰∫∫ÂëòÁ≠õÈÄ?- ÊîØÊåÅIDÂíåÂßìÂêçÊêúÁ¥?-->
            <if test="query.salesStaffId != null">
                AND sr.sales_staff_id = #{query.salesStaffId}
            </if>
            <if test="query.salesStaffName != null and query.salesStaffName != ''">
                AND ss.staff_name LIKE CONCAT('%', #{query.salesStaffName}, '%')
            </if>
            <!-- ÈîÄÂîÆÈáëÈ¢ùËåÉÂõ¥Á≠õÈÄ?-->
            <if test="query.minSalesAmount != null">
                AND sr.sales_amount >= #{query.minSalesAmount}
            </if>
            <if test="query.maxSalesAmount != null">
                AND sr.sales_amount &lt;= #{query.maxSalesAmount}
            </if>
            <!-- Êó∂Èó¥ËåÉÂõ¥Á≠õÈÄ?- ‰ºòÂåñÁ¥¢Âºï‰ΩøÁî® -->
            <if test="query.startDate != null and query.endDate != null">
                AND sr.order_date BETWEEN #{query.startDate} AND #{query.endDate}
            </if>
            <if test="query.startDate != null and query.endDate == null">
                AND sr.order_date >= #{query.startDate}
            </if>
            <if test="query.startDate == null and query.endDate != null">
                AND sr.order_date &lt;= #{query.endDate}
            </if>
            <!-- Áä∂ÊÄÅÁ≠õÈÄ?-->
            <if test="query.status != null">
                AND sr.status = #{query.status}
            </if>
            <if test="query.paymentStatus != null">
                AND sr.payment_status = #{query.paymentStatus}
            </if>
            <!-- Âú∞Âå∫Á≠õÈÄ?-->
            <if test="query.region != null and query.region != ''">
                <choose>
                    <when test="query.region == 'ALL'">
                        <!-- Êü•ËØ¢ÊâÄÊúâÂú∞Âå∫Ôºå‰∏çÊ∑ªÂä†Êù°‰ª?-->
                    </when>
                    <otherwise>
                        AND sr.region = #{query.region}
                    </otherwise>
                </choose>
            </if>
            <!-- Ê∏†ÈÅìÁ≠õÈÄ?-->
            <if test="query.channel != null and query.channel != ''">
                <choose>
                    <when test="query.channel == 'ALL'">
                        <!-- Êü•ËØ¢ÊâÄÊúâÊ∏†ÈÅìÔºå‰∏çÊ∑ªÂä†Êù°‰ª?-->
                    </when>
                    <otherwise>
                        AND sr.channel = #{query.channel}
                    </otherwise>
                </choose>
            </if>
            <!-- ‰ªòÊ¨æÊñπÂºèÁ≠õÈÄ?-->
            <if test="query.paymentMethod != null and query.paymentMethod != ''">
                <choose>
                    <when test="query.paymentMethod == 'ALL'">
                        <!-- Êü•ËØ¢ÊâÄÊúâ‰ªòÊ¨æÊñπÂºèÔºå‰∏çÊ∑ªÂä†Êù°‰ª?-->
                    </when>
                    <otherwise>
                        AND sr.payment_method = #{query.paymentMethod}
                    </otherwise>
                </choose>
            </if>
            <!-- ÂÖ≥ÈîÆËØçÊêúÁ¥?- Â§öÂ≠óÊÆµÊ®°Á≥äÂåπÈÖçÔºå‰ºòÂåñÊÄßËÉΩ -->
            <if test="query.keyword != null and query.keyword != ''">
                AND (
                    sr.order_number LIKE CONCAT('%', #{query.keyword}, '%')
                    OR c.customer_name LIKE CONCAT('%', #{query.keyword}, '%')
                    OR p.product_name LIKE CONCAT('%', #{query.keyword}, '%')
                    OR ss.staff_name LIKE CONCAT('%', #{query.keyword}, '%')
                    OR sr.notes LIKE CONCAT('%', #{query.keyword}, '%')
                    OR sr.region LIKE CONCAT('%', #{query.keyword}, '%')
                    OR sr.channel LIKE CONCAT('%', #{query.keyword}, '%')
                    OR sr.payment_method LIKE CONCAT('%', #{query.keyword}, '%')
                )
            </if>
        </where>
    </sql>

    <!-- ÊéíÂ∫èÊù°‰ª∂ -->
    <sql id="Order_By_Clause">
        <choose>
            <when test="query.sortBy != null and query.sortBy != ''">
                ORDER BY 
                <choose>
                    <when test="query.sortBy == 'orderNumber'">sr.order_number</when>
                    <when test="query.sortBy == 'customerName'">c.customer_name</when>
                    <when test="query.sortBy == 'productName'">p.product_name</when>
                    <when test="query.sortBy == 'salesStaffName'">ss.staff_name</when>
                    <when test="query.sortBy == 'salesAmount'">sr.sales_amount</when>
                    <when test="query.sortBy == 'quantity'">sr.quantity</when>
                    <when test="query.sortBy == 'orderDate'">sr.order_date</when>
                    <when test="query.sortBy == 'status'">sr.status</when>
                    <when test="query.sortBy == 'paymentStatus'">sr.payment_status</when>
                    <when test="query.sortBy == 'createdAt'">sr.created_at</when>
                    <otherwise>sr.created_at</otherwise>
                </choose>
                <choose>
                    <when test="query.sortDir != null and query.sortDir.toLowerCase() == 'asc'">ASC</when>
                    <otherwise>DESC</otherwise>
                </choose>
            </when>
            <otherwise>ORDER BY sr.created_at DESC</otherwise>
        </choose>
    </sql>

    <!-- Ê†πÊçÆIDÊü•ËØ¢ÈîÄÂîÆËÆ∞ÂΩ?-->
    <select id="selectById" resultMap="SalesRecordResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sales_records
        WHERE id = #{id} AND is_deleted = 0
    </select>

    <!-- Ê†πÊçÆËÆ¢ÂçïÂè∑Êü•ËØ¢ÈîÄÂîÆËÆ∞ÂΩ?-->
    <select id="selectByOrderNumber" resultMap="SalesRecordResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sales_records
        WHERE order_number = #{orderNumber} AND is_deleted = 0
    </select>

    <!-- ÂàÜÈ°µÊü•ËØ¢ÈîÄÂîÆËÆ∞ÂΩïÂàóË°?-->
    <select id="selectList" resultMap="SalesRecordResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sales_records sr
        LEFT JOIN customers c ON sr.customer_id = c.id
        LEFT JOIN sales_products sp ON sr.product_id = sp.id
        LEFT JOIN sales_staff ss ON sr.sales_staff_id = ss.id
        <include refid="Query_Where_Clause"/>
        <include refid="Order_By_Clause"/>
        <if test="query.page != null and query.size != null">
            LIMIT #{query.size} OFFSET #{query.page}
        </if>
    </select>

    <!-- Êü•ËØ¢ÈîÄÂîÆËÆ∞ÂΩïÊÄªÊï∞ -->
    <select id="selectCount" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM sales_records sr
        LEFT JOIN customers c ON sr.customer_id = c.id
        LEFT JOIN sales_products sp ON sr.product_id = sp.id
        LEFT JOIN sales_staff ss ON sr.sales_staff_id = ss.id
        <include refid="Query_Where_Clause"/>
    </select>

    <!-- Êü•ËØ¢ÈîÄÂîÆËÆ∞ÂΩïÂàóË°®ÔºàÂ∏¶ÂÖ≥ËÅî‰ø°ÊÅØÔºâ -->
    <select id="selectListWithDetails" resultType="java.util.Map">
        SELECT <include refid="Detail_Column_List"/>
        FROM sales_records sr
        LEFT JOIN customers c ON sr.customer_id = c.id
        LEFT JOIN sales_products sp ON sr.product_id = sp.id
        LEFT JOIN sales_staff ss ON sr.sales_staff_id = ss.id
        <include refid="Query_Where_Clause"/>
        <include refid="Order_By_Clause"/>
        <if test="query.page != null and query.size != null">
            LIMIT #{query.size} OFFSET #{query.page}
        </if>
    </select>

    <!-- Êü•ËØ¢ÈîÄÂîÆËÆ∞ÂΩïÊÄªÊï∞ÔºàÂ∏¶ÂÖ≥ËÅî‰ø°ÊÅØÔº?-->
    <select id="selectCountWithDetails" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM sales_records sr
        LEFT JOIN customers c ON sr.customer_id = c.id
        LEFT JOIN sales_products sp ON sr.product_id = sp.id
        LEFT JOIN sales_staff ss ON sr.sales_staff_id = ss.id
        <include refid="Query_Where_Clause"/>
    </select>

    <!-- Êü•ËØ¢ÈîÄÂîÆËÆ∞ÂΩïDTOÂàóË°®ÔºàÂåÖÂê´ÂÖ≥ËÅîÊï∞ÊçÆÔºåÂåπÈÖçÂâçÁ´ØÈúÄÊ±ÇÔºâ -->
    <select id="selectDTOList" resultMap="SalesRecordDTOResultMap">
        SELECT <include refid="Detail_Column_List"/>
        FROM sales_records sr
        LEFT JOIN customers c ON sr.customer_id = c.id
        LEFT JOIN sales_products p ON sr.product_id = p.id
        LEFT JOIN sales_staff ss ON sr.sales_staff_id = ss.id
        <include refid="Query_Where_Clause"/>
        <include refid="Order_By_Clause"/>
        <if test="query.page != null and query.size != null">
            LIMIT #{query.size} OFFSET #{query.page}
        </if>
    </select>

    <!-- ÊèíÂÖ•ÈîÄÂîÆËÆ∞ÂΩ?-->
    <insert id="insert" parameterType="com.yxrobot.entity.SalesRecord" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO sales_records (
            order_number, customer_id, product_id, sales_staff_id, sales_amount, 
            quantity, unit_price, discount_amount, order_date, delivery_date, 
            status, payment_status, payment_method, region, channel, notes, 
            created_at, updated_at, is_deleted
        ) VALUES (
            #{orderNumber}, #{customerId}, #{productId}, #{salesStaffId}, #{salesAmount}, 
            #{quantity}, #{unitPrice}, #{discountAmount}, #{orderDate}, #{deliveryDate}, 
            #{status}, #{paymentStatus}, #{paymentMethod}, #{region}, #{channel}, #{notes}, 
            NOW(), NOW(), 0
        )
    </insert>

    <!-- ÊâπÈáèÊèíÂÖ•ÈîÄÂîÆËÆ∞ÂΩ?-->
    <insert id="insertBatch" parameterType="java.util.List">
        INSERT INTO sales_records (
            order_number, customer_id, product_id, sales_staff_id, sales_amount, 
            quantity, unit_price, discount_amount, order_date, delivery_date, 
            status, payment_status, payment_method, region, channel, notes, 
            created_at, updated_at, is_deleted
        ) VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.orderNumber}, #{item.customerId}, #{item.productId}, #{item.salesStaffId}, #{item.salesAmount}, 
             #{item.quantity}, #{item.unitPrice}, #{item.discountAmount}, #{item.orderDate}, #{item.deliveryDate}, 
             #{item.status}, #{item.paymentStatus}, #{item.paymentMethod}, #{item.region}, #{item.channel}, #{item.notes}, 
             NOW(), NOW(), 0)
        </foreach>
    </insert>

    <!-- Êõ¥Êñ∞ÈîÄÂîÆËÆ∞ÂΩ?-->
    <update id="updateById" parameterType="com.yxrobot.entity.SalesRecord">
        UPDATE sales_records SET
            order_number = #{orderNumber},
            customer_id = #{customerId},
            product_id = #{productId},
            sales_staff_id = #{salesStaffId},
            sales_amount = #{salesAmount},
            quantity = #{quantity},
            unit_price = #{unitPrice},
            discount_amount = #{discountAmount},
            order_date = #{orderDate},
            delivery_date = #{deliveryDate},
            status = #{status},
            payment_status = #{paymentStatus},
            payment_method = #{paymentMethod},
            region = #{region},
            channel = #{channel},
            notes = #{notes},
            updated_at = NOW()
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- Ê†πÊçÆIDÂà†Èô§ÈîÄÂîÆËÆ∞ÂΩïÔºàÁâ©ÁêÜÂà†Èô§Ôº?-->
    <delete id="deleteById">
        DELETE FROM sales_records WHERE id = #{id}
    </delete>

    <!-- Ê†πÊçÆIDËΩØÂà†Èô§ÈîÄÂîÆËÆ∞ÂΩ?-->
    <update id="softDeleteById">
        UPDATE sales_records SET is_deleted = 1, updated_at = NOW() WHERE id = #{id}
    </update>

    <!-- ÊâπÈáèËΩØÂà†Èô§ÈîÄÂîÆËÆ∞ÂΩ?-->
    <update id="softDeleteByIds">
        UPDATE sales_records SET is_deleted = 1, updated_at = NOW() 
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- Ê†πÊçÆÂÆ¢Êà∑IDÊü•ËØ¢ÈîÄÂîÆËÆ∞ÂΩ?-->
    <select id="selectByCustomerId" resultMap="SalesRecordResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sales_records
        WHERE customer_id = #{customerId} AND is_deleted = 0
        ORDER BY created_at DESC
    </select>

    <!-- Ê†πÊçÆ‰∫ßÂìÅIDÊü•ËØ¢ÈîÄÂîÆËÆ∞ÂΩ?-->
    <select id="selectByProductId" resultMap="SalesRecordResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sales_records
        WHERE product_id = #{productId} AND is_deleted = 0
        ORDER BY created_at DESC
    </select>

    <!-- Ê†πÊçÆÈîÄÂîÆ‰∫∫ÂëòIDÊü•ËØ¢ÈîÄÂîÆËÆ∞ÂΩ?-->
    <select id="selectBySalesStaffId" resultMap="SalesRecordResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sales_records
        WHERE sales_staff_id = #{salesStaffId} AND is_deleted = 0
        ORDER BY created_at DESC
    </select>

    <!-- Ê†πÊçÆÊó•ÊúüËåÉÂõ¥Êü•ËØ¢ÈîÄÂîÆËÆ∞ÂΩ?-->
    <select id="selectByDateRange" resultMap="SalesRecordResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sales_records
        WHERE order_date BETWEEN #{startDate} AND #{endDate} AND is_deleted = 0
        ORDER BY order_date DESC
    </select>

    <!-- Êü•ËØ¢ÊåáÂÆöÊó∂Èó¥ÊÆµÁöÑÈîÄÂîÆÁªüËÆ?-->
    <select id="selectSalesStatsByDateRange" resultType="java.util.Map">
        SELECT 
            COUNT(*) as total_orders,
            SUM(sales_amount) as total_sales_amount,
            SUM(quantity) as total_quantity,
            AVG(sales_amount) as avg_order_amount,
            COUNT(DISTINCT customer_id) as unique_customers,
            COUNT(DISTINCT product_id) as unique_products
        FROM sales_records
        WHERE order_date BETWEEN #{startDate} AND #{endDate} AND is_deleted = 0
    </select>

    <!-- Êü•ËØ¢ÈîÄÂîÆË∂ãÂäøÊï∞Êç?-->
    <select id="selectSalesTrends" resultType="java.util.Map">
        SELECT 
            <choose>
                <when test="groupBy == 'day'">DATE(order_date) as date_key</when>
                <when test="groupBy == 'week'">DATE_FORMAT(order_date, '%Y-%u') as date_key</when>
                <when test="groupBy == 'month'">DATE_FORMAT(order_date, '%Y-%m') as date_key</when>
                <when test="groupBy == 'year'">YEAR(order_date) as date_key</when>
                <otherwise>DATE(order_date) as date_key</otherwise>
            </choose>,
            COUNT(*) as order_count,
            SUM(sales_amount) as sales_amount,
            AVG(sales_amount) as avg_amount
        FROM sales_records
        WHERE order_date BETWEEN #{startDate} AND #{endDate} AND is_deleted = 0
        GROUP BY date_key
        ORDER BY date_key
    </select>

    <!-- Êü•ËØ¢‰∫ßÂìÅÈîÄÂîÆÊéíË°?-->
    <select id="selectProductRanking" resultType="java.util.Map">
        SELECT 
            sp.id as product_id,
            sp.product_name,
            COUNT(*) as order_count,
            SUM(sr.quantity) as total_quantity,
            SUM(sr.sales_amount) as total_sales_amount
        FROM sales_records sr
        LEFT JOIN sales_products sp ON sr.product_id = sp.id
        WHERE sr.order_date BETWEEN #{startDate} AND #{endDate} AND sr.is_deleted = 0
        GROUP BY sp.id, sp.product_name
        ORDER BY total_sales_amount DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- Êü•ËØ¢ÈîÄÂîÆ‰∫∫Âëò‰∏öÁª©ÊéíË°?-->
    <select id="selectStaffPerformance" resultType="java.util.Map">
        SELECT 
            ss.id as staff_id,
            ss.staff_name,
            ss.department,
            COUNT(*) as order_count,
            SUM(sr.sales_amount) as total_sales_amount,
            AVG(sr.sales_amount) as avg_order_amount,
            COUNT(DISTINCT sr.customer_id) as customer_count
        FROM sales_records sr
        LEFT JOIN sales_staff ss ON sr.sales_staff_id = ss.id
        WHERE sr.order_date BETWEEN #{startDate} AND #{endDate} AND sr.is_deleted = 0
        GROUP BY ss.id, ss.staff_name, ss.department
        ORDER BY total_sales_amount DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- Êü•ËØ¢Âú∞Âå∫ÈîÄÂîÆÂàÜÂ∏?-->
    <select id="selectRegionDistribution" resultType="java.util.Map">
        SELECT 
            region,
            COUNT(*) as order_count,
            SUM(sales_amount) as total_sales_amount,
            ROUND(SUM(sales_amount) * 100.0 / (SELECT SUM(sales_amount) FROM sales_records WHERE order_date BETWEEN #{startDate} AND #{endDate} AND is_deleted = 0), 2) as percentage
        FROM sales_records
        WHERE order_date BETWEEN #{startDate} AND #{endDate} AND is_deleted = 0 AND region IS NOT NULL
        GROUP BY region
        ORDER BY total_sales_amount DESC
    </select>

    <!-- Êü•ËØ¢Ê∏†ÈÅìÈîÄÂîÆÂàÜÂ∏?-->
    <select id="selectChannelDistribution" resultType="java.util.Map">
        SELECT 
            channel,
            COUNT(*) as order_count,
            SUM(sales_amount) as total_sales_amount,
            ROUND(SUM(sales_amount) * 100.0 / (SELECT SUM(sales_amount) FROM sales_records WHERE order_date BETWEEN #{startDate} AND #{endDate} AND is_deleted = 0), 2) as percentage
        FROM sales_records
        WHERE order_date BETWEEN #{startDate} AND #{endDate} AND is_deleted = 0 AND channel IS NOT NULL
        GROUP BY channel
        ORDER BY total_sales_amount DESC
    </select>

    <!-- Êü•ËØ¢ÊúàÂ∫¶ÈîÄÂîÆÊï∞Êç?-->
    <select id="selectMonthlySalesData" resultType="java.util.Map">
        SELECT 
            MONTH(order_date) as month,
            COUNT(*) as order_count,
            SUM(sales_amount) as sales_amount,
            SUM(quantity) as quantity
        FROM sales_records
        WHERE YEAR(order_date) = #{year} AND is_deleted = 0
        GROUP BY MONTH(order_date)
        ORDER BY month
    </select>

    <!-- Êü•ËØ¢ÈîÄÂîÆÊºèÊñóÊï∞Êç?-->
    <select id="selectSalesFunnelData" resultType="java.util.Map">
        SELECT 
            'pending' as stage,
            'ÂæÖÁ°ÆËÆ? as stage_name,
            COUNT(*) as count,
            SUM(sales_amount) as amount
        FROM sales_records
        WHERE order_date BETWEEN #{startDate} AND #{endDate} AND status = 'pending' AND is_deleted = 0
        UNION ALL
        SELECT 
            'confirmed' as stage,
            'Â∑≤Á°ÆËÆ? as stage_name,
            COUNT(*) as count,
            SUM(sales_amount) as amount
        FROM sales_records
        WHERE order_date BETWEEN #{startDate} AND #{endDate} AND status = 'confirmed' AND is_deleted = 0
        UNION ALL
        SELECT 
            'delivered' as stage,
            'Â∑≤‰∫§‰ª? as stage_name,
            COUNT(*) as count,
            SUM(sales_amount) as amount
        FROM sales_records
        WHERE order_date BETWEEN #{startDate} AND #{endDate} AND status = 'delivered' AND is_deleted = 0
        UNION ALL
        SELECT 
            'completed' as stage,
            'Â∑≤ÂÆåÊà? as stage_name,
            COUNT(*) as count,
            SUM(sales_amount) as amount
        FROM sales_records
        WHERE order_date BETWEEN #{startDate} AND #{endDate} AND status = 'completed' AND is_deleted = 0
    </select>

    <!-- Êü•ËØ¢ÂÆ¢Êà∑ÈîÄÂîÆÊ±áÊÄ?-->
    <select id="selectCustomerSalesSummary" resultType="java.util.Map">
        SELECT 
            c.id as customer_id,
            c.customer_name,
            c.customer_type,
            c.region,
            COUNT(*) as order_count,
            SUM(sr.sales_amount) as total_sales_amount,
            AVG(sr.sales_amount) as avg_order_amount,
            MAX(sr.order_date) as last_order_date
        FROM sales_records sr
        LEFT JOIN customers c ON sr.customer_id = c.id
        WHERE sr.order_date BETWEEN #{startDate} AND #{endDate} AND sr.is_deleted = 0
        GROUP BY c.id, c.customer_name, c.customer_type, c.region
        ORDER BY total_sales_amount DESC
    </select>

    <!-- Êü•ËØ¢ÈîÄÂîÆËÆ∞ÂΩïÊï∞ÈáèÔºàÊåâÁä∂ÊÄÅÂàÜÁªÑÔºâ -->
    <select id="selectCountByStatus" resultType="java.util.Map">
        SELECT 
            status,
            COUNT(*) as count,
            SUM(sales_amount) as total_amount
        FROM sales_records
        WHERE is_deleted = 0
        GROUP BY status
    </select>

    <!-- Êü•ËØ¢ÈîÄÂîÆËÆ∞ÂΩïÊï∞ÈáèÔºàÊåâ‰ªòÊ¨æÁä∂ÊÄÅÂàÜÁªÑÔºâ -->
    <select id="selectCountByPaymentStatus" resultType="java.util.Map">
        SELECT 
            payment_status,
            COUNT(*) as count,
            SUM(sales_amount) as total_amount
        FROM sales_records
        WHERE is_deleted = 0
        GROUP BY payment_status
    </select>

    <!-- Êü•ËØ¢‰ªäÊó•ÈîÄÂîÆÊï∞Êç?-->
    <select id="selectTodaySalesData" resultType="java.util.Map">
        SELECT 
            COUNT(*) as today_orders,
            COALESCE(SUM(sales_amount), 0) as today_sales_amount,
            COALESCE(SUM(quantity), 0) as today_quantity,
            COUNT(DISTINCT customer_id) as today_customers
        FROM sales_records
        WHERE DATE(order_date) = CURDATE() AND is_deleted = 0
    </select>

    <!-- Êü•ËØ¢Êú¨ÊúàÈîÄÂîÆÊï∞Êç?-->
    <select id="selectCurrentMonthSalesData" resultType="java.util.Map">
        SELECT 
            COUNT(*) as month_orders,
            COALESCE(SUM(sales_amount), 0) as month_sales_amount,
            COALESCE(SUM(quantity), 0) as month_quantity,
            COUNT(DISTINCT customer_id) as month_customers
        FROM sales_records
        WHERE YEAR(order_date) = YEAR(CURDATE()) AND MONTH(order_date) = MONTH(CURDATE()) AND is_deleted = 0
    </select>

    <!-- Êü•ËØ¢Êú¨Âπ¥ÈîÄÂîÆÊï∞Êç?-->
    <select id="selectCurrentYearSalesData" resultType="java.util.Map">
        SELECT 
            COUNT(*) as year_orders,
            COALESCE(SUM(sales_amount), 0) as year_sales_amount,
            COALESCE(SUM(quantity), 0) as year_quantity,
            COUNT(DISTINCT customer_id) as year_customers
        FROM sales_records
        WHERE YEAR(order_date) = YEAR(CURDATE()) AND is_deleted = 0
    </select>

    <!-- Êõ¥Êñ∞ÈîÄÂîÆËÆ∞ÂΩïÁä∂ÊÄ?-->
    <update id="updateStatus">
        UPDATE sales_records SET status = #{status}, updated_at = NOW() 
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- Êõ¥Êñ∞‰ªòÊ¨æÁä∂ÊÄ?-->
    <update id="updatePaymentStatus">
        UPDATE sales_records SET payment_status = #{paymentStatus}, updated_at = NOW() 
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- ÊâπÈáèÊõ¥Êñ∞ÈîÄÂîÆËÆ∞ÂΩïÁä∂ÊÄ?-->
    <update id="batchUpdateStatus">
        UPDATE sales_records SET status = #{status}, updated_at = NOW() 
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND is_deleted = 0
    </update>

    <!-- Ê£ÄÊü•ËÆ¢ÂçïÂè∑ÊòØÂê¶Â≠òÂú® -->
    <select id="existsByOrderNumber" resultType="boolean">
        SELECT COUNT(*) > 0 FROM sales_records WHERE order_number = #{orderNumber} AND is_deleted = 0
    </select>

    <!-- Ê£ÄÊü•ËÆ¢ÂçïÂè∑ÊòØÂê¶Â≠òÂú®ÔºàÊéíÈô§ÊåáÂÆöIDÔº?-->
    <select id="existsByOrderNumberExcludeId" resultType="boolean">
        SELECT COUNT(*) > 0 FROM sales_records 
        WHERE order_number = #{orderNumber} AND id != #{id} AND is_deleted = 0
    </select>

    <!-- È´òÁ∫ßÊêúÁ¥¢ - Ëé∑ÂèñÊêúÁ¥¢Âª∫ËÆÆ -->
    <select id="getSearchSuggestions" resultType="java.util.Map">
        SELECT DISTINCT 
            'orderNumber' as type,
            sr.order_number as value,
            COUNT(*) as count
        FROM sales_records sr
        WHERE sr.order_number LIKE CONCAT('%', #{keyword}, '%') AND sr.is_deleted = 0
        GROUP BY sr.order_number
        UNION ALL
        SELECT DISTINCT 
            'customerName' as type,
            c.customer_name as value,
            COUNT(*) as count
        FROM sales_records sr
        LEFT JOIN customers c ON sr.customer_id = c.id
        WHERE c.customer_name LIKE CONCAT('%', #{keyword}, '%') AND sr.is_deleted = 0
        GROUP BY c.customer_name
        UNION ALL
        SELECT DISTINCT 
            'productName' as type,
            sp.product_name as value,
            COUNT(*) as count
        FROM sales_records sr
        LEFT JOIN sales_products sp ON sr.product_id = sp.id
        WHERE sp.product_name LIKE CONCAT('%', #{keyword}, '%') AND sr.is_deleted = 0
        GROUP BY sp.product_name
        ORDER BY count DESC
        LIMIT 10
    </select>

    <!-- Ëé∑ÂèñÁ≠õÈÄâÈÄâÈ°π - Âú∞Âå∫ÂàóË°® -->
    <select id="getRegionOptions" resultType="java.util.Map">
        SELECT 
            region as value,
            region as label,
            COUNT(*) as count
        FROM sales_records
        WHERE region IS NOT NULL AND region != '' AND is_deleted = 0
        GROUP BY region
        ORDER BY count DESC
    </select>

    <!-- Ëé∑ÂèñÁ≠õÈÄâÈÄâÈ°π - Ê∏†ÈÅìÂàóË°® -->
    <select id="getChannelOptions" resultType="java.util.Map">
        SELECT 
            channel as value,
            channel as label,
            COUNT(*) as count
        FROM sales_records
        WHERE channel IS NOT NULL AND channel != '' AND is_deleted = 0
        GROUP BY channel
        ORDER BY count DESC
    </select>

    <!-- Ëé∑ÂèñÁ≠õÈÄâÈÄâÈ°π - ‰ªòÊ¨æÊñπÂºèÂàóË°® -->
    <select id="getPaymentMethodOptions" resultType="java.util.Map">
        SELECT 
            payment_method as value,
            payment_method as label,
            COUNT(*) as count
        FROM sales_records
        WHERE payment_method IS NOT NULL AND payment_method != '' AND is_deleted = 0
        GROUP BY payment_method
        ORDER BY count DESC
    </select>

    <!-- Ëé∑ÂèñÈîÄÂîÆÈáëÈ¢ùËåÉÂõ¥ÁªüËÆ?-->
    <select id="getSalesAmountRangeStats" resultType="java.util.Map">
        SELECT 
            '0-1000' as range_label,
            '0' as min_amount,
            '1000' as max_amount,
            COUNT(*) as count,
            SUM(sales_amount) as total_amount
        FROM sales_records
        WHERE sales_amount BETWEEN 0 AND 1000 AND is_deleted = 0
        UNION ALL
        SELECT 
            '1000-5000' as range_label,
            '1000' as min_amount,
            '5000' as max_amount,
            COUNT(*) as count,
            SUM(sales_amount) as total_amount
        FROM sales_records
        WHERE sales_amount BETWEEN 1000 AND 5000 AND is_deleted = 0
        UNION ALL
        SELECT 
            '5000-10000' as range_label,
            '5000' as min_amount,
            '10000' as max_amount,
            COUNT(*) as count,
            SUM(sales_amount) as total_amount
        FROM sales_records
        WHERE sales_amount BETWEEN 5000 AND 10000 AND is_deleted = 0
        UNION ALL
        SELECT 
            '10000+' as range_label,
            '10000' as min_amount,
            '999999999' as max_amount,
            COUNT(*) as count,
            SUM(sales_amount) as total_amount
        FROM sales_records
        WHERE sales_amount > 10000 AND is_deleted = 0
        ORDER BY min_amount
    </select>

    <!-- Âø´ÈÄüÁ≠õÈÄ?- ‰ªäÊó•ËÆ¢Âçï -->
    <select id="selectTodayOrders" resultMap="SalesRecordResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sales_records
        WHERE DATE(order_date) = CURDATE() AND is_deleted = 0
        ORDER BY created_at DESC
    </select>

    <!-- Âø´ÈÄüÁ≠õÈÄ?- Êú¨Âë®ËÆ¢Âçï -->
    <select id="selectThisWeekOrders" resultMap="SalesRecordResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sales_records
        WHERE YEARWEEK(order_date, 1) = YEARWEEK(CURDATE(), 1) AND is_deleted = 0
        ORDER BY order_date DESC
    </select>

    <!-- Âø´ÈÄüÁ≠õÈÄ?- Êú¨ÊúàËÆ¢Âçï -->
    <select id="selectThisMonthOrders" resultMap="SalesRecordResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sales_records
        WHERE YEAR(order_date) = YEAR(CURDATE()) AND MONTH(order_date) = MONTH(CURDATE()) AND is_deleted = 0
        ORDER BY order_date DESC
    </select>

    <!-- Âø´ÈÄüÁ≠õÈÄ?- ÂæÖÂ§ÑÁêÜËÆ¢Âç?-->
    <select id="selectPendingOrders" resultMap="SalesRecordResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sales_records
        WHERE status = 'pending' AND is_deleted = 0
        ORDER BY created_at ASC
    </select>

    <!-- Âø´ÈÄüÁ≠õÈÄ?- È´ò‰ª∑ÂÄºËÆ¢Âç?-->
    <select id="selectHighValueOrders" resultMap="SalesRecordResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sales_records
        WHERE sales_amount >= #{minAmount} AND is_deleted = 0
        ORDER BY sales_amount DESC
    </select>

    <!-- ÊêúÁ¥¢ÊÄßËÉΩ‰ºòÂåñ - ‰ΩøÁî®Á¥¢ÂºïÊèêÁ§∫ -->
    <select id="selectListWithDetailsOptimized" resultType="java.util.Map">
        SELECT <include refid="Detail_Column_List"/>
        FROM sales_records sr USE INDEX (idx_order_date, idx_status, idx_customer_id)
        LEFT JOIN customers c ON sr.customer_id = c.id
        LEFT JOIN sales_products sp ON sr.product_id = sp.id
        LEFT JOIN sales_staff ss ON sr.sales_staff_id = ss.id
        <include refid="Query_Where_Clause"/>
        <include refid="Order_By_Clause"/>
        <if test="query.page != null and query.size != null">
            LIMIT #{query.size} OFFSET #{query.page}
        </if>
    </select>

    <!-- ÊêúÁ¥¢ÊÄßËÉΩ‰ºòÂåñ - ËÆ°Êï∞Êü•ËØ¢‰ºòÂåñ -->
    <select id="selectCountOptimized" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM sales_records sr USE INDEX (idx_order_date, idx_status, idx_customer_id)
        <if test="query.customerName != null and query.customerName != '' or query.productName != null and query.productName != '' or query.salesStaffName != null and query.salesStaffName != '' or query.keyword != null and query.keyword != ''">
            LEFT JOIN customers c ON sr.customer_id = c.id
            LEFT JOIN sales_products sp ON sr.product_id = sp.id
            LEFT JOIN sales_staff ss ON sr.sales_staff_id = ss.id
        </if>
        <include refid="Query_Where_Clause"/>
    </select>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yxrobot.mapper.SalesStatsMapper">

    <!-- ÈîÄÂîÆÁªüËÆ°ÁªìÊûúÊò†Â∞?-->
    <resultMap id="SalesStatsResultMap" type="com.yxrobot.entity.SalesStats">
        <id column="id" property="id"/>
        <result column="stat_date" property="statDate"/>
        <result column="stat_type" property="statType"/>
        <result column="total_sales_amount" property="totalSalesAmount"/>
        <result column="total_orders" property="totalOrders"/>
        <result column="total_quantity" property="totalQuantity"/>
        <result column="avg_order_amount" property="avgOrderAmount"/>
        <result column="new_customers" property="newCustomers"/>
        <result column="active_customers" property="activeCustomers"/>
        <result column="top_product_id" property="topProductId"/>
        <result column="top_staff_id" property="topStaffId"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <!-- Âü∫Á°ÄÊü•ËØ¢Â≠óÊÆµ -->
    <sql id="Base_Column_List">
        id, stat_date, stat_type, total_sales_amount, total_orders, total_quantity, 
        avg_order_amount, new_customers, active_customers, top_product_id, top_staff_id, 
        created_at, updated_at
    </sql>

    <!-- Êü•ËØ¢Êù°‰ª∂ -->
    <sql id="Query_Where_Clause">
        <where>
            1 = 1
            <if test="statType != null and statType != ''">
                AND stat_type = #{statType}
            </if>
            <if test="startDate != null">
                AND stat_date >= #{startDate}
            </if>
            <if test="endDate != null">
                AND stat_date &lt;= #{endDate}
            </if>
        </where>
    </sql>

    <!-- Ê†πÊçÆIDÊü•ËØ¢ÈîÄÂîÆÁªüËÆ?-->
    <select id="selectById" resultMap="SalesStatsResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sales_stats
        WHERE id = #{id}
    </select>

    <!-- Ê†πÊçÆÊó•ÊúüÂíåÁ±ªÂûãÊü•ËØ¢ÈîÄÂîÆÁªüËÆ?-->
    <select id="selectByDateAndType" resultMap="SalesStatsResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sales_stats
        WHERE stat_date = #{statDate} AND stat_type = #{statType}
    </select>

    <!-- Êü•ËØ¢ÊâÄÊúâÈîÄÂîÆÁªüËÆ°ÂàóË°?-->
    <select id="selectAll" resultMap="SalesStatsResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sales_stats
        ORDER BY stat_date DESC, stat_type
    </select>

    <!-- ÂàÜÈ°µÊü•ËØ¢ÈîÄÂîÆÁªüËÆ°ÂàóË°?-->
    <select id="selectList" resultMap="SalesStatsResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sales_stats
        <include refid="Query_Where_Clause"/>
        ORDER BY stat_date DESC, stat_type
        <if test="page != null and size != null">
            LIMIT #{size} OFFSET #{page}
        </if>
    </select>

    <!-- Êü•ËØ¢ÈîÄÂîÆÁªüËÆ°ÊÄªÊï∞ -->
    <select id="selectCount" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM sales_stats
        <include refid="Query_Where_Clause"/>
    </select>

    <!-- Êü•ËØ¢ÈîÄÂîÆÁªüËÆ°ÂàóË°®ÔºàÂ∏¶ÂÖ≥ËÅî‰ø°ÊÅØÔºâ -->
    <select id="selectListWithDetails" resultType="java.util.Map">
        SELECT 
            ss.id, ss.stat_date, ss.stat_type, ss.total_sales_amount, ss.total_orders, 
            ss.total_quantity, ss.avg_order_amount, ss.new_customers, ss.active_customers, 
            ss.top_product_id, ss.top_staff_id, ss.created_at, ss.updated_at,
            p.product_name as top_product_name,
            st.staff_name as top_staff_name
        FROM sales_stats ss
        LEFT JOIN products p ON ss.top_product_id = p.id
        LEFT JOIN sales_staff st ON ss.top_staff_id = st.id
        <include refid="Query_Where_Clause"/>
        ORDER BY ss.stat_date DESC, ss.stat_type
        <if test="page != null and size != null">
            LIMIT #{size} OFFSET #{page}
        </if>
    </select>

    <!-- ÊèíÂÖ•ÈîÄÂîÆÁªüËÆ?-->
    <insert id="insert" parameterType="com.yxrobot.entity.SalesStats" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO sales_stats (
            stat_date, stat_type, total_sales_amount, total_orders, total_quantity, 
            avg_order_amount, new_customers, active_customers, top_product_id, top_staff_id, 
            created_at, updated_at
        ) VALUES (
            #{statDate}, #{statType}, #{totalSalesAmount}, #{totalOrders}, #{totalQuantity}, 
            #{avgOrderAmount}, #{newCustomers}, #{activeCustomers}, #{topProductId}, #{topStaffId}, 
            NOW(), NOW()
        )
    </insert>

    <!-- Êõ¥Êñ∞ÈîÄÂîÆÁªüËÆ?-->
    <update id="updateById" parameterType="com.yxrobot.entity.SalesStats">
        UPDATE sales_stats SET
            stat_date = #{statDate},
            stat_type = #{statType},
            total_sales_amount = #{totalSalesAmount},
            total_orders = #{totalOrders},
            total_quantity = #{totalQuantity},
            avg_order_amount = #{avgOrderAmount},
            new_customers = #{newCustomers},
            active_customers = #{activeCustomers},
            top_product_id = #{topProductId},
            top_staff_id = #{topStaffId},
            updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- Ê†πÊçÆIDÂà†Èô§ÈîÄÂîÆÁªüËÆ?-->
    <delete id="deleteById">
        DELETE FROM sales_stats WHERE id = #{id}
    </delete>

    <!-- Ê†πÊçÆÊó•ÊúüÂíåÁ±ªÂûãÂà†Èô§ÈîÄÂîÆÁªüËÆ?-->
    <delete id="deleteByDateAndType">
        DELETE FROM sales_stats WHERE stat_date = #{statDate} AND stat_type = #{statType}
    </delete>

    <!-- Êü•ËØ¢ÊúÄÊñ∞ÁöÑÈîÄÂîÆÁªüËÆ?-->
    <select id="selectLatestByType" resultMap="SalesStatsResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sales_stats
        WHERE stat_type = #{statType}
        ORDER BY stat_date DESC
        LIMIT 1
    </select>

    <!-- Êü•ËØ¢Êó•ÁªüËÆ°Êï∞Êç?-->
    <select id="selectDailyStats" resultMap="SalesStatsResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sales_stats
        WHERE stat_type = 'daily' AND stat_date BETWEEN #{startDate} AND #{endDate}
        ORDER BY stat_date
    </select>

    <!-- Êü•ËØ¢ÈîÄÂîÆË∂ãÂäøÊï∞Êç?-->
    <select id="selectSalesTrends" resultType="java.util.Map">
        SELECT 
            stat_date,
            total_sales_amount,
            total_orders,
            avg_order_amount,
            new_customers,
            active_customers
        FROM sales_stats
        WHERE stat_type = #{statType} AND stat_date BETWEEN #{startDate} AND #{endDate}
        ORDER BY stat_date
    </select>

    <!-- Êü•ËØ¢ÂÖ≥ÈîÆÊåáÊ†áÊ±áÊÄ?- Áõ¥Êé•‰ªéÈîÄÂîÆËÆ∞ÂΩïË°®ËÆ°ÁÆó -->
    <select id="selectKeyMetricsSummary" resultType="java.util.Map">
        SELECT 
            COALESCE(SUM(sr.sales_amount), 0) as total_sales_amount,
            COUNT(sr.id) as total_orders,
            COALESCE(SUM(sr.quantity), 0) as total_quantity,
            COALESCE(AVG(sr.sales_amount), 0) as avg_order_amount,
            COUNT(DISTINCT CASE 
                WHEN sr.order_date BETWEEN #{startDate} AND #{endDate} 
                THEN sr.customer_id 
                ELSE NULL 
            END) as new_customers,
            COUNT(DISTINCT sr.customer_id) as active_customers,
            (SELECT p.id FROM sales_records sr2 
             LEFT JOIN products p ON sr2.product_id = p.id 
             WHERE sr2.order_date BETWEEN #{startDate} AND #{endDate} 
               AND sr2.is_deleted = 0 
             GROUP BY p.id 
             ORDER BY SUM(sr2.quantity) DESC 
             LIMIT 1) as top_product_id,
            (SELECT ss.id FROM sales_records sr3 
             LEFT JOIN sales_staff ss ON sr3.sales_staff_id = ss.id 
             WHERE sr3.order_date BETWEEN #{startDate} AND #{endDate} 
               AND sr3.is_deleted = 0 
             GROUP BY ss.id 
             ORDER BY SUM(sr3.sales_amount) DESC 
             LIMIT 1) as top_staff_id
        FROM sales_records sr
        WHERE sr.order_date BETWEEN #{startDate} AND #{endDate}
          AND sr.is_deleted = 0
    </select>

    <!-- Êü•ËØ¢ÂÆûÊó∂ÁªüËÆ°Êï∞ÊçÆ -->
    <select id="selectRealTimeStats" resultType="java.util.Map">
        SELECT 
            COUNT(*) as total_orders,
            COALESCE(SUM(sales_amount), 0) as total_sales_amount,
            COALESCE(SUM(quantity), 0) as total_quantity,
            COALESCE(AVG(sales_amount), 0) as avg_order_amount,
            COUNT(DISTINCT customer_id) as active_customers,
            COUNT(DISTINCT CASE 
                WHEN DATE(created_at) = CURDATE() 
                THEN customer_id 
                ELSE NULL 
            END) as new_customers
        FROM sales_records
        WHERE is_deleted = 0
    </select>

    <!-- Êü•ËØ¢‰ªäÊó•ÁªüËÆ°Êï∞ÊçÆ -->
    <select id="selectTodayStats" resultType="java.util.Map">
        SELECT 
            COUNT(*) as today_orders,
            COALESCE(SUM(sales_amount), 0) as today_sales_amount,
            COALESCE(SUM(quantity), 0) as today_quantity,
            COALESCE(AVG(sales_amount), 0) as today_avg_amount,
            COUNT(DISTINCT customer_id) as today_customers
        FROM sales_records
        WHERE DATE(order_date) = CURDATE() AND is_deleted = 0
    </select>

    <!-- Êü•ËØ¢Êú¨ÊúàÁªüËÆ°Êï∞ÊçÆ -->
    <select id="selectCurrentMonthStats" resultType="java.util.Map">
        SELECT 
            COUNT(*) as month_orders,
            COALESCE(SUM(sales_amount), 0) as month_sales_amount,
            COALESCE(SUM(quantity), 0) as month_quantity,
            COALESCE(AVG(sales_amount), 0) as month_avg_amount,
            COUNT(DISTINCT customer_id) as month_customers
        FROM sales_records
        WHERE YEAR(order_date) = YEAR(CURDATE()) 
            AND MONTH(order_date) = MONTH(CURDATE()) 
            AND is_deleted = 0
    </select>

    <!-- Êü•ËØ¢Êú¨Âπ¥ÁªüËÆ°Êï∞ÊçÆ -->
    <select id="selectCurrentYearStats" resultType="java.util.Map">
        SELECT 
            COUNT(*) as year_orders,
            COALESCE(SUM(sales_amount), 0) as year_sales_amount,
            COALESCE(SUM(quantity), 0) as year_quantity,
            COALESCE(AVG(sales_amount), 0) as year_avg_amount,
            COUNT(DISTINCT customer_id) as year_customers
        FROM sales_records
        WHERE YEAR(order_date) = YEAR(CURDATE()) AND is_deleted = 0
    </select>

    <!-- ÁîüÊàêÊó•ÁªüËÆ°Êï∞Êç?-->
    <insert id="generateDailyStats">
        INSERT INTO sales_stats (
            stat_date, stat_type, total_sales_amount, total_orders, total_quantity, 
            avg_order_amount, new_customers, active_customers, created_at, updated_at
        )
        SELECT 
            #{statDate} as stat_date,
            'daily' as stat_type,
            COALESCE(SUM(sales_amount), 0) as total_sales_amount,
            COUNT(*) as total_orders,
            COALESCE(SUM(quantity), 0) as total_quantity,
            COALESCE(AVG(sales_amount), 0) as avg_order_amount,
            COUNT(DISTINCT CASE WHEN DATE(c.created_at) = #{statDate} THEN sr.customer_id END) as new_customers,
            COUNT(DISTINCT sr.customer_id) as active_customers,
            NOW() as created_at,
            NOW() as updated_at
        FROM sales_records sr
        LEFT JOIN customers c ON sr.customer_id = c.id
        WHERE DATE(sr.order_date) = #{statDate} AND sr.is_deleted = 0
        ON DUPLICATE KEY UPDATE
            total_sales_amount = VALUES(total_sales_amount),
            total_orders = VALUES(total_orders),
            total_quantity = VALUES(total_quantity),
            avg_order_amount = VALUES(avg_order_amount),
            new_customers = VALUES(new_customers),
            active_customers = VALUES(active_customers),
            updated_at = NOW()
    </insert>

    <!-- Ê£ÄÊü•ÁªüËÆ°Êï∞ÊçÆÊòØÂê¶Â≠òÂú?-->
    <select id="existsByDateAndType" resultType="boolean">
        SELECT COUNT(*) > 0 FROM sales_stats WHERE stat_date = #{statDate} AND stat_type = #{statType}
    </select>

</mapper>
