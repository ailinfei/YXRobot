var Et=Object.defineProperty,Ft=Object.defineProperties;var Rt=Object.getOwnPropertyDescriptors;var wt=Object.getOwnPropertySymbols;var Bt=Object.prototype.hasOwnProperty,Yt=Object.prototype.propertyIsEnumerable;var vt=(re,l,o)=>l in re?Et(re,l,{enumerable:!0,configurable:!0,writable:!0,value:o}):re[l]=o,De=(re,l)=>{for(var o in l||(l={}))Bt.call(l,o)&&vt(re,o,l[o]);if(wt)for(var o of wt(l))Yt.call(l,o)&&vt(re,o,l[o]);return re},Re=(re,l)=>Ft(re,Rt(l));var xe=(re,l,o)=>vt(re,typeof l!="symbol"?l+"":l,o);var G=(re,l,o)=>new Promise((_,b)=>{var m=v=>{try{h(o.next(v))}catch(V){b(V)}},u=v=>{try{h(o.throw(v))}catch(V){b(V)}},h=v=>v.done?_(v.value):Promise.resolve(v.value).then(m,u);h((o=o.apply(re,l)).next())});import{af as St,ag as Xt,ac as at,a3 as Ce,a6 as We,b as x,q as Le,k as ft,e as Lt,$ as pt,ah as Ht,a0 as Qe,n as Ue,m as gt,F as Je,ai as Zt,R as $t,aj as jt,aa as nt,a4 as Kt,ab as Vt,w as it,r as et,ak as Ct,al as kt,W as je,j as rt,V as Ge,a9 as Ye,am as qt,ae as Wt,an as Gt,v as Qt,c as Jt,ao as es,z as ts}from"./element-plus-B_LAMX2W.js";import{x as Pe,c as ae,r as I,h as Ke,j as Xe,al as f,ar as qe,H as B,z as n,I as s,J as He,y as p,A as e,K as Y,Q as t,P as ne,a6 as oe,M as d,u as g,O as a,S as Tt,D as Ne,n as ss,X as mt,R as ls}from"./vue-C2NPAEWw.js";import{_ as Oe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{i as as}from"./charts-4xgvsrqt.js";const ns=()=>[{id:"1",version:"2.1.0",deviceModel:["YX-EDU-2024","YX-HOME-2024"],releaseDate:"2024-01-15T00:00:00Z",fileSize:52428800,fileName:"firmware_v2.1.0.bin",filePath:"/firmware/v2.1.0/firmware_v2.1.0.bin",checksum:"sha256:a1b2c3d4e5f6...",description:"修复了字体渲染问题，提升了系统稳定性",changelog:["修复字体渲染异常问题","优化内存使用效率","增强网络连接稳定性","修复已知的安全漏洞"],compatibility:["YX-EDU-2024 v1.0+","YX-HOME-2024 v1.0+"],knownIssues:["在某些网络环境下可能出现连接延迟"],downloadCount:1250,status:"stable",createdBy:"admin",createdAt:"2024-01-10T00:00:00Z",updatedAt:"2024-01-15T00:00:00Z"},{id:"2",version:"2.0.5",deviceModel:["YX-EDU-2024","YX-HOME-2024","YX-PRO-2024"],releaseDate:"2024-01-01T00:00:00Z",fileSize:48234496,fileName:"firmware_v2.0.5.bin",filePath:"/firmware/v2.0.5/firmware_v2.0.5.bin",checksum:"sha256:b2c3d4e5f6g7...",description:"稳定版本，推荐所有用户更新",changelog:["提升书写识别准确度","优化电池管理算法","修复蓝牙连接问题","增加新的练字模式"],compatibility:["所有设备型号"],knownIssues:[],downloadCount:2340,status:"stable",createdBy:"admin",createdAt:"2023-12-25T00:00:00Z",updatedAt:"2024-01-01T00:00:00Z"},{id:"3",version:"2.2.0-beta",deviceModel:["YX-PRO-2024"],releaseDate:"2024-01-20T00:00:00Z",fileSize:55574528,fileName:"firmware_v2.2.0-beta.bin",filePath:"/firmware/v2.2.0-beta/firmware_v2.2.0-beta.bin",checksum:"sha256:c3d4e5f6g7h8...",description:"测试版本，包含AI智能纠错功能",changelog:["新增AI智能纠错功能","支持多种字体风格","优化触控响应速度","增加语音指导功能"],compatibility:["YX-PRO-2024 v2.0+"],knownIssues:["AI功能可能消耗更多电量","部分字体在小尺寸下显示不清晰"],downloadCount:156,status:"testing",createdBy:"developer",createdAt:"2024-01-18T00:00:00Z",updatedAt:"2024-01-20T00:00:00Z"}],os=()=>[{deviceId:"dev-001",deviceSerialNumber:"EDU-001234",deviceModel:"YX-EDU-2024",deviceName:"教学设备-001",currentVersion:"2.0.5",latestVersion:"2.1.0",updateAvailable:!0,lastUpdateCheck:"2024-01-16T10:30:00Z",updateStatus:"update-available",lastUpdateTime:"2024-01-01T15:20:00Z",updateHistory:[{id:"update-001",deviceId:"dev-001",fromVersion:"2.0.3",toVersion:"2.0.5",updateTime:"2024-01-01T15:20:00Z",status:"success",duration:180,updatedBy:"admin"}],isOnline:!0,signalStrength:85,location:"教室A-101",lastHeartbeat:"2024-01-16T10:28:00Z",canUpdate:!0,updateRestrictions:[]},{deviceId:"dev-002",deviceSerialNumber:"HOME-005678",deviceModel:"YX-HOME-2024",deviceName:"家用设备-002",currentVersion:"2.1.0",latestVersion:"2.1.0",updateAvailable:!1,lastUpdateCheck:"2024-01-16T10:30:00Z",updateStatus:"up-to-date",lastUpdateTime:"2024-01-15T09:45:00Z",updateHistory:[{id:"update-002",deviceId:"dev-002",fromVersion:"2.0.5",toVersion:"2.1.0",updateTime:"2024-01-15T09:45:00Z",status:"success",duration:210,updatedBy:"admin"}],isOnline:!0,signalStrength:92,location:"客厅",lastHeartbeat:"2024-01-16T10:29:00Z",canUpdate:!1,updateRestrictions:["没有可用更新"]},{deviceId:"dev-003",deviceSerialNumber:"PRO-009876",deviceModel:"YX-PRO-2024",deviceName:"专业设备-003",currentVersion:"2.0.5",latestVersion:"2.1.0",updateAvailable:!0,lastUpdateCheck:"2024-01-16T10:30:00Z",updateStatus:"failed",lastUpdateTime:"2024-01-14T14:20:00Z",updateHistory:[{id:"update-003",deviceId:"dev-003",fromVersion:"2.0.5",toVersion:"2.1.0",updateTime:"2024-01-14T14:20:00Z",status:"failed",errorMessage:"网络连接超时",duration:45,updatedBy:"admin"}],isOnline:!1,signalStrength:25,location:"办公室B-205",lastHeartbeat:"2024-01-16T09:15:00Z",updateProgress:0,errorCode:"NETWORK_TIMEOUT",errorMessage:"网络连接超时",canUpdate:!1,updateRestrictions:["设备离线","信号强度不足（需要至少30%）"]},{deviceId:"dev-004",deviceSerialNumber:"EDU-002468",deviceModel:"YX-EDU-2024",deviceName:"教学设备-004",currentVersion:"2.0.3",latestVersion:"2.1.0",updateAvailable:!0,lastUpdateCheck:"2024-01-16T10:30:00Z",updateStatus:"updating",lastUpdateTime:"2024-01-10T11:30:00Z",updateHistory:[{id:"update-004",deviceId:"dev-004",fromVersion:"2.0.1",toVersion:"2.0.3",updateTime:"2024-01-10T11:30:00Z",status:"success",duration:195,updatedBy:"admin"}],isOnline:!0,signalStrength:78,location:"教室C-302",lastHeartbeat:"2024-01-16T10:30:00Z",updateProgress:45,canUpdate:!1,updateRestrictions:["设备正在更新中"]},{deviceId:"dev-005",deviceSerialNumber:"HOME-001357",deviceModel:"YX-HOME-2024",deviceName:"家用设备-005",currentVersion:"2.0.5",latestVersion:"2.1.0",updateAvailable:!0,lastUpdateCheck:"2024-01-16T10:30:00Z",updateStatus:"update-available",lastUpdateTime:"2024-01-05T16:45:00Z",updateHistory:[{id:"update-005",deviceId:"dev-005",fromVersion:"2.0.3",toVersion:"2.0.5",updateTime:"2024-01-05T16:45:00Z",status:"success",duration:165,updatedBy:"user"}],isOnline:!0,signalStrength:65,location:"书房",lastHeartbeat:"2024-01-16T10:27:00Z",canUpdate:!0,updateRestrictions:[]}],is=()=>[{id:"task-001",name:"批量更新到v2.1.0",targetVersion:"2.1.0",deviceIds:["dev-001","dev-003","dev-005"],status:"running",progress:{total:3,completed:1,failed:0,inProgress:2},createdBy:"admin",createdAt:"2024-01-16T14:00:00Z",startedAt:"2024-01-16T14:05:00Z",devices:[{deviceId:"dev-001",deviceSerialNumber:"EDU-001234",status:"downloading",progress:65,currentStep:"下载固件文件",startTime:"2024-01-16T14:05:00Z",retryCount:0},{deviceId:"dev-003",deviceSerialNumber:"PRO-009876",status:"completed",progress:100,currentStep:"更新完成",startTime:"2024-01-16T14:05:00Z",endTime:"2024-01-16T14:08:00Z",retryCount:0},{deviceId:"dev-005",deviceSerialNumber:"HOME-001357",status:"installing",progress:85,currentStep:"安装固件",startTime:"2024-01-16T14:06:00Z",retryCount:0}]}];class rs{constructor(){xe(this,"firmwareVersions",ns());xe(this,"deviceFirmwareStatus",os());xe(this,"updateTasks",is())}getFirmwareVersions(){return G(this,arguments,function*(l={}){yield this.delay(800);let o=[...this.firmwareVersions];if(l.keyword){const h=l.keyword.toLowerCase();o=o.filter(v=>v.version.toLowerCase().includes(h)||v.description.toLowerCase().includes(h))}l.status&&(o=o.filter(h=>h.status===l.status)),l.deviceModel&&(o=o.filter(h=>h.deviceModel.includes(l.deviceModel))),l.sortBy&&o.sort((h,v)=>{const V=h[l.sortBy],y=v[l.sortBy],X=l.sortOrder==="desc"?-1:1;return V<y?-1*X:V>y?1*X:0});const _=l.page||1,b=l.pageSize||10,m=(_-1)*b,u=m+b;return{data:{list:o.slice(m,u),total:o.length,page:_,pageSize:b}}})}getDeviceFirmwareStatus(){return G(this,arguments,function*(l={}){yield this.delay(600);let o=[...this.deviceFirmwareStatus];if(l.keyword){const v=l.keyword.toLowerCase();o=o.filter(V=>V.deviceSerialNumber.toLowerCase().includes(v)||V.deviceName.toLowerCase().includes(v))}l.updateStatus&&(o=o.filter(v=>v.updateStatus===l.updateStatus)),l.hasUpdate!==void 0&&(o=o.filter(v=>v.updateAvailable===l.hasUpdate));const _=l.page||1,b=l.pageSize||10,m=(_-1)*b,u=m+b,h={total:this.deviceFirmwareStatus.length,upToDate:this.deviceFirmwareStatus.filter(v=>v.updateStatus==="up-to-date").length,updateAvailable:this.deviceFirmwareStatus.filter(v=>v.updateStatus==="update-available").length,updating:this.deviceFirmwareStatus.filter(v=>v.updateStatus==="updating").length,failed:this.deviceFirmwareStatus.filter(v=>v.updateStatus==="failed").length};return{data:{list:o.slice(m,u),total:o.length,page:_,pageSize:b,stats:h}}})}getUpdateTasks(){return G(this,arguments,function*(l={}){yield this.delay(500);let o=[...this.updateTasks];if(l.keyword){const h=l.keyword.toLowerCase();o=o.filter(v=>v.name.toLowerCase().includes(h)||v.targetVersion.toLowerCase().includes(h))}l.status&&(o=o.filter(h=>h.status===l.status));const _=l.page||1,b=l.pageSize||10,m=(_-1)*b,u=m+b;return{data:{list:o.slice(m,u),total:o.length,page:_,pageSize:b}}})}uploadFirmware(l){return G(this,null,function*(){yield this.delay(2e3);const o={id:Date.now().toString(),version:l.version,deviceModel:l.deviceModel,releaseDate:new Date().toISOString(),fileSize:l.file.size,fileName:l.file.name,filePath:`/firmware/${l.version}/${l.file.name}`,checksum:`sha256:${Math.random().toString(36).substring(2)}`,description:l.description,changelog:l.changelog,compatibility:l.compatibility,knownIssues:l.knownIssues,downloadCount:0,status:"draft",createdBy:"admin",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return this.firmwareVersions.unshift(o),{data:o}})}createUpdateTask(l){return G(this,null,function*(){yield this.delay(1e3);const o={id:Date.now().toString(),name:l.name,targetVersion:l.targetVersion,deviceIds:l.deviceIds,scheduledTime:l.scheduledTime,status:"pending",progress:{total:l.deviceIds.length,completed:0,failed:0,inProgress:0},createdBy:"admin",createdAt:new Date().toISOString(),devices:l.deviceIds.map(_=>{const b=this.deviceFirmwareStatus.find(m=>m.deviceId===_);return{deviceId:_,deviceSerialNumber:(b==null?void 0:b.deviceSerialNumber)||"Unknown",status:"pending",progress:0,currentStep:"等待开始",retryCount:0}})};return this.updateTasks.unshift(o),{data:o}})}getFirmwareStats(){return G(this,null,function*(){return yield this.delay(400),{data:{totalVersions:this.firmwareVersions.length,stableVersions:this.firmwareVersions.filter(o=>o.status==="stable").length,testingVersions:this.firmwareVersions.filter(o=>o.status==="testing").length,draftVersions:this.firmwareVersions.filter(o=>o.status==="draft").length,deprecatedVersions:this.firmwareVersions.filter(o=>o.status==="deprecated").length,totalDownloads:this.firmwareVersions.reduce((o,_)=>o+_.downloadCount,0),deviceDistribution:{"YX-EDU-2024":45,"YX-HOME-2024":32,"YX-PRO-2024":23}}}})}deleteFirmware(l){return G(this,null,function*(){yield this.delay(500);const o=this.firmwareVersions.findIndex(_=>_.id===l);return o>-1&&this.firmwareVersions.splice(o,1),{data:{success:!0}}})}cancelUpdateTask(l){return G(this,null,function*(){yield this.delay(300);const o=this.updateTasks.find(_=>_.id===l);return o&&(o.status="cancelled"),{data:{success:!0}}})}retryDeviceUpdate(l,o){return G(this,null,function*(){yield this.delay(500);const _=this.updateTasks.find(b=>b.id===l);if(_){const b=_.devices.find(m=>m.deviceId===o);b&&(b.status="pending",b.progress=0,b.currentStep="准备重试",b.retryCount+=1,b.errorMessage=void 0)}return{data:{success:!0}}})}delay(l){return new Promise(o=>setTimeout(o,l))}}const Me=new rs,dt={draft:"草稿",testing:"测试中",stable:"稳定版",deprecated:"已弃用"},Dt={"up-to-date":"最新版本","update-available":"有可用更新",updating:"更新中",failed:"更新失败"},It={pending:"等待中",running:"执行中",completed:"已完成",failed:"失败",cancelled:"已取消"},Mt={pending:"准备中",downloading:"下载中",installing:"安装中",rebooting:"重启中",completed:"完成",failed:"失败"},ze=re=>{if(re===0)return"0 B";const l=1024,o=["B","KB","MB","GB"],_=Math.floor(Math.log(re)/Math.log(l));return parseFloat((re/Math.pow(l,_)).toFixed(2))+" "+o[_]};class Be{static createUpdateTask(l,o,_,b,m){const u=_.map(h=>({deviceId:h,deviceSerialNumber:"",status:"pending",progress:0,currentStep:"准备中",retryCount:0}));return{id:`task_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,name:l,targetVersion:o,deviceIds:_,scheduledTime:m,status:"pending",progress:{total:_.length,completed:0,failed:0,inProgress:0},createdBy:b,createdAt:new Date().toISOString(),devices:u}}static updateTaskStatus(l,o,_){const b=Re(De({},l),{status:o});switch(o){case"running":b.startedAt=(_==null?void 0:_.startedAt)||new Date().toISOString();break;case"completed":case"failed":case"cancelled":b.completedAt=(_==null?void 0:_.completedAt)||new Date().toISOString();break}return b}static updateDeviceProgress(l,o,_){const b=l.devices.map(h=>h.deviceId===o?Re(De(De({},h),_),{endTime:_.status==="completed"||_.status==="failed"?new Date().toISOString():h.endTime}):h),m=this.calculateTaskProgress(b);let u=l.status;return m.completed+m.failed===m.total?u=m.failed===0?"completed":"failed":m.inProgress>0&&l.status==="pending"&&(u="running"),Re(De({},l),{devices:b,progress:m,status:u,completedAt:u==="completed"||u==="failed"?new Date().toISOString():l.completedAt})}static calculateTaskProgress(l){const o=l.length;let _=0,b=0,m=0;return l.forEach(u=>{switch(u.status){case"completed":_++;break;case"failed":b++;break;case"downloading":case"installing":case"rebooting":m++;break}}),{total:o,completed:_,failed:b,inProgress:m}}static getTaskCompletionPercentage(l){if(l.progress.total===0)return 0;const o=l.progress.completed+l.progress.failed;return Math.round(o/l.progress.total*100)}static getTaskSuccessRate(l){const o=l.progress.completed+l.progress.failed;return o===0?0:Math.round(l.progress.completed/o*100)}static canStartTask(l){if(l.status!=="pending")return{canStart:!1,reason:`任务状态为 "${l.status}"，只有待执行的任务才能启动`};if(l.devices.length===0)return{canStart:!1,reason:"任务中没有设备"};if(l.scheduledTime){const o=new Date(l.scheduledTime).getTime();if(Date.now()<o)return{canStart:!1,reason:`定时任务，预定执行时间：${l.scheduledTime}`}}return{canStart:!0}}static canCancelTask(l){return l.status==="completed"?{canCancel:!1,reason:"任务已完成，无法取消"}:l.status==="cancelled"?{canCancel:!1,reason:"任务已取消"}:{canCancel:!0}}static cancelTask(l,o){const _=l.devices.map(m=>m.status==="pending"||m.status==="downloading"||m.status==="installing"||m.status==="rebooting"?Re(De({},m),{status:"failed",errorMessage:"任务被取消",endTime:new Date().toISOString()}):m),b=this.calculateTaskProgress(_);return Re(De({},l),{status:"cancelled",devices:_,progress:b,completedAt:new Date().toISOString()})}static retryFailedDevices(l){const o=l.devices.map(m=>m.status==="failed"?Re(De({},m),{status:"pending",progress:0,currentStep:"准备重试",errorMessage:void 0,retryCount:m.retryCount+1,endTime:void 0}):m),_=this.calculateTaskProgress(o);let b=l.status;return(l.status==="completed"||l.status==="failed")&&(b="running"),Re(De({},l),{devices:o,progress:_,status:b,completedAt:void 0})}static getTaskSummary(l){const o={totalDevices:l.progress.total,completedDevices:l.progress.completed,failedDevices:l.progress.failed,inProgressDevices:l.progress.inProgress,completionPercentage:this.getTaskCompletionPercentage(l),successRate:this.getTaskSuccessRate(l),duration:void 0,estimatedTimeRemaining:void 0};if(l.startedAt){const _=new Date(l.startedAt).getTime(),b=l.completedAt?new Date(l.completedAt).getTime():Date.now();o.duration=Math.floor((b-_)/1e3)}if(l.startedAt&&o.completedDevices>0&&o.inProgressDevices>0){const _=new Date(l.startedAt).getTime(),u=(Date.now()-_)/1e3/o.completedDevices;o.estimatedTimeRemaining=Math.floor(u*o.inProgressDevices)}return o}}const ds={class:"firmware-version-compare"},us={class:"version-selector"},cs={class:"selector-item"},vs={class:"selector-item"},ps={class:"selector-actions"},_s={key:0,class:"comparison-result"},ms={class:"comparison-section"},fs={class:"comparison-table"},gs={class:"compare-table"},hs={class:"version-column base"},ys={class:"version-column compare"},bs={class:"version-value"},ws={class:"version-value"},$s={class:"diff-value"},ks={class:"version-value"},Ss={class:"version-value"},Vs={class:"diff-value"},Cs={class:"version-value"},Ts={class:"version-value"},Ds={class:"diff-value"},Is={class:"version-value"},Ms={class:"device-list"},Us={class:"version-value"},xs={class:"device-list"},zs={class:"diff-value"},Ns={class:"device-diff"},Ps={key:0},Os={key:1},As={key:2},Es={class:"comparison-section"},Fs={class:"changelog-comparison"},Rs={class:"changelog-column"},Bs={class:"changelog-list"},Ys={class:"changelog-column"},Xs={class:"changelog-list"},Ls={class:"changelog-diff"},Hs={class:"diff-items"},Zs={key:0},js={key:1,class:"no-diff"},Ks={class:"comparison-section"},qs={class:"compatibility-comparison"},Ws={class:"compatibility-column"},Gs={class:"compatibility-list"},Qs={class:"compatibility-column"},Js={class:"compatibility-list"},el={class:"compatibility-diff"},tl={class:"diff-items"},sl={key:0},ll={key:1,class:"no-diff"},al={key:0,class:"comparison-section"},nl={class:"issues-comparison"},ol={class:"issues-column"},il={class:"issues-list"},rl={key:0,class:"no-issues"},dl={class:"issues-column"},ul={class:"issues-list"},cl={key:0,class:"no-issues"},vl={class:"issues-diff"},pl={class:"diff-items"},_l={key:0},ml={key:1,class:"no-diff"},fl={class:"dialog-footer"},gl=Pe({__name:"FirmwareVersionCompare",props:{modelValue:{type:Boolean},currentVersion:{}},emits:["update:modelValue","compare-complete"],setup(re,{emit:l}){const o=re,_=l,b=ae({get:()=>o.modelValue,set:c=>_("update:modelValue",c)}),m=I(!1),u=I(!1),h=I([]),v=I(""),V=I(""),y=I(null),X=()=>G(null,null,function*(){m.value=!0;try{const c=yield Me.getFirmwareVersions({page:1,pageSize:100});h.value=c.data.list,o.currentVersion&&(v.value=o.currentVersion.id)}catch(c){console.error("加载版本列表失败:",c),x.error("加载版本列表失败")}finally{m.value=!1}}),J=()=>{y.value=null},P=()=>{const c=v.value;v.value=V.value,V.value=c,y.value=null},se=()=>G(null,null,function*(){if(!(!v.value||!V.value)){u.value=!0;try{const c=h.value.find(q=>q.id===v.value),r=h.value.find(q=>q.id===V.value);if(!c||!r){x.error("版本信息不完整");return}yield new Promise(q=>setTimeout(q,1e3));const K={version1:c,version2:r,differences:{changelog:r.changelog.filter(q=>!c.changelog.includes(q)),compatibility:r.compatibility.filter(q=>!c.compatibility.includes(q)),knownIssues:r.knownIssues.filter(q=>!c.knownIssues.includes(q)),fileSize:r.fileSize-c.fileSize}};y.value=K,_("compare-complete",K),x.success("版本比较完成")}catch(c){console.error("版本比较失败:",c),x.error("版本比较失败")}finally{u.value=!1}}}),O=()=>{y.value&&x.success("比较结果导出功能开发中")},ye=()=>{_("update:modelValue",!1),y.value=null,v.value="",V.value=""},fe=c=>({stable:"success",testing:"warning",draft:"info",deprecated:"danger"})[c]||"info",ge=c=>dt[c]||c,F=c=>({"YX-EDU-2024":"教育版","YX-HOME-2024":"家庭版","YX-PRO-2024":"专业版","YX-MINI-2024":"迷你版"})[c]||c,k=c=>new Date(c).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}),R=(c,r)=>{const K=new Date(r).getTime()-new Date(c).getTime(),q=Math.floor(K/(1e3*60*60*24));return q===0?"同一天":q>0?`晚 ${q} 天`:`早 ${Math.abs(q)} 天`},Z=(c,r)=>{const K=new Date(r).getTime()-new Date(c).getTime();return K===0?"info":K>0?"success":"warning"},ue=c=>{if(c===0)return"无变化";const r=Math.abs(c);return`${c>0?"+":"-"}${ze(r)}`},_e=c=>c===0?"info":c>0?"warning":"success",te=(c,r)=>{const K=r-c;return K===0?"无变化":`${K>0?"+":""}${K.toLocaleString()}`},j=(c,r)=>{const K=r-c;return K===0?"info":K>0?"success":"warning"},z=(c,r)=>{const K=r.filter(ee=>!c.includes(ee)),q=c.filter(ee=>!r.includes(ee));return{added:K,removed:q}};return Ke(()=>{b.value&&X()}),Xe(b,c=>{c&&X()}),(c,r)=>{const K=f("el-option"),q=f("el-select"),ee=f("el-icon"),le=f("el-button"),ve=f("el-tag"),A=f("el-alert"),W=f("el-dialog"),ce=qe("loading");return n(),B(W,{modelValue:b.value,"onUpdate:modelValue":r[2]||(r[2]=N=>b.value=N),title:"固件版本比较",width:"1200px","close-on-click-modal":!1,onClose:ye},{footer:s(()=>[e("div",fl,[t(le,{onClick:ye},{default:s(()=>r[28]||(r[28]=[d("关闭",-1)])),_:1,__:[28]}),y.value?(n(),B(le,{key:0,type:"primary",onClick:O},{default:s(()=>[t(ee,null,{default:s(()=>[t(g(We))]),_:1}),r[29]||(r[29]=d(" 导出比较结果 ",-1))]),_:1,__:[29]})):Y("",!0)])]),default:s(()=>[He((n(),p("div",ds,[e("div",us,[e("div",cs,[r[3]||(r[3]=e("label",null,"基准版本",-1)),t(q,{modelValue:v.value,"onUpdate:modelValue":r[0]||(r[0]=N=>v.value=N),placeholder:"选择基准版本",onChange:J,style:{width:"100%"}},{default:s(()=>[(n(!0),p(ne,null,oe(h.value,N=>(n(),B(K,{key:N.id,label:`${N.version} (${ge(N.status)})`,value:N.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),e("div",vs,[r[4]||(r[4]=e("label",null,"对比版本",-1)),t(q,{modelValue:V.value,"onUpdate:modelValue":r[1]||(r[1]=N=>V.value=N),placeholder:"选择对比版本",onChange:J,style:{width:"100%"}},{default:s(()=>[(n(!0),p(ne,null,oe(h.value,N=>(n(),B(K,{key:N.id,label:`${N.version} (${ge(N.status)})`,value:N.id,disabled:N.id===v.value},null,8,["label","value","disabled"]))),128))]),_:1},8,["modelValue"])]),e("div",ps,[t(le,{type:"primary",onClick:se,disabled:!v.value||!V.value,loading:u.value},{default:s(()=>[t(ee,null,{default:s(()=>[t(g(St))]),_:1}),r[5]||(r[5]=d(" 开始比较 ",-1))]),_:1,__:[5]},8,["disabled","loading"]),t(le,{onClick:P,disabled:!v.value||!V.value},{default:s(()=>[t(ee,null,{default:s(()=>[t(g(Xt))]),_:1}),r[6]||(r[6]=d(" 交换版本 ",-1))]),_:1,__:[6]},8,["disabled"])])]),y.value?(n(),p("div",_s,[e("div",ms,[r[16]||(r[16]=e("div",{class:"section-header"},[e("h3",null,"基本信息对比")],-1)),e("div",fs,[e("table",gs,[e("thead",null,[e("tr",null,[r[7]||(r[7]=e("th",{class:"property-column"},"属性",-1)),e("th",hs,[d(a(y.value.version1.version)+" ",1),t(ve,{type:fe(y.value.version1.status),size:"small"},{default:s(()=>[d(a(ge(y.value.version1.status)),1)]),_:1},8,["type"])]),e("th",ys,[d(a(y.value.version2.version)+" ",1),t(ve,{type:fe(y.value.version2.status),size:"small"},{default:s(()=>[d(a(ge(y.value.version2.status)),1)]),_:1},8,["type"])]),r[8]||(r[8]=e("th",{class:"diff-column"},"差异",-1))])]),e("tbody",null,[e("tr",null,[r[9]||(r[9]=e("td",{class:"property-name"},"发布时间",-1)),e("td",bs,a(k(y.value.version1.releaseDate)),1),e("td",ws,a(k(y.value.version2.releaseDate)),1),e("td",$s,[t(ve,{type:Z(y.value.version1.releaseDate,y.value.version2.releaseDate),size:"small"},{default:s(()=>[d(a(R(y.value.version1.releaseDate,y.value.version2.releaseDate)),1)]),_:1},8,["type"])])]),e("tr",null,[r[10]||(r[10]=e("td",{class:"property-name"},"文件大小",-1)),e("td",ks,a(g(ze)(y.value.version1.fileSize)),1),e("td",Ss,a(g(ze)(y.value.version2.fileSize)),1),e("td",Vs,[t(ve,{type:_e(y.value.differences.fileSize),size:"small"},{default:s(()=>[d(a(ue(y.value.differences.fileSize)),1)]),_:1},8,["type"])])]),e("tr",null,[r[11]||(r[11]=e("td",{class:"property-name"},"下载次数",-1)),e("td",Cs,a(y.value.version1.downloadCount.toLocaleString()),1),e("td",Ts,a(y.value.version2.downloadCount.toLocaleString()),1),e("td",Ds,[t(ve,{type:j(y.value.version1.downloadCount,y.value.version2.downloadCount),size:"small"},{default:s(()=>[d(a(te(y.value.version1.downloadCount,y.value.version2.downloadCount)),1)]),_:1},8,["type"])])]),e("tr",null,[r[15]||(r[15]=e("td",{class:"property-name"},"适用设备",-1)),e("td",Is,[e("div",Ms,[(n(!0),p(ne,null,oe(y.value.version1.deviceModel,N=>(n(),B(ve,{key:N,size:"small"},{default:s(()=>[d(a(F(N)),1)]),_:2},1024))),128))])]),e("td",Us,[e("div",xs,[(n(!0),p(ne,null,oe(y.value.version2.deviceModel,N=>(n(),B(ve,{key:N,size:"small"},{default:s(()=>[d(a(F(N)),1)]),_:2},1024))),128))])]),e("td",zs,[e("div",Ns,[z(y.value.version1.deviceModel,y.value.version2.deviceModel).added.length>0?(n(),p("div",Ps,[r[12]||(r[12]=e("span",{class:"diff-label"},"新增:",-1)),(n(!0),p(ne,null,oe(z(y.value.version1.deviceModel,y.value.version2.deviceModel).added,N=>(n(),B(ve,{key:N,type:"success",size:"small"},{default:s(()=>[d(a(F(N)),1)]),_:2},1024))),128))])):Y("",!0),z(y.value.version1.deviceModel,y.value.version2.deviceModel).removed.length>0?(n(),p("div",Os,[r[13]||(r[13]=e("span",{class:"diff-label"},"移除:",-1)),(n(!0),p(ne,null,oe(z(y.value.version1.deviceModel,y.value.version2.deviceModel).removed,N=>(n(),B(ve,{key:N,type:"danger",size:"small"},{default:s(()=>[d(a(F(N)),1)]),_:2},1024))),128))])):Y("",!0),z(y.value.version1.deviceModel,y.value.version2.deviceModel).added.length===0&&z(y.value.version1.deviceModel,y.value.version2.deviceModel).removed.length===0?(n(),p("div",As,[t(ve,{type:"info",size:"small"},{default:s(()=>r[14]||(r[14]=[d("无变化",-1)])),_:1,__:[14]})])):Y("",!0)])])])])])])]),e("div",Es,[r[19]||(r[19]=e("div",{class:"section-header"},[e("h3",null,"更新日志对比")],-1)),e("div",Fs,[e("div",Rs,[e("h4",null,a(y.value.version1.version),1),e("ul",Bs,[(n(!0),p(ne,null,oe(y.value.version1.changelog,(N,pe)=>(n(),p("li",{key:pe,class:"changelog-item"},[t(ee,{class:"changelog-icon"},{default:s(()=>[t(g(Ce))]),_:1}),e("span",null,a(N),1)]))),128))])]),e("div",Ys,[e("h4",null,a(y.value.version2.version),1),e("ul",Xs,[(n(!0),p(ne,null,oe(y.value.version2.changelog,(N,pe)=>(n(),p("li",{key:pe,class:"changelog-item"},[t(ee,{class:"changelog-icon"},{default:s(()=>[t(g(Ce))]),_:1}),e("span",null,a(N),1)]))),128))])])]),e("div",Ls,[r[18]||(r[18]=e("h4",null,"差异分析",-1)),e("div",Hs,[y.value.differences.changelog.length>0?(n(),p("div",Zs,[(n(!0),p(ne,null,oe(y.value.differences.changelog,(N,pe)=>(n(),p("div",{key:pe,class:"diff-item"},[t(ee,{class:"diff-icon"},{default:s(()=>[t(g(Le))]),_:1}),e("span",null,a(N),1)]))),128))])):(n(),p("div",js,[t(ee,null,{default:s(()=>[t(g(at))]),_:1}),r[17]||(r[17]=e("span",null,"更新日志无显著差异",-1))]))])])]),e("div",Ks,[r[22]||(r[22]=e("div",{class:"section-header"},[e("h3",null,"兼容性对比")],-1)),e("div",qs,[e("div",Ws,[e("h4",null,a(y.value.version1.version),1),e("div",Gs,[(n(!0),p(ne,null,oe(y.value.version1.compatibility,(N,pe)=>(n(),p("div",{key:pe,class:"compatibility-item"},[t(ee,{class:"compatibility-icon"},{default:s(()=>[t(g(Ce))]),_:1}),e("span",null,a(N),1)]))),128))])]),e("div",Qs,[e("h4",null,a(y.value.version2.version),1),e("div",Js,[(n(!0),p(ne,null,oe(y.value.version2.compatibility,(N,pe)=>(n(),p("div",{key:pe,class:"compatibility-item"},[t(ee,{class:"compatibility-icon"},{default:s(()=>[t(g(Ce))]),_:1}),e("span",null,a(N),1)]))),128))])])]),e("div",el,[r[21]||(r[21]=e("h4",null,"兼容性变化",-1)),e("div",tl,[y.value.differences.compatibility.length>0?(n(),p("div",sl,[(n(!0),p(ne,null,oe(y.value.differences.compatibility,(N,pe)=>(n(),p("div",{key:pe,class:"diff-item"},[t(ee,{class:"diff-icon"},{default:s(()=>[t(g(Le))]),_:1}),e("span",null,a(N),1)]))),128))])):(n(),p("div",ll,[t(ee,null,{default:s(()=>[t(g(at))]),_:1}),r[20]||(r[20]=e("span",null,"兼容性信息无变化",-1))]))])])]),y.value.version1.knownIssues.length>0||y.value.version2.knownIssues.length>0?(n(),p("div",al,[r[27]||(r[27]=e("div",{class:"section-header"},[e("h3",null,"已知问题对比")],-1)),e("div",nl,[e("div",ol,[e("h4",null,a(y.value.version1.version),1),e("div",il,[(n(!0),p(ne,null,oe(y.value.version1.knownIssues,(N,pe)=>(n(),B(A,{key:pe,title:N,type:"warning","show-icon":"",closable:!1,class:"issue-alert"},null,8,["title"]))),128)),y.value.version1.knownIssues.length===0?(n(),p("div",rl,[t(ee,null,{default:s(()=>[t(g(Ce))]),_:1}),r[23]||(r[23]=e("span",null,"无已知问题",-1))])):Y("",!0)])]),e("div",dl,[e("h4",null,a(y.value.version2.version),1),e("div",ul,[(n(!0),p(ne,null,oe(y.value.version2.knownIssues,(N,pe)=>(n(),B(A,{key:pe,title:N,type:"warning","show-icon":"",closable:!1,class:"issue-alert"},null,8,["title"]))),128)),y.value.version2.knownIssues.length===0?(n(),p("div",cl,[t(ee,null,{default:s(()=>[t(g(Ce))]),_:1}),r[24]||(r[24]=e("span",null,"无已知问题",-1))])):Y("",!0)])])]),e("div",vl,[r[26]||(r[26]=e("h4",null,"问题变化",-1)),e("div",pl,[y.value.differences.knownIssues.length>0?(n(),p("div",_l,[(n(!0),p(ne,null,oe(y.value.differences.knownIssues,(N,pe)=>(n(),p("div",{key:pe,class:"diff-item"},[t(ee,{class:"diff-icon"},{default:s(()=>[t(g(Le))]),_:1}),e("span",null,a(N),1)]))),128))])):(n(),p("div",ml,[t(ee,null,{default:s(()=>[t(g(at))]),_:1}),r[25]||(r[25]=e("span",null,"已知问题无变化",-1))]))])])])):Y("",!0)])):Y("",!0)])),[[ce,m.value]])]),_:1},8,["modelValue"])}}}),hl=Oe(gl,[["__scopeId","data-v-0476b274"]]),yl={class:"firmware-version-detail"},bl={key:0,class:"detail-content"},wl={class:"info-section"},$l={class:"section-header"},kl={class:"header-actions"},Sl={class:"info-grid"},Vl={class:"info-item"},Cl={class:"value"},Tl={class:"info-item"},Dl={class:"value"},Il={class:"info-item"},Ml={class:"value"},Ul={class:"info-item"},xl={class:"value"},zl={class:"info-item"},Nl={class:"value"},Pl={class:"info-item"},Ol={class:"value"},Al={class:"info-item full-width"},El={class:"value"},Fl={class:"info-item full-width"},Rl={class:"value"},Bl={class:"info-section"},Yl={class:"device-models"},Xl={class:"info-section"},Ll={class:"description-content"},Hl={class:"info-section"},Zl={class:"changelog-content"},jl={class:"changelog-list"},Kl={class:"info-section"},ql={class:"compatibility-content"},Wl={class:"compatibility-list"},Gl={key:0,class:"info-section"},Ql={class:"issues-content"},Jl={class:"dialog-footer"},ea=Pe({__name:"FirmwareVersionDetail",props:{modelValue:{type:Boolean},versionId:{}},emits:["update:modelValue","version-updated","version-deleted"],setup(re,{emit:l}){const o=re,_=l,b=ae({get:()=>o.modelValue,set:F=>_("update:modelValue",F)}),m=I(!1),u=I(null),h=I(!1),v=()=>G(null,null,function*(){if(o.versionId){m.value=!0;try{yield new Promise(R=>setTimeout(R,500));const k=(yield Me.getFirmwareVersions({page:1,pageSize:100})).data.list.find(R=>R.id===o.versionId);k?u.value=k:(x.error("未找到指定的固件版本"),se())}catch(F){console.error("加载版本详情失败:",F),x.error("加载版本详情失败")}finally{m.value=!1}}}),V=()=>{if(!u.value)return;x.success(`开始下载固件：${u.value.fileName}`);const F=document.createElement("a");F.href="#",F.download=u.value.fileName,F.click()},y=()=>{h.value=!0},X=F=>{x.success("版本比较完成")},J=F=>G(null,null,function*(){if(u.value)try{switch(F){case"edit":x.info("编辑版本信息功能开发中");break;case"copy":x.info("复制版本功能开发中");break;case"update":x.info("推送更新功能开发中");break;case"delete":yield Ue.confirm("确定要删除这个固件版本吗？此操作不可恢复。","确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),yield Me.deleteFirmware(u.value.id),x.success("固件版本已删除"),_("version-deleted",u.value.id),se();break}}catch(k){k!=="cancel"&&(console.error("操作失败:",k),x.error("操作失败"))}}),P=F=>G(null,null,function*(){try{yield navigator.clipboard.writeText(F),x.success("已复制到剪贴板")}catch(k){console.error("复制失败:",k),x.error("复制失败")}}),se=()=>{_("update:modelValue",!1),u.value=null},O=F=>({stable:"success",testing:"warning",draft:"info",deprecated:"danger"})[F]||"info",ye=F=>dt[F]||F,fe=F=>({"YX-EDU-2024":"教育版","YX-HOME-2024":"家庭版","YX-PRO-2024":"专业版","YX-MINI-2024":"迷你版"})[F]||F,ge=F=>new Date(F).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});return Xe(()=>o.versionId,F=>{F&&b.value&&v()}),Xe(b,F=>{F&&o.versionId&&v()}),(F,k)=>{var q;const R=f("el-icon"),Z=f("el-button"),ue=f("el-dropdown-item"),_e=f("el-dropdown-menu"),te=f("el-dropdown"),j=f("el-tag"),z=f("el-input"),c=f("el-alert"),r=f("el-dialog"),K=qe("loading");return n(),B(r,{modelValue:b.value,"onUpdate:modelValue":k[3]||(k[3]=ee=>b.value=ee),title:`固件版本详情 - ${((q=u.value)==null?void 0:q.version)||""}`,width:"900px","close-on-click-modal":!1,onClose:se},{footer:s(()=>[e("div",Jl,[t(Z,{onClick:se},{default:s(()=>k[25]||(k[25]=[d("关闭",-1)])),_:1,__:[25]}),t(Z,{type:"primary",onClick:V},{default:s(()=>[t(R,null,{default:s(()=>[t(g(We))]),_:1}),k[26]||(k[26]=d(" 下载固件 ",-1))]),_:1,__:[26]})])]),default:s(()=>[He((n(),p("div",yl,[u.value?(n(),p("div",bl,[e("div",wl,[e("div",$l,[k[11]||(k[11]=e("h3",null,"基本信息",-1)),e("div",kl,[t(Z,{type:"primary",size:"small",onClick:V},{default:s(()=>[t(R,null,{default:s(()=>[t(g(We))]),_:1}),k[4]||(k[4]=d(" 下载固件 ",-1))]),_:1,__:[4]}),t(Z,{type:"success",size:"small",onClick:y},{default:s(()=>[t(R,null,{default:s(()=>[t(g(St))]),_:1}),k[5]||(k[5]=d(" 版本比较 ",-1))]),_:1,__:[5]}),t(te,{onCommand:J,trigger:"click"},{dropdown:s(()=>[t(_e,null,{default:s(()=>[t(ue,{command:"edit"},{default:s(()=>[t(R,null,{default:s(()=>[t(g(Lt))]),_:1}),k[7]||(k[7]=d(" 编辑信息 ",-1))]),_:1,__:[7]}),t(ue,{command:"copy"},{default:s(()=>[t(R,null,{default:s(()=>[t(g(pt))]),_:1}),k[8]||(k[8]=d(" 复制版本 ",-1))]),_:1,__:[8]}),u.value.status==="stable"?(n(),B(ue,{key:0,command:"update"},{default:s(()=>[t(R,null,{default:s(()=>[t(g(Ht))]),_:1}),k[9]||(k[9]=d(" 推送更新 ",-1))]),_:1,__:[9]})):Y("",!0),t(ue,{command:"delete",divided:""},{default:s(()=>[t(R,null,{default:s(()=>[t(g(Qe))]),_:1}),k[10]||(k[10]=d(" 删除版本 ",-1))]),_:1,__:[10]})]),_:1})]),default:s(()=>[t(Z,{size:"small"},{default:s(()=>[k[6]||(k[6]=d(" 更多操作",-1)),t(R,{class:"el-icon--right"},{default:s(()=>[t(g(ft))]),_:1})]),_:1,__:[6]})]),_:1})])]),e("div",Sl,[e("div",Vl,[k[12]||(k[12]=e("label",null,"版本号",-1)),e("div",Cl,[t(j,{size:"large",type:O(u.value.status)},{default:s(()=>[d(a(u.value.version),1)]),_:1},8,["type"])])]),e("div",Tl,[k[13]||(k[13]=e("label",null,"状态",-1)),e("div",Dl,[t(j,{type:O(u.value.status)},{default:s(()=>[d(a(ye(u.value.status)),1)]),_:1},8,["type"])])]),e("div",Il,[k[14]||(k[14]=e("label",null,"文件大小",-1)),e("div",Ml,a(g(ze)(u.value.fileSize)),1)]),e("div",Ul,[k[15]||(k[15]=e("label",null,"下载次数",-1)),e("div",xl,a(u.value.downloadCount.toLocaleString()),1)]),e("div",zl,[k[16]||(k[16]=e("label",null,"发布时间",-1)),e("div",Nl,a(ge(u.value.releaseDate)),1)]),e("div",Pl,[k[17]||(k[17]=e("label",null,"创建者",-1)),e("div",Ol,a(u.value.createdBy),1)]),e("div",Al,[k[18]||(k[18]=e("label",null,"文件名",-1)),e("div",El,[t(z,{value:u.value.fileName,readonly:""},{append:s(()=>[t(Z,{onClick:k[0]||(k[0]=ee=>P(u.value.fileName))},{default:s(()=>[t(R,null,{default:s(()=>[t(g(pt))]),_:1})]),_:1})]),_:1},8,["value"])])]),e("div",Fl,[k[19]||(k[19]=e("label",null,"校验和",-1)),e("div",Rl,[t(z,{value:u.value.checksum,readonly:""},{append:s(()=>[t(Z,{onClick:k[1]||(k[1]=ee=>P(u.value.checksum))},{default:s(()=>[t(R,null,{default:s(()=>[t(g(pt))]),_:1})]),_:1})]),_:1},8,["value"])])])])]),e("div",Bl,[k[20]||(k[20]=e("div",{class:"section-header"},[e("h3",null,"适用设备")],-1)),e("div",Yl,[(n(!0),p(ne,null,oe(u.value.deviceModel,ee=>(n(),B(j,{key:ee,size:"large",class:"model-tag"},{default:s(()=>[t(R,null,{default:s(()=>[t(g(gt))]),_:1}),d(" "+a(fe(ee)),1)]),_:2},1024))),128))])]),e("div",Xl,[k[21]||(k[21]=e("div",{class:"section-header"},[e("h3",null,"版本描述")],-1)),e("div",Ll,[e("p",null,a(u.value.description),1)])]),e("div",Hl,[k[22]||(k[22]=e("div",{class:"section-header"},[e("h3",null,"更新日志")],-1)),e("div",Zl,[e("ul",jl,[(n(!0),p(ne,null,oe(u.value.changelog,(ee,le)=>(n(),p("li",{key:le,class:"changelog-item"},[t(R,{class:"changelog-icon"},{default:s(()=>[t(g(Ce))]),_:1}),e("span",null,a(ee),1)]))),128))])])]),e("div",Kl,[k[23]||(k[23]=e("div",{class:"section-header"},[e("h3",null,"兼容性信息")],-1)),e("div",ql,[e("div",Wl,[(n(!0),p(ne,null,oe(u.value.compatibility,(ee,le)=>(n(),p("div",{key:le,class:"compatibility-item"},[t(R,{class:"compatibility-icon"},{default:s(()=>[t(g(Ce))]),_:1}),e("span",null,a(ee),1)]))),128))])])]),u.value.knownIssues.length>0?(n(),p("div",Gl,[k[24]||(k[24]=e("div",{class:"section-header"},[e("h3",null,"已知问题")],-1)),e("div",Ql,[(n(!0),p(ne,null,oe(u.value.knownIssues,(ee,le)=>(n(),B(c,{key:le,title:ee,type:"warning","show-icon":"",closable:!1,class:"issue-alert"},null,8,["title"]))),128))])])):Y("",!0)])):Y("",!0)])),[[K,m.value]]),t(hl,{modelValue:h.value,"onUpdate:modelValue":k[2]||(k[2]=ee=>h.value=ee),"current-version":u.value,onCompareComplete:X},null,8,["modelValue","current-version"])]),_:1},8,["modelValue","title"])}}}),ta=Oe(ea,[["__scopeId","data-v-a3c80f4b"]]),sa={class:"firmware-version-list"},la={class:"table-section"},aa={class:"device-models"},na={class:"pagination-wrapper"},oa=Pe({__name:"FirmwareVersionList",setup(re){const l=I(!1);I(!1);const o=I(1),_=I(20),b=I(0),m=I([]),u=I([]),h=R=>{_.value=R,o.value=1,y()},v=R=>{o.value=R,y()},V=R=>{u.value=R},y=()=>G(null,null,function*(){l.value=!0;try{const R=yield Me.getFirmwareVersions({page:o.value,pageSize:_.value});m.value=R.data.list,b.value=R.data.total}catch(R){console.error("加载版本数据失败:",R),x.error("加载版本数据失败")}finally{l.value=!1}}),X=I(!1),J=I(""),P=R=>{J.value=R.id,X.value=!0},se=R=>{x.success(`开始下载固件：${R.fileName}`)},O=(R,Z)=>G(null,null,function*(){try{switch(R){case"compare":x.info("版本比较功能开发中");break;case"update":x.info("推送更新功能开发中");break;case"edit":x.info("编辑版本信息功能开发中");break;case"delete":yield Ue.confirm("确定要删除这个固件版本吗？此操作不可恢复。","确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),yield Me.deleteFirmware(Z.id),x.success("固件版本已删除"),y();break}}catch(ue){ue!=="cancel"&&(console.error("版本操作失败:",ue),x.error("操作失败"))}}),ye=R=>({stable:"success",testing:"warning",draft:"info",deprecated:"danger"})[R]||"info",fe=R=>dt[R]||R,ge=R=>({"YX-EDU-2024":"教育版","YX-HOME-2024":"家庭版","YX-PRO-2024":"专业版"})[R]||R,F=R=>new Date(R).toLocaleString("zh-CN"),k=R=>{y(),X.value=!1};return Ke(()=>{y()}),(R,Z)=>{const ue=f("el-table-column"),_e=f("el-tag"),te=f("el-button"),j=f("el-icon"),z=f("el-dropdown-item"),c=f("el-dropdown-menu"),r=f("el-dropdown"),K=f("el-table"),q=f("el-pagination"),ee=qe("loading");return n(),p("div",sa,[e("div",la,[He((n(),B(K,{data:m.value,stripe:"",onSelectionChange:V},{default:s(()=>[t(ue,{type:"selection",width:"55"}),t(ue,{prop:"version",label:"版本号",width:"120",sortable:""}),t(ue,{prop:"status",label:"状态",width:"100"},{default:s(({row:le})=>[t(_e,{type:ye(le.status),size:"small"},{default:s(()=>[d(a(fe(le.status)),1)]),_:2},1032,["type"])]),_:1}),t(ue,{label:"适用设备",width:"200"},{default:s(({row:le})=>[e("div",aa,[(n(!0),p(ne,null,oe(le.deviceModel,ve=>(n(),B(_e,{key:ve,size:"small",style:{margin:"2px"}},{default:s(()=>[d(a(ge(ve)),1)]),_:2},1024))),128))])]),_:1}),t(ue,{prop:"description",label:"描述","min-width":"200"}),t(ue,{prop:"fileSize",label:"文件大小",width:"100"},{default:s(({row:le})=>[d(a(g(ze)(le.fileSize)),1)]),_:1}),t(ue,{prop:"downloadCount",label:"下载次数",width:"100",sortable:""}),t(ue,{prop:"releaseDate",label:"发布时间",width:"150",sortable:""},{default:s(({row:le})=>[d(a(F(le.releaseDate)),1)]),_:1}),t(ue,{label:"操作",width:"200",fixed:"right"},{default:s(({row:le})=>[t(te,{text:"",type:"primary",size:"small",onClick:ve=>P(le)},{default:s(()=>Z[3]||(Z[3]=[d(" 查看详情 ",-1)])),_:2,__:[3]},1032,["onClick"]),t(te,{text:"",type:"success",size:"small",onClick:ve=>se(le)},{default:s(()=>Z[4]||(Z[4]=[d(" 下载 ",-1)])),_:2,__:[4]},1032,["onClick"]),t(r,{onCommand:ve=>O(ve,le),trigger:"click"},{dropdown:s(()=>[t(c,null,{default:s(()=>[t(z,{command:"compare"},{default:s(()=>Z[6]||(Z[6]=[d(" 版本比较 ",-1)])),_:1,__:[6]}),le.status==="stable"?(n(),B(z,{key:0,command:"update"},{default:s(()=>Z[7]||(Z[7]=[d(" 推送更新 ",-1)])),_:1,__:[7]})):Y("",!0),t(z,{command:"edit"},{default:s(()=>Z[8]||(Z[8]=[d(" 编辑信息 ",-1)])),_:1,__:[8]}),t(z,{command:"delete",divided:""},{default:s(()=>Z[9]||(Z[9]=[d(" 删除版本 ",-1)])),_:1,__:[9]})]),_:2},1024)]),default:s(()=>[t(te,{text:"",type:"primary",size:"small"},{default:s(()=>[Z[5]||(Z[5]=d(" 更多",-1)),t(j,{class:"el-icon--right"},{default:s(()=>[t(g(ft))]),_:1})]),_:1,__:[5]})]),_:2},1032,["onCommand"])]),_:1})]),_:1},8,["data"])),[[ee,l.value]]),e("div",na,[t(q,{"current-page":o.value,"onUpdate:currentPage":Z[0]||(Z[0]=le=>o.value=le),"page-size":_.value,"onUpdate:pageSize":Z[1]||(Z[1]=le=>_.value=le),"page-sizes":[10,20,50,100],total:b.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:h,onCurrentChange:v},null,8,["current-page","page-size","total"])])]),t(ta,{modelValue:X.value,"onUpdate:modelValue":Z[2]||(Z[2]=le=>X.value=le),"version-id":J.value,onVersionDeleted:k},null,8,["modelValue","version-id"])])}}}),ia=Oe(oa,[["__scopeId","data-v-d034ec64"]]),Ze=class Ze{constructor(){xe(this,"activeUpdates",new Map);xe(this,"progressCallbacks",new Map);xe(this,"resultCallbacks",new Map);xe(this,"retryQueue",[]);xe(this,"maxRetries",3);xe(this,"retryDelay",5e3);this.startProgressSimulation()}static getInstance(){return Ze.instance||(Ze.instance=new Ze),Ze.instance}sendUpdateCommand(l){return G(this,null,function*(){try{const o=this.validateUpdateCommand(l);if(!o.valid)return{deviceId:l.deviceId,taskId:l.taskId,status:"rejected",message:o.reason};if(yield this.delay(Math.random()*1e3+500),Math.random()>.1)return this.activeUpdates.set(l.deviceId,l),this.simulateUpdateProgress(l),{deviceId:l.deviceId,taskId:l.taskId,status:"acknowledged",message:"设备已接收更新指令"};{const b=["NETWORK_ERROR","DEVICE_BUSY","INSUFFICIENT_STORAGE","INVALID_VERSION"],m=b[Math.floor(Math.random()*b.length)];return{deviceId:l.deviceId,taskId:l.taskId,status:"error",errorCode:m,message:this.getErrorMessage(m)}}}catch(o){return{deviceId:l.deviceId,taskId:l.taskId,status:"error",message:"发送更新指令失败"}}})}sendBatchUpdateCommands(l){return G(this,null,function*(){const o=[];for(let b=0;b<l.length;b+=5){const u=l.slice(b,b+5).map(v=>this.sendUpdateCommand(v)),h=yield Promise.all(u);o.push(...h),b+5<l.length&&(yield this.delay(1e3))}return o})}cancelDeviceUpdate(l,o){return G(this,null,function*(){try{this.activeUpdates.delete(l),yield this.delay(500);const _={deviceId:l,taskId:o,status:"failed",progress:0,currentStep:"更新已取消",errorMessage:"用户取消更新",timestamp:new Date().toISOString()};return this.notifyProgress(_),!0}catch(_){return console.error("取消设备更新失败:",_),!1}})}retryDeviceUpdate(l){return G(this,null,function*(){const o=Re(De({},l),{retryCount:l.retryCount+1});return o.retryCount>this.maxRetries?{deviceId:l.deviceId,taskId:l.taskId,status:"rejected",message:`已达到最大重试次数 (${this.maxRetries})`}:(yield this.delay(this.retryDelay),this.sendUpdateCommand(o))})}onProgress(l,o){this.progressCallbacks.set(l,o)}onResult(l,o){this.resultCallbacks.set(l,o)}removeCallbacks(l){this.progressCallbacks.delete(l),this.resultCallbacks.delete(l)}getDeviceUpdateStatus(l){return this.activeUpdates.get(l)||null}getActiveUpdates(){return Array.from(this.activeUpdates.values())}validateUpdateCommand(l){return l.deviceId?l.taskId?l.targetVersion?l.firmwareUrl?l.checksum?l.timeout<=0?{valid:!1,reason:"超时时间必须大于0"}:{valid:!0}:{valid:!1,reason:"固件校验和不能为空"}:{valid:!1,reason:"固件下载地址不能为空"}:{valid:!1,reason:"目标版本不能为空"}:{valid:!1,reason:"任务ID不能为空"}:{valid:!1,reason:"设备ID不能为空"}}simulateUpdateProgress(l){const o=[{status:"pending",step:"准备更新",duration:2e3},{status:"downloading",step:"下载固件",duration:15e3},{status:"installing",step:"安装固件",duration:1e4},{status:"rebooting",step:"重启设备",duration:5e3},{status:"completed",step:"更新完成",duration:1e3}];let _=0,b=0;const m=()=>{if(_>=o.length){const V={deviceId:l.deviceId,taskId:l.taskId,success:!0,fromVersion:"2.0.5",toVersion:l.targetVersion,duration:32,timestamp:new Date().toISOString()};this.notifyResult(V),this.activeUpdates.delete(l.deviceId);return}const u=o[_],h=Math.min(100,b+Math.random()*20);if(Math.random()<.05&&_>0){const V={deviceId:l.deviceId,taskId:l.taskId,status:"failed",progress:h,currentStep:u.step,errorMessage:"更新过程中发生错误",timestamp:new Date().toISOString()};this.notifyProgress(V);const y={deviceId:l.deviceId,taskId:l.taskId,success:!1,fromVersion:"2.0.5",toVersion:l.targetVersion,duration:Math.floor((Date.now()-Date.now())/1e3),errorMessage:"更新过程中发生错误",timestamp:new Date().toISOString()};this.notifyResult(y),this.activeUpdates.delete(l.deviceId);return}const v={deviceId:l.deviceId,taskId:l.taskId,status:u.status,progress:h,currentStep:u.step,timestamp:new Date().toISOString()};this.notifyProgress(v),h>=100||Math.random()>.3?(_++,b=0):b=h,setTimeout(m,Math.random()*2e3+1e3)};setTimeout(m,1e3)}notifyProgress(l){const o=this.progressCallbacks.get(l.taskId);o&&o(l)}notifyResult(l){const o=this.resultCallbacks.get(l.taskId);o&&o(l)}startProgressSimulation(){}getErrorMessage(l){return{NETWORK_ERROR:"网络连接错误",DEVICE_BUSY:"设备忙碌，请稍后重试",INSUFFICIENT_STORAGE:"设备存储空间不足",INVALID_VERSION:"固件版本不兼容",CHECKSUM_MISMATCH:"固件校验失败",TIMEOUT:"操作超时",PERMISSION_DENIED:"权限不足",DEVICE_OFFLINE:"设备离线"}[l]||"未知错误"}delay(l){return new Promise(o=>setTimeout(o,l))}};xe(Ze,"instance");let ot=Ze;class ra{constructor(){xe(this,"updateService");xe(this,"activeTasks",new Map);this.updateService=ot.getInstance()}executeUpdateTask(l,o,_){return G(this,null,function*(){try{this.activeTasks.set(l.id,l),o&&this.updateService.onProgress(l.id,h=>{o(l.id,h.deviceId,h)});const b=[];this.updateService.onResult(l.id,h=>{b.push(h),b.length===l.deviceIds.length&&_&&(_(l.id,b),this.cleanup(l.id))});const m=l.deviceIds.map(h=>({taskId:l.id,deviceId:h,targetVersion:l.targetVersion,firmwareUrl:`/firmware/${l.targetVersion}/firmware.bin`,checksum:"sha256:mock-checksum",priority:"normal",retryCount:0,timeout:3e5}));(yield this.updateService.sendBatchUpdateCommands(m)).forEach(h=>{if(h.status!=="acknowledged"){const v={deviceId:h.deviceId,taskId:h.taskId,success:!1,fromVersion:"unknown",toVersion:l.targetVersion,duration:0,errorMessage:h.message,timestamp:new Date().toISOString()};b.push(v)}})}catch(b){throw console.error("执行更新任务失败:",b),this.cleanup(l.id),b}})}cancelUpdateTask(l){return G(this,null,function*(){const o=this.activeTasks.get(l);if(!o)return!1;try{const _=o.deviceIds.map(u=>this.updateService.cancelDeviceUpdate(u,l)),m=(yield Promise.all(_)).every(u=>u);return m&&this.cleanup(l),m}catch(_){return console.error("取消更新任务失败:",_),!1}})}retryFailedDevices(l,o){return G(this,null,function*(){const _=this.activeTasks.get(l);if(!_)throw new Error("任务不存在");const b=o.map(m=>({taskId:l,deviceId:m,targetVersion:_.targetVersion,firmwareUrl:`/firmware/${_.targetVersion}/firmware.bin`,checksum:"sha256:mock-checksum",priority:"high",retryCount:1,timeout:3e5}));yield this.updateService.sendBatchUpdateCommands(b)})}getTaskStatus(l){return this.activeTasks.get(l)||null}cleanup(l){this.activeTasks.delete(l),this.updateService.removeCallbacks(l)}}const da=ot.getInstance();new ra;const ua={class:"version-difference"},ca={key:0,class:"difference-content"},va={class:"version-comparison"},pa={class:"version-item current"},_a={class:"version-header"},ma={class:"version-status"},fa={class:"version-arrow"},ga={class:"version-item latest"},ha={class:"version-header"},ya={class:"version-status"},ba={key:0,class:"benefits-section"},wa={class:"section-header"},$a={class:"benefits-list"},ka={class:"benefit-text"},Sa={class:"changelog-section"},Va={class:"section-header"},Ca={class:"changelog-list"},Ta={class:"changelog-text"},Da={key:1,class:"risks-section"},Ia={class:"section-header"},Ma={class:"risks-list"},Ua={class:"recommendation-section"},xa={class:"section-header"},za={class:"recommendation-content"},Na={class:"recommendation-card"},Pa={class:"card-icon"},Oa={class:"time-estimation"},Aa={class:"estimation-item"},Ea={class:"estimation-value"},Fa={class:"estimation-item"},Ra={class:"estimation-value"},Ba={key:1,class:"no-data"},Ya={class:"dialog-footer"},Xa=Pe({__name:"FirmwareVersionDifference",props:{modelValue:{type:Boolean},deviceId:{}},emits:["update:modelValue","update-device"],setup(re,{emit:l}){const o=re,_=l,b=ae({get:()=>o.modelValue,set:J=>_("update:modelValue",J)}),m=I(!1),u=I(null),h=ae(()=>u.value?u.value.latestVersion.localeCompare(u.value.currentVersion)>0?u.value.latestVersion.split(".")[0]!==u.value.currentVersion.split(".")[0]?"8-12 分钟":u.value.latestVersion.split(".")[1]!==u.value.currentVersion.split(".")[1]?"5-8 分钟":"2-5 分钟":"3-6 分钟":"未知"),v=ae(()=>u.value?u.value.latestVersion.localeCompare(u.value.currentVersion)>0?u.value.latestVersion.split(".")[0]!==u.value.currentVersion.split(".")[0]?"45-60 MB":u.value.latestVersion.split(".")[1]!==u.value.currentVersion.split(".")[1]?"25-40 MB":"8-15 MB":"20-35 MB":"未知"),V=()=>G(null,null,function*(){if(o.deviceId){m.value=!0;try{const J=yield da.getVersionDifference(o.deviceId);u.value=J,J||x.info("该设备已是最新版本")}catch(J){console.error("加载版本差异失败:",J),x.error("加载版本差异失败")}finally{m.value=!1}}}),y=()=>{o.deviceId&&(_("update-device",o.deviceId),x.success("已开始更新设备"))},X=()=>{_("update:modelValue",!1),u.value=null};return Xe(()=>o.deviceId,J=>{J&&b.value&&V()}),Xe(b,J=>{J&&o.deviceId&&V()}),(J,P)=>{const se=f("el-tag"),O=f("el-icon"),ye=f("el-alert"),fe=f("el-empty"),ge=f("el-button"),F=f("el-dialog"),k=qe("loading");return n(),B(F,{modelValue:b.value,"onUpdate:modelValue":P[0]||(P[0]=R=>b.value=R),title:"版本差异对比",width:"800px","close-on-click-modal":!1,onClose:X},{footer:s(()=>[e("div",Ya,[t(ge,{onClick:X},{default:s(()=>P[13]||(P[13]=[d("取消",-1)])),_:1,__:[13]}),t(ge,{type:"primary",onClick:y,disabled:!u.value},{default:s(()=>[t(O,null,{default:s(()=>[t(g(it))]),_:1}),P[14]||(P[14]=d(" 确认更新 ",-1))]),_:1,__:[14]},8,["disabled"])])]),default:s(()=>[He((n(),p("div",ua,[u.value?(n(),p("div",ca,[e("div",va,[e("div",pa,[e("div",_a,[P[1]||(P[1]=e("h3",null,"当前版本",-1)),t(se,{type:"info",size:"large"},{default:s(()=>[d(a(u.value.currentVersion),1)]),_:1})]),e("div",ma,[t(O,null,{default:s(()=>[t(g(Je))]),_:1}),P[2]||(P[2]=e("span",null,"正在使用",-1))])]),e("div",fa,[t(O,null,{default:s(()=>[t(g(Zt))]),_:1})]),e("div",ga,[e("div",ha,[P[3]||(P[3]=e("h3",null,"最新版本",-1)),t(se,{type:"success",size:"large"},{default:s(()=>[d(a(u.value.latestVersion),1)]),_:1})]),e("div",ya,[t(O,null,{default:s(()=>[t(g($t))]),_:1}),P[4]||(P[4]=e("span",null,"推荐更新",-1))])])]),u.value.benefits.length>0?(n(),p("div",ba,[e("div",wa,[e("h3",null,[t(O,null,{default:s(()=>[t(g(Ce))]),_:1}),P[5]||(P[5]=d(" 更新收益 ",-1))])]),e("div",$a,[(n(!0),p(ne,null,oe(u.value.benefits,(R,Z)=>(n(),p("div",{key:Z,class:"benefit-item"},[t(O,{class:"benefit-icon"},{default:s(()=>[t(g(Ce))]),_:1}),e("span",ka,a(R),1)]))),128))])])):Y("",!0),e("div",Sa,[e("div",Va,[e("h3",null,[t(O,null,{default:s(()=>[t(g(jt))]),_:1}),P[6]||(P[6]=d(" 更新日志 ",-1))])]),e("div",Ca,[(n(!0),p(ne,null,oe(u.value.changelog,(R,Z)=>(n(),p("div",{key:Z,class:"changelog-item"},[t(O,{class:"changelog-icon"},{default:s(()=>[t(g(Le))]),_:1}),e("span",Ta,a(R),1)]))),128))])]),u.value.risks.length>0?(n(),p("div",Da,[e("div",Ia,[e("h3",null,[t(O,null,{default:s(()=>[t(g(nt))]),_:1}),P[7]||(P[7]=d(" 注意事项 ",-1))])]),e("div",Ma,[(n(!0),p(ne,null,oe(u.value.risks,(R,Z)=>(n(),B(ye,{key:Z,title:R,type:"warning","show-icon":"",closable:!1,class:"risk-alert"},null,8,["title"]))),128))])])):Y("",!0),e("div",Ua,[e("div",xa,[e("h3",null,[t(O,null,{default:s(()=>[t(g($t))]),_:1}),P[8]||(P[8]=d(" 更新建议 ",-1))])]),e("div",za,[e("div",Na,[e("div",Pa,[t(O,null,{default:s(()=>[t(g(Kt))]),_:1})]),P[9]||(P[9]=e("div",{class:"card-content"},[e("div",{class:"card-title"},"推荐立即更新"),e("div",{class:"card-description"}," 新版本包含重要的性能优化和安全修复，建议尽快更新以获得最佳体验。 ")],-1))]),P[10]||(P[10]=e("div",{class:"recommendation-tips"},[e("h4",null,"更新前准备："),e("ul",{class:"tips-list"},[e("li",null,"确保设备电量充足（建议 > 50%）"),e("li",null,"确保网络连接稳定"),e("li",null,"更新过程中请勿断开设备连接"),e("li",null,"更新完成后设备将自动重启")])],-1))])]),e("div",Oa,[e("div",Aa,[t(O,null,{default:s(()=>[t(g(Vt))]),_:1}),P[11]||(P[11]=e("span",{class:"estimation-label"},"预计更新时间：",-1)),e("span",Ea,a(h.value),1)]),e("div",Fa,[t(O,null,{default:s(()=>[t(g(We))]),_:1}),P[12]||(P[12]=e("span",{class:"estimation-label"},"下载大小：",-1)),e("span",Ra,a(v.value),1)])])])):(n(),p("div",Ba,[t(fe,{description:"暂无版本差异数据"})]))])),[[k,m.value]])]),_:1},8,["modelValue"])}}}),La=Oe(Xa,[["__scopeId","data-v-219e2221"]]),Ha={class:"firmware-update-notification"},Za={class:"alert-content"},ja={class:"alert-text"},Ka={class:"alert-title"},qa={class:"alert-description"},Wa={class:"alert-actions"},Ga={class:"update-details"},Qa={class:"update-overview"},Ja={class:"overview-stats"},en={class:"stat-item"},tn={class:"stat-value"},sn={class:"stat-item highlight"},ln={class:"stat-value"},an={class:"stat-item critical"},nn={class:"stat-value"},on={class:"overview-actions"},rn={class:"recommendations-section"},dn={class:"section-header"},un={class:"header-filters"},cn={class:"recommendations-list"},vn={class:"recommendation-header"},pn={class:"device-info"},_n={class:"device-name"},mn={class:"version-info"},fn={class:"recommendation-content"},gn={class:"recommendation-reason"},hn={class:"recommendation-details"},yn={key:0,class:"detail-section"},bn={class:"detail-title"},wn={class:"detail-list"},$n={key:1,class:"detail-section"},kn={class:"detail-title"},Sn={class:"detail-list"},Vn={class:"detail-section"},Cn={class:"detail-title"},Tn={class:"recommendation-actions"},Dn={key:0,class:"no-recommendations"},In={class:"dialog-footer"},Mn=Pe({__name:"FirmwareUpdateNotification",setup(re){const l=I(!1),o=I(!1),_=I(!1),b=I(""),m=I([]),u=I(""),h=I(null),v=ae(()=>h.value&&h.value.devicesNeedingUpdate>0),V=ae(()=>h.value?h.value.criticalUpdates>0?"error":h.value.devicesNeedingUpdate>5?"warning":"info":"info"),y=ae(()=>{if(!h.value)return"检查更新中...";const{devicesNeedingUpdate:j,criticalUpdates:z}=h.value;return z>0?`发现 ${z} 个紧急更新`:`发现 ${j} 个可用更新`}),X=ae(()=>{if(!h.value)return"正在检查设备固件更新...";const{devicesNeedingUpdate:j,criticalUpdates:z}=h.value;return z>0?`${z} 个设备需要紧急更新，${j-z} 个设备有常规更新可用`:`${j} 个设备有新的固件版本可用，建议及时更新以获得最佳性能`}),J=ae(()=>{if(!h.value)return[];let j=h.value.recommendations;return b.value&&(j=j.filter(z=>z.priority===b.value)),j.sort((z,c)=>{const r={high:3,medium:2,low:1};return r[c.priority]-r[z.priority]})}),P=()=>G(null,null,function*(){try{h.value={totalDevices:25,devicesNeedingUpdate:8,criticalUpdates:2,recommendations:[{deviceId:"device-001",currentVersion:"1.2.0",recommendedVersion:"1.3.0",reason:"安全补丁和性能优化",priority:"high",benefits:["安全修复","性能提升"],risks:[],compatibility:!0}],lastCheckTime:new Date().toISOString(),nextCheckTime:new Date(Date.now()+3e4).toISOString()}}catch(j){console.error("加载更新状态失败:",j)}}),se=()=>{l.value=!0},O=()=>G(null,null,function*(){_.value=!0;try{yield new Promise(j=>setTimeout(j,1e3)),yield P(),x.success("更新检查完成")}catch(j){console.error("更新检查失败:",j),x.error("更新检查失败")}finally{_.value=!1}}),ye=()=>{},fe=j=>{const z=m.value.indexOf(j);z>-1?m.value.splice(z,1):m.value.push(j)},ge=()=>{m.value.length===J.value.length?m.value=[]:m.value=J.value.map(j=>j.deviceId)},F=j=>{u.value=j,o.value=!0},k=j=>{x.info(`开始更新设备: ${j}`)},R=()=>{if(!h.value)return;const j=h.value.recommendations.filter(z=>z.priority==="high").map(z=>z.deviceId);j.length>0?(m.value=j,Z()):se()},Z=()=>{if(m.value.length===0){x.warning("请选择要更新的设备");return}x.info(`开始批量更新 ${m.value.length} 个设备`),l.value=!1},ue=j=>{k(j),o.value=!1},_e=j=>({high:"danger",medium:"warning",low:"info"})[j]||"info",te=j=>({high:"高优先级",medium:"中优先级",low:"低优先级"})[j]||j;return Ke(()=>{P();const j=setInterval(()=>{P()},3e4);Tt(()=>{clearInterval(j)})}),(j,z)=>{const c=f("el-button"),r=f("el-alert"),K=f("el-icon"),q=f("el-option"),ee=f("el-select"),le=f("el-checkbox"),ve=f("el-tag"),A=f("el-empty"),W=f("el-dialog"),ce=qe("loading");return n(),p("div",Ha,[v.value?(n(),B(r,{key:0,title:y.value,type:V.value,description:X.value,"show-icon":"",closable:!1,class:"update-alert"},{default:s(()=>[e("div",Za,[e("div",ja,[e("div",Ka,a(y.value),1),e("div",qa,a(X.value),1)]),e("div",Wa,[t(c,{size:"small",onClick:se},{default:s(()=>z[4]||(z[4]=[d(" 查看详情 ",-1)])),_:1,__:[4]}),t(c,{type:"primary",size:"small",onClick:R},{default:s(()=>z[5]||(z[5]=[d(" 立即更新 ",-1)])),_:1,__:[5]})])])]),_:1},8,["title","type","description"])):Y("",!0),t(W,{modelValue:l.value,"onUpdate:modelValue":z[2]||(z[2]=N=>l.value=N),title:"固件更新详情",width:"900px","close-on-click-modal":!1},{footer:s(()=>[e("div",In,[t(c,{onClick:z[1]||(z[1]=N=>l.value=!1)},{default:s(()=>z[17]||(z[17]=[d("关闭",-1)])),_:1,__:[17]}),t(c,{type:"primary",onClick:Z,disabled:m.value.length===0},{default:s(()=>[d(" 更新选中设备 ("+a(m.value.length)+") ",1)]),_:1},8,["disabled"])])]),default:s(()=>{var N,pe,Se;return[He((n(),p("div",Ga,[e("div",Qa,[e("div",Ja,[e("div",en,[e("div",tn,a(((N=h.value)==null?void 0:N.totalDevices)||0),1),z[6]||(z[6]=e("div",{class:"stat-label"},"总设备数",-1))]),e("div",sn,[e("div",ln,a(((pe=h.value)==null?void 0:pe.devicesNeedingUpdate)||0),1),z[7]||(z[7]=e("div",{class:"stat-label"},"需要更新",-1))]),e("div",an,[e("div",nn,a(((Se=h.value)==null?void 0:Se.criticalUpdates)||0),1),z[8]||(z[8]=e("div",{class:"stat-label"},"紧急更新",-1))])]),e("div",on,[t(c,{onClick:O,loading:_.value},{default:s(()=>[t(K,null,{default:s(()=>[t(g(et))]),_:1}),z[9]||(z[9]=d(" 重新检查 ",-1))]),_:1,__:[9]},8,["loading"]),t(c,{type:"primary",onClick:ge},{default:s(()=>[t(K,null,{default:s(()=>[t(g(Ct))]),_:1}),z[10]||(z[10]=d(" 全选更新 ",-1))]),_:1,__:[10]})])]),e("div",rn,[e("div",dn,[z[11]||(z[11]=e("h3",null,"更新推荐",-1)),e("div",un,[t(ee,{modelValue:b.value,"onUpdate:modelValue":z[0]||(z[0]=de=>b.value=de),placeholder:"优先级",size:"small",onChange:ye},{default:s(()=>[t(q,{label:"全部",value:""}),t(q,{label:"高优先级",value:"high"}),t(q,{label:"中优先级",value:"medium"}),t(q,{label:"低优先级",value:"low"})]),_:1},8,["modelValue"])])]),e("div",cn,[(n(!0),p(ne,null,oe(J.value,de=>(n(),p("div",{key:de.deviceId,class:Ne(["recommendation-item",{"high-priority":de.priority==="high","medium-priority":de.priority==="medium","low-priority":de.priority==="low",selected:m.value.includes(de.deviceId)}])},[e("div",vn,[t(le,{"model-value":m.value.includes(de.deviceId),onChange:T=>fe(de.deviceId)},null,8,["model-value","onChange"]),e("div",pn,[e("div",_n,"设备 "+a(de.deviceId),1),e("div",mn,a(de.currentVersion)+" → "+a(de.recommendedVersion),1)]),t(ve,{type:_e(de.priority),size:"small"},{default:s(()=>[d(a(te(de.priority)),1)]),_:2},1032,["type"])]),e("div",fn,[e("div",gn,[t(K,null,{default:s(()=>[t(g(at))]),_:1}),e("span",null,a(de.reason),1)]),e("div",hn,[de.benefits.length>0?(n(),p("div",yn,[e("div",bn,[t(K,null,{default:s(()=>[t(g(Ce))]),_:1}),z[12]||(z[12]=e("span",null,"更新收益",-1))]),e("div",wn,[(n(!0),p(ne,null,oe(de.benefits,T=>(n(),B(ve,{key:T,type:"success",size:"small",class:"detail-tag"},{default:s(()=>[d(a(T),1)]),_:2},1024))),128))])])):Y("",!0),de.risks.length>0?(n(),p("div",$n,[e("div",kn,[t(K,null,{default:s(()=>[t(g(nt))]),_:1}),z[13]||(z[13]=e("span",null,"潜在风险",-1))]),e("div",Sn,[(n(!0),p(ne,null,oe(de.risks,T=>(n(),B(ve,{key:T,type:"warning",size:"small",class:"detail-tag"},{default:s(()=>[d(a(T),1)]),_:2},1024))),128))])])):Y("",!0),e("div",Vn,[e("div",Cn,[t(K,null,{default:s(()=>[t(g(gt))]),_:1}),z[14]||(z[14]=e("span",null,"兼容性",-1))]),t(ve,{type:de.compatibility?"success":"danger",size:"small"},{default:s(()=>[d(a(de.compatibility?"完全兼容":"存在兼容性问题"),1)]),_:2},1032,["type"])])]),e("div",Tn,[t(c,{size:"small",onClick:T=>F(de.deviceId)},{default:s(()=>z[15]||(z[15]=[d(" 查看差异 ",-1)])),_:2,__:[15]},1032,["onClick"]),t(c,{type:"primary",size:"small",onClick:T=>k(de.deviceId),disabled:!de.compatibility},{default:s(()=>z[16]||(z[16]=[d(" 立即更新 ",-1)])),_:2,__:[16]},1032,["onClick","disabled"])])])],2))),128)),J.value.length===0?(n(),p("div",Dn,[t(A,{description:"暂无更新推荐"})])):Y("",!0)])])])),[[ce,_.value]])]}),_:1},8,["modelValue"]),t(La,{modelValue:o.value,"onUpdate:modelValue":z[3]||(z[3]=N=>o.value=N),"device-id":u.value,onUpdateDevice:ue},null,8,["modelValue","device-id"])])}}}),Un=Oe(Mn,[["__scopeId","data-v-db5596d4"]]),xn={class:"batch-update-dialog"},zn={key:0,class:"step-content"},Nn={class:"device-selection"},Pn={class:"selection-toolbar"},On={class:"toolbar-left"},An={class:"toolbar-right"},En={class:"selection-count"},Fn={class:"device-filters"},Rn={class:"device-list"},Bn=["onClick"],Yn={class:"device-checkbox"},Xn={class:"device-info"},Ln={class:"device-header"},Hn={class:"device-name"},Zn={class:"device-serial"},jn={class:"device-details"},Kn={class:"detail-item"},qn={class:"detail-value"},Wn={class:"detail-item"},Gn={class:"detail-value target-version"},Qn={class:"detail-item"},Jn={class:"detail-value"},eo={class:"device-status"},to={class:"status-item"},so={key:0,class:"status-item"},lo={key:0,class:"no-devices"},ao={class:"step-actions"},no={key:1,class:"step-content"},oo={class:"update-confirmation"},io={class:"confirmation-overview"},ro={class:"overview-header"},uo={class:"overview-stats"},co={class:"stat-card"},vo={class:"stat-icon"},po={class:"stat-info"},_o={class:"stat-value"},mo={class:"stat-card"},fo={class:"stat-icon"},go={class:"stat-info"},ho={class:"stat-value"},yo={class:"stat-card"},bo={class:"stat-icon"},wo={class:"stat-info"},$o={class:"stat-value"},ko={class:"risk-warnings"},So={class:"warning-list"},Vo={class:"update-options"},Co={class:"options-form"},To={class:"step-actions"},Do={key:2,class:"step-content"},Io={class:"update-progress"},Mo={class:"overall-progress"},Uo={class:"progress-header"},xo={class:"progress-stats"},zo={class:"progress-item"},No={class:"progress-text"},Po={class:"status-summary"},Oo={class:"summary-item success"},Ao={class:"summary-value"},Eo={class:"summary-item processing"},Fo={class:"summary-value"},Ro={class:"summary-item failed"},Bo={class:"summary-value"},Yo={class:"summary-item pending"},Xo={class:"summary-value"},Lo={class:"device-progress-list"},Ho={class:"progress-list-header"},Zo={class:"header-actions"},jo={class:"progress-list"},Ko={class:"device-progress-header"},qo={class:"device-info"},Wo={class:"device-name"},Go={class:"device-serial"},Qo={class:"progress-status"},Jo={class:"status-text"},ei={class:"device-progress-content"},ti={class:"progress-bar"},si={class:"progress-percentage"},li={class:"progress-step"},ai={key:0,class:"error-message"},ni={class:"step-actions"},oi={key:3,class:"step-content"},ii={class:"update-results"},ri={class:"results-overview"},di={class:"results-header"},ui={class:"results-stats"},ci={class:"result-stat success"},vi={class:"stat-value"},pi={class:"result-stat failed"},_i={class:"stat-value"},mi={class:"result-stat time"},fi={class:"stat-value"},gi={class:"detailed-results"},hi={class:"result-list"},yi={class:"result-info"},bi={class:"result-name"},wi={class:"result-details"},$i={class:"result-list"},ki={class:"result-info"},Si={class:"result-name"},Vi={class:"result-details"},Ci={class:"result-actions"},Ti={class:"step-actions"},Di=Pe({__name:"FirmwareBatchUpdateDialog",props:{modelValue:{type:Boolean},availableDevices:{default:()=>[]}},emits:["update:modelValue","update-complete"],setup(re,{emit:l}){const o=re,_=l,b=ae({get:()=>o.modelValue,set:w=>_("update:modelValue",w)}),m=I(0),u=I([]),h=I(""),v=I(""),V=I(""),y=I(!1),X=I("success"),J=I(!1),P=I({mode:"parallel",failureHandling:"continue",autoRetry:!0}),se=I(new Map),O=ae(()=>{let w=o.availableDevices;if(h.value){const i=h.value.toLowerCase();w=w.filter(we=>we.deviceName.toLowerCase().includes(i)||we.deviceSerialNumber.toLowerCase().includes(i))}return v.value&&(w=w.filter(i=>i.priority===v.value)),V.value&&(w=w.filter(i=>i.deviceModel===V.value)),w}),ye=ae(()=>o.availableDevices.some(w=>w.priority==="high")),fe=ae(()=>u.value.filter(w=>{const i=o.availableDevices.find(we=>we.deviceId===w);return(i==null?void 0:i.priority)==="high"}).length),ge=ae(()=>{const w=u.value.length;return w===0?"0分钟":P.value.mode==="parallel"?`${Math.ceil(w/5)*6}-${Math.ceil(w/5)*10}分钟`:`${w*5}-${w*8}分钟`}),F=ae(()=>u.value.filter(w=>{const i=o.availableDevices.find(we=>we.deviceId===w);return!(i!=null&&i.isOnline)}).length),k=ae(()=>u.value.filter(w=>{const i=o.availableDevices.find(we=>we.deviceId===w);return(i==null?void 0:i.signalStrength)&&i.signalStrength<50}).length),R=ae(()=>{if(u.value.length===0)return 0;const w=Array.from(se.value.values()).reduce((i,we)=>i+we.progress,0);return Math.round(w/u.value.length)}),Z=ae(()=>{if(te.value>0)return"exception";if(ue.value===u.value.length)return"success"}),ue=ae(()=>Array.from(se.value.values()).filter(w=>w.status==="completed"||w.status==="failed").length),_e=ae(()=>Array.from(se.value.values()).filter(w=>w.status==="completed").length),te=ae(()=>Array.from(se.value.values()).filter(w=>w.status==="failed").length),j=ae(()=>Array.from(se.value.values()).filter(w=>w.status==="updating").length),z=ae(()=>Array.from(se.value.values()).filter(w=>w.status==="pending").length),c=ae(()=>{const w=Array.from(se.value.values());return y.value?w:w.filter(i=>i.status==="updating"||i.status==="failed")}),r=ae(()=>te.value===0?"success":_e.value===0?"error":"warning"),K=ae(()=>te.value===0?"批量更新完成":_e.value===0?"批量更新失败":"批量更新部分完成"),q=ae(()=>te.value===0?`所有 ${_e.value} 个设备已成功更新到最新版本`:_e.value===0?`所有 ${te.value} 个设备更新失败，请检查设备状态后重试`:`${_e.value} 个设备更新成功，${te.value} 个设备更新失败`),ee=ae(()=>"15分钟"),le=ae(()=>Array.from(se.value.values()).filter(w=>w.status==="completed")),ve=ae(()=>Array.from(se.value.values()).filter(w=>w.status==="failed")),A=()=>{u.value=O.value.map(w=>w.deviceId)},W=()=>{u.value=[]},ce=w=>{u.value=o.availableDevices.filter(i=>i.priority===w).map(i=>i.deviceId)},N=()=>{},pe=w=>{const i=u.value.indexOf(w);i>-1?u.value.splice(i,1):u.value.push(w)},Se=()=>{m.value<3&&m.value++},de=()=>{m.value>0&&m.value--},T=()=>G(null,null,function*(){m.value=2,J.value=!0,u.value.forEach(w=>{const i=o.availableDevices.find(we=>we.deviceId===w);i&&se.value.set(w,{deviceId:w,deviceName:i.deviceName,deviceSerialNumber:i.deviceSerialNumber,currentVersion:i.currentVersion,targetVersion:i.targetVersion,status:"pending",progress:0,currentStep:"准备更新",startTime:new Date().toISOString()})});try{P.value.mode==="parallel"?yield S():yield M()}catch(w){console.error("批量更新失败:",w)}finally{J.value=!1,m.value=3}}),S=()=>G(null,null,function*(){const w=u.value.map(i=>U(i));yield Promise.allSettled(w)}),M=()=>G(null,null,function*(){for(const w of u.value){if(!J.value)break;yield U(w)}}),U=w=>G(null,null,function*(){const i=se.value.get(w);if(i)try{i.status="updating",i.currentStep="下载固件",se.value.set(w,De({},i));for(let Ve=0;Ve<=50;Ve+=10){if(!J.value)throw new Error("更新被取消");i.progress=Ve,se.value.set(w,De({},i)),yield new Promise(me=>setTimeout(me,200))}i.currentStep="安装固件",se.value.set(w,De({},i));for(let Ve=50;Ve<=90;Ve+=10){if(!J.value)throw new Error("更新被取消");i.progress=Ve,se.value.set(w,De({},i)),yield new Promise(me=>setTimeout(me,300))}if(i.currentStep="重启设备",se.value.set(w,De({},i)),yield new Promise(Ve=>setTimeout(Ve,1e3)),Math.random()<.1)throw new Error("设备更新失败：网络连接中断");i.status="completed",i.progress=100,i.currentStep="更新完成",i.endTime=new Date().toISOString(),i.duration="5分钟",se.value.set(w,De({},i))}catch(we){i.status="failed",i.errorMessage=we.message,i.endTime=new Date().toISOString(),se.value.set(w,De({},i))}}),D=()=>{J.value=!1,x.info("更新已暂停")},E=()=>G(null,null,function*(){try{yield Ue.confirm("确定要取消批量更新吗？正在进行的更新将被中断。","确认取消",{confirmButtonText:"确定取消",cancelButtonText:"继续更新",type:"warning"}),J.value=!1,m.value=3,x.info("批量更新已取消")}catch(w){}}),C=()=>{y.value=!y.value},ie=w=>{x.info(`重试设备更新: ${w}`)},Q=w=>{x.info(`查看设备日志: ${w}`)},be=()=>{x.info("重试失败设备功能开发中")},Te=()=>{x.success("更新结果导出功能开发中")},he=()=>{if(J.value){x.warning("更新进行中，无法关闭对话框");return}m.value=0,u.value=[],se.value.clear(),_("update:modelValue",!1)},Ee=w=>({high:"danger",medium:"warning",low:"info"})[w]||"info",Fe=w=>({high:"高优先级",medium:"中优先级",low:"低优先级"})[w]||w,Ae=w=>({"YX-EDU-2024":"教育版","YX-HOME-2024":"家庭版","YX-PRO-2024":"专业版"})[w]||w,Ie=w=>({pending:"等待中",updating:"更新中",completed:"已完成",failed:"失败"})[w]||w,L=w=>{if(w==="completed")return"success";if(w==="failed")return"exception"};return Xe(b,w=>{w||he()}),(w,i)=>{const we=f("el-step"),Ve=f("el-steps"),me=f("el-icon"),$=f("el-button"),$e=f("el-input"),ke=f("el-option"),tt=f("el-select"),Ut=f("el-checkbox"),xt=f("el-tag"),zt=f("el-empty"),st=f("el-alert"),lt=f("el-radio"),ht=f("el-radio-group"),ut=f("el-form-item"),Nt=f("el-switch"),Pt=f("el-form"),yt=f("el-progress"),bt=f("el-tab-pane"),Ot=f("el-tabs"),At=f("el-dialog");return n(),B(At,{modelValue:b.value,"onUpdate:modelValue":i[8]||(i[8]=H=>b.value=H),title:"批量固件更新",width:"1000px","close-on-click-modal":!1,"close-on-press-escape":!1,onClose:he},{default:s(()=>[e("div",xn,[t(Ve,{active:m.value,"align-center":"",class:"update-steps"},{default:s(()=>[t(we,{title:"选择设备",icon:"Select"}),t(we,{title:"确认更新",icon:"Warning"}),t(we,{title:"执行更新",icon:"Loading"}),t(we,{title:"更新完成",icon:"SuccessFilled"})]),_:1},8,["active"]),m.value===0?(n(),p("div",zn,[e("div",Nn,[e("div",Pn,[e("div",On,[t($,{onClick:A,disabled:w.availableDevices.length===0},{default:s(()=>[t(me,null,{default:s(()=>[t(g(Ct))]),_:1}),d(" 全选 ("+a(w.availableDevices.length)+") ",1)]),_:1},8,["disabled"]),t($,{onClick:W,disabled:u.value.length===0},{default:s(()=>[t(me,null,{default:s(()=>[t(g(kt))]),_:1}),i[9]||(i[9]=d(" 清空选择 ",-1))]),_:1,__:[9]},8,["disabled"]),t($,{onClick:i[0]||(i[0]=H=>ce("high")),disabled:!ye.value},{default:s(()=>[t(me,null,{default:s(()=>[t(g(je))]),_:1}),i[10]||(i[10]=d(" 选择高优先级 ",-1))]),_:1,__:[10]},8,["disabled"])]),e("div",An,[e("span",En,"已选择 "+a(u.value.length)+" / "+a(w.availableDevices.length)+" 个设备",1)])]),e("div",Fn,[t($e,{modelValue:h.value,"onUpdate:modelValue":i[1]||(i[1]=H=>h.value=H),placeholder:"搜索设备序列号或名称","prefix-icon":g(rt),clearable:"",onInput:N,style:{width:"300px"}},null,8,["modelValue","prefix-icon"]),t(tt,{modelValue:v.value,"onUpdate:modelValue":i[2]||(i[2]=H=>v.value=H),placeholder:"优先级",clearable:"",onChange:N},{default:s(()=>[t(ke,{label:"全部优先级",value:""}),t(ke,{label:"高优先级",value:"high"}),t(ke,{label:"中优先级",value:"medium"}),t(ke,{label:"低优先级",value:"low"})]),_:1},8,["modelValue"]),t(tt,{modelValue:V.value,"onUpdate:modelValue":i[3]||(i[3]=H=>V.value=H),placeholder:"设备型号",clearable:"",onChange:N},{default:s(()=>[t(ke,{label:"全部型号",value:""}),t(ke,{label:"教育版",value:"YX-EDU-2024"}),t(ke,{label:"家庭版",value:"YX-HOME-2024"}),t(ke,{label:"专业版",value:"YX-PRO-2024"})]),_:1},8,["modelValue"])]),e("div",Rn,[(n(!0),p(ne,null,oe(O.value,H=>(n(),p("div",{key:H.deviceId,class:Ne(["device-item",{selected:u.value.includes(H.deviceId),"high-priority":H.priority==="high","medium-priority":H.priority==="medium","low-priority":H.priority==="low"}]),onClick:ct=>pe(H.deviceId)},[e("div",Yn,[t(Ut,{"model-value":u.value.includes(H.deviceId),onChange:ct=>pe(H.deviceId)},null,8,["model-value","onChange"])]),e("div",Xn,[e("div",Ln,[e("div",Hn,a(H.deviceName),1),e("div",Zn,a(H.deviceSerialNumber),1),t(xt,{type:Ee(H.priority),size:"small"},{default:s(()=>[d(a(Fe(H.priority)),1)]),_:2},1032,["type"])]),e("div",jn,[e("div",Kn,[i[11]||(i[11]=e("span",{class:"detail-label"},"当前版本:",-1)),e("span",qn,a(H.currentVersion),1)]),e("div",Wn,[i[12]||(i[12]=e("span",{class:"detail-label"},"目标版本:",-1)),e("span",Gn,a(H.targetVersion),1)]),e("div",Qn,[i[13]||(i[13]=e("span",{class:"detail-label"},"设备型号:",-1)),e("span",Jn,a(Ae(H.deviceModel)),1)])]),e("div",eo,[e("div",to,[t(me,{class:Ne(H.isOnline?"status-online":"status-offline")},{default:s(()=>[H.isOnline?(n(),B(g(Ce),{key:0})):(n(),B(g(Ye),{key:1}))]),_:2},1032,["class"]),e("span",null,a(H.isOnline?"在线":"离线"),1)]),H.signalStrength?(n(),p("div",so,[t(me,null,{default:s(()=>[t(g(Wt))]),_:1}),e("span",null,"信号 "+a(H.signalStrength)+"%",1)])):Y("",!0)])])],10,Bn))),128)),O.value.length===0?(n(),p("div",lo,[t(zt,{description:"没有找到符合条件的设备"})])):Y("",!0)])]),e("div",ao,[t($,{onClick:he},{default:s(()=>i[14]||(i[14]=[d("取消",-1)])),_:1,__:[14]}),t($,{type:"primary",onClick:Se,disabled:u.value.length===0},{default:s(()=>[d(" 下一步 ("+a(u.value.length)+") ",1)]),_:1},8,["disabled"])])])):Y("",!0),m.value===1?(n(),p("div",no,[e("div",oo,[e("div",io,[e("div",ro,[i[15]||(i[15]=e("h3",null,"更新确认",-1)),e("p",null,"即将为以下 "+a(u.value.length)+" 个设备执行固件更新",1)]),e("div",uo,[e("div",co,[e("div",vo,[t(me,null,{default:s(()=>[t(g(gt))]),_:1})]),e("div",po,[e("div",_o,a(u.value.length),1),i[16]||(i[16]=e("div",{class:"stat-label"},"选中设备",-1))])]),e("div",mo,[e("div",fo,[t(me,null,{default:s(()=>[t(g(je))]),_:1})]),e("div",go,[e("div",ho,a(fe.value),1),i[17]||(i[17]=e("div",{class:"stat-label"},"高优先级",-1))])]),e("div",yo,[e("div",bo,[t(me,null,{default:s(()=>[t(g(Vt))]),_:1})]),e("div",wo,[e("div",$o,a(ge.value),1),i[18]||(i[18]=e("div",{class:"stat-label"},"预计时间",-1))])])])]),e("div",ko,[i[19]||(i[19]=e("h4",null,"重要提示",-1)),e("div",So,[t(st,{title:"更新过程中请勿断开设备连接",type:"warning","show-icon":"",closable:!1}),t(st,{title:"确保设备电量充足（建议 > 50%）",type:"warning","show-icon":"",closable:!1}),F.value>0?(n(),B(st,{key:0,title:`${F.value} 个设备当前离线，可能无法更新`,type:"error","show-icon":"",closable:!1},null,8,["title"])):Y("",!0),k.value>0?(n(),B(st,{key:1,title:`${k.value} 个设备信号较弱，更新可能中断`,type:"warning","show-icon":"",closable:!1},null,8,["title"])):Y("",!0)])]),e("div",Vo,[i[25]||(i[25]=e("h4",null,"更新选项",-1)),e("div",Co,[t(Pt,{model:P.value,"label-width":"120px"},{default:s(()=>[t(ut,{label:"更新模式"},{default:s(()=>[t(ht,{modelValue:P.value.mode,"onUpdate:modelValue":i[4]||(i[4]=H=>P.value.mode=H)},{default:s(()=>[t(lt,{label:"parallel"},{default:s(()=>i[20]||(i[20]=[d("并行更新（快速）",-1)])),_:1,__:[20]}),t(lt,{label:"sequential"},{default:s(()=>i[21]||(i[21]=[d("顺序更新（稳定）",-1)])),_:1,__:[21]})]),_:1},8,["modelValue"])]),_:1}),t(ut,{label:"失败处理"},{default:s(()=>[t(ht,{modelValue:P.value.failureHandling,"onUpdate:modelValue":i[5]||(i[5]=H=>P.value.failureHandling=H)},{default:s(()=>[t(lt,{label:"continue"},{default:s(()=>i[22]||(i[22]=[d("继续更新其他设备",-1)])),_:1,__:[22]}),t(lt,{label:"stop"},{default:s(()=>i[23]||(i[23]=[d("停止所有更新",-1)])),_:1,__:[23]})]),_:1},8,["modelValue"])]),_:1}),t(ut,{label:"自动重试"},{default:s(()=>[t(Nt,{modelValue:P.value.autoRetry,"onUpdate:modelValue":i[6]||(i[6]=H=>P.value.autoRetry=H)},null,8,["modelValue"]),i[24]||(i[24]=e("span",{class:"option-description"},"更新失败时自动重试",-1))]),_:1,__:[24]})]),_:1},8,["model"])])])]),e("div",To,[t($,{onClick:de},{default:s(()=>i[26]||(i[26]=[d("上一步",-1)])),_:1,__:[26]}),t($,{type:"primary",onClick:T},{default:s(()=>[t(me,null,{default:s(()=>[t(g(it))]),_:1}),i[27]||(i[27]=d(" 开始更新 ",-1))]),_:1,__:[27]})])])):Y("",!0),m.value===2?(n(),p("div",Do,[e("div",Io,[e("div",Mo,[e("div",Uo,[i[28]||(i[28]=e("h3",null,"批量更新进行中...",-1)),e("p",null,"正在更新 "+a(u.value.length)+" 个设备，请勿关闭页面",1)]),e("div",xo,[e("div",zo,[i[29]||(i[29]=e("div",{class:"progress-label"},"总体进度",-1)),t(yt,{percentage:R.value,status:Z.value,"stroke-width":"12"},null,8,["percentage","status"]),e("div",No,a(ue.value)+" / "+a(u.value.length)+" 设备完成 ",1)])]),e("div",Po,[e("div",Oo,[t(me,null,{default:s(()=>[t(g(Ce))]),_:1}),i[30]||(i[30]=e("span",{class:"summary-label"},"成功",-1)),e("span",Ao,a(_e.value),1)]),e("div",Eo,[t(me,null,{default:s(()=>[t(g(Ge))]),_:1}),i[31]||(i[31]=e("span",{class:"summary-label"},"进行中",-1)),e("span",Fo,a(j.value),1)]),e("div",Ro,[t(me,null,{default:s(()=>[t(g(Ye))]),_:1}),i[32]||(i[32]=e("span",{class:"summary-label"},"失败",-1)),e("span",Bo,a(te.value),1)]),e("div",Yo,[t(me,null,{default:s(()=>[t(g(Je))]),_:1}),i[33]||(i[33]=e("span",{class:"summary-label"},"等待",-1)),e("span",Xo,a(z.value),1)])])]),e("div",Lo,[e("div",Ho,[i[34]||(i[34]=e("h4",null,"设备更新详情",-1)),e("div",Zo,[t($,{size:"small",onClick:C},{default:s(()=>[d(a(y.value?"只显示进行中":"显示全部"),1)]),_:1})])]),e("div",jo,[(n(!0),p(ne,null,oe(c.value,H=>(n(),p("div",{key:H.deviceId,class:Ne(["device-progress-item",H.status])},[e("div",Ko,[e("div",qo,[e("span",Wo,a(H.deviceName),1),e("span",Go,a(H.deviceSerialNumber),1)]),e("div",Qo,[t(me,{class:"status-icon"},{default:s(()=>[H.status==="updating"?(n(),B(g(Ge),{key:0})):H.status==="completed"?(n(),B(g(Ce),{key:1})):H.status==="failed"?(n(),B(g(Ye),{key:2})):(n(),B(g(Je),{key:3}))]),_:2},1024),e("span",Jo,a(Ie(H.status)),1)])]),e("div",ei,[e("div",ti,[t(yt,{percentage:H.progress,status:L(H.status),"show-text":!1,"stroke-width":"6"},null,8,["percentage","status"]),e("span",si,a(H.progress)+"%",1)]),e("div",li,a(H.currentStep),1),H.errorMessage?(n(),p("div",ai,[t(me,null,{default:s(()=>[t(g(nt))]),_:1}),e("span",null,a(H.errorMessage),1)])):Y("",!0)])],2))),128))])])]),e("div",ni,[t($,{onClick:D,disabled:!J.value},{default:s(()=>[t(me,null,{default:s(()=>[t(g(qt))]),_:1}),i[35]||(i[35]=d(" 暂停更新 ",-1))]),_:1,__:[35]},8,["disabled"]),t($,{onClick:E,disabled:!J.value},{default:s(()=>[t(me,null,{default:s(()=>[t(g(kt))]),_:1}),i[36]||(i[36]=d(" 取消更新 ",-1))]),_:1,__:[36]},8,["disabled"])])])):Y("",!0),m.value===3?(n(),p("div",oi,[e("div",ii,[e("div",ri,[e("div",di,[e("div",{class:Ne(["result-icon",r.value])},[t(me,null,{default:s(()=>[r.value==="success"?(n(),B(g(Ce),{key:0})):r.value==="warning"?(n(),B(g(nt),{key:1})):(n(),B(g(Ye),{key:2}))]),_:1})],2),e("h3",null,a(K.value),1),e("p",null,a(q.value),1)]),e("div",ui,[e("div",ci,[e("div",vi,a(_e.value),1),i[37]||(i[37]=e("div",{class:"stat-label"},"更新成功",-1))]),e("div",pi,[e("div",_i,a(te.value),1),i[38]||(i[38]=e("div",{class:"stat-label"},"更新失败",-1))]),e("div",mi,[e("div",fi,a(ee.value),1),i[39]||(i[39]=e("div",{class:"stat-label"},"总用时",-1))])])]),e("div",gi,[t(Ot,{modelValue:X.value,"onUpdate:modelValue":i[7]||(i[7]=H=>X.value=H),type:"border-card"},{default:s(()=>[_e.value>0?(n(),B(bt,{key:0,label:"成功设备",name:"success"},{default:s(()=>[e("div",hi,[(n(!0),p(ne,null,oe(le.value,H=>(n(),p("div",{key:H.deviceId,class:"result-item success"},[t(me,{class:"result-icon"},{default:s(()=>[t(g(Ce))]),_:1}),e("div",yi,[e("div",bi,a(H.deviceName),1),e("div",wi,a(H.deviceSerialNumber)+" · "+a(H.currentVersion)+" → "+a(H.targetVersion)+" · 用时 "+a(H.duration),1)])]))),128))])]),_:1})):Y("",!0),te.value>0?(n(),B(bt,{key:1,label:"失败设备",name:"failed"},{default:s(()=>[e("div",$i,[(n(!0),p(ne,null,oe(ve.value,H=>(n(),p("div",{key:H.deviceId,class:"result-item failed"},[t(me,{class:"result-icon"},{default:s(()=>[t(g(Ye))]),_:1}),e("div",ki,[e("div",Si,a(H.deviceName),1),e("div",Vi,a(H.deviceSerialNumber)+" · "+a(H.errorMessage),1),e("div",Ci,[t($,{size:"small",text:"",type:"primary",onClick:ct=>ie(H.deviceId)},{default:s(()=>i[40]||(i[40]=[d(" 重试 ",-1)])),_:2,__:[40]},1032,["onClick"]),t($,{size:"small",text:"",onClick:ct=>Q(H.deviceId)},{default:s(()=>i[41]||(i[41]=[d(" 查看日志 ",-1)])),_:2,__:[41]},1032,["onClick"])])])]))),128))])]),_:1})):Y("",!0)]),_:1},8,["modelValue"])])]),e("div",Ti,[t($,{onClick:he},{default:s(()=>i[42]||(i[42]=[d("关闭",-1)])),_:1,__:[42]}),te.value>0?(n(),B($,{key:0,type:"primary",onClick:be},{default:s(()=>[t(me,null,{default:s(()=>[t(g(et))]),_:1}),i[43]||(i[43]=d(" 重试失败设备 ",-1))]),_:1,__:[43]})):Y("",!0),t($,{type:"success",onClick:Te},{default:s(()=>[t(me,null,{default:s(()=>[t(g(We))]),_:1}),i[44]||(i[44]=d(" 导出结果 ",-1))]),_:1,__:[44]})])])):Y("",!0)])]),_:1},8,["modelValue"])}}}),Ii=Oe(Di,[["__scopeId","data-v-05ba6b0c"]]),Mi={class:"device-firmware-status"},Ui={class:"status-overview"},xi={class:"status-stats"},zi={class:"stat-item up-to-date"},Ni={class:"stat-icon"},Pi={class:"stat-info"},Oi={class:"stat-value"},Ai={class:"stat-percentage"},Ei={class:"stat-item update-available"},Fi={class:"stat-icon"},Ri={class:"stat-info"},Bi={class:"stat-value"},Yi={class:"stat-percentage"},Xi={class:"stat-item updating"},Li={class:"stat-icon"},Hi={class:"stat-info"},Zi={class:"stat-value"},ji={class:"stat-percentage"},Ki={class:"stat-item failed"},qi={class:"stat-icon"},Wi={class:"stat-info"},Gi={class:"stat-value"},Qi={class:"stat-percentage"},Ji={class:"status-chart"},er={class:"chart-header"},tr={class:"search-filters"},sr={class:"filters-left"},lr={class:"filters-right"},ar={class:"table-section"},nr={class:"status-cell"},or={class:"status-text"},ir={class:"pagination-wrapper"},rr=Pe({__name:"DeviceFirmwareStatus",setup(re){const l=I(!1),o=I(!1),_=I(""),b=I(""),m=I(""),u=I(1),h=I(20),v=I(0),V=I([]),y=I([]),X=I({total:0,upToDate:0,updateAvailable:0,updating:0,failed:0}),J=I();let P=null;const se=()=>{u.value=1,F()},O=()=>{u.value=1,F()},ye=A=>{h.value=A,u.value=1,F()},fe=A=>{u.value=A,F()},ge=A=>{y.value=A},F=()=>G(null,null,function*(){l.value=!0;try{const A=yield Me.getDeviceFirmwareStatus({page:u.value,pageSize:h.value,keyword:_.value,updateStatus:b.value,deviceModel:m.value});V.value=A.data.list,v.value=A.data.total,X.value=A.data.stats}catch(A){console.error("加载设备数据失败:",A),x.error("加载设备数据失败")}finally{l.value=!1}}),k=()=>G(null,null,function*(){o.value=!0;try{yield new Promise(A=>setTimeout(A,2e3)),yield F(),x.success("更新检查完成")}finally{o.value=!1}}),R=A=>{x.info(`开始更新设备：${A.deviceSerialNumber}`)},Z=I(!1),ue=()=>{if(y.value.length===0){x.warning("请先选择要更新的设备");return}y.value.map(A=>({deviceId:A.deviceId,deviceName:A.deviceName,deviceSerialNumber:A.deviceSerialNumber,deviceModel:A.deviceModel,currentVersion:A.currentVersion,targetVersion:A.latestVersion,priority:_e(A),isOnline:A.isOnline,signalStrength:A.signalStrength})),Z.value=!0},_e=A=>{if(A.updateStatus==="failed")return"high";if(!A.isOnline||A.signalStrength&&A.signalStrength<30)return"low";if(A.latestVersion.localeCompare(A.currentVersion)>0){const ce=A.currentVersion.split(".")[0],N=A.latestVersion.split(".")[0];return ce!==N?"high":"medium"}return"low"},te=A=>{x.success(`批量更新完成: ${A.successCount}/${A.totalDevices} 设备更新成功`),F()},j=A=>{x.info(`查看设备更新历史：${A.deviceSerialNumber}`)},z=(A,W)=>G(null,null,function*(){try{switch(A){case"check":x.info(`检查设备更新：${W.deviceSerialNumber}`);break;case"rollback":x.info("版本回滚功能开发中");break;case"logs":x.info("查看设备日志功能开发中");break}}catch(ce){console.error("设备操作失败:",ce),x.error("操作失败")}}),c=A=>({"YX-EDU-2024":"教育版","YX-HOME-2024":"家庭版","YX-PRO-2024":"专业版"})[A]||A,r=A=>({"up-to-date":"status-success","update-available":"status-warning",updating:"status-info",failed:"status-danger"})[A]||"status-info",K=A=>Dt[A]||A,q=A=>new Date(A).toLocaleString("zh-CN"),ee=A=>{if(X.value.total===0)return 0;const W=X.value[A];return Math.round(W/X.value.total*100)},le=()=>G(null,null,function*(){if(!J.value)return;yield ss(),P&&P.dispose(),P=as(J.value);const A={tooltip:{trigger:"item",formatter:"{a} <br/>{b}: {c} ({d}%)"},legend:{orient:"vertical",left:"left",data:["最新版本","有可用更新","更新中","更新失败"]},series:[{name:"设备状态",type:"pie",radius:["40%","70%"],avoidLabelOverlap:!1,label:{show:!1,position:"center"},emphasis:{label:{show:!0,fontSize:"18",fontWeight:"bold"}},labelLine:{show:!1},data:[{value:X.value.upToDate,name:"最新版本",itemStyle:{color:"#67c23a"}},{value:X.value.updateAvailable,name:"有可用更新",itemStyle:{color:"#e6a23c"}},{value:X.value.updating,name:"更新中",itemStyle:{color:"#409eff"}},{value:X.value.failed,name:"更新失败",itemStyle:{color:"#f56c6c"}}]}]};P.setOption(A),window.addEventListener("resize",()=>{P==null||P.resize()})}),ve=()=>{le()};return Ke(()=>G(null,null,function*(){yield F(),yield le()})),(A,W)=>{const ce=f("el-icon"),N=f("el-button"),pe=f("el-input"),Se=f("el-option"),de=f("el-select"),T=f("el-table-column"),S=f("el-tag"),M=f("el-dropdown-item"),U=f("el-dropdown-menu"),D=f("el-dropdown"),E=f("el-table"),C=f("el-pagination"),ie=qe("loading");return n(),p("div",Mi,[t(Un),e("div",Ui,[e("div",xi,[e("div",zi,[e("div",Ni,[t(ce,null,{default:s(()=>[t(g(Ce))]),_:1})]),e("div",Pi,[e("div",Oi,a(X.value.upToDate),1),W[6]||(W[6]=e("div",{class:"stat-label"},"最新版本",-1)),e("div",Ai,a(ee("upToDate"))+"%",1)])]),e("div",Ei,[e("div",Fi,[t(ce,null,{default:s(()=>[t(g(je))]),_:1})]),e("div",Ri,[e("div",Bi,a(X.value.updateAvailable),1),W[7]||(W[7]=e("div",{class:"stat-label"},"有可用更新",-1)),e("div",Yi,a(ee("updateAvailable"))+"%",1)])]),e("div",Xi,[e("div",Li,[t(ce,null,{default:s(()=>[t(g(Ge))]),_:1})]),e("div",Hi,[e("div",Zi,a(X.value.updating),1),W[8]||(W[8]=e("div",{class:"stat-label"},"更新中",-1)),e("div",ji,a(ee("updating"))+"%",1)])]),e("div",Ki,[e("div",qi,[t(ce,null,{default:s(()=>[t(g(Ye))]),_:1})]),e("div",Wi,[e("div",Gi,a(X.value.failed),1),W[9]||(W[9]=e("div",{class:"stat-label"},"更新失败",-1)),e("div",Qi,a(ee("failed"))+"%",1)])])]),e("div",Ji,[e("div",er,[W[11]||(W[11]=e("h3",null,"设备状态分布",-1)),t(N,{text:"",type:"primary",size:"small",onClick:ve},{default:s(()=>[t(ce,null,{default:s(()=>[t(g(et))]),_:1}),W[10]||(W[10]=d(" 刷新图表 ",-1))]),_:1,__:[10]})]),e("div",{ref_key:"chartContainer",ref:J,class:"chart-container"},null,512)])]),e("div",tr,[e("div",sr,[t(pe,{modelValue:_.value,"onUpdate:modelValue":W[0]||(W[0]=Q=>_.value=Q),placeholder:"搜索设备序列号或名称","prefix-icon":g(rt),clearable:"",onInput:se,style:{width:"300px"}},null,8,["modelValue","prefix-icon"]),t(de,{modelValue:b.value,"onUpdate:modelValue":W[1]||(W[1]=Q=>b.value=Q),placeholder:"更新状态",clearable:"",onChange:O},{default:s(()=>[t(Se,{label:"全部状态",value:""}),t(Se,{label:"最新版本",value:"up-to-date"}),t(Se,{label:"有可用更新",value:"update-available"}),t(Se,{label:"更新中",value:"updating"}),t(Se,{label:"更新失败",value:"failed"})]),_:1},8,["modelValue"]),t(de,{modelValue:m.value,"onUpdate:modelValue":W[2]||(W[2]=Q=>m.value=Q),placeholder:"设备型号",clearable:"",onChange:O},{default:s(()=>[t(Se,{label:"全部型号",value:""}),t(Se,{label:"教育版",value:"YX-EDU-2024"}),t(Se,{label:"家庭版",value:"YX-HOME-2024"}),t(Se,{label:"专业版",value:"YX-PRO-2024"})]),_:1},8,["modelValue"])]),e("div",lr,[t(N,{type:"primary",onClick:ue,disabled:y.value.length===0},{default:s(()=>[t(ce,null,{default:s(()=>[t(g(it))]),_:1}),d(" 批量更新 ("+a(y.value.length)+") ",1)]),_:1},8,["disabled"]),t(N,{onClick:k,loading:o.value},{default:s(()=>[t(ce,null,{default:s(()=>[t(g(et))]),_:1}),W[12]||(W[12]=d(" 检查更新 ",-1))]),_:1,__:[12]},8,["loading"])])]),e("div",ar,[He((n(),B(E,{data:V.value,stripe:"",onSelectionChange:ge},{default:s(()=>[t(T,{type:"selection",width:"55"}),t(T,{prop:"deviceSerialNumber",label:"设备序列号",width:"150"}),t(T,{prop:"deviceName",label:"设备名称",width:"150"}),t(T,{prop:"deviceModel",label:"设备型号",width:"120"},{default:s(({row:Q})=>[t(S,{size:"small"},{default:s(()=>[d(a(c(Q.deviceModel)),1)]),_:2},1024)]),_:1}),t(T,{prop:"currentVersion",label:"当前版本",width:"120"}),t(T,{prop:"latestVersion",label:"最新版本",width:"120"},{default:s(({row:Q})=>[e("span",{class:Ne({"version-highlight":Q.updateAvailable})},a(Q.latestVersion),3)]),_:1}),t(T,{prop:"updateStatus",label:"更新状态",width:"120"},{default:s(({row:Q})=>[e("div",nr,[t(ce,{class:Ne(r(Q.updateStatus))},{default:s(()=>[Q.updateStatus==="up-to-date"?(n(),B(g(Ce),{key:0})):Q.updateStatus==="update-available"?(n(),B(g(je),{key:1})):Q.updateStatus==="updating"?(n(),B(g(Ge),{key:2})):(n(),B(g(Ye),{key:3}))]),_:2},1032,["class"]),e("span",or,a(K(Q.updateStatus)),1)])]),_:1}),t(T,{prop:"lastUpdateCheck",label:"最后检查",width:"150"},{default:s(({row:Q})=>[d(a(q(Q.lastUpdateCheck)),1)]),_:1}),t(T,{label:"操作",width:"200",fixed:"right"},{default:s(({row:Q})=>[t(N,{text:"",type:"primary",size:"small",onClick:be=>R(Q),disabled:!Q.updateAvailable||Q.updateStatus==="updating"},{default:s(()=>W[13]||(W[13]=[d(" 更新 ",-1)])),_:2,__:[13]},1032,["onClick","disabled"]),t(N,{text:"",type:"success",size:"small",onClick:be=>j(Q)},{default:s(()=>W[14]||(W[14]=[d(" 历史 ",-1)])),_:2,__:[14]},1032,["onClick"]),t(D,{onCommand:be=>z(be,Q),trigger:"click"},{dropdown:s(()=>[t(U,null,{default:s(()=>[t(M,{command:"check"},{default:s(()=>W[16]||(W[16]=[d(" 检查更新 ",-1)])),_:1,__:[16]}),Q.updateHistory.length>0?(n(),B(M,{key:0,command:"rollback"},{default:s(()=>W[17]||(W[17]=[d(" 版本回滚 ",-1)])),_:1,__:[17]})):Y("",!0),t(M,{command:"logs"},{default:s(()=>W[18]||(W[18]=[d(" 查看日志 ",-1)])),_:1,__:[18]})]),_:2},1024)]),default:s(()=>[t(N,{text:"",type:"primary",size:"small"},{default:s(()=>[W[15]||(W[15]=d(" 更多",-1)),t(ce,{class:"el-icon--right"},{default:s(()=>[t(g(ft))]),_:1})]),_:1,__:[15]})]),_:2},1032,["onCommand"])]),_:1})]),_:1},8,["data"])),[[ie,l.value]]),e("div",ir,[t(C,{"current-page":u.value,"onUpdate:currentPage":W[3]||(W[3]=Q=>u.value=Q),"page-size":h.value,"onUpdate:pageSize":W[4]||(W[4]=Q=>h.value=Q),"page-sizes":[10,20,50,100],total:v.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:ye,onCurrentChange:fe},null,8,["current-page","page-size","total"])])]),t(Ii,{modelValue:Z.value,"onUpdate:modelValue":W[5]||(W[5]=Q=>Z.value=Q),"available-devices":y.value.map(Q=>({deviceId:Q.deviceId,deviceName:Q.deviceName,deviceSerialNumber:Q.deviceSerialNumber,deviceModel:Q.deviceModel,currentVersion:Q.currentVersion,targetVersion:Q.latestVersion,priority:_e(Q),isOnline:Q.isOnline,signalStrength:Q.signalStrength})),onUpdateComplete:te},null,8,["modelValue","available-devices"])])}}}),dr=Oe(rr,[["__scopeId","data-v-2b891f41"]]),ur={class:"firmware-update-dialog"},cr={key:0,class:"step-content"},vr={class:"device-filters"},pr={class:"device-list"},_r={class:"list-header"},mr={class:"device-count"},fr={class:"device-items"},gr=["onClick"],hr={class:"device-info"},yr={class:"device-main"},br={class:"device-name"},wr={class:"device-serial"},$r={class:"device-details"},kr={class:"device-model"},Sr={class:"device-version"},Vr={key:0,class:"latest-version"},Cr={key:0,class:"device-restrictions"},Tr={class:"device-status"},Dr={key:0,class:"signal-strength"},Ir={key:1,class:"step-content"},Mr={class:"selected-devices-summary"},Ur={class:"device-tags"},xr={class:"version-list"},zr=["onClick"],Nr={class:"version-info"},Pr={class:"version-header"},Or={class:"version-number"},Ar={class:"version-date"},Er={class:"version-description"},Fr={class:"version-details"},Rr={class:"file-size"},Br={class:"device-models"},Yr={key:0,class:"version-details-panel"},Xr={class:"changelog-list"},Lr={class:"compatibility-list"},Hr={class:"issues-list"},Zr={key:2,class:"step-content"},jr={class:"update-summary"},Kr={class:"update-device-list"},qr={class:"update-options"},Wr={class:"dialog-footer"},Gr=Pe({__name:"FirmwareUpdateDialog",props:{modelValue:{type:Boolean},preSelectedDevices:{default:()=>[]}},emits:["update:modelValue","update-started"],setup(re,{emit:l}){const o=re,_=l,b=ae({get:()=>o.modelValue,set:T=>_("update:modelValue",T)}),m=I(0),u=I(!1),h=I([]),v=I([]),V=mt({keyword:"",deviceModel:"",updateStatus:"",onlineOnly:!1}),y=I([]),X=I(null),J=I([]),P=I(""),se=mt({forceUpdate:!1,autoRetry:!0}),O=ae(()=>{let T=h.value;if(V.keyword){const S=V.keyword.toLowerCase();T=T.filter(M=>M.deviceName.toLowerCase().includes(S)||M.deviceSerialNumber.toLowerCase().includes(S))}return V.deviceModel&&(T=T.filter(S=>S.deviceModel===V.deviceModel)),V.updateStatus&&(T=T.filter(S=>S.updateStatus===V.updateStatus)),V.onlineOnly&&(T=T.filter(S=>S.isOnline)),T}),ye=ae(()=>O.value.filter(T=>T.canUpdate)),fe=ae({get:()=>{const T=ye.value.map(S=>S.deviceId);return T.length>0&&T.every(S=>v.value.includes(S))},set:T=>{if(T)v.value=[...new Set([...v.value,...ye.value.map(S=>S.deviceId)])];else{const S=ye.value.map(M=>M.deviceId);v.value=v.value.filter(M=>!S.includes(M))}}}),ge=ae(()=>{const T=ye.value.map(M=>M.deviceId),S=v.value.filter(M=>T.includes(M));return S.length>0&&S.length<T.length}),F=ae(()=>{if(v.value.length===0)return[];const T=v.value.map(S=>{var M;return(M=h.value.find(U=>U.deviceId===S))==null?void 0:M.deviceModel}).filter(Boolean);return y.value.filter(S=>T.every(M=>S.deviceModel.includes(M))).sort((S,M)=>S.status==="stable"&&M.status!=="stable"?-1:M.status==="stable"&&S.status!=="stable"?1:M.version.localeCompare(S.version))}),k=ae(()=>v.value.map(T=>h.value.find(S=>S.deviceId===T)).filter(Boolean)),R=ae(()=>{const M=v.value.length*3;if(M<60)return`约 ${M} 分钟`;{const U=Math.floor(M/60),D=M%60;return`约 ${U} 小时 ${D} 分钟`}}),Z=ae(()=>{switch(m.value){case 0:return v.value.length>0;case 1:return X.value!==null;default:return!1}}),ue=ae(()=>P.value.trim()!==""&&X.value!==null&&v.value.length>0),_e=()=>G(null,null,function*(){try{const T=yield Me.getDeviceFirmwareStatus({pageSize:1e3});h.value=T.data.list}catch(T){x.error("加载设备列表失败")}}),te=()=>G(null,null,function*(){try{const T=yield Me.getFirmwareVersions({pageSize:1e3});y.value=T.data.list}catch(T){x.error("加载固件版本失败")}}),j=()=>{},z=T=>{fe.value=T},c=T=>{if(!T.canUpdate)return;const S=v.value.indexOf(T.deviceId);S>-1?v.value.splice(S,1):v.value.push(T.deviceId)},r=(T,S)=>{if(S)v.value.includes(T)||v.value.push(T);else{const M=v.value.indexOf(T);M>-1&&v.value.splice(M,1)}},K=T=>{const S=v.value.indexOf(T);S>-1&&v.value.splice(S,1)},q=T=>{X.value=T},ee=()=>{var T;if(Z.value&&(m.value++,m.value===2&&!P.value)){const S=new Date().toLocaleString("zh-CN");P.value=`批量更新到${(T=X.value)==null?void 0:T.version} - ${S}`}},le=()=>{m.value>0&&m.value--},ve=()=>G(null,null,function*(){var T;if(ue.value)try{yield Ue.confirm(`确定要开始更新 ${v.value.length} 台设备到版本 ${(T=X.value)==null?void 0:T.version} 吗？`,"确认更新",{confirmButtonText:"开始更新",cancelButtonText:"取消",type:"warning"}),u.value=!0;const S=yield Me.createUpdateTask({name:P.value,targetVersion:X.value.version,deviceIds:v.value});x.success("更新任务创建成功"),_("update-started",S.data.id),A()}catch(S){S!=="cancel"&&x.error("创建更新任务失败")}finally{u.value=!1}}),A=()=>{b.value=!1,m.value=0,v.value=[],X.value=null,P.value="",Object.assign(V,{keyword:"",deviceModel:"",updateStatus:"",onlineOnly:!1}),Object.assign(se,{forceUpdate:!1,autoRetry:!0})},W=T=>{const S=h.value.find(M=>M.deviceId===T);return S?S.deviceName:T},ce=T=>({"up-to-date":"success","update-available":"warning",updating:"primary",failed:"danger"})[T]||"info",N=T=>Dt[T]||T,pe=T=>({stable:"success",testing:"warning",draft:"info",deprecated:"danger"})[T]||"info",Se=T=>dt[T]||T,de=T=>new Date(T).toLocaleDateString("zh-CN");return Xe(b,T=>{T&&(_e(),te(),o.preSelectedDevices.length>0&&(v.value=[...o.preSelectedDevices]))}),Ke(()=>{b.value&&(_e(),te())}),(T,S)=>{const M=f("el-step"),U=f("el-steps"),D=f("el-input"),E=f("el-col"),C=f("el-option"),ie=f("el-select"),Q=f("el-checkbox"),be=f("el-row"),Te=f("el-tag"),he=f("el-icon"),Ee=f("el-radio"),Fe=f("el-collapse-item"),Ae=f("el-collapse"),Ie=f("el-descriptions-item"),L=f("el-descriptions"),w=f("el-table-column"),i=f("el-table"),we=f("el-alert"),Ve=f("el-button"),me=f("el-dialog");return n(),B(me,{modelValue:b.value,"onUpdate:modelValue":S[9]||(S[9]=$=>b.value=$),title:"固件更新",width:"800px","close-on-click-modal":!1,"close-on-press-escape":!1,onClose:A},{footer:s(()=>[e("div",Wr,[t(Ve,{onClick:A},{default:s(()=>S[19]||(S[19]=[d("取消",-1)])),_:1,__:[19]}),m.value>0?(n(),B(Ve,{key:0,onClick:le},{default:s(()=>S[20]||(S[20]=[d("上一步",-1)])),_:1,__:[20]})):Y("",!0),m.value<2?(n(),B(Ve,{key:1,type:"primary",disabled:!Z.value,onClick:ee},{default:s(()=>S[21]||(S[21]=[d(" 下一步 ",-1)])),_:1,__:[21]},8,["disabled"])):Y("",!0),m.value===2?(n(),B(Ve,{key:2,type:"primary",loading:u.value,disabled:!ue.value,onClick:ve},{default:s(()=>S[22]||(S[22]=[d(" 开始更新 ",-1)])),_:1,__:[22]},8,["loading","disabled"])):Y("",!0)])]),default:s(()=>[e("div",ur,[t(U,{active:m.value,"align-center":"",class:"update-steps"},{default:s(()=>[t(M,{title:"选择设备",icon:"Monitor"}),t(M,{title:"选择版本",icon:"Download"}),t(M,{title:"确认更新",icon:"Check"})]),_:1},8,["active"]),m.value===0?(n(),p("div",cr,[S[11]||(S[11]=e("div",{class:"step-header"},[e("h3",null,"选择要更新的设备"),e("p",{class:"step-description"},"选择需要进行固件更新的设备，支持单个或批量选择")],-1)),e("div",vr,[t(be,{gutter:16},{default:s(()=>[t(E,{span:8},{default:s(()=>[t(D,{modelValue:V.keyword,"onUpdate:modelValue":S[0]||(S[0]=$=>V.keyword=$),placeholder:"搜索设备名称或序列号","prefix-icon":"Search",clearable:"",onInput:j},null,8,["modelValue"])]),_:1}),t(E,{span:6},{default:s(()=>[t(ie,{modelValue:V.deviceModel,"onUpdate:modelValue":S[1]||(S[1]=$=>V.deviceModel=$),placeholder:"设备型号",clearable:"",onChange:j},{default:s(()=>[t(C,{label:"全部型号",value:""}),t(C,{label:"YX-EDU-2024",value:"YX-EDU-2024"}),t(C,{label:"YX-HOME-2024",value:"YX-HOME-2024"}),t(C,{label:"YX-PRO-2024",value:"YX-PRO-2024"})]),_:1},8,["modelValue"])]),_:1}),t(E,{span:6},{default:s(()=>[t(ie,{modelValue:V.updateStatus,"onUpdate:modelValue":S[2]||(S[2]=$=>V.updateStatus=$),placeholder:"更新状态",clearable:"",onChange:j},{default:s(()=>[t(C,{label:"全部状态",value:""}),t(C,{label:"有可用更新",value:"update-available"}),t(C,{label:"最新版本",value:"up-to-date"}),t(C,{label:"更新失败",value:"failed"})]),_:1},8,["modelValue"])]),_:1}),t(E,{span:4},{default:s(()=>[t(Q,{modelValue:V.onlineOnly,"onUpdate:modelValue":S[3]||(S[3]=$=>V.onlineOnly=$),onChange:j},{default:s(()=>S[10]||(S[10]=[d(" 仅在线设备 ",-1)])),_:1,__:[10]},8,["modelValue"])]),_:1})]),_:1})]),e("div",pr,[e("div",_r,[t(Q,{modelValue:fe.value,"onUpdate:modelValue":S[4]||(S[4]=$=>fe.value=$),indeterminate:ge.value,onChange:z},{default:s(()=>[d(" 全选 ("+a(v.value.length)+"/"+a(O.value.length)+") ",1)]),_:1},8,["modelValue","indeterminate"]),e("span",mr," 共 "+a(O.value.length)+" 台设备，"+a(ye.value.length)+" 台可更新 ",1)]),e("div",fr,[(n(!0),p(ne,null,oe(O.value,$=>{var $e;return n(),p("div",{key:$.deviceId,class:Ne(["device-item",{selected:v.value.includes($.deviceId),disabled:!$.canUpdate}]),onClick:ke=>c($)},[t(Q,{"model-value":v.value.includes($.deviceId),disabled:!$.canUpdate,onChange:ke=>r($.deviceId,ke)},null,8,["model-value","disabled","onChange"]),e("div",hr,[e("div",yr,[e("span",br,a($.deviceName),1),e("span",wr,a($.deviceSerialNumber),1),t(Te,{type:$.isOnline?"success":"danger",size:"small"},{default:s(()=>[d(a($.isOnline?"在线":"离线"),1)]),_:2},1032,["type"])]),e("div",$r,[e("span",kr,a($.deviceModel),1),e("span",Sr,"当前版本: "+a($.currentVersion),1),$.updateAvailable?(n(),p("span",Vr," 最新版本: "+a($.latestVersion),1)):Y("",!0)]),($e=$.updateRestrictions)!=null&&$e.length?(n(),p("div",Cr,[t(he,{class:"warning-icon"},{default:s(()=>[t(g(je))]),_:1}),e("span",null,a($.updateRestrictions.join(", ")),1)])):Y("",!0)]),e("div",Tr,[t(Te,{type:ce($.updateStatus),size:"small"},{default:s(()=>[d(a(N($.updateStatus)),1)]),_:2},1032,["type"]),$.signalStrength!==void 0?(n(),p("div",Dr,[t(he,null,{default:s(()=>[t(g(Gt))]),_:1}),e("span",null,a($.signalStrength)+"%",1)])):Y("",!0)])],10,gr)}),128))])])])):Y("",!0),m.value===1?(n(),p("div",Ir,[S[12]||(S[12]=e("div",{class:"step-header"},[e("h3",null,"选择目标固件版本"),e("p",{class:"step-description"},"为选中的设备选择要更新的固件版本")],-1)),e("div",Mr,[e("h4",null,"已选择设备 ("+a(v.value.length)+"台)",1),e("div",Ur,[(n(!0),p(ne,null,oe(v.value,$=>(n(),B(Te,{key:$,closable:"",onClose:$e=>K($)},{default:s(()=>[d(a(W($)),1)]),_:2},1032,["onClose"]))),128))])]),e("div",xr,[(n(!0),p(ne,null,oe(F.value,$=>{var $e,ke;return n(),p("div",{key:$.id,class:Ne(["version-item",{selected:(($e=X.value)==null?void 0:$e.id)===$.id}]),onClick:tt=>q($)},[t(Ee,{"model-value":((ke=X.value)==null?void 0:ke.id)===$.id,onChange:tt=>q($)},{default:s(()=>[e("div",Nr,[e("div",Pr,[e("span",Or,a($.version),1),t(Te,{type:pe($.status),size:"small"},{default:s(()=>[d(a(Se($.status)),1)]),_:2},1032,["type"]),e("span",Ar,a(de($.releaseDate)),1)]),e("div",Er,a($.description),1),e("div",Fr,[e("span",Rr,"大小: "+a(g(ze)($.fileSize)),1),e("span",Br," 兼容: "+a($.deviceModel.join(", ")),1)])])]),_:2},1032,["model-value","onChange"])],10,zr)}),128))]),X.value?(n(),p("div",Yr,[t(Ae,{modelValue:J.value,"onUpdate:modelValue":S[5]||(S[5]=$=>J.value=$)},{default:s(()=>[t(Fe,{title:"更新日志",name:"changelog"},{default:s(()=>[e("ul",Xr,[(n(!0),p(ne,null,oe(X.value.changelog,$=>(n(),p("li",{key:$},a($),1))),128))])]),_:1}),t(Fe,{title:"兼容性说明",name:"compatibility"},{default:s(()=>[e("ul",Lr,[(n(!0),p(ne,null,oe(X.value.compatibility,$=>(n(),p("li",{key:$},a($),1))),128))])]),_:1}),X.value.knownIssues.length?(n(),B(Fe,{key:0,title:"已知问题",name:"issues"},{default:s(()=>[e("ul",Hr,[(n(!0),p(ne,null,oe(X.value.knownIssues,$=>(n(),p("li",{key:$},[t(he,{class:"warning-icon"},{default:s(()=>[t(g(je))]),_:1}),d(" "+a($),1)]))),128))])]),_:1})):Y("",!0)]),_:1},8,["modelValue"])])):Y("",!0)])):Y("",!0),m.value===2?(n(),p("div",Zr,[S[18]||(S[18]=e("div",{class:"step-header"},[e("h3",null,"确认更新信息"),e("p",{class:"step-description"},"请确认更新信息，点击开始更新后将立即执行")],-1)),e("div",jr,[t(L,{column:2,border:""},{default:s(()=>[t(Ie,{label:"任务名称"},{default:s(()=>[t(D,{modelValue:P.value,"onUpdate:modelValue":S[6]||(S[6]=$=>P.value=$),placeholder:"请输入任务名称",style:{width:"300px"}},null,8,["modelValue"])]),_:1}),t(Ie,{label:"目标版本"},{default:s(()=>{var $;return[d(a(($=X.value)==null?void 0:$.version),1)]}),_:1}),t(Ie,{label:"更新设备数量"},{default:s(()=>[d(a(v.value.length)+" 台 ",1)]),_:1}),t(Ie,{label:"预计时间"},{default:s(()=>[d(a(R.value),1)]),_:1})]),_:1})]),e("div",Kr,[S[13]||(S[13]=e("h4",null,"设备更新列表",-1)),t(i,{data:k.value,style:{width:"100%"}},{default:s(()=>[t(w,{prop:"deviceName",label:"设备名称",width:"150"}),t(w,{prop:"deviceSerialNumber",label:"序列号",width:"120"}),t(w,{prop:"deviceModel",label:"型号",width:"120"}),t(w,{prop:"currentVersion",label:"当前版本",width:"100"}),t(w,{label:"目标版本",width:"100"},{default:s(()=>{var $;return[d(a(($=X.value)==null?void 0:$.version),1)]}),_:1}),t(w,{label:"状态",width:"100"},{default:s(({row:$})=>[t(Te,{type:$.isOnline?"success":"warning",size:"small"},{default:s(()=>[d(a($.isOnline?"就绪":"离线"),1)]),_:2},1032,["type"])]),_:1}),t(w,{prop:"location",label:"位置"})]),_:1},8,["data"])]),e("div",qr,[S[16]||(S[16]=e("h4",null,"更新选项",-1)),t(Q,{modelValue:se.forceUpdate,"onUpdate:modelValue":S[7]||(S[7]=$=>se.forceUpdate=$)},{default:s(()=>S[14]||(S[14]=[d(" 强制更新（忽略版本兼容性警告） ",-1)])),_:1,__:[14]},8,["modelValue"]),t(Q,{modelValue:se.autoRetry,"onUpdate:modelValue":S[8]||(S[8]=$=>se.autoRetry=$)},{default:s(()=>S[15]||(S[15]=[d(" 失败时自动重试（最多3次） ",-1)])),_:1,__:[15]},8,["modelValue"])]),t(we,{title:"更新风险提示",type:"warning",closable:!1,"show-icon":""},{default:s(()=>S[17]||(S[17]=[e("ul",null,[e("li",null,"固件更新过程中请勿断开设备电源或网络连接"),e("li",null,"更新过程可能需要几分钟时间，期间设备将无法正常使用"),e("li",null,"如果更新失败，设备可能需要手动恢复"),e("li",null,"建议在设备使用较少的时间段进行更新")],-1)])),_:1,__:[17]})])):Y("",!0)])]),_:1},8,["modelValue"])}}}),Qr=Oe(Gr,[["__scopeId","data-v-ef9a6a19"]]),Jr={key:0,class:"task-detail-dialog"},ed={class:"task-info-section"},td={class:"task-progress-section"},sd={class:"progress-stats"},ld={class:"stat-card"},ad={class:"stat-number"},nd={class:"stat-card success"},od={class:"stat-number"},id={class:"stat-card processing"},rd={class:"stat-number"},dd={class:"stat-card failed"},ud={class:"stat-number"},cd={class:"stat-card"},vd={class:"stat-number"},pd={class:"overall-progress"},_d={class:"device-details-section"},md={class:"section-header"},fd={class:"header-actions"},gd={key:0,class:"error-message"},hd={key:1},yd={key:0,class:"task-history-section"},bd={class:"history-content"},wd={class:"history-action"},$d={key:0,class:"history-description"},kd={class:"history-operator"},Sd={class:"dialog-footer"},Vd=Pe({__name:"TaskDetailDialog",props:{modelValue:{type:Boolean},task:{}},emits:["update:modelValue","refresh"],setup(re,{emit:l}){const o=re,_=l,b=ae({get:()=>o.modelValue,set:c=>_("update:modelValue",c)}),m=I(""),u=I(""),h=I([{timestamp:"2024-01-16T14:00:00Z",action:"任务创建",description:"创建固件更新任务",operator:"admin"},{timestamp:"2024-01-16T14:05:00Z",action:"任务开始",description:"开始执行固件更新",operator:"admin"}]),v=ae(()=>{var r;if(!((r=o.task)!=null&&r.devices))return[];let c=o.task.devices;if(m.value){const K=m.value.toLowerCase();c=c.filter(q=>q.deviceSerialNumber.toLowerCase().includes(K))}return u.value&&(c=c.filter(K=>K.status===u.value)),c}),V=()=>{b.value=!1,m.value="",u.value=""},y=c=>({pending:"info",running:"primary",completed:"success",failed:"danger",cancelled:"warning"})[c]||"info",X=c=>It[c]||c,J=c=>({pending:"info",downloading:"primary",installing:"primary",rebooting:"warning",completed:"success",failed:"danger"})[c]||"info",P=c=>Mt[c]||c,se=c=>Be.getTaskCompletionPercentage(c),O=c=>Be.getTaskSuccessRate(c),ye=c=>({pending:"#909399",running:"#409eff",completed:"#67c23a",failed:"#f56c6c",cancelled:"#e6a23c"})[c]||"#909399",fe=c=>({pending:"#909399",downloading:"#409eff",installing:"#409eff",rebooting:"#e6a23c",completed:"#67c23a",failed:"#f56c6c"})[c]||"#909399",ge=c=>({任务创建:"primary",任务开始:"success",任务暂停:"warning",任务取消:"danger",任务完成:"success",任务失败:"danger"})[c]||"info",F=c=>new Date(c).toLocaleString("zh-CN"),k=c=>{if(!c.startedAt)return"未开始";const r=new Date(c.startedAt).getTime(),K=c.completedAt?new Date(c.completedAt).getTime():Date.now(),q=Math.floor((K-r)/1e3);if(q<60)return`${q}秒`;if(q<3600)return`${Math.floor(q/60)}分${q%60}秒`;const ee=Math.floor(q/3600),le=Math.floor(q%3600/60),ve=q%60;return`${ee}小时${le}分${ve}秒`},R=()=>G(null,null,function*(){if(o.task)try{yield Ue.confirm("确定要开始执行此任务吗？","确认开始",{confirmButtonText:"开始",cancelButtonText:"取消",type:"info"}),x.success("任务已开始执行"),_("refresh")}catch(c){c!=="cancel"&&x.error("开始任务失败")}}),Z=()=>G(null,null,function*(){if(o.task)try{yield Ue.confirm("确定要暂停此任务吗？","确认暂停",{confirmButtonText:"暂停",cancelButtonText:"取消",type:"warning"}),x.success("任务已暂停"),_("refresh")}catch(c){c!=="cancel"&&x.error("暂停任务失败")}}),ue=()=>G(null,null,function*(){if(o.task)try{yield Ue.confirm("确定要取消此任务吗？取消后无法恢复。","确认取消",{confirmButtonText:"取消任务",cancelButtonText:"保留任务",type:"danger"}),(yield Me.cancelUpdateTask(o.task.id)).data.success&&(x.success("任务已取消"),_("refresh"),V())}catch(c){c!=="cancel"&&x.error("取消任务失败")}}),_e=()=>G(null,null,function*(){if(o.task)try{yield Ue.confirm("确定要重试失败的设备吗？","确认重试",{confirmButtonText:"重试",cancelButtonText:"取消",type:"info"}),x.success("失败设备已重新开始更新"),_("refresh")}catch(c){c!=="cancel"&&x.error("重试任务失败")}}),te=c=>G(null,null,function*(){if(o.task)try{yield Ue.confirm(`确定要重试设备 ${c.deviceSerialNumber} 吗？`,"确认重试设备",{confirmButtonText:"重试",cancelButtonText:"取消",type:"info"}),(yield Me.retryDeviceUpdate(o.task.id,c.deviceId)).data.success&&(x.success("设备已重新开始更新"),_("refresh"))}catch(r){r!=="cancel"&&x.error("重试设备失败")}}),j=c=>{x.info(`查看设备 ${c.deviceSerialNumber} 的更新日志`)},z=()=>{o.task&&(x.info("正在生成任务报告..."),setTimeout(()=>{x.success("任务报告已生成并下载")},2e3))};return Xe(()=>o.task,c=>{}),(c,r)=>{var S;const K=f("el-descriptions-item"),q=f("el-tag"),ee=f("el-descriptions"),le=f("el-progress"),ve=f("el-input"),A=f("el-option"),W=f("el-select"),ce=f("el-table-column"),N=f("el-button"),pe=f("el-table"),Se=f("el-timeline-item"),de=f("el-timeline"),T=f("el-dialog");return n(),B(T,{modelValue:b.value,"onUpdate:modelValue":r[2]||(r[2]=M=>b.value=M),title:`任务详情 - ${((S=c.task)==null?void 0:S.name)||""}`,width:"900px","close-on-click-modal":!1,onClose:V},{footer:s(()=>{var M,U,D,E;return[e("div",Sd,[t(N,{onClick:V},{default:s(()=>r[15]||(r[15]=[d("关闭",-1)])),_:1,__:[15]}),((M=c.task)==null?void 0:M.status)==="running"?(n(),B(N,{key:0,type:"warning",onClick:Z},{default:s(()=>r[16]||(r[16]=[d(" 暂停任务 ",-1)])),_:1,__:[16]})):Y("",!0),((U=c.task)==null?void 0:U.status)==="pending"?(n(),B(N,{key:1,type:"success",onClick:R},{default:s(()=>r[17]||(r[17]=[d(" 开始任务 ",-1)])),_:1,__:[17]})):Y("",!0),["pending","running"].includes(((D=c.task)==null?void 0:D.status)||"")?(n(),B(N,{key:2,type:"danger",onClick:ue},{default:s(()=>r[18]||(r[18]=[d(" 取消任务 ",-1)])),_:1,__:[18]})):Y("",!0),((E=c.task)==null?void 0:E.status)==="failed"?(n(),B(N,{key:3,type:"primary",onClick:_e},{default:s(()=>r[19]||(r[19]=[d(" 重试失败设备 ",-1)])),_:1,__:[19]})):Y("",!0),t(N,{type:"primary",onClick:z},{default:s(()=>r[20]||(r[20]=[d(" 导出报告 ",-1)])),_:1,__:[20]})])]}),default:s(()=>[c.task?(n(),p("div",Jr,[e("div",ed,[r[3]||(r[3]=e("h3",null,"基本信息",-1)),t(ee,{column:2,border:""},{default:s(()=>[t(K,{label:"任务名称"},{default:s(()=>[d(a(c.task.name),1)]),_:1}),t(K,{label:"目标版本"},{default:s(()=>[d(a(c.task.targetVersion),1)]),_:1}),t(K,{label:"任务状态"},{default:s(()=>[t(q,{type:y(c.task.status),size:"large"},{default:s(()=>[d(a(X(c.task.status)),1)]),_:1},8,["type"])]),_:1}),t(K,{label:"设备数量"},{default:s(()=>[d(a(c.task.deviceIds.length)+"台",1)]),_:1}),t(K,{label:"创建时间"},{default:s(()=>[d(a(F(c.task.createdAt)),1)]),_:1}),t(K,{label:"创建者"},{default:s(()=>[d(a(c.task.createdBy),1)]),_:1}),c.task.startedAt?(n(),B(K,{key:0,label:"开始时间"},{default:s(()=>[d(a(F(c.task.startedAt)),1)]),_:1})):Y("",!0),c.task.completedAt?(n(),B(K,{key:1,label:"完成时间"},{default:s(()=>[d(a(F(c.task.completedAt)),1)]),_:1})):Y("",!0),c.task.scheduledTime?(n(),B(K,{key:2,label:"计划时间"},{default:s(()=>[d(a(F(c.task.scheduledTime)),1)]),_:1})):Y("",!0),t(K,{label:"执行时长"},{default:s(()=>[d(a(k(c.task)),1)]),_:1})]),_:1})]),e("div",td,[r[10]||(r[10]=e("h3",null,"进度统计",-1)),e("div",sd,[e("div",ld,[e("div",ad,a(c.task.progress.total),1),r[4]||(r[4]=e("div",{class:"stat-label"},"总设备数",-1))]),e("div",nd,[e("div",od,a(c.task.progress.completed),1),r[5]||(r[5]=e("div",{class:"stat-label"},"成功",-1))]),e("div",id,[e("div",rd,a(c.task.progress.inProgress),1),r[6]||(r[6]=e("div",{class:"stat-label"},"进行中",-1))]),e("div",dd,[e("div",ud,a(c.task.progress.failed),1),r[7]||(r[7]=e("div",{class:"stat-label"},"失败",-1))]),e("div",cd,[e("div",vd,a(O(c.task))+"%",1),r[8]||(r[8]=e("div",{class:"stat-label"},"成功率",-1))])]),e("div",pd,[r[9]||(r[9]=e("div",{class:"progress-label"},"整体进度",-1)),t(le,{percentage:se(c.task),color:ye(c.task.status),"stroke-width":12},null,8,["percentage","color"])])]),e("div",_d,[e("div",md,[r[11]||(r[11]=e("h3",null,"设备更新详情",-1)),e("div",fd,[t(ve,{modelValue:m.value,"onUpdate:modelValue":r[0]||(r[0]=M=>m.value=M),placeholder:"搜索设备","prefix-icon":g(rt),clearable:"",style:{width:"200px"}},null,8,["modelValue","prefix-icon"]),t(W,{modelValue:u.value,"onUpdate:modelValue":r[1]||(r[1]=M=>u.value=M),placeholder:"设备状态",clearable:"",style:{width:"150px"}},{default:s(()=>[t(A,{label:"全部状态",value:""}),t(A,{label:"等待中",value:"pending"}),t(A,{label:"下载中",value:"downloading"}),t(A,{label:"安装中",value:"installing"}),t(A,{label:"重启中",value:"rebooting"}),t(A,{label:"完成",value:"completed"}),t(A,{label:"失败",value:"failed"})]),_:1},8,["modelValue"])])]),t(pe,{data:v.value,style:{width:"100%"},"max-height":"400"},{default:s(()=>[t(ce,{prop:"deviceSerialNumber",label:"设备序列号",width:"150"}),t(ce,{label:"状态",width:"100"},{default:s(({row:M})=>[t(q,{type:J(M.status),size:"small"},{default:s(()=>[d(a(P(M.status)),1)]),_:2},1032,["type"])]),_:1}),t(ce,{label:"进度",width:"150"},{default:s(({row:M})=>[t(le,{percentage:M.progress,color:fe(M.status),"stroke-width":6},null,8,["percentage","color"])]),_:1}),t(ce,{prop:"currentStep",label:"当前步骤"}),t(ce,{label:"开始时间",width:"150"},{default:s(({row:M})=>[d(a(M.startTime?F(M.startTime):"-"),1)]),_:1}),t(ce,{label:"结束时间",width:"150"},{default:s(({row:M})=>[d(a(M.endTime?F(M.endTime):"-"),1)]),_:1}),t(ce,{label:"重试次数",width:"100"},{default:s(({row:M})=>[d(a(M.retryCount||0),1)]),_:1}),t(ce,{label:"错误信息"},{default:s(({row:M})=>[M.errorMessage?(n(),p("span",gd,a(M.errorMessage),1)):(n(),p("span",hd,"-"))]),_:1}),t(ce,{label:"操作",width:"120",fixed:"right"},{default:s(({row:M})=>[M.status==="failed"?(n(),B(N,{key:0,text:"",type:"primary",size:"small",onClick:U=>te(M)},{default:s(()=>r[12]||(r[12]=[d(" 重试 ",-1)])),_:2,__:[12]},1032,["onClick"])):Y("",!0),t(N,{text:"",type:"info",size:"small",onClick:U=>j(M)},{default:s(()=>r[13]||(r[13]=[d(" 日志 ",-1)])),_:2,__:[13]},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),h.value.length>0?(n(),p("div",yd,[r[14]||(r[14]=e("h3",null,"操作历史",-1)),t(de,null,{default:s(()=>[(n(!0),p(ne,null,oe(h.value,(M,U)=>(n(),B(Se,{key:U,timestamp:F(M.timestamp),type:ge(M.action)},{default:s(()=>[e("div",bd,[e("div",wd,a(M.action),1),M.description?(n(),p("div",$d,a(M.description),1)):Y("",!0),e("div",kd,"操作者: "+a(M.operator),1)])]),_:2},1032,["timestamp","type"]))),128))]),_:1})])):Y("",!0)])):Y("",!0)]),_:1},8,["modelValue","title"])}}}),Cd=Oe(Vd,[["__scopeId","data-v-44a6e5db"]]),Td={class:"firmware-update-tasks"},Dd={class:"task-stats"},Id={class:"stat-item"},Md={class:"stat-value running"},Ud={class:"stat-item"},xd={class:"stat-value completed"},zd={class:"stat-item"},Nd={class:"stat-value failed"},Pd={class:"stat-item"},Od={class:"stat-value total"},Ad={class:"search-filters"},Ed={class:"filters-left"},Fd={class:"filters-right"},Rd={class:"task-list"},Bd={class:"task-header"},Yd={class:"task-info"},Xd={class:"task-name"},Ld={class:"task-meta"},Hd={class:"task-version"},Zd={class:"task-devices"},jd={class:"task-time"},Kd={key:0,class:"task-started"},qd={key:1,class:"task-completed"},Wd={class:"task-status"},Gd={key:0,class:"task-duration"},Qd={class:"task-progress"},Jd={class:"progress-info"},eu={key:0},tu={class:"success-rate"},su={key:0,class:"device-progress"},lu={class:"device-header"},au={class:"device-list"},nu={class:"device-info"},ou={class:"device-serial"},iu={class:"device-step"},ru={key:0,class:"device-error"},du={class:"device-status"},uu={class:"device-progress-bar"},cu={class:"progress-text"},vu={key:0,class:"retry-count"},pu={key:1,class:"task-summary"},_u={class:"summary-item"},mu={class:"summary-value"},fu={class:"summary-item"},gu={class:"summary-value success"},hu={class:"summary-item"},yu={class:"summary-value failed"},bu={class:"summary-item"},wu={class:"summary-value"},$u={class:"task-actions"},ku={key:0,class:"empty-state"},Su={key:0,class:"pagination-wrapper"},Vu=Pe({__name:"FirmwareUpdateTasks",setup(re){const l=I(!1),o=I(!1),_=I(""),b=I(""),m=I(""),u=I(null),h=I(1),v=I(10),V=I(0),y=I([]),X=I([]),J=I(!1),P=I(!1),se=I(null);let O=null;const ye=ae(()=>y.value.filter(U=>U.status==="running").length),fe=ae(()=>{const U=new Date().toDateString();return y.value.filter(D=>D.status==="completed"&&D.completedAt&&new Date(D.completedAt).toDateString()===U).length}),ge=ae(()=>y.value.filter(U=>U.status==="failed").length),F=()=>G(null,null,function*(){l.value=!0;try{const U={page:h.value,pageSize:v.value,keyword:b.value||void 0,status:m.value||void 0,dateRange:u.value||void 0},D=yield Me.getUpdateTasks(U);y.value=D.data.list,V.value=D.data.total}catch(U){x.error("加载任务列表失败")}finally{l.value=!1}}),k=()=>G(null,null,function*(){o.value=!0;try{yield F(),x.success("任务列表已刷新")}catch(U){x.error("刷新任务列表失败")}finally{o.value=!1}}),R=()=>{h.value=1,F()},Z=()=>{h.value=1,F()},ue=U=>{v.value=U,h.value=1,F()},_e=U=>{h.value=U,F()},te=()=>{J.value=!0},j=U=>{x.success("更新任务已创建"),F()},z=U=>G(null,null,function*(){const D=Be.canStartTask(U);if(!D.canStart){x.warning(D.reason);return}try{yield Ue.confirm(`确定要开始执行任务 "${U.name}" 吗？`,"确认开始任务",{confirmButtonText:"开始",cancelButtonText:"取消",type:"info"}),_.value=U.id;const E=y.value.findIndex(C=>C.id===U.id);E>-1&&(y.value[E]=Be.updateTaskStatus(U,"running",{startedAt:new Date().toISOString()})),x.success("任务已开始执行")}catch(E){E!=="cancel"&&x.error("启动任务失败")}finally{_.value=""}}),c=U=>G(null,null,function*(){const D=Be.canCancelTask(U);if(!D.canCancel){x.warning(D.reason);return}try{if(yield Ue.confirm(`确定要取消任务 "${U.name}" 吗？取消后无法恢复。`,"确认取消任务",{confirmButtonText:"取消任务",cancelButtonText:"保留任务",type:"warning"}),_.value=U.id,(yield Me.cancelUpdateTask(U.id)).data.success){const C=y.value.findIndex(ie=>ie.id===U.id);C>-1&&(y.value[C]=Be.cancelTask(U,"admin")),x.success("任务已取消")}}catch(E){E!=="cancel"&&x.error("取消任务失败")}finally{_.value=""}}),r=U=>G(null,null,function*(){try{yield Ue.confirm(`确定要重试任务 "${U.name}" 中失败的设备吗？`,"确认重试任务",{confirmButtonText:"重试",cancelButtonText:"取消",type:"info"}),_.value=U.id;const D=y.value.findIndex(E=>E.id===U.id);D>-1&&(y.value[D]=Be.retryFailedDevices(U)),x.success("失败设备已重新开始更新")}catch(D){D!=="cancel"&&x.error("重试任务失败")}finally{_.value=""}}),K=U=>G(null,null,function*(){try{yield Ue.confirm(`确定要删除任务 "${U.name}" 吗？删除后无法恢复。`,"确认删除任务",{confirmButtonText:"删除",cancelButtonText:"取消",type:"danger"}),_.value=U.id;const D=y.value.findIndex(E=>E.id===U.id);D>-1&&(y.value.splice(D,1),V.value--),x.success("任务已删除")}catch(D){D!=="cancel"&&x.error("删除任务失败")}finally{_.value=""}}),q=U=>{se.value=U,P.value=!0},ee=U=>{const D=X.value.indexOf(U);D>-1?X.value.splice(D,1):X.value.push(U)},le=U=>({pending:"info",running:"primary",completed:"success",failed:"danger",cancelled:"warning"})[U]||"info",ve=U=>It[U]||U,A=U=>({pending:"info",downloading:"primary",installing:"primary",rebooting:"warning",completed:"success",failed:"danger"})[U]||"info",W=U=>Mt[U]||U,ce=U=>Be.getTaskCompletionPercentage(U),N=U=>Be.getTaskSuccessRate(U),pe=U=>({pending:"#909399",running:"#409eff",completed:"#67c23a",failed:"#f56c6c",cancelled:"#e6a23c"})[U]||"#909399",Se=U=>({pending:"#909399",downloading:"#409eff",installing:"#409eff",rebooting:"#e6a23c",completed:"#67c23a",failed:"#f56c6c"})[U]||"#909399",de=U=>new Date(U).toLocaleString("zh-CN"),T=U=>{if(!U.startedAt)return"未开始";const D=new Date(U.startedAt).getTime(),E=U.completedAt?new Date(U.completedAt).getTime():Date.now(),C=Math.floor((E-D)/1e3);if(C<60)return`${C}秒`;if(C<3600)return`${Math.floor(C/60)}分${C%60}秒`;const ie=Math.floor(C/3600),Q=Math.floor(C%3600/60),be=C%60;return`${ie}小时${Q}分${be}秒`},S=()=>{O=setInterval(()=>{y.value.some(D=>D.status==="running")&&F()},5e3)},M=()=>{O&&(clearInterval(O),O=null)};return Ke(()=>{F(),S()}),Tt(()=>{M()}),(U,D)=>{const E=f("el-input"),C=f("el-option"),ie=f("el-select"),Q=f("el-date-picker"),be=f("el-icon"),Te=f("el-button"),he=f("el-tag"),Ee=f("el-progress"),Fe=f("el-empty"),Ae=f("el-pagination"),Ie=qe("loading");return n(),p("div",Td,[e("div",Dd,[e("div",Id,[D[7]||(D[7]=e("div",{class:"stat-label"},"进行中任务",-1)),e("div",Md,a(ye.value),1)]),e("div",Ud,[D[8]||(D[8]=e("div",{class:"stat-label"},"今日完成",-1)),e("div",xd,a(fe.value),1)]),e("div",zd,[D[9]||(D[9]=e("div",{class:"stat-label"},"失败任务",-1)),e("div",Nd,a(ge.value),1)]),e("div",Pd,[D[10]||(D[10]=e("div",{class:"stat-label"},"总任务数",-1)),e("div",Od,a(V.value),1)])]),e("div",Ad,[e("div",Ed,[t(E,{modelValue:b.value,"onUpdate:modelValue":D[0]||(D[0]=L=>b.value=L),placeholder:"搜索任务名称或版本","prefix-icon":g(rt),clearable:"",onInput:R,style:{width:"300px"}},null,8,["modelValue","prefix-icon"]),t(ie,{modelValue:m.value,"onUpdate:modelValue":D[1]||(D[1]=L=>m.value=L),placeholder:"任务状态",clearable:"",onChange:Z},{default:s(()=>[t(C,{label:"全部状态",value:""}),t(C,{label:"等待中",value:"pending"}),t(C,{label:"执行中",value:"running"}),t(C,{label:"已完成",value:"completed"}),t(C,{label:"失败",value:"failed"}),t(C,{label:"已取消",value:"cancelled"})]),_:1},8,["modelValue"]),t(Q,{modelValue:u.value,"onUpdate:modelValue":D[2]||(D[2]=L=>u.value=L),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",onChange:Z,style:{width:"240px"}},null,8,["modelValue"])]),e("div",Fd,[t(Te,{type:"primary",onClick:te},{default:s(()=>[t(be,null,{default:s(()=>[t(g(Le))]),_:1}),D[11]||(D[11]=d(" 创建任务 ",-1))]),_:1,__:[11]}),t(Te,{onClick:k,loading:o.value},{default:s(()=>[t(be,null,{default:s(()=>[t(g(et))]),_:1}),D[12]||(D[12]=d(" 刷新 ",-1))]),_:1,__:[12]},8,["loading"])])]),He((n(),p("div",Rd,[(n(!0),p(ne,null,oe(y.value,L=>(n(),p("div",{key:L.id,class:Ne(["task-card",{"task-running":L.status==="running","task-completed":L.status==="completed","task-failed":L.status==="failed"}])},[e("div",Bd,[e("div",Yd,[e("h4",Xd,a(L.name),1),e("div",Ld,[e("span",Hd,"目标版本: "+a(L.targetVersion),1),e("span",Zd,"设备数量: "+a(L.deviceIds.length)+"台",1),e("span",jd,"创建时间: "+a(de(L.createdAt)),1),L.startedAt?(n(),p("span",Kd,"开始时间: "+a(de(L.startedAt)),1)):Y("",!0),L.completedAt?(n(),p("span",qd,"完成时间: "+a(de(L.completedAt)),1)):Y("",!0)])]),e("div",Wd,[t(he,{type:le(L.status),size:"large"},{default:s(()=>[d(a(ve(L.status)),1)]),_:2},1032,["type"]),L.status==="running"?(n(),p("div",Gd," 运行时长: "+a(T(L)),1)):Y("",!0)])]),e("div",Qd,[e("div",Jd,[e("span",null,"进度: "+a(L.progress.completed+L.progress.failed)+"/"+a(L.progress.total),1),e("span",null,"成功: "+a(L.progress.completed),1),e("span",null,"失败: "+a(L.progress.failed),1),L.progress.inProgress>0?(n(),p("span",eu,"进行中: "+a(L.progress.inProgress),1)):Y("",!0),e("span",tu,"成功率: "+a(N(L))+"%",1)]),t(Ee,{percentage:ce(L),color:pe(L.status),"stroke-width":8},null,8,["percentage","color"])]),L.status==="running"&&L.devices.length>0?(n(),p("div",su,[e("div",lu,[D[13]||(D[13]=e("h5",null,"设备更新进度",-1)),t(Te,{text:"",size:"small",onClick:w=>ee(L.id)},{default:s(()=>[d(a(X.value.includes(L.id)?"收起":"展开"),1)]),_:2},1032,["onClick"])]),He(e("div",au,[(n(!0),p(ne,null,oe(L.devices,w=>(n(),p("div",{key:w.deviceId,class:"device-item"},[e("div",nu,[e("span",ou,a(w.deviceSerialNumber),1),e("span",iu,a(w.currentStep),1),w.errorMessage?(n(),p("span",ru,a(w.errorMessage),1)):Y("",!0)]),e("div",du,[e("div",uu,[t(Ee,{percentage:w.progress,color:Se(w.status),"stroke-width":4,"show-text":!1},null,8,["percentage","color"]),e("span",cu,a(w.progress)+"%",1)]),t(he,{type:A(w.status),size:"small"},{default:s(()=>[d(a(W(w.status)),1)]),_:2},1032,["type"]),w.retryCount>0?(n(),p("div",vu," 重试: "+a(w.retryCount)+"次 ",1)):Y("",!0)])]))),128))],512),[[ls,X.value.includes(L.id)]])])):Y("",!0),["completed","failed","cancelled"].includes(L.status)?(n(),p("div",pu,[e("div",_u,[D[14]||(D[14]=e("span",{class:"summary-label"},"执行时长:",-1)),e("span",mu,a(T(L)),1)]),e("div",fu,[D[15]||(D[15]=e("span",{class:"summary-label"},"成功设备:",-1)),e("span",gu,a(L.progress.completed)+"台",1)]),e("div",hu,[D[16]||(D[16]=e("span",{class:"summary-label"},"失败设备:",-1)),e("span",yu,a(L.progress.failed)+"台",1)]),e("div",bu,[D[17]||(D[17]=e("span",{class:"summary-label"},"成功率:",-1)),e("span",wu,a(N(L))+"%",1)])])):Y("",!0),e("div",$u,[L.status==="pending"?(n(),B(Te,{key:0,text:"",type:"success",size:"small",onClick:w=>z(L),loading:L.id===_.value},{default:s(()=>D[18]||(D[18]=[d(" 开始任务 ",-1)])),_:2,__:[18]},1032,["onClick","loading"])):Y("",!0),["pending","running"].includes(L.status)?(n(),B(Te,{key:1,text:"",type:"danger",size:"small",onClick:w=>c(L),loading:L.id===_.value},{default:s(()=>D[19]||(D[19]=[d(" 取消任务 ",-1)])),_:2,__:[19]},1032,["onClick","loading"])):Y("",!0),t(Te,{text:"",type:"primary",size:"small",onClick:w=>q(L)},{default:s(()=>D[20]||(D[20]=[d(" 查看详情 ",-1)])),_:2,__:[20]},1032,["onClick"]),L.status==="failed"?(n(),B(Te,{key:2,text:"",type:"primary",size:"small",onClick:w=>r(L),loading:L.id===_.value},{default:s(()=>D[21]||(D[21]=[d(" 重试失败设备 ",-1)])),_:2,__:[21]},1032,["onClick","loading"])):Y("",!0),["completed","failed","cancelled"].includes(L.status)?(n(),B(Te,{key:3,text:"",type:"info",size:"small",onClick:w=>K(L),loading:L.id===_.value},{default:s(()=>D[22]||(D[22]=[d(" 删除任务 ",-1)])),_:2,__:[22]},1032,["onClick","loading"])):Y("",!0)])],2))),128)),y.value.length===0&&!l.value?(n(),p("div",ku,[t(Fe,{description:"暂无更新任务"},{default:s(()=>[t(Te,{type:"primary",onClick:te},{default:s(()=>D[23]||(D[23]=[d("创建第一个任务",-1)])),_:1,__:[23]})]),_:1})])):Y("",!0)])),[[Ie,l.value]]),V.value>0?(n(),p("div",Su,[t(Ae,{"current-page":h.value,"onUpdate:currentPage":D[3]||(D[3]=L=>h.value=L),"page-size":v.value,"onUpdate:pageSize":D[4]||(D[4]=L=>v.value=L),"page-sizes":[5,10,20,50],total:V.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:ue,onCurrentChange:_e},null,8,["current-page","page-size","total"])])):Y("",!0),t(Cd,{modelValue:P.value,"onUpdate:modelValue":D[5]||(D[5]=L=>P.value=L),task:se.value,onRefresh:F},null,8,["modelValue","task"]),t(Qr,{modelValue:J.value,"onUpdate:modelValue":D[6]||(D[6]=L=>J.value=L),onUpdateStarted:j},null,8,["modelValue"])])}}}),Cu=Oe(Vu,[["__scopeId","data-v-531d44da"]]),Tu={class:"firmware-upload-dialog"},Du={key:0,class:"step-content"},Iu={class:"upload-area"},Mu={class:"upload-content"},Uu={key:0,class:"selected-file"},xu={class:"file-info"},zu={class:"file-details"},Nu={class:"file-name"},Pu={class:"file-meta"},Ou={class:"step-actions"},Au={key:1,class:"step-content"},Eu={class:"validation-content"},Fu={class:"validation-progress"},Ru={class:"validation-results"},Bu={class:"check-name"},Yu={class:"check-message"},Xu={class:"step-actions"},Lu={key:2,class:"step-content"},Hu={class:"form-section"},Zu={class:"form-section"},ju={class:"changelog-editor"},Ku={class:"form-section"},qu={class:"compatibility-editor"},Wu={class:"issues-editor"},Gu={class:"step-actions"},Qu={key:3,class:"step-content"},Ju={class:"upload-progress-content"},ec={key:0,class:"uploading"},tc={class:"progress-section"},sc={class:"progress-info"},lc={class:"upload-steps-detail"},ac={class:"step-name"},nc={class:"step-message"},oc={key:1,class:"upload-completed"},ic={class:"success-icon"},rc={class:"upload-result"},dc={class:"result-item"},uc={class:"value"},cc={class:"result-item"},vc={class:"value"},pc={class:"result-item"},_c={class:"value"},mc={class:"result-item"},fc={class:"value"},gc={class:"step-actions"},_t=100,hc=".bin,.hex,.fw",yc=Pe({__name:"FirmwareUploadDialog",props:{modelValue:{type:Boolean}},emits:["update:modelValue","upload-success"],setup(re,{emit:l}){const o=re,_=l,b=ae({get:()=>o.modelValue,set:E=>_("update:modelValue",E)}),m=I(),u=I(),h=I(0),v=I(null),V=I(!1),y=I(!1),X=I(!1),J=_t*1024*1024,P=["bin","hex","fw"],se=[{label:"YX-EDU-2024 (教育版)",value:"YX-EDU-2024"},{label:"YX-HOME-2024 (家用版)",value:"YX-HOME-2024"},{label:"YX-PRO-2024 (专业版)",value:"YX-PRO-2024"},{label:"YX-MINI-2024 (迷你版)",value:"YX-MINI-2024"}],O=mt({version:"",deviceModel:[],description:"",changelog:[""],compatibility:[""],knownIssues:[]}),ye={version:[{required:!0,message:"请输入版本号",trigger:"blur"},{pattern:/^\d+\.\d+\.\d+(-\w+)?$/,message:"版本号格式不正确，例如: 2.1.0 或 2.1.0-beta",trigger:"blur"}],deviceModel:[{required:!0,message:"请选择适用设备",trigger:"change"}],description:[{required:!0,message:"请输入版本描述",trigger:"blur"},{min:10,message:"描述至少需要10个字符",trigger:"blur"}]},fe=I(0),ge=I(void 0),F=I(""),k=I([{name:"文件格式检查",status:"pending",message:"等待检查"},{name:"文件大小检查",status:"pending",message:"等待检查"},{name:"文件完整性校验",status:"pending",message:"等待检查"},{name:"固件信息提取",status:"pending",message:"等待检查"}]),R=I(0),Z=I(void 0),ue=I(0),_e=I(0),te=I([{name:"准备上传",status:"pending",message:"等待开始"},{name:"文件传输",status:"pending",message:"等待开始"},{name:"服务器验证",status:"pending",message:"等待开始"},{name:"数据库保存",status:"pending",message:"等待开始"}]),j=E=>c(E),z=E=>{E.raw&&c(E.raw)&&(v.value=E.raw)},c=E=>{const ie=E.name.toLowerCase().split(".").pop();return!ie||!P.includes(ie)?(x.error(`不支持的文件格式，请选择 ${P.join(", ")} 格式的文件`),!1):E.size>J?(x.error(`文件大小不能超过 ${_t}MB`),!1):E.size===0?(x.error("文件不能为空"),!1):!0},r=()=>{v.value=null,m.value&&m.value.clearFiles()},K=()=>G(null,null,function*(){if(h.value===0)h.value=1,yield ee();else if(h.value===1)F.value||(h.value=2,le());else if(h.value===2&&u.value)try{yield u.value.validate(),h.value=3}catch(E){x.error("请完善固件信息")}}),q=()=>{h.value>0&&h.value--},ee=()=>G(null,null,function*(){if(v.value){y.value=!0,F.value="",fe.value=0,ge.value=void 0,k.value.forEach(E=>{E.status="pending",E.message="等待检查"});try{k.value[0].status="checking",k.value[0].message="检查中...",yield M(500);const C=v.value.name.toLowerCase().split(".").pop();if(!C||!P.includes(C))throw k.value[0].status="error",k.value[0].message="不支持的文件格式",new Error("不支持的文件格式");if(k.value[0].status="success",k.value[0].message="格式正确",fe.value=25,k.value[1].status="checking",k.value[1].message="检查中...",yield M(300),v.value.size>J)throw k.value[1].status="error",k.value[1].message=`文件过大 (${ze(v.value.size)})`,new Error("文件大小超出限制");k.value[1].status="success",k.value[1].message=`大小正常 (${ze(v.value.size)})`,fe.value=50,k.value[2].status="checking",k.value[2].message="计算校验和...",yield M(800);const ie=yield U(v.value);k.value[2].status="success",k.value[2].message=`校验和: ${ie.substring(0,8)}...`,fe.value=75,k.value[3].status="checking",k.value[3].message="提取固件信息...",yield M(600);const Q=yield D(v.value);k.value[3].status="success",k.value[3].message=`检测到版本信息: ${Q.version||"未知"}`,fe.value=100,ge.value="success"}catch(E){F.value=E.message||"文件验证失败",ge.value="exception"}finally{y.value=!1}}}),le=()=>{if(!v.value)return;const E=v.value.name,C=E.match(/v?(\d+\.\d+\.\d+(-\w+)?)/i);C&&(O.version=C[1]);const ie=E.toLowerCase();ie.includes("edu")?O.deviceModel=["YX-EDU-2024"]:ie.includes("home")?O.deviceModel=["YX-HOME-2024"]:ie.includes("pro")?O.deviceModel=["YX-PRO-2024"]:ie.includes("mini")&&(O.deviceModel=["YX-MINI-2024"])},ve=()=>G(null,null,function*(){if(v.value){V.value=!0,X.value=!1,R.value=0,Z.value=void 0,ue.value=0,_e.value=v.value.size,te.value.forEach(E=>{E.status="pending",E.message="等待开始"});try{te.value[0].status="processing",te.value[0].message="准备上传数据...",yield M(500);const E={file:v.value,version:O.version,deviceModel:O.deviceModel,description:O.description,changelog:O.changelog.filter(ie=>ie.trim()),compatibility:O.compatibility.filter(ie=>ie.trim()),knownIssues:O.knownIssues.filter(ie=>ie.trim())};te.value[0].status="completed",te.value[0].message="准备完成",te.value[1].status="processing",te.value[1].message="正在传输文件...";for(let ie=0;ie<=100;ie+=5)R.value=Math.floor(ie*.7),ue.value=Math.floor(_e.value*ie/100),yield M(100);te.value[1].status="completed",te.value[1].message="文件传输完成",te.value[2].status="processing",te.value[2].message="服务器验证中...",R.value=80,yield M(1e3),te.value[2].status="completed",te.value[2].message="验证通过",te.value[3].status="processing",te.value[3].message="保存到数据库...",R.value=90,yield M(800);const C=yield Me.uploadFirmware(E);te.value[3].status="completed",te.value[3].message="保存完成",R.value=100,Z.value="success",X.value=!0,x.success("固件上传成功！"),_("upload-success",C.data)}catch(E){console.error("上传失败:",E),Z.value="exception";const C=te.value.findIndex(ie=>ie.status==="processing");C>=0&&(te.value[C].status="error",te.value[C].message=E.message||"上传失败"),x.error(E.message||"固件上传失败")}finally{V.value=!1}}}),A=()=>G(null,null,function*(){if(V.value)try{yield Ue.confirm("正在上传中，确定要关闭吗？关闭后上传将被中断。","确认关闭",{confirmButtonText:"确定关闭",cancelButtonText:"继续上传",type:"warning"})}catch(E){return}ce(),_("update:modelValue",!1)}),W=()=>{ce(),h.value=0},ce=()=>{h.value=0,v.value=null,V.value=!1,y.value=!1,X.value=!1,F.value="",fe.value=0,ge.value=void 0,R.value=0,Z.value=void 0,ue.value=0,_e.value=0,Object.assign(O,{version:"",deviceModel:[],description:"",changelog:[""],compatibility:[""],knownIssues:[]}),k.value.forEach(E=>{E.status="pending",E.message="等待检查"}),te.value.forEach(E=>{E.status="pending",E.message="等待开始"}),m.value&&m.value.clearFiles()},N=()=>{O.changelog.push("")},pe=E=>{O.changelog.length>1&&O.changelog.splice(E,1)},Se=()=>{O.compatibility.push("")},de=E=>{O.compatibility.length>1&&O.compatibility.splice(E,1)},T=()=>{O.knownIssues.push("")},S=E=>{O.knownIssues.splice(E,1)},M=E=>new Promise(C=>setTimeout(C,E)),U=E=>G(null,null,function*(){return yield M(500),`sha256:${Math.random().toString(36).substring(2,15)}${Math.random().toString(36).substring(2,15)}`}),D=E=>G(null,null,function*(){yield M(300);const ie=E.name.match(/v?(\d+\.\d+\.\d+(-\w+)?)/i);return{version:ie?ie[1]:void 0}});return Xe(b,E=>{E||ce()}),(E,C)=>{const ie=f("el-step"),Q=f("el-steps"),be=f("el-icon"),Te=f("el-upload"),he=f("el-button"),Ee=f("el-progress"),Fe=f("el-alert"),Ae=f("el-input"),Ie=f("el-form-item"),L=f("el-option"),w=f("el-select"),i=f("el-form"),we=f("el-dialog");return n(),B(we,{modelValue:b.value,"onUpdate:modelValue":C[3]||(C[3]=Ve=>b.value=Ve),title:"上传固件",width:"800px","close-on-click-modal":!1,"close-on-press-escape":!1,onClose:A},{default:s(()=>{var Ve,me;return[e("div",Tu,[t(Q,{active:h.value,"align-center":"",class:"upload-steps"},{default:s(()=>[t(ie,{title:"选择文件",icon:"Upload"}),t(ie,{title:"文件验证",icon:"CircleCheck"}),t(ie,{title:"编辑信息",icon:"Edit"}),t(ie,{title:"上传完成",icon:"SuccessFilled"})]),_:1},8,["active"]),h.value===0?(n(),p("div",Du,[e("div",Iu,[t(Te,{ref_key:"uploadRef",ref:m,class:"firmware-uploader",drag:"","auto-upload":!1,"show-file-list":!1,accept:hc,"before-upload":j,"on-change":z,disabled:V.value},{default:s(()=>[e("div",Mu,[t(be,{class:"upload-icon"},{default:s(()=>[t(g(Qt))]),_:1}),e("div",{class:"upload-text"},[C[4]||(C[4]=e("p",{class:"upload-title"},"拖拽固件文件到此处，或点击选择文件",-1)),e("p",{class:"upload-hint"},"支持 .bin, .hex, .fw 格式，文件大小不超过 "+a(_t)+"MB")])])]),_:1},8,["disabled"]),v.value?(n(),p("div",Uu,[e("div",xu,[t(be,{class:"file-icon"},{default:s(()=>[t(g(Jt))]),_:1}),e("div",zu,[e("div",Nu,a(v.value.name),1),e("div",Pu,a(g(ze)(v.value.size))+" · "+a(v.value.type||"未知类型"),1)]),t(he,{type:"danger",size:"small",text:"",onClick:r,disabled:V.value},{default:s(()=>[t(be,null,{default:s(()=>[t(g(Qe))]),_:1})]),_:1},8,["disabled"])])])):Y("",!0)]),e("div",Ou,[t(he,{onClick:A,disabled:V.value},{default:s(()=>C[5]||(C[5]=[d("取消",-1)])),_:1,__:[5]},8,["disabled"]),t(he,{type:"primary",onClick:K,disabled:!v.value||V.value},{default:s(()=>C[6]||(C[6]=[d(" 下一步 ",-1)])),_:1,__:[6]},8,["disabled"])])])):Y("",!0),h.value===1?(n(),p("div",Au,[e("div",Eu,[C[7]||(C[7]=e("div",{class:"validation-header"},[e("h3",null,"文件验证中..."),e("p",null,"正在检查文件完整性和格式")],-1)),e("div",Fu,[t(Ee,{percentage:fe.value,status:ge.value,"stroke-width":"8"},null,8,["percentage","status"])]),e("div",Ru,[(n(!0),p(ne,null,oe(k.value,$=>(n(),p("div",{key:$.name,class:Ne(["validation-item",$.status])},[t(be,{class:"check-icon"},{default:s(()=>[$.status==="checking"?(n(),B(g(Ge),{key:0})):$.status==="success"?(n(),B(g(Ce),{key:1})):$.status==="error"?(n(),B(g(Ye),{key:2})):(n(),B(g(Je),{key:3}))]),_:2},1024),e("span",Bu,a($.name),1),e("span",Yu,a($.message),1)],2))),128))]),F.value?(n(),B(Fe,{key:0,title:F.value,type:"error","show-icon":"",closable:!1,class:"validation-error"},null,8,["title"])):Y("",!0)]),e("div",Xu,[t(he,{onClick:q,disabled:y.value},{default:s(()=>C[8]||(C[8]=[d("上一步",-1)])),_:1,__:[8]},8,["disabled"]),t(he,{type:"primary",onClick:K,disabled:y.value||F.value,loading:y.value},{default:s(()=>[d(a(y.value?"验证中...":"下一步"),1)]),_:1},8,["disabled","loading"])])])):Y("",!0),h.value===2?(n(),p("div",Lu,[t(i,{ref_key:"formRef",ref:u,model:O,rules:ye,"label-width":"120px",class:"firmware-form"},{default:s(()=>[e("div",Hu,[C[9]||(C[9]=e("h4",{class:"section-title"},"基本信息",-1)),t(Ie,{label:"版本号",prop:"version",required:""},{default:s(()=>[t(Ae,{modelValue:O.version,"onUpdate:modelValue":C[0]||(C[0]=$=>O.version=$),placeholder:"例如: 2.1.0",disabled:V.value},null,8,["modelValue","disabled"])]),_:1}),t(Ie,{label:"适用设备",prop:"deviceModel",required:""},{default:s(()=>[t(w,{modelValue:O.deviceModel,"onUpdate:modelValue":C[1]||(C[1]=$=>O.deviceModel=$),multiple:"",placeholder:"选择适用的设备型号",style:{width:"100%"},disabled:V.value},{default:s(()=>[(n(),p(ne,null,oe(se,$=>t(L,{key:$.value,label:$.label,value:$.value},null,8,["label","value"])),64))]),_:1},8,["modelValue","disabled"])]),_:1}),t(Ie,{label:"版本描述",prop:"description",required:""},{default:s(()=>[t(Ae,{modelValue:O.description,"onUpdate:modelValue":C[2]||(C[2]=$=>O.description=$),type:"textarea",rows:3,placeholder:"简要描述此版本的主要功能和改进",disabled:V.value},null,8,["modelValue","disabled"])]),_:1})]),e("div",Zu,[C[11]||(C[11]=e("h4",{class:"section-title"},"更新日志",-1)),t(Ie,{label:"更新内容",prop:"changelog"},{default:s(()=>[e("div",ju,[(n(!0),p(ne,null,oe(O.changelog,($,$e)=>(n(),p("div",{key:$e,class:"changelog-item"},[t(Ae,{modelValue:O.changelog[$e],"onUpdate:modelValue":ke=>O.changelog[$e]=ke,placeholder:"输入更新内容",disabled:V.value},null,8,["modelValue","onUpdate:modelValue","disabled"]),t(he,{type:"danger",size:"small",text:"",onClick:ke=>pe($e),disabled:V.value},{default:s(()=>[t(be,null,{default:s(()=>[t(g(Qe))]),_:1})]),_:2},1032,["onClick","disabled"])]))),128)),t(he,{type:"primary",size:"small",text:"",onClick:N,disabled:V.value},{default:s(()=>[t(be,null,{default:s(()=>[t(g(Le))]),_:1}),C[10]||(C[10]=d(" 添加更新内容 ",-1))]),_:1,__:[10]},8,["disabled"])])]),_:1})]),e("div",Ku,[C[14]||(C[14]=e("h4",{class:"section-title"},"兼容性信息",-1)),t(Ie,{label:"兼容性说明",prop:"compatibility"},{default:s(()=>[e("div",qu,[(n(!0),p(ne,null,oe(O.compatibility,($,$e)=>(n(),p("div",{key:$e,class:"compatibility-item"},[t(Ae,{modelValue:O.compatibility[$e],"onUpdate:modelValue":ke=>O.compatibility[$e]=ke,placeholder:"例如: YX-EDU-2024 v1.0+",disabled:V.value},null,8,["modelValue","onUpdate:modelValue","disabled"]),t(he,{type:"danger",size:"small",text:"",onClick:ke=>de($e),disabled:V.value},{default:s(()=>[t(be,null,{default:s(()=>[t(g(Qe))]),_:1})]),_:2},1032,["onClick","disabled"])]))),128)),t(he,{type:"primary",size:"small",text:"",onClick:Se,disabled:V.value},{default:s(()=>[t(be,null,{default:s(()=>[t(g(Le))]),_:1}),C[12]||(C[12]=d(" 添加兼容性说明 ",-1))]),_:1,__:[12]},8,["disabled"])])]),_:1}),t(Ie,{label:"已知问题",prop:"knownIssues"},{default:s(()=>[e("div",Wu,[(n(!0),p(ne,null,oe(O.knownIssues,($,$e)=>(n(),p("div",{key:$e,class:"issue-item"},[t(Ae,{modelValue:O.knownIssues[$e],"onUpdate:modelValue":ke=>O.knownIssues[$e]=ke,placeholder:"描述已知问题（可选）",disabled:V.value},null,8,["modelValue","onUpdate:modelValue","disabled"]),t(he,{type:"danger",size:"small",text:"",onClick:ke=>S($e),disabled:V.value},{default:s(()=>[t(be,null,{default:s(()=>[t(g(Qe))]),_:1})]),_:2},1032,["onClick","disabled"])]))),128)),t(he,{type:"primary",size:"small",text:"",onClick:T,disabled:V.value},{default:s(()=>[t(be,null,{default:s(()=>[t(g(Le))]),_:1}),C[13]||(C[13]=d(" 添加已知问题 ",-1))]),_:1,__:[13]},8,["disabled"])])]),_:1})])]),_:1},8,["model"]),e("div",Gu,[t(he,{onClick:q,disabled:V.value},{default:s(()=>C[15]||(C[15]=[d("上一步",-1)])),_:1,__:[15]},8,["disabled"]),t(he,{type:"primary",onClick:ve,loading:V.value,disabled:V.value},{default:s(()=>[d(a(V.value?"上传中...":"开始上传"),1)]),_:1},8,["loading","disabled"])])])):Y("",!0),h.value===3?(n(),p("div",Qu,[e("div",Ju,[X.value?(n(),p("div",oc,[e("div",ic,[t(be,null,{default:s(()=>[t(g(es))]),_:1})]),C[21]||(C[21]=e("h3",null,"固件上传成功！",-1)),e("p",null,"固件版本 "+a(O.version)+" 已成功上传到系统",1),e("div",rc,[e("div",dc,[C[17]||(C[17]=e("span",{class:"label"},"文件名:",-1)),e("span",uc,a((Ve=v.value)==null?void 0:Ve.name),1)]),e("div",cc,[C[18]||(C[18]=e("span",{class:"label"},"文件大小:",-1)),e("span",vc,a(g(ze)(((me=v.value)==null?void 0:me.size)||0)),1)]),e("div",pc,[C[19]||(C[19]=e("span",{class:"label"},"版本号:",-1)),e("span",_c,a(O.version),1)]),e("div",mc,[C[20]||(C[20]=e("span",{class:"label"},"适用设备:",-1)),e("span",fc,a(O.deviceModel.join(", ")),1)])])])):(n(),p("div",ec,[C[16]||(C[16]=e("div",{class:"upload-header"},[e("h3",null,"正在上传固件..."),e("p",null,"请勿关闭页面，上传过程可能需要几分钟")],-1)),e("div",tc,[t(Ee,{percentage:R.value,status:Z.value,"stroke-width":"12",class:"main-progress"},null,8,["percentage","status"]),e("div",sc,[e("span",null,a(R.value)+"%",1),e("span",null,a(g(ze)(ue.value))+" / "+a(g(ze)(_e.value)),1)])]),e("div",lc,[(n(!0),p(ne,null,oe(te.value,$=>(n(),p("div",{key:$.name,class:Ne(["upload-step-item",$.status])},[t(be,{class:"step-icon"},{default:s(()=>[$.status==="processing"?(n(),B(g(Ge),{key:0})):$.status==="completed"?(n(),B(g(Ce),{key:1})):$.status==="error"?(n(),B(g(Ye),{key:2})):(n(),B(g(Je),{key:3}))]),_:2},1024),e("span",ac,a($.name),1),e("span",nc,a($.message),1)],2))),128))])]))]),e("div",gc,[X.value?(n(),B(he,{key:0,onClick:A},{default:s(()=>C[22]||(C[22]=[d(" 关闭 ",-1)])),_:1,__:[22]})):Y("",!0),X.value?(n(),B(he,{key:1,type:"primary",onClick:W},{default:s(()=>C[23]||(C[23]=[d(" 继续上传 ",-1)])),_:1,__:[23]})):Y("",!0),!X.value&&!V.value?(n(),B(he,{key:2,onClick:q},{default:s(()=>C[24]||(C[24]=[d(" 返回编辑 ",-1)])),_:1,__:[24]})):Y("",!0)])])):Y("",!0)])]}),_:1},8,["modelValue"])}}}),bc=Oe(yc,[["__scopeId","data-v-fa204eef"]]),wc={class:"firmware-management"},$c={class:"page-header"},kc={class:"header-right"},Sc={class:"stats-cards"},Vc={class:"stat-card"},Cc={class:"stat-icon total"},Tc={class:"stat-content"},Dc={class:"stat-value"},Ic={class:"stat-card"},Mc={class:"stat-icon stable"},Uc={class:"stat-content"},xc={class:"stat-value"},zc={class:"stat-card"},Nc={class:"stat-icon testing"},Pc={class:"stat-content"},Oc={class:"stat-value"},Ac={class:"stat-card"},Ec={class:"stat-icon downloads"},Fc={class:"stat-content"},Rc={class:"stat-value"},Bc=Pe({__name:"FirmwareManagement",setup(re){const l=I("versions"),o=I({totalVersions:0,stableVersions:0,testingVersions:0,draftVersions:0,deprecatedVersions:0,totalDownloads:0,deviceDistribution:{}}),_=()=>G(null,null,function*(){try{const h=yield Me.getFirmwareStats();o.value=h.data}catch(h){console.error("加载统计数据失败:",h),x.error("加载统计数据失败")}}),b=I(!1),m=()=>{b.value=!0},u=h=>{x.success(`固件 ${h.version} 上传成功`),b.value=!1,_()};return Ke(()=>{_()}),(h,v)=>{const V=f("el-icon"),y=f("el-button"),X=f("el-tab-pane"),J=f("el-tabs");return n(),p("div",wc,[e("div",$c,[v[3]||(v[3]=e("div",{class:"header-left"},[e("h2",null,"固件管理"),e("p",{class:"header-subtitle"},"设备固件版本管理与更新 · 练字机器人管理系统")],-1)),e("div",kc,[t(y,{type:"primary",onClick:m},{default:s(()=>[t(V,null,{default:s(()=>[t(g(it))]),_:1}),v[2]||(v[2]=d(" 上传固件 ",-1))]),_:1,__:[2]})])]),e("div",Sc,[e("div",Vc,[e("div",Cc,[t(V,null,{default:s(()=>[t(g(ts))]),_:1})]),e("div",Tc,[e("div",Dc,a(o.value.totalVersions),1),v[4]||(v[4]=e("div",{class:"stat-label"},"固件版本",-1))])]),e("div",Ic,[e("div",Mc,[t(V,null,{default:s(()=>[t(g(Ce))]),_:1})]),e("div",Uc,[e("div",xc,a(o.value.stableVersions),1),v[5]||(v[5]=e("div",{class:"stat-label"},"稳定版本",-1))])]),e("div",zc,[e("div",Nc,[t(V,null,{default:s(()=>[t(g(je))]),_:1})]),e("div",Pc,[e("div",Oc,a(o.value.testingVersions),1),v[6]||(v[6]=e("div",{class:"stat-label"},"测试版本",-1))])]),e("div",Ac,[e("div",Ec,[t(V,null,{default:s(()=>[t(g(We))]),_:1})]),e("div",Fc,[e("div",Rc,a(o.value.totalDownloads),1),v[7]||(v[7]=e("div",{class:"stat-label"},"总下载量",-1))])])]),t(J,{modelValue:l.value,"onUpdate:modelValue":v[0]||(v[0]=P=>l.value=P),type:"border-card",class:"main-tabs"},{default:s(()=>[t(X,{label:"固件版本",name:"versions"},{default:s(()=>[t(ia)]),_:1}),t(X,{label:"设备状态",name:"devices"},{default:s(()=>[t(dr)]),_:1}),t(X,{label:"更新任务",name:"tasks"},{default:s(()=>[t(Cu)]),_:1})]),_:1},8,["modelValue"]),t(bc,{modelValue:b.value,"onUpdate:modelValue":v[1]||(v[1]=P=>b.value=P),onUploadSuccess:u},null,8,["modelValue"])])}}}),jc=Oe(Bc,[["__scopeId","data-v-7ec18678"]]);export{jc as default};
